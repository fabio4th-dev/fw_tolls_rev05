<!-- Estrutura principal, CSS, login, dashboard b√°sico, navega√ß√£o -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramentas - Login</title>
    <link rel="icon" type="image/x-icon" href="fw_mini.ico">
    <link rel="icon" type="image/x-icon" href="fw_mini.ico">
    <link rel="shortcut icon" href="fw_mini.ico">
    <link rel="icon" type="image/png" href="fw_mini.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- Adicione no HEAD do seu HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* Efeito hover para bot√£o de fechar do zoom */
        .image-modal-close:hover {
            background: rgba(96, 96, 96, 0.95) !important;
            border-color: rgba(255, 255, 255, 0.8) !important;
            transform: scale(1.15) rotate(90deg) !important;
            box-shadow: 0 6px 16px rgba(0,0,0,0.5) !important;
        }
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #2980b9;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --gray-color: #95a5a6;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Login Container */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-box {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .login-box::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(25deg);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }
        
        .login-logo-fw {
            width: 180px;
            margin: 0 auto 20px;
        }
        
        .login-logo-fw img {
            width: 100%;
            height: auto;
        }
        
        .login-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .login-form {
            position: relative;
            z-index: 1;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: white;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .form-group input:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .form-group input.error {
            border-color: var(--danger-color);
        }
        
        .login-btn {
            width: 100%;
            padding: 16px;
            background-color: white;
            color: var(--primary-color);
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-btn:hover {
            background-color: var(--light-color);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .login-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            position: relative;
            z-index: 1;
        }
        
        .login-logo-delservin {
            width: 120px;
        }
        
        .login-logo-altercon {
            width: 90px;
        }
        
        .login-footer img {
            width: 100%;
            height: auto;
        }
        
        .login-error {
            background-color: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--danger-color);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .login-error.show {
            display: block;
        }
        
        .user-badge {
            display: inline-block;
            padding: 4px 12px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* Dashboard Container */
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 12px;
            padding: 2px;
            margin-bottom: 5px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(25deg);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            position: relative;
            z-index: 1;
            margin-bottom: 2px;
        }
        
        .logo-fw {
            width: 140px;
            flex-shrink: 0;
            margin-left: 25px;
            position: relative;
            top: 42px;
        }
        
        .logo-fw img {
            width: 100%;
            height: auto;
            margin-left: 20px;
            margin-top: 10px;
            max-height: 650px;
            object-fit: contain;
        }
        
        .header-center {
            text-align: center;
            flex-grow: 1;
            padding: 0 20px;
        }
        
        .project-title {
            font-size: 40px;
            font-weight: 700;
            position: relative;
            left: 70px;
            z-index: 1;
            margin-bottom: 5px;
        }
        
        .project-subtitle {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .header-right {
            display: flex;
            gap: 30px;
            flex-shrink: 0;
        }
        
        .logo-right {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-right img {
            width: 100%;
            height: auto;
            max-height: 60px;
            object-fit: contain;
        }
        
        .logo-delservin {
            width: 130px;
            position: relative;
            top: 38px;
            flex-shrink: 0;
        }
        
        .logo-altercon {
            width: 100px;
            position: relative;
            top: 38px;
            margin-right: 30px;
            flex-shrink: 0;
        }
        
        .user-info {
            position: absolute;
            top: 0px;
            right: 20px;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-welcome {
            color: white;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .project-info {
            display: flex;
            gap: 20px;
            position: relative;
            z-index: 1;
            align-items: center;
            justify-content: center;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .info-item {
            text-align: center;
            min-width: 100px;
        }
        
        .info-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .info-value {
            font-size: 20px;
            font-weight: 700;
        }
        
        .tabs-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .tabs-header {
            display: flex;
            background-color: var(--light-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 18px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-color);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .tab-button.active {
            background-color: white;
            color: var(--secondary-color);
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--secondary-color);
        }
        
        .tab-button.hidden {
            display: none;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 22px;
            margin-bottom: 25px;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--secondary-color);
        }
        
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid var(--secondary-color);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card.hidden {
            display: none;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--secondary-color);
        }
        
        .progress-container {
            margin-bottom: 18px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: var(--light-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.8s ease;
        }
        
        .progress-fill.planned {
            background-color: var(--secondary-color);
        }
        
        .progress-fill.actual {
            background-color: var(--success-color);
        }
        
        .chart-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            height: 450px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-title i {
            color: var(--secondary-color);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .status-completed {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }
        
        .status-ontrack {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary-color);
        }
        
        .status-delayed {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }
        
        /* Formul√°rio de cadastro */
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        label.required::after {
            content: " *";
            color: var(--danger-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s ease;
            background-color: white;
            color: var(--text-color);
        }
        
        input::placeholder, select::placeholder, textarea::placeholder {
            color: var(--gray-color);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }
        
        input.error, select.error, textarea.error {
            border-color: var(--danger-color);
            background-color: rgba(231, 76, 60, 0.05);
        }
        
        .error-message {
            color: var(--danger-color);
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* √Årea de captura de imagem */
        .image-capture-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .camera-area {
            width: 100%;
            height: 300px;
            background-color: var(--light-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .camera-area img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .camera-placeholder {
            text-align: center;
            color: var(--gray-color);
        }
        
        .camera-placeholder i {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* Lista de ferramentas */
        .tools-list {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            background-color: var(--light-color);
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background-color: rgba(236, 240, 241, 0.5);
        }
        
        .tool-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        /* Indicador de ferramenta atribu√≠da */
        .tool-assigned-indicator {
            position: relative;
        }

        .tool-assigned-indicator::after {
            content: "üë§";
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 12px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
    }

        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .action-btn-view {
            color: var(--secondary-color);
        }
        
        .action-btn-edit {
            color: var(--warning-color);
        }
        
        .action-btn-delete {
            color: var(--danger-color);
        }
        
        .action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            color: var(--primary-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-color);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Configura√ß√£o do banco de dados */
        .config-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .config-step {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .config-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .step-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-title i {
            color: var(--secondary-color);
        }
        
        .step-content {
            margin-left: 35px;
        }
        
        .step-content p {
            color: var(--text-color);
            margin-bottom: 10px;
        }
        
        .step-content a {
            color: var(--secondary-color);
            text-decoration: none;
        }
        
        .step-content a:hover {
            text-decoration: underline;
        }
        
        .code-block {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            overflow-x: auto;
            font-size: 14px;
        }
        
        .storage-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--gray-color);
        }
        
        .status-indicator.online {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        
        /* ============================================ */
        /* ESTILOS ESPEC√çFICOS PARA A ABA MAPEAMENTO */
        /* ============================================ */
        
        .mapping-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .mapping-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--secondary-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .mapping-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .mapping-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid var(--light-color);
            transition: all 0.3s ease;
        }
        
        .mapping-thumbnail:hover {
            border-color: var(--secondary-color);
        }
        
        .mapping-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .mapping-card p {
            color: var(--gray-color);
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .mapping-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-color);
        }
        
        .mapping-stat {
            text-align: center;
        }
        
        .mapping-stat-value {
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 18px;
        }
        
        .mapping-stat-label {
            font-size: 12px;
            color: var(--gray-color);
        }
        
        /* Responsividade */
        @media (max-width: 992px) {
            .header-top {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .logo-fw, .header-right {
                width: 100%;
                justify-content: center;
            }
            
            .header-center {
                padding: 0;
            }
            
            .project-info {
                gap: 15px;
            }
            
            .info-item {
                min-width: 80px;
            }
            
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                position: relative;
                top: 0;
                right: 0;
                justify-content: center;
                margin-top: 10px;
            }
            
            .mapping-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .tabs-header {
                justify-content: center;
            }
            
            .btn-group {
                justify-content: center;
            }
            
            .step-content {
                margin-left: 0;
            }
            
            .header-right {
                gap: 15px;
            }
            
            .logo-delservin {
                width: 100px;
            }
            
            .logo-altercon {
                width: 80px;
            }
            
            table {
                font-size: 13px;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .login-box {
                padding: 30px 20px;
            }
            
            .login-title {
                font-size: 28px;
            }
            
            .mapping-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-container {
                padding: 10px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .card {
                padding: 15px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .camera-controls {
                flex-wrap: wrap;
            }
            
            .login-box {
                padding: 25px 15px;
            }
            
            .login-title {
                font-size: 24px;
            }
            
            .mapping-card {
                padding: 15px;
            }
            
            .mapping-thumbnail {
                height: 150px;
            }
        }
        
        /* Notifica√ß√µes */
        .notification {
            position: fixed;
            top: 150px;
            right: 20px;
            padding: 10px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1100;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }
        
        .notification-success {
            background-color: var(--success-color);
        }
        
        .notification-error {
            background-color: var(--danger-color);
        }
        
        .notification-warning {
            background-color: var(--warning-color);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Loader */
        .loader {
            display: none;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Info de armazenamento */
        .storage-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .storage-info p {
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-color);
        }
        
        .storage-info .storage-type {
            display: inline-block;
            padding: 3px 8px;
            background-color: var(--light-color);
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .storage-info.hidden {
            display: none;
        }
        
        .export-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Backup Button */
        .backup-btn {
            background-color: #8e44ad;
            color: white;
        }
        
        .backup-btn:hover {
            background-color: #7d3c98;
        }
        
        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            padding-left: 40px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        /* Tool Status Colors */
        .status-available { color: var(--success-color); }
        .status-inuse { color: var(--secondary-color); }
        .status-maintenance { color: var(--warning-color); }
        .status-damaged { color: var(--danger-color); }
        
        /* QR Code Styles */
        .qrcode-container {
            text-align: center;
            padding: 20px;
        }
        
        .qrcode-container canvas {
            max-width: 200px;
            max-height: 200px;
            margin: 0 auto 20px;
        }
        
        /* Number input spinner */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
            height: 30px;
        }
        
        /* Money input */
        .money-input {
            position: relative;
        }
        
        .money-input::before {
            content: "R$";
            position: absolute;
            left: 12px;
            top: 12px;
            color: var(--gray-color);
        }
        
        .money-input input {
            padding-left: 40px;
        }
        
        /* Compact table view */
        .compact-view .action-buttons {
            flex-direction: column;
            gap: 4px;
        }
        
        /* Stock indicators */
        .stock-low {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .stock-normal {
            color: var(--success-color);
        }
        
        .stock-high {
            color: var(--warning-color);
        }
        
        /* Footer */
        .site-footer {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 40px;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .footer-version {
            margin-top: 10px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Bot√£o de sincroniza√ß√£o fixo */
        .auto-sync-btn {
            position: fixed;
            bottom: 20px;
            right: 90px;
            z-index: 999;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .auto-sync-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Corre√ß√µes espec√≠ficas */
        #cadastro .form-container,
        #cadastro .image-capture-container,
        #database .config-container {
            background-color: white !important;
        }
        
        #cadastro label,
        #cadastro .form-group label,
        #cadastro .section-title,
        #cadastro h4,
        #database .config-step .step-content p,
        #database .config-step .step-content label,
        #database .step-title {
            color: var(--text-color) !important;
            opacity: 1 !important;
            font-weight: 500 !important;
        }
        
        #cadastro input,
        #cadastro select,
        #cadastro textarea,
        #database input,
        #database select {
            background-color: white !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232c3e50' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 12px center !important;
            background-size: 16px !important;
            padding-right: 40px !important;
        }


        
        /* ============================================ */
        /* ESTILOS PARA MINIATURAS DE IMAGEM (NOVO) */
        /* ============================================ */

        /* Estilo para miniaturas */
        .tool-thumbnail {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .tool-thumbnail:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        /* Efeito de overlay na miniatura */
        .tool-thumbnail-container {
            position: relative;
            display: inline-block;
        }

        /* Modal de imagem ampliada */
        .image-modal {
            background-color: rgba(0, 0, 0, 0.95) !important;
        }

        .image-modal-content {
            max-width: 95vw;
            max-height: 95vh;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        .image-modal-body {
            padding: 0 !important;
            display: flex;
            justify-content: center;
            align-items: center;
            background: transparent;
        }

        .image-modal-body img {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        /* Bot√£o de fechar no modal de imagem */
        .image-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .image-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        /* Legenda da imagem */
        .image-caption {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 20px 10px 10px 10px;
            border-radius: 0 0 8px 8px;
        }

        .image-caption h4 {
            margin: 0 0 5px 0;
            font-size: 18px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .image-caption p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Anima√ß√µes */
        @keyframes zoomIn {
            from { 
                opacity: 0; 
                transform: scale(0.8); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .image-modal {
            animation: fadeIn 0.3s ease;
        }

        .image-modal-body img {
            animation: zoomIn 0.3s ease 0.1s both;
        }

        /* Responsividade para miniaturas */
        @media (max-width: 768px) {
            .tool-thumbnail {
                width: 35px !important;
                height: 35px !important;
            }
            
            .tool-thumbnail-container::after {
                width: 25px;
                height: 25px;
                font-size: 12px;
            }
        }

        /* Placeholder sem imagem */
        .no-image-placeholder {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .no-image-placeholder:hover {
            background-color: var(--light-color) !important;
            transform: scale(1.05);
        }

        .no-image-placeholder i {
            transition: all 0.3s ease;
        }

        .no-image-placeholder:hover i {
            color: var(--secondary-color) !important;
        }
        
        /* ============================================ */
        /* NOVOS ESTILOS - BOT√ïES */
        /* ============================================ */
        
        /* Bot√£o de envio para nuvem fixo */
        .cloud-upload-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 999;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .cloud-upload-btn:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* Bot√µes de status */
        .status-filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .status-filter-btn {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
        }
        
        .status-filter-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .status-filter-btn.active {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
            font-weight: 600;
        }
        
        .status-available-btn {
            background-color: var(--success-color);
        }
        
        .status-inuse-btn {
            background-color: var(--secondary-color);
        }
        
        .status-maintenance-btn {
            background-color: var(--warning-color);
        }
        
        .status-damaged-btn {
            background-color: var(--danger-color);
        }
        
        .status-reserved-btn {
            background-color: #8e44ad;
        }
        
        .status-discarded-btn {
            background-color: #7f8c8d;
        }
        
        .status-all-btn {
            background-color: var(--primary-color);
        }

        /* CORRE√á√ïES ESPEC√çFICAS PARA ABA COLABORADOR */
        #controle-colaborador * {
            color: var(--text-color) !important;
        }

        #controle-colaborador .card-title,
        #controle-colaborador .section-title,
        #controle-colaborador th,
        #controle-colaborador .modal-title {
            color: var(--primary-color) !important;
        }

        #controle-colaborador input,
        #controle-colaborador select,
        #controle-colaborador textarea {
            color: var(--text-color) !important;
            background-color: white !important;
            border: 1px solid var(--border-color) !important;
        }

        #controle-colaborador label {
            color: var(--text-color) !important;
            font-weight: 500 !important;
        }

        #controle-colaborador .error-message {
            color: var(--danger-color) !important;
        }

        #controle-colaborador .form-container {
            background-color: white !important;
        }

        #controle-colaborador .search-box i {
            color: var(--gray-color) !important;
        }    
        /* CORRE√á√ïES ESPEC√çFICAS PARA ABA ROMANEIO */
        #romaneio * {
            color: var(--text-color) !important;
        }

        #romaneio .card-title,
        #romaneio .section-title,
        #romaneio th,
        #romaneio .modal-title,
        #romaneio label,
        #romaneio strong {
            color: var(--primary-color) !important;
        }

        #romaneio input,
        #romaneio select,
        #romaneio textarea {
            color: var(--text-color) !important;
            background-color: white !important;
            border: 1px solid var(--border-color) !important;
        }

        #romaneio .form-container {
            background-color: white !important;
        }

        #romaneio .search-box i {
            color: var(--gray-color) !important;
        }

        #romaneio table {
            color: var(--text-color) !important;
        }

        #romaneio table th {
            color: var(--primary-color) !important;
            background-color: var(--light-color) !important;
        }

        #romaneio table td {
            color: var(--text-color) !important;
            border-bottom: 1px solid var(--border-color) !important;
        }

        /* ============================================ */
        /* MODO NOTURNO - DARK MODE */
        /* ============================================ */

        /* Bot√£o de altern√¢ncia de modo */
        .mode-toggle-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
        }

        .mode-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(30deg);
        }

        /* Classes para modo escuro */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        body.dark-mode .dashboard-header {
        background: linear-gradient(135deg, #1a1a2e, #16213e) !important;
        }

        body.dark-mode .tabs-container {
        background-color: #1e1e1e;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

        body.dark-mode .tabs-header {
        background-color: #2d2d2d;
        border-bottom: 1px solid #404040;
        }

        body.dark-mode .tab-button {
            color: #b0b0b0;
        }

        body.dark-mode .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .tab-button.active {
            background-color: #2d2d2d;
            color: var(--secondary-color);
        }

        body.dark-mode .section-title {
            color: #e0e0e0;
            border-bottom: 1px solid #404040;
        }

        body.dark-mode .card,
        body.dark-mode .chart-container,
        body.dark-mode .form-container,
        body.dark-mode .image-capture-container,
        body.dark-mode .tools-list,
        body.dark-mode .config-container,
        body.dark-mode .mapping-card {
            background-color: #2d2d2d !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        body.dark-mode .card-title {
            color: #e0e0e0 !important;
        }

        body.dark-mode table {
            background-color: #2d2d2d;
        }

        body.dark-mode th {
            background-color: #3d3d3d;
            color: #e0e0e0;
            border-bottom: 1px solid #404040;
        }

        body.dark-mode td {
            color: #d0d0d0;
            border-bottom: 1px solid #404040;
        }

        body.dark-mode tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: #3d3d3d !important;
            color: #e0e0e0 !important;
            border: 1px solid #555 !important;
        }

        body.dark-mode input::placeholder,
        body.dark-mode select::placeholder,
        body.dark-mode textarea::placeholder {
            color: #aaa;
        }

        body.dark-mode input:focus,
        body.dark-mode select:focus,
        body.dark-mode textarea:focus {
            border-color: var(--secondary-color) !important;
            background-color: #454545 !important;
        }

        body.dark-mode .search-box input {
            background-color: #3d3d3d !important;
            color: #e0e0e0 !important;
        }

        body.dark-mode .search-box i {
            color: #aaa !important;
        }

        body.dark-mode label {
            color: #e0e0e0 !important;
        }

        body.dark-mode .progress-bar {
            background-color: #404040;
        }

        body.dark-mode .modal-content {
            background-color: #2d2d2d;
        }

        body.dark-mode .modal-title {
            color: #e0e0e0;
        }

        body.dark-mode .modal-header {
            border-bottom: 1px solid #404040;
        }

        body.dark-mode .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
        }

        body.dark-mode .site-footer {
            background-color: #1a1a1a;
            color: #aaa;
        }

        body.dark-mode .status-badge.status-completed {
            background-color: rgba(39, 174, 96, 0.2);
            color: #27ae60;
        }

        body.dark-mode .status-badge.status-ontrack {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        body.dark-mode .status-badge.status-delayed {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        body.dark-mode .storage-info {
            background-color: #3d3d3d;
            border-left: 4px solid var(--secondary-color);
        }

        body.dark-mode .storage-info p {
            color: #e0e0e0;
        }

        body.dark-mode .login-container {
            background: linear-gradient(135deg, #121212 0%, #1a1a2e 100%) !important;
        }

        body.dark-mode .login-box {
            background: linear-gradient(135deg, #1a1a2e, #16213e) !important;
        }

        /* Ajustes espec√≠ficos para abas */
        body.dark-mode #controle-colaborador * {
            color: #e0e0e0 !important;
        }

        body.dark-mode #romaneio * {
            color: #e0e0e0 !important;
        }

        body.dark-mode #romaneio .card-title,
        body.dark-mode #romaneio .section-title,
        body.dark-mode #romaneio th,
        body.dark-mode #romaneio .modal-title,
        body.dark-mode #romaneio label,
        body.dark-mode #romaneio strong {
            color: #e0e0e0 !important;
        }

        body.dark-mode #cadastro * {
            color: #e0e0e0 !important;
        }

        body.dark-mode #cadastro input,
        body.dark-mode #cadastro select,
        body.dark-mode #cadastro textarea {
        color: #e0e0e0 !important;
            background-color: #3d3d3d !important;
        }

        body.dark-mode #database * {
            color: #e0e0e0 !important;
        }
        /* ============================================ */
        /* CORRE√á√ïES ESPEC√çFICAS PARA ELEMENTOS COM FUNDO PRETO - MODO NOTURNO */
        /* ============================================ */

        /* Box "Cadastrar/Editar Colaborador" */
        body.dark-mode #controle-colaborador .card[style*="background-color: white"] {
            background-color: #3d3d3d !important;
            border: 1px solid #555 !important;
        }

        /* Form container dentro do card */
        body.dark-mode #controle-colaborador .form-container[style*="background-color: white"] {
            background-color: #3d3d3d !important;
            border: 1px solid #555 !important;
        }

        /* √Årea "Atribuir Ferramentas" */
body.dark-mode #controle-colaborador .card[style*="background-color"]:nth-child(2) {
    background-color: #3d3d3d !important;
    border: 1px solid #555 !important;
}

/* Texto "Selecione um colaborador na lista acima para atribuir ferramentas" */
body.dark-mode #controle-colaborador #semColaboradorSelecionado {
    background-color: #3d3d3d !important;
    color: #aaa !important;
    border: 1px solid #555 !important;
    border-radius: 8px;
}

/* √çcone da pessoa no texto acima */
body.dark-mode #controle-colaborador #semColaboradorSelecionado i {
    color: #777 !important;
    background-color: transparent !important;
}

/* Texto dentro do container semColaboradorSelecionado */
body.dark-mode #controle-colaborador #semColaboradorSelecionado p {
    color: #aaa !important;
    background-color: transparent !important;
}

/* Container de atribui√ß√£o quando vis√≠vel */
body.dark-mode #atribuicaoContainer {
    background-color: #3d3d3d !important;
    border: 1px solid #555 !important;
    border-radius: 8px;
    padding: 20px;
}

/* √Årea com fundo cinza claro no formul√°rio (estilo inline) */
body.dark-mode #controle-colaborador div[style*="background-color: #f5f5f5;"],
body.dark-mode #controle-colaborador div[style*="background:#f5f5f5"],
body.dark-mode #controle-colaborador div[style*="background-color:#f5f5f5;"] {
    background-color: #454545 !important;
    border: 1px solid #666 !important;
    color: #e0e0e0 !important;
}

/* Textos dentro das √°reas de fundo */
body.dark-mode #controle-colaborador #colaboradorSelecionadoNome,
body.dark-mode #controle-colaborador #colaboradorSelecionadoMatricula,
body.dark-mode #controle-colaborador #colaboradorFerramentasAtuais {
    color: #e0e0e0 !important;
    background-color: transparent !important;
}

/* Inputs dentro do container de atribui√ß√£o */
body.dark-mode #atribuicaoContainer input,
body.dark-mode #atribuicaoContainer select,
body.dark-mode #atribuicaoContainer textarea {
    background-color: #454545 !important;
    border: 1px solid #666 !important;
    color: #e0e0e0 !important;
}

/* Labels dentro do container de atribui√ß√£o */
body.dark-mode #atribuicaoContainer label {
    color: #e0e0e0 !important;
    background-color: transparent !important;
}

/* Bot√µes dentro do container de atribui√ß√£o */
body.dark-mode #atribuicaoContainer .btn {
    background-color: #555 !important;
    color: #e0e0e0 !important;
    border: 1px solid #666 !important;
}

body.dark-mode #atribuicaoContainer .btn-primary {
    background-color: #3498db !important;
    color: white !important;
}

body.dark-mode #atribuicaoContainer .btn-warning {
    background-color: #f39c12 !important;
    color: white !important;
}

/* REMOVER qualquer fundo preto em divs gerais */
body.dark-mode #controle-colaborador div:not([class]):not([id]) {
    background-color: transparent !important;
}

/* Corrigir fundos espec√≠ficos por estilo inline */
body.dark-mode #controle-colaborador [style*="background-color"]:not([style*="background-color: transparent"]) {
    background-color: #3d3d3d !important;
}

/* Exce√ß√£o para inputs, selects e textareas */
body.dark-mode #controle-colaborador input[style*="background-color"],
body.dark-mode #controle-colaborador select[style*="background-color"],
body.dark-mode #controle-colaborador textarea[style*="background-color"] {
    background-color: #454545 !important;
}

/* Garantir que todos os cards tenham fundo cinza */
body.dark-mode #controle-colaborador > .cards-container > .card,
body.dark-mode #controle-colaborador > .card {
    background-color: #3d3d3d !important;
    border: 1px solid #555 !important;
}

/* Especificar os dois cards principais */
body.dark-mode #controle-colaborador > .cards-container > .card:first-child,
body.dark-mode #controle-colaborador > .cards-container > .card:nth-child(2) {
    background-color: #3d3d3d !important;
    border: 1px solid #555 !important;
}

/* Container de formul√°rio dentro do primeiro card */
body.dark-mode #controle-colaborador > .cards-container > .card:first-child .form-container {
    background-color: #3d3d3d !important;
}

/* Container dentro do segundo card */
body.dark-mode #controle-colaborador > .cards-container > .card:nth-child(2) > div {
    background-color: #3d3d3d !important;
}
        /* Ajuste do select no modo escuro */
        body.dark-mode select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
        }

        /* Ajuste para gr√°ficos */
        body.dark-mode .chart-container {
            background-color: #2d2d2d !important;
        }

        /* Bot√µes no modo escuro */
        body.dark-mode .btn {
            opacity: 0.9;
        }

        body.dark-mode .btn:hover {
            opacity: 1;
        }

        /* Corre√ß√£o para modais espec√≠ficas */
        body.dark-mode .image-modal {
            background-color: rgba(0, 0, 0, 0.98) !important;
        }

/* ============================================ */
/* CORRE√á√ïES ESPEC√çFICAS PARA MODO NOTURNO */
/* ============================================ */

body.dark-mode .form-container,
body.dark-mode .card,
body.dark-mode .image-capture-container,
body.dark-mode .tools-list,
body.dark-mode .search-box input,
body.dark-mode .config-container {
    background-color: #2d2d2d !important;
}

body.dark-mode .form-container *,
body.dark-mode .card *,
body.dark-mode .image-capture-container *,
body.dark-mode .tools-list * {
    color: #e0e0e0 !important;
}

/* Corre√ß√µes espec√≠ficas para aba de cadastro */
body.dark-mode #cadastro .form-container,
body.dark-mode #cadastro .image-capture-container,
body.dark-mode #cadastro .card {
    background-color: #3d3d3d !important;
    border: 1px solid #555 !important;
}

body.dark-mode #cadastro input,
body.dark-mode #cadastro select,
body.dark-mode #cadastro textarea {
    background-color: #454545 !important;
    border: 1px solid #666 !important;
    color: #e0e0e0 !important;
}

body.dark-mode #cadastro input::placeholder,
body.dark-mode #cadastro select::placeholder,
body.dark-mode #cadastro textarea::placeholder {
    color: #aaa !important;
}

body.dark-mode #cadastro label,
body.dark-mode #cadastro .section-title,
body.dark-mode #cadastro .card-title,
body.dark-mode #cadastro h4 {
    color: #e0e0e0 !important;
}

/* Corre√ß√µes espec√≠ficas para aba de controle por colaborador */
body.dark-mode #controle-colaborador .form-container,
body.dark-mode #controle-colaborador .card,
body.dark-mode #controle-colaborador .tools-list {
    background-color: #3d3d3d !important;
    border: 1px solid #555 !important;
}

body.dark-mode #controle-colaborador input,
body.dark-mode #controle-colaborador select,
body.dark-mode #controle-colaborador textarea {
    background-color: #454545 !important;
    border: 1px solid #666 !important;
    color: #e0e0e0 !important;
}

body.dark-mode #controle-colaborador input::placeholder,
body.dark-mode #controle-colaborador select::placeholder,
body.dark-mode #controle-colaborador textarea::placeholder {
    color: #aaa !important;
}

body.dark-mode #controle-colaborador label,
body.dark-mode #controle-colaborador .section-title,
body.dark-mode #controle-colaborador .card-title,
body.dark-mode #controle-colaborador th,
body.dark-mode #controle-colaborador strong {
    color: #e0e0e0 !important;
}

body.dark-mode #controle-colaborador .search-box input {
    background-color: #454545 !important;
    color: #e0e0e0 !important;
    border: 1px solid #666 !important;
}

body.dark-mode #controle-colaborador .search-box i {
    color: #aaa !important;
}

/* Corre√ß√µes espec√≠ficas para aba de romaneio */
body.dark-mode #romaneio .form-container,
body.dark-mode #romaneio .card {
    background-color: #3d3d3d !important;
    border: 1px solid #555 !important;
}

body.dark-mode #romaneio input,
body.dark-mode #romaneio select,
body.dark-mode #romaneio textarea {
    background-color: #454545 !important;
    border: 1px solid #666 !important;
    color: #e0e0e0 !important;
}

body.dark-mode #romaneio input::placeholder,
body.dark-mode #romaneio select::placeholder,
body.dark-mode #romaneio textarea::placeholder {
    color: #aaa !important;
}

body.dark-mode #romaneio label,
body.dark-mode #romaneio .section-title,
body.dark-mode #romaneio .card-title,
body.dark-mode #romaneio th,
body.dark-mode #romaneio strong {
    color: #e0e0e0 !important;
}

body.dark-mode #romaneio .search-box input {
    background-color: #454545 !important;
    color: #e0e0e0 !important;
    border: 1px solid #666 !important;
}

body.dark-mode #romaneio .search-box i {
    color: #aaa !important;
}

body.dark-mode #romaneio table {
    background-color: #3d3d3d !important;
}

body.dark-mode #romaneio table th {
    background-color: #4d4d4d !important;
    color: #e0e0e0 !important;
    border-bottom: 1px solid #666 !important;
}

body.dark-mode #romaneio table td {
    background-color: #3d3d3d !important;
    color: #e0e0e0 !important;
    border-bottom: 1px solid #555 !important;
}

/* Estilo para os boxes de fundo cinza mais claro */
body.dark-mode .camera-area {
    background-color: #3d3d3d !important;
    border: 1px solid #555 !important;
}

body.dark-mode .camera-placeholder {
    color: #aaa !important;
}

body.dark-mode .no-image-placeholder {
    background-color: #3d3d3d !important;
    border: 1px solid #555 !important;
}

body.dark-mode .no-image-placeholder i {
    color: #777 !important;
}

/* Ajustar bordas e sombras */
body.dark-mode .card,
body.dark-mode .form-container,
body.dark-mode .image-capture-container {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
    border: 1px solid #555 !important;
}

/* Ajustar tabelas no modo noturno */
body.dark-mode table {
    background-color: #3d3d3d !important;
}

body.dark-mode th {
    background-color: #4d4d4d !important;
}

body.dark-mode tr:hover {
    background-color: rgba(255, 255, 255, 0.05) !important;
}

/* Ajustar bot√µes */
body.dark-mode .btn {
    opacity: 0.9;
}

body.dark-mode .btn:hover {
    opacity: 1;
}

/* Ajustar placeholders e textos de ajuda */
body.dark-mode ::placeholder {
    color: #888 !important;
}

/* Ajustar cores dos √≠cones */
body.dark-mode i {
    color: #e0e0e0 !important;
}

body.dark-mode .fa-camera,
body.dark-mode .fa-search,
body.dark-mode .fa-image {
    color: #aaa !important;
}

/* Ajustar cores dos badges e status */
body.dark-mode .status-badge {
    opacity: 0.9;
}

body.dark-mode .status-badge.status-completed {
    background-color: rgba(39, 174, 96, 0.2) !important;
    color: #27ae60 !important;
}

body.dark-mode .status-badge.status-ontrack {
    background-color: rgba(52, 152, 219, 0.2) !important;
    color: #3498db !important;
}

body.dark-mode .status-badge.status-delayed {
    background-color: rgba(231, 76, 60, 0.2) !important;
    color: #e74c3c !important;
}

/* ============================================ */
/* CORRE√á√ÉO URGENTE PARA CONTROLE POR COLABORADOR NO MODO NOTURNO */
/* ============================================ */

/* FOR√áAR a cor de fundo de TODOS os elementos dentro da aba */
body.dark-mode #controle-colaborador,
body.dark-mode #controle-colaborador * {
    background-color: #2d2d2d !important;
    color: #e0e0e0 !important;
}

/* Mas os containers internos devem ser um pouco mais claros */
body.dark-mode #controle-colaborador .card,
body.dark-mode #controle-colaborador .form-container,
body.dark-mode #controle-colaborador .tools-list,
body.dark-mode #controle-colaborador .table-container {
    background-color: #3d3d3d !important;
}

/* Inputs, selects e textareas precisam de fundo mais escuro */
body.dark-mode #controle-colaborador input,
body.dark-mode #controle-colaborador select,
body.dark-mode #controle-colaborador textarea {
    background-color: #454545 !important;
    border: 1px solid #666 !important;
    color: #e0e0e0 !important;
}

/* REMOVER qualquer cor de texto branca que esteja sobrescrevendo */
body.dark-mode #controle-colaborador label,
body.dark-mode #controle-colaborador .section-title,
body.dark-mode #controle-colaborador .card-title,
body.dark-mode #controle-colaborador th,
body.dark-mode #controle-colaborador td,
body.dark-mode #controle-colaborador h3,
body.dark-mode #controle-colaborador h4,
body.dark-mode #controle-colaborador p,
body.dark-mode #controle-colaborador span,
body.dark-mode #controle-colaborador div {
    color: #e0e0e0 !important;
}

/* REMOVER especificamente qualquer cor fixa que esteja no HTML inline */
body.dark-mode #controle-colaborador [style*="color: var(--text-color)"],
body.dark-mode #controle-colaborador [style*="color: var(--primary-color)"],
body.dark-mode #controle-colaborador [style*="color: var(--gray-color)"] {
    color: #e0e0e0 !important;
}

/* Tabela espec√≠fica */
body.dark-mode #colaboradoresTable {
    background-color: #3d3d3d !important;
}

body.dark-mode #colaboradoresTable th {
    background-color: #4d4d4d !important;
    border-bottom: 1px solid #666 !important;
}

body.dark-mode #colaboradoresTable td {
    border-bottom: 1px solid #555 !important;
}

/* Linha de "nenhum colaborador" */
body.dark-mode #noColaboradoresRow td {
    color: #aaa !important;
}

/* √Åreas com fundo espec√≠fico no HTML */
body.dark-mode #controle-colaborador div[style*="background-color: #f5f5f5"],
body.dark-mode #controle-colaborador div[style*="background-color:#f5f5f5"],
body.dark-mode #controle-colaborador div[style*="background: #f5f5f5"],
body.dark-mode #controle-colaborador div[style*="background:#f5f5f5"] {
    background-color: #454545 !important;
    border: 1px solid #666 !important;
}

/* Caixa de busca */
body.dark-mode #controle-colaborador .search-box input {
    background-color: #454545 !important;
    color: #e0e0e0 !important;
    border: 1px solid #666 !important;
}

body.dark-mode #controle-colaborador .search-box i {
    color: #aaa !important;
}

/* Bot√µes - resetar para usar as cores do modo escuro */
body.dark-mode #controle-colaborador .btn {
    opacity: 0.9;
}

body.dark-mode #controle-colaborador .btn:hover {
    opacity: 1;
}

/* REMOVER qualquer estilo inline de cor nos bot√µes */
body.dark-mode #controle-colaborador .action-btn-view,
body.dark-mode #controle-colaborador .action-btn-edit,
body.dark-mode #controle-colaborador .action-btn-delete {
    color: #e0e0e0 !important;
}

/* Container de atribui√ß√£o */
body.dark-mode #atribuicaoContainer {
    background-color: #3d3d3d !important;
    border: 1px solid #555 !important;
    padding: 15px;
    border-radius: 8px;
}

body.dark-mode #semColaboradorSelecionado {
    background-color: #3d3d3d !important;
    color: #aaa !important;
}

body.dark-mode #semColaboradorSelecionado i {
    color: #777 !important;
}

/* REMOVER qualquer cor espec√≠fica em spans e divs */
body.dark-mode #controle-colaborador span[style*="color"],
body.dark-mode #controle-colaborador div[style*="color"],
body.dark-mode #controle-colaborador p[style*="color"],
body.dark-mode #controle-colaborador strong[style*="color"] {
    color: #e0e0e0 !important;
}

/* Status badges */
body.dark-mode #controle-colaborador .status-badge {
    background-color: rgba(255, 255, 255, 0.1) !important;
    color: #e0e0e0 !important;
}

/* Modal espec√≠fico */
body.dark-mode #ferramentasColaboradorModal .modal-content {
    background-color: #3d3d3d !important;
}

body.dark-mode #ferramentasColaboradorModal .modal-body {
    background-color: #3d3d3d !important;
    color: #e0e0e0 !important;
}

/* REMOVER cores fixas de texto nos modais */
body.dark-mode #ferramentasColaboradorModal [style*="color: var("] {
    color: #e0e0e0 !important;
}

/* √Årea de ferramentas dispon√≠veis */
body.dark-mode #ferramentaParaAtribuir {
    background-color: #454545 !important;
    color: #e0e0e0 !important;
    border: 1px solid #666 !important;
}

/* REMOVER qualquer cor de texto em op√ß√µes do select */
body.dark-mode #ferramentaParaAtribuir option {
    background-color: #454545 !important;
    color: #e0e0e0 !important;
}

/* REMOVER cores espec√≠ficas em todos os elementos filhos */
body.dark-mode #controle-colaborador *:not(input):not(select):not(textarea):not(button) {
    color: #e0e0e0 !important;
}

/* Inputs, selects e textareas mant√™m suas cores */
body.dark-mode #controle-colaborador input,
body.dark-mode #controle-colaborador select,
body.dark-mode #controle-colaborador textarea,
body.dark-mode #controle-colaborador button {
    color: #e0e0e0 !important;
}

/* ============================================ */
/* ESTILOS PARA BOT√ïES DE SINCRONIZA√á√ÉO DE COLABORADORES */
/* ============================================ */

#colaboradoresSyncButtons .btn {
    min-width: 180px;
    justify-content: center;
}

#colaboradoresSyncStatus {
    transition: all 0.3s ease;
    animation: fadeIn 0.3s ease;
}

#colaboradoresSyncStatus i {
    font-size: 18px;
}

/* Anima√ß√µes para os bot√µes */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

#colaboradoresSyncButtons .btn:hover {
    animation: pulse 0.5s ease;
}

/* Estilo para modo noturno */
body.dark-mode #colaboradoresSyncButtons h4 {
    color: #e0e0e0 !important;
}

body.dark-mode #colaboradoresSyncButtons .btn {
    opacity: 0.9;
}

body.dark-mode #colaboradoresSyncButtons .btn:hover {
    opacity: 1;
}

/* Responsividade */
@media (max-width: 768px) {
    #colaboradoresSyncButtons .btn {
        min-width: 100%;
        margin-bottom: 10px;
    }
    
    #colaboradoresSyncButtons .btn-group {
        flex-direction: column;
    }
}
        </style>
    </head>
<body>
    
    <!-- Login Screen (Inicial) -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo-fw">
                    <img src="FW Logo.png" alt="FW Logo">
                </div>
                <h1 class="login-title">Sistema de Controle de Ferramentas</h1>
                <p class="login-subtitle">Fa√ßa login para acessar o sistema</p>
            </div>
            
            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-circle"></i> Credenciais inv√°lidas. Tente novamente.
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="loginEmail">Email ou Usu√°rio</label>
                    <input type="text" id="loginEmail" placeholder="Digite seu email ou usu√°rio">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha">
                </div>
                
                <button type="button" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                </button>
                
                <div style="margin-top: 20px; text-align: center;">
                    <p style="font-size: 14px; opacity: 0.9;">Credenciais de exemplo:</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">DEV (Acesso Total)</span>
                            <span style="font-size: 0px;">fabio@fwcompany.com.br / FabioFW123@</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">Almoxarife</span>
                            <span style="font-size: 10px;">emerson.silva@fwcompany.com.br  EmersonFW1@</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">Consultas</span>
                            <span style="font-size: 10px;">fwuser / User123</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">Outros</span>
                            <span style="font-size: 10px;">raquel@fwcompany.com.br  RaqueL1234</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="login-footer">
                <div class="login-logo-delservin">
                    <img src="Delservin Logo.png" alt="Delservin Logo">
                </div>
                <div class="login-logo-altercon">
                    <img src="Altercon Logo.png" alt="Altercon Logo">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Screen (Ap√≥s Login) -->
    <div id="dashboardScreen" class="dashboard-container" style="display: none;">
        <header class="dashboard-header">
            <div class="user-info">
                <div class="user-welcome">
                    <i class="fas fa-user"></i>
                    <span id="userWelcomeText">Bem-vindo!</span>
                    <span class="user-badge" id="userRoleBadge">DEV</span>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
            
            <div class="header-top">
                <div class="logo-fw">
                    <img src="FW Logo.png" alt="FW Logo">
                </div>
                
                <div class="header-center">
                    <h1 class="project-title">Sistema de Controle de Ferramentas</h1>                    
                </div>
                
                <div class="header-right">
                    <div class="logo-right logo-delservin">
                        <img src="Delservin Logo.png" alt="Delservin Logo">
                    </div>
                    <div class="logo-right logo-altercon">
                        <img src="Altercon Logo.png" alt="Altercon Logo">
                    </div>
                </div>
            </div>
            
            <div class="project-info">
                <div class="info-item">
                    <div class="info-label">Total de Itens</div>
                    <div class="info-value" id="totalTools">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Valor Total</div>
                    <div class="info-value" id="totalValue">R$ 0,00</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value">
                        <span class="status-badge status-ontrack" id="storageStatus">Local</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Cloud</div>
                    <div class="info-value">
                        <span class="status-badge status-delayed" id="indexedDBStatus">Desconectado</span>
                    </div>
                </div>
                <button class="mode-toggle-btn" id="modeToggleBtn" title="Alternar modo claro/escuro">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="info-item">
                    <div class="info-label">√öltima Atualiza√ß√£o</div>
                    <div class="info-value" id="lastUpdate">Hoje</div>
                </div>
            </div>
        </header>
                
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="tab-button" data-tab="cadastro" id="cadastroTab">
                    <i class="fas fa-tools"></i> Cadastrar Item
                </button>
                <button class="tab-button" data-tab="catalogo">
                    <i class="fas fa-list"></i> Cat√°logo de Itens
                </button>
                <button class="tab-button" data-tab="controle-colaborador">
                    <i class="fas fa-users"></i> Controle por Colaborador
                </button>
                <button class="tab-button" data-tab="mapeamento">
                    <i class="fas fa-map"></i> Mapeamento
                </button>
                <button class="tab-button" data-tab="exportar">
                    <i class="fas fa-file-excel"></i> Exportar
                </button>
                <button class="tab-button" data-tab="romaneio">
                    <i class="fas fa-truck-loading"></i> Romaneio
                </button>
                <button class="tab-button" data-tab="database" id="databaseTab">
                    <i class="fas fa-database"></i> Banco de Dados
                </button>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Estat√≠sticas do Sistema</h2>
                
                <div class="cards-container">
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-boxes"></i> Status dos Itens</h3>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Dispon√≠veis</span>
                                <span id="availablePercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill actual" id="availableBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Em Uso</span>
                                <span id="inUsePercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill planned" id="inUseBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Manuten√ß√£o</span>
                                <span id="maintenancePercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="maintenanceBar" style="width: 0%; background-color: var(--warning-color)"></div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Danificados</span>
                                <span id="damagedPercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="damagedBar" style="width: 0%; background-color: var(--danger-color)"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-money-bill-wave"></i> Valor por Categoria</h3>
                        <div id="valueStats">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Carregando dados...</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Itens com Estoque Baixo</h3>
                        <div id="lowStockItems">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Carregando dados...</p>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Distribui√ß√£o por Localiza√ß√£o</h3>
                    <canvas id="locationChart"></canvas>
                </div>
                
                <div class="card" id="backupCard">
                    <h3 class="card-title"><i class="fas fa-download"></i> Backup R√°pido</h3>
                    <p style="margin-bottom: 15px;">Fa√ßa um backup completo dos seus dados localmente.</p>
                    <div class="btn-group">
                        <button type="button" class="btn backup-btn" id="backupBtn">
                            <i class="fas fa-download"></i> Fazer Backup
                        </button>
                        <button type="button" class="btn btn-warning" id="restoreBtn">
                            <i class="fas fa-upload"></i> Restaurar Backup
                        </button>
                    </div>
                    <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
                </div>
            </div>
            
            <!-- Cadastro Tab -->
            <div id="cadastro" class="tab-content">
                <h2 class="section-title"><i class="fas fa-plus-circle"></i> Cadastrar Novo Item</h2>
                
                <div class="form-container">
                    <form id="toolForm">
                        <!-- Campo oculto para usu√°rio ser√° adicionado via JavaScript -->
                        
                        <h4 style="color: var(--primary-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--light-color);">
                            <i class="fas fa-info-circle"></i> Informa√ß√µes B√°sicas
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="toolName" class="required">Nome do Produto</label>
                                <input type="text" id="toolName" required maxlength="200" placeholder="Ex: Martelo de Borracha">
                                <div class="error-message" id="toolNameError">O nome do produto √© obrigat√≥rio</div>
                            </div>
                            <div class="form-group">
                                <label for="toolCode" class="required">C√≥digo</label>
                                <input type="text" id="toolCode" required maxlength="50" placeholder="Ex: MART-001">
                                <div class="error-message" id="toolCodeError">O c√≥digo √© obrigat√≥rio</div>
                            </div>
                            <div class="form-group">
                                <label for="patrimonioNumber">N√∫mero do Patrim√¥nio</label>
                                <input type="text" id="patrimonioNumber" maxlength="50" placeholder="Ex: PAT-2023-001">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ncmCode">N.C.M. (Nomenclatura Comum do Mercosul)</label>
                                <input type="text" id="ncmCode" maxlength="20" placeholder="Ex: 8205.70.00 (opcional)">
                            </div>
                            <div class="form-group">
                                <label for="toolCategory" class="required">Categoria</label>
                                <select id="toolCategory" required>
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Ferramentas El√©tricas">Ferramentas El√©tricas</option>
                                    <option value="Ferramentas Manuais">Ferramentas Manuais</option>
                                    <option value="Equipamentos de Seguran√ßa">Equipamentos de Seguran√ßa</option>
                                    <option value="Ferramentas √† Bateria">Ferramentas √† Bateria</option>
                                    <option value="Material de Consumo">Material de Consumo</option>
                                    <option value="EPI">EPI (Equipamento de Prote√ß√£o Individual)</option>
                                    <option value="Inform√°tica">Inform√°tica</option>
                                    <option value="Ve√≠culos">Ve√≠culos</option>
                                    <option value="Outros">Outros</option>
                                </select>
                                <div class="error-message" id="toolCategoryError">Selecione uma categoria</div>
                            </div>
                            <div class="form-group">
                                <label for="toolStatus" class="required">Status</label>
                                <select id="toolStatus" required>
                                    <option value="Dispon√≠vel">Dispon√≠vel</option>
                                    <option value="Em Uso">Em Uso</option>
                                    <option value="Manuten√ß√£o">Em Manuten√ß√£o</option>
                                    <option value="Danificado">Danificado</option>
                                    <option value="Reservado">Reservado</option>
                                    <option value="Descartado">Descartado</option>
                                </select>
                                <div class="error-message" id="toolStatusError">Selecione um status</div>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-color); margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid var(--light-color);">
                            <i class="fas fa-map-marker-alt"></i> Localiza√ß√£o e Condi√ß√£o
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="toolLocation" class="required">Localiza√ß√£o</label>
                                <select id="toolLocation" required>
                                    <option value="">Selecione uma localiza√ß√£o</option>
                                    <option value="Almoxarifado Central">Almoxarifado Central</option>
                                    <option value="Container Mec√¢nica">Container Mec√¢nica</option>
                                    <option value="Container El√©trica">Container El√©trica</option>
                                    <option value="Oficina">Oficina</option>
                                    <option value="Galp√£o Altercon">Galp√£o Altercon</option>
                                    <option value="Campo">Campo</option>
                                    <option value="Caminh√£o">Caminh√£o</option>
                                    <option value="Kombi de Servi√ßo">Kombi de Servi√ßo</option>
                                    <option value="Escrit√≥rio">Escrit√≥rio</option>                                    
                                    <option value="Dep√≥sito">Dep√≥sito</option>
                                </select>
                                <div class="error-message" id="toolLocationError">Selecione uma localiza√ß√£o</div>
                            </div>
                            <div class="form-group">
                                <label for="toolCondition" class="required">Condi√ß√£o</label>
                                <select id="toolCondition" required>
                                    <option value="Novo">Novo</option>
                                    <option value="Bom">Bom</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Precisa de Reparo">Precisa de Reparo</option>
                                    <option value="Inutiliz√°vel">Inutiliz√°vel</option>
                                </select>
                                <div class="error-message" id="toolConditionError">Selecione uma condi√ß√£o</div>
                            </div>
                            <div class="form-group">
                                <label for="notaFiscal">N¬∫ da Nota Fiscal</label>
                                <input type="text" id="notaFiscal" maxlength="50" placeholder="Ex: NF-2023-001234">
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-color); margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid var(--light-color);">
                            <i class="fas fa-calculator"></i> Dados Financeiros e Estoque
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="unidadeMedida">Unidade de Medida</label>
                                <select id="unidadeMedida">
                                    <option value="UN">UN (Unidade)</option>
                                    <option value="PC">PC (Pe√ßa)</option>
                                    <option value="CX">CX (Caixa)</option>
                                    <option value="KG">KG (Quilograma)</option>
                                    <option value="M">M (Metro)</option>
                                    <option value="L">L (Litro)</option>
                                    <option value="PAR">PAR (Par)</option>
                                    <option value="JGO">JGO (Jogo)</option>
                                    <option value="HR">HR (Hora)</option>
                                </select>
                            </div>
                            <div class="form-group money-input">
                                <label for="preco">Pre√ßo Unit√°rio (R$)</label>
                                <input type="number" id="preco" min="0" step="0.01" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label for="quantidadeAtual">Quantidade Atual</label>
                                <input type="number" id="quantidadeAtual" min="0" value="1">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="estoqueMinimo">Estoque M√≠nimo</label>
                                <input type="number" id="estoqueMinimo" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="estoqueMaximo">Estoque M√°ximo</label>
                                <input type="number" id="estoqueMaximo" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="dataCadastro">Data do Cadastro</label>
                                <input type="date" id="dataCadastro" value="">
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-color); margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid var(--light-color);">
                            <i class="fas fa-align-left"></i> Descri√ß√µes e Observa√ß√µes
                        </h4>
                        
                        <div class="form-group">
                            <label for="toolDescription">Descri√ß√£o Detalhada</label>
                            <textarea id="toolDescription" rows="3" maxlength="1000" placeholder="Descreva detalhadamente o produto..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="toolObservations">GPS</label>
                            <textarea id="toolObservations" rows="2" maxlength="500" placeholder="Localiza√ß√£o exata do item"></textarea>
                        </div>
                    </form>
                </div>
                
                <div class="image-capture-container" id="imageCaptureContainer">
                    <h3 class="section-title"><i class="fas fa-camera"></i> Fotografar Item</h3>
                    
                    <div class="camera-area" id="cameraArea">
                        <div class="camera-placeholder" id="cameraPlaceholder">
                            <i class="fas fa-camera"></i>
                            <p>Nenhuma imagem selecionada</p>
                        </div>
                        <img id="toolImagePreview" style="display: none;">
                    </div>
                    
                    <div class="camera-controls">
                        <button type="button" class="btn btn-primary" id="captureImageBtn">
                            <i class="fas fa-camera"></i> Tirar Foto
                        </button>
                        <button type="button" class="btn btn-warning" id="uploadImageBtn">
                            <i class="fas fa-upload"></i> Carregar Imagem
                        </button>
                        <button type="button" class="btn btn-danger" id="clearImageBtn">
                            <i class="fas fa-trash"></i> Remover Imagem
                        </button>
                    </div>
                    <p style="text-align: center; margin-top: 10px; color: var(--gray-color); font-size: 12px;">
                        Tamanho m√°ximo: 5MB | Formatos: JPG, PNG, GIF
                    </p>
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-success" id="saveToolBtn">
                        <i class="fas fa-save"></i> Salvar Item
                    </button>
                    <button type="button" class="btn btn-primary" id="saveAndNewBtn">
                        <i class="fas fa-plus-circle"></i> Salvar e Novo
                    </button>
                    <button type="button" class="btn btn-warning" id="clearFormBtn">
                        <i class="fas fa-eraser"></i> Limpar Formul√°rio
                    </button>
                    <button type="button" class="btn backup-btn" id="generateQRCodeBtn">
                        <i class="fas fa-qrcode"></i> Gerar QR Code
                    </button>
                </div>
            </div>
            
            <!-- Cat√°logo Tab -->
            <div id="catalogo" class="tab-content">
                <h2 class="section-title"><i class="fas fa-list"></i> Cat√°logo de Itens</h2>
                
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchTool" placeholder="Buscar por nome, c√≥digo, patrim√¥nio ou categoria...">
                </div>
                
                <!-- Bot√µes de status -->
                <div class="status-filter-buttons">
                    <button type="button" class="status-filter-btn status-all-btn active" data-status="all">
                        <i class="fas fa-th-list"></i> Todos
                    </button>
                    <button type="button" class="status-filter-btn status-available-btn" data-status="Dispon√≠vel">
                        <i class="fas fa-check-circle"></i> Dispon√≠vel
                    </button>
                    <button type="button" class="status-filter-btn status-inuse-btn" data-status="Em Uso">
                        <i class="fas fa-user-check"></i> Em Uso
                    </button>
                    <button type="button" class="status-filter-btn status-maintenance-btn" data-status="Manuten√ß√£o">
                        <i class="fas fa-tools"></i> Manuten√ß√£o
                    </button>
                    <button type="button" class="status-filter-btn status-damaged-btn" data-status="Danificado">
                        <i class="fas fa-times-circle"></i> Danificado
                    </button>
                    <button type="button" class="status-filter-btn status-reserved-btn" data-status="Reservado">
                        <i class="fas fa-clock"></i> Reservado
                    </button>
                    <button type="button" class="status-filter-btn status-discarded-btn" data-status="Descartado">
                        <i class="fas fa-trash-alt"></i> Descartado
                    </button>
                    <button type="button" class="btn btn-warning" id="filterLowStockBtn">
                        <i class="fas fa-exclamation-triangle"></i> Estoque Baixo
                    </button>
                </div>
                
                <div class="tools-list">
                    <div class="table-container">
                        <table id="toolsTable">
                            <thead>
                                <tr>
                                    <th>Imagem</th>
                                    <th>C√≥digo</th>
                                    <th>Nome do Produto</th>
                                    <th>Patrim√¥nio</th>
                                    <th>Categoria</th>
                                    <th>Status</th>
                                    <th>Localiza√ß√£o</th>
                                    <th>Condi√ß√£o</th>
                                    <th>Unidade</th>
                                    <th>Estoque</th>
                                    <th>Pre√ßo (R$)</th>
                                    <th>Data Cad.</th>
                                    <th>Usu√°rio Cad.</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="toolsTableBody">
                                <tr id="noToolsRow">
                                    <td colspan="14" style="text-align: center; padding: 40px; color: var(--gray-color);">
                                        Nenhum item cadastrado. Clique em "Cadastrar Item" para adicionar.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="storage-info" id="storageInfo">
                    <p><strong>Informa√ß√µes de Armazenamento:</strong></p>
                    <p id="storageInfoText">Carregando informa√ß√µes...</p>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button type="button" class="btn btn-sm btn-warning" id="clearCacheBtn">
                            <i class="fas fa-trash-alt"></i> Limpar Cache Local
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" id="optimizeStorageBtn">
                            <i class="fas fa-compress-alt"></i> Otimizar Armazenamento
                        </button>
                        <button type="button" class="btn btn-sm backup-btn" id="quickBackupBtn">
                            <i class="fas fa-download"></i> Backup R√°pido
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Controle por Colaborador Tab -->
            <div id="controle-colaborador" class="tab-content">
            <h2 class="section-title" style="color: var(--primary-color) !important;">
                <i class="fas fa-users"></i> Controle por Colaborador
            </h2>
    
            <!-- Lista de colaboradores em cima -->
        <div class="card">
                <h3 class="card-title" style="color: var(--primary-color) !important;">
                    <i class="fas fa-list"></i> Lista de Colaboradores
                </h3>
        
                <div class="search-box">
            <i class="fas fa-search" style="color: var(--gray-color) !important;"></i>
            <input type="text" id="searchColaborador" placeholder="Buscar colaborador por nome, c√≥digo ou setor..." style="color: var(--text-color) !important; background-color: white !important;">
        </div>
        
        <div class="tools-list">
            <div class="table-container">
                <table id="colaboradoresTable">
                    <thead>
                        <tr>
                            <th style="color: var(--primary-color) !important;">Nome</th>
                            <th style="color: var(--primary-color) !important;">C√≥digo</th>
                            <th style="color: var(--primary-color) !important;">Setor</th>
                            <th style="color: var(--primary-color) !important;">Cargo</th>
                            <th style="color: var(--primary-color) !important;">Telefone</th>
                            <th style="color: var(--primary-color) !important;">Email</th>
                            <th style="color: var(--primary-color) !important;">Ferramentas</th>
                            <th style="color: var(--primary-color) !important;">Status</th>
                            <th style="color: var(--primary-color) !important;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="colaboradoresTableBody">
                        <tr id="noColaboradoresRow">
                            <td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-color) !important;">
                                Nenhum colaborador cadastrado. Cadastre um colaborador para come√ßar.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Cards abaixo da lista -->
    <div class="cards-container">
        <!-- Formul√°rio para cadastrar/atualizar colaborador -->
        <div class="card">
            <h3 class="card-title" style="color: var(--primary-color) !important;">
                <i class="fas fa-user-plus"></i> Cadastrar/Editar Colaborador
            </h3>
            
            <div class="form-container" style="background-color: white !important;">
                <form id="colaboradorForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="colaboradorNome" class="required" style="color: var(--text-color) !important;">
                                Nome do Colaborador
                            </label>
                            <input type="text" id="colaboradorNome" required maxlength="100" 
                                   placeholder="Ex: Jo√£o da Silva" 
                                   style="color: var(--text-color) !important; background-color: white !important;">
                            <div class="error-message" id="colaboradorNomeError" style="color: var(--danger-color) !important;">
                                O nome √© obrigat√≥rio
                            </div>
                        </div>
                        <!-- No formul√°rio de cadastro de colaborador, substitua a se√ß√£o da matr√≠cula por: -->
<div class="form-group">
    <label for="colaboradorMatricula" class="required" style="color: var(--text-color) !important;">
        Matr√≠cula
    </label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="colaboradorMatricula" required maxlength="6" 
               placeholder="Ex: A-0001" 
               style="color: var(--text-color) !important; background-color: white !important; flex: 1;"
               readonly>
        <button type="button" class="btn btn-primary" id="gerarMatriculaBtn" 
                style="white-space: nowrap;">
            <i class="fas fa-sync-alt"></i> Gerar C√≥digo
        </button>
    </div>
    <div class="error-message" id="colaboradorMatriculaError" style="color: var(--danger-color) !important;">
        A matr√≠cula √© obrigat√≥ria
    </div>
    <p style="font-size: 12px; color: var(--gray-color); margin-top: 5px;">
        Formato: Letra seguida de 4 d√≠gitos (ex: A-0001, B-1234)
    </p>
</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="colaboradorSetor" style="color: var(--text-color) !important;">
                                Setor/Departamento
                            </label>
                            <select id="colaboradorSetor" style="color: var(--text-color) !important; background-color: white !important;">
                                <option value="">Selecione um setor</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                                <option value="El√©trica">El√©trica</option>
                                <option value="Mec√¢nica">Mec√¢nica</option>
                                <option value="Almoxarifado">Almoxarifado</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Produ√ß√£o">Produ√ß√£o</option>
                                <option value="Qualidade">Qualidade</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="colaboradorCargo" style="color: var(--text-color) !important;">
                                Cargo/Fun√ß√£o
                            </label>
                            <input type="text" id="colaboradorCargo" maxlength="100" 
                                   placeholder="Ex: T√©cnico de Manuten√ß√£o" 
                                   style="color: var(--text-color) !important; background-color: white !important;">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="colaboradorTelefone" style="color: var(--text-color) !important;">
                                Telefone
                            </label>
                            <input type="text" id="colaboradorTelefone" maxlength="20" 
                                   placeholder="Ex: (11) 99999-9999" 
                                   style="color: var(--text-color) !important; background-color: white !important;">
                        </div>
                        <div class="form-group">
                            <label for="colaboradorEmail" style="color: var(--text-color) !important;">
                                Email
                            </label>
                            <input type="email" id="colaboradorEmail" maxlength="100" 
                                   placeholder="Ex: joao@empresa.com" 
                                   style="color: var(--text-color) !important; background-color: white !important;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="colaboradorObservacoes" style="color: var(--text-color) !important;">
                            Observa√ß√µes
                        </label>
                        <textarea id="colaboradorObservacoes" rows="2" maxlength="500" 
                                  placeholder="Observa√ß√µes sobre o colaborador..." 
                                  style="color: var(--text-color) !important; background-color: white !important;"></textarea>
                    </div>
                    
                    <input type="hidden" id="colaboradorId">
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-success" id="salvarColaboradorBtn">
                            <i class="fas fa-save"></i> Salvar Colaborador
                        </button>
                        <button type="button" class="btn btn-warning" id="limparColaboradorBtn">
                            <i class="fas fa-eraser"></i> Limpar Formul√°rio
                        </button>
                        <button type="button" class="btn btn-danger" id="excluirColaboradorBtn" style="display: none;">
                            <i class="fas fa-trash"></i> Excluir Colaborador
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- √Årea para atribui√ß√£o de ferramentas -->
        <div class="card">
            <h3 class="card-title" style="color: var(--primary-color) !important;">
                <i class="fas fa-tools"></i> Atribuir Ferramentas
            </h3>
            
            <div id="atribuicaoContainer" style="display: none;">
                <div class="form-group">
                    <label style="color: var(--text-color) !important;">Colaborador Selecionado:</label>
                    <div style="background-color: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <strong id="colaboradorSelecionadoNome" style="color: var(--primary-color) !important;">
                            Nenhum
                        </strong> - 
                        <span id="colaboradorSelecionadoMatricula" style="color: var(--text-color) !important;">
                            Nenhum
                        </span> |
                        <span id="colaboradorFerramentasAtuais" style="color: var(--text-color) !important;">
                            0 ferramentas atribu√≠das
                        </span>
                    </div>
                </div>
<!-- BOT√ïES DE SINCRONIZA√á√ÉO COM NUVEM -->
<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
    <h4 style="color: var(--primary-color) !important; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-cloud"></i> Sincronizar com a Nuvem
    </h4>
    
    <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid var(--warning-color);">
        <p style="margin: 0; color: var(--text-color) !important; font-size: 13px;">
            <i class="fas fa-info-circle"></i> 
            <strong>Atribui√ß√µes Locais:</strong> <span id="localAtribuicoesCount">0</span> | 
            <strong>Status:</strong> <span id="atribuicoesCloudStatus">Desconectado</span>
        </p>
    </div>
    
    <div class="btn-group" style="justify-content: center; flex-wrap: wrap; gap: 8px;">
        <button type="button" class="btn btn-sm btn-success" id="enviarAtribuicoesBtn">
            <i class="fas fa-cloud-upload-alt"></i> Enviar para Nuvem
        </button>
        
        <button type="button" class="btn btn-sm btn-primary" id="buscarAtribuicoesBtn">
            <i class="fas fa-cloud-download-alt"></i> Buscar da Nuvem
        </button>
        
        <button type="button" class="btn btn-sm btn-warning" id="sincronizarTudoAtribBtn">
            <i class="fas fa-sync-alt"></i> Sincronizar Tudo
        </button>
    </div>
    
    <div id="atribuicoesSyncStatus" style="margin-top: 10px; padding: 8px; border-radius: 6px; display: none; font-size: 12px;">
        <!-- Status ser√° mostrado aqui -->
    </div>
</div>                
                <div class="form-group">
                    <label for="ferramentaParaAtribuir" style="color: var(--text-color) !important;">
                        Selecionar Ferramenta para Atribuir:
                    </label>
                    <select id="ferramentaParaAtribuir" class="form-control" 
                            style="color: var(--text-color) !important; background-color: white !important;">
                        <option value="">Selecione uma ferramenta</option>
                        <!-- Op√ß√µes ser√£o preenchidas via JavaScript -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="dataAtribuicao" style="color: var(--text-color) !important;">
                        Data de Atribui√ß√£o
                    </label>
                    <input type="date" id="dataAtribuicao" class="form-control" value="" 
                           style="color: var(--text-color) !important; background-color: white !important;">
                </div>
                
                <div class="form-group">
                    <label for="observacaoAtribuicao" style="color: var(--text-color) !important;">
                        Observa√ß√£o da Atribui√ß√£o
                    </label>
                    <textarea id="observacaoAtribuicao" rows="2" maxlength="500" 
                              placeholder="Observa√ß√£o sobre esta atribui√ß√£o..." class="form-control"
                              style="color: var(--text-color) !important; background-color: white !important;"></textarea>
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" id="atribuirFerramentaBtn">
                        <i class="fas fa-link"></i> Atribuir Ferramenta
                    </button>
                    <button type="button" class="btn btn-warning" id="limparAtribuicaoBtn">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
            
            <div id="semColaboradorSelecionado" style="text-align: center; padding: 20px;">
                <i class="fas fa-user" style="font-size: 40px; color: var(--gray-color); margin-bottom: 10px;"></i>
                <p style="color: var(--text-color) !important;">
                    Selecione um colaborador na lista acima para atribuir ferramentas
                </p>
            </div>
        </div>
    </div>
    
    <!-- Modal para visualizar ferramentas do colaborador -->
    <div id="ferramentasColaboradorModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: var(--primary-color) !important;">
                    Ferramentas do Colaborador
                </h3>
                <button class="modal-close" id="closeFerramentasModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="ferramentasColaboradorBody">
                <!-- Conte√∫do ser√° preenchido via JavaScript -->
            </div>
        </div>
    </div>
</div>
            
            <!-- Mapeamento Tab (NOVO) -->
            <div id="mapeamento" class="tab-content">
                <h2 class="section-title"><i class="fas fa-map"></i> Mapeamento de Containers e Locais</h2>
                
                <div class="mapping-container">
                    <!-- Container de Ferramentas El√©tricas (Mapa) -->
<div class="mapping-card" data-id="container_eletrico">
    <img src="mapa_container_eletrico_mini.png" 
         alt="Container de Ferramentas El√©tricas" 
         class="mapping-thumbnail" 
         onclick="viewMapDetails('container_eletrico')"
         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiByeD0iOCIgZmlsbD0iI0UzRThGRCIvPgo8dGV4dCB4PSI1MCUiIHk9IjQ1JSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjMzQ5OERCIj5NYXBhPC90ZXh0Pgo8dGV4dCB4PSI1MCUiIHk9IjYwJSIgdGV4dC1hbmNob3I9Im1pZGdsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjMkMzRTUwIj5Db250YWluZXIgRWzDqXRyaWNhczwvdGV4dD4KPC9zdmc+'">
    
    <h3>Container de Ferramentas El√©tricas</h3>
    <p>Mapa de organiza√ß√£o interna com todas as posi√ß√µes identificadas.</p>
    <div class="mapping-stats">
        <div class="mapping-stat">
            <div class="mapping-stat-value">4</div>
            <div class="mapping-stat-label">Prateleiras L</div>
        </div>
        <div class="mapping-stat">
            <div class="mapping-stat-value">10</div>
            <div class="mapping-stat-label">Prateleiras R</div>
        </div>
        <div class="mapping-stat">
            <div class="mapping-stat-value">70</div>
            <div class="mapping-stat-label">Posi√ß√µes</div>
        </div>
    </div>
    <button class="btn btn-primary" style="margin-top: 15px; width: 100%;" onclick="viewMapDetails('container_eletrico')">
        <i class="fas fa-search-plus"></i> Visualizar Mapa Completo
    </button>
</div>
                    
                    <!-- Outros containers podem ser adicionados aqui -->
                    <div class="mapping-card" data-id="container_mecanica">
                        <div class="no-image-placeholder" style="width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; background-color: #f5f5f5; border-radius: 8px; margin-bottom: 15px; cursor: pointer;" onclick="viewMapDetails('container_mecanica')">
                            <i class="fas fa-tools" style="color: #ccc; font-size: 60px;"></i>
                        </div>
                        <h3>Container de Mec√¢nica</h3>
                        <p>Mapa de ferramentas manuais e equipamentos mec√¢nicos.</p>
                        <div class="mapping-stats">
                            <div class="mapping-stat">
                                <div class="mapping-stat-value">--</div>
                                <div class="mapping-stat-label">Prateleiras</div>
                            </div>
                            <div class="mapping-stat">
                                <div class="mapping-stat-value">--</div>
                                <div class="mapping-stat-label">Posi√ß√µes</div>
                            </div>
                            <div class="mapping-stat">
                                <div class="mapping-stat-value">--</div>
                                <div class="mapping-stat-label">Itens</div>
                            </div>
                        </div>
                        <button class="btn btn-warning" style="margin-top: 15px; width: 100%;" onclick="viewMapDetails('container_mecanica')">
                            <i class="fas fa-plus-circle"></i> Adicionar Mapa
                        </button>
                    </div>
                    
                    <div class="mapping-card" data-id="almoxarifado_central">
    <img src="mapa_almoxarifado_central_mini.png" 
         alt="Almoxarifado Central" 
         class="mapping-thumbnail" 
         onclick="viewMapDetails('almoxarifado_central')"
         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiByeD0iOCIgZmlsbD0iI0UzRThGRCIvPgo8dGV4dCB4PSI1MCUiIHk9IjQ1JSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjMzQ5OERCIj5NYXBhPC90ZXh0Pgo8dGV4dCB4PSI1MCUiIHk9IjYwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjMkMzRTUwIj5BbW94YXJpZmFkbyBDZW50cmFsPC90ZXh0Pgo8L3N2Zz4+">
    <h3>Almoxarifado Central</h3>
    <p>Mapa de organiza√ß√£o do almoxarifado principal (10.4m/34ft).</p>
    <div class="mapping-stats">
        <div class="mapping-stat">
            <div class="mapping-stat-value">5</div>
            <div class="mapping-stat-label">Se√ß√µes (A-E)</div>
        </div>
        <div class="mapping-stat">
            <div class="mapping-stat-value">15</div>
            <div class="mapping-stat-label">Ruas (A-H)</div>
        </div>
        <div class="mapping-stat">
            <div class="mapping-stat-value">70+</div>
            <div class="mapping-stat-label">Posi√ß√µes</div>
        </div>
    </div>
    <button class="btn btn-primary" style="margin-top: 15px; width: 100%;" onclick="viewMapDetails('almoxarifado_central')">
        <i class="fas fa-search-plus"></i> Visualizar Mapa Completo
    </button>
</div>
                </div>
                
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-info-circle"></i> Sobre o Mapeamento</h3>
                    <p>O sistema de mapeamento permite visualizar a organiza√ß√£o f√≠sica dos itens em containers e almoxarifados. Cada mapa mostra a disposi√ß√£o das prateleiras e as posi√ß√µes espec√≠ficas onde os itens devem ser armazenados.</p>
                    <div class="btn-group" style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="addNewMap()">
                            <i class="fas fa-plus"></i> Adicionar Novo Mapa
                        </button>
                        
                        <button class="btn btn-danger" onclick="downloadMapPDF()">
                            <i class="fas fa-file-pdf"></i> Exportar/Baixar PDF
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Exportar Tab -->
            <div id="exportar" class="tab-content">
                <h2 class="section-title"><i class="fas fa-file-excel"></i> Exportar Dados</h2>
                
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-download"></i> Exportar Dados</h3>
                    <p style="margin-bottom: 20px;">Exporte todos os itens cadastrados para um arquivo Excel. O arquivo incluir√° todas as informa√ß√µes.</p>
                    
                    <div class="form-group">
                        <label for="exportRange">Exportar</label>
                        <select id="exportRange" class="form-control">
                            <option value="all">Todos os itens</option>
                            <option value="available">Apenas dispon√≠veis</option>
                            <option value="inuse">Apenas em uso</option>
                            <option value="maintenance">Apenas em manuten√ß√£o</option>
                            <option value="lowstock">Apenas estoque baixo</option>
                        </select>
                    </div>
                    
                    <div class="loader" id="exportLoader"></div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button type="button" class="btn btn-success" id="exportExcelBtn">
                            <i class="fas fa-file-excel"></i> Exportar para Excel
                        </button>
                        <button type="button" class="btn btn-primary" id="exportCSVBtn">
                            <i class="fas fa-file-csv"></i> Exportar para CSV
                        </button>
                        <button type="button" class="btn backup-btn" id="exportJSONBtn">
                            <i class="fas fa-file-code"></i> Exportar para JSON
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-history"></i> Hist√≥rico de Exporta√ß√µes</h3>
                    <div class="export-history" id="exportHistory">
                        <p style="text-align: center; color: var(--gray-color); padding: 20px 0;">
                            Nenhuma exporta√ß√£o realizada ainda
                        </p>
                    </div>
                </div>
            </div>
                        <!-- Romaneio Tab -->
            <div id="romaneio" class="tab-content">
                <h2 class="section-title"><i class="fas fa-truck-loading"></i> Gerar Romaneio</h2>
                
                <div class="cards-container">
                    <!-- Card de Sele√ß√£o de Ferramentas -->
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-list-check"></i> Selecionar Ferramentas para o Romaneio</h3>
                        
                        <div class="form-container">
                            <div class="search-box" style="margin-bottom: 20px;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchRomaneio" placeholder="Buscar ferramentas por nome, c√≥digo ou categoria...">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label><strong>Selecionar Ferramentas</strong></label>
                                    <button class="btn btn-sm btn-primary" id="selectAllToolsBtn">
                                        <i class="fas fa-check-square"></i> Selecionar Todas
                                    </button>
                                </div>
                                
                                <div style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; max-height: 400px; overflow-y: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead style="background-color: var(--light-color); position: sticky; top: 0;">
                                            <tr>
                                                <th style="padding: 10px; text-align: center; width: 50px;">
                                                    <input type="checkbox" id="checkAllRomaneio">
                                                </th>
                                                <th style="padding: 10px; text-align: left;">C√≥digo</th>
                                                <th style="padding: 10px; text-align: left;">Nome</th>
                                                <th style="padding: 10px; text-align: left;">Categoria</th>
                                                <th style="padding: 10px; text-align: left;">N.C.M.</th>
                                                <th style="padding: 10px; text-align: left;">Localiza√ß√£o</th>
                                                <th style="padding: 10px; text-align: center;">Quantidade</th>
                                            </tr>
                                        </thead>
                                        <tbody id="romaneioToolsList">
                                            <!-- Lista de ferramentas ser√° preenchida aqui -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div style="text-align: center; padding: 20px; border-top: 1px solid var(--border-color); margin-top: 10px;">
                                    <p style="color: var(--gray-color);" id="romaneioSelectionCount">
                                        Nenhuma ferramenta selecionada
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                                <!-- Card de Configura√ß√£o do Romaneio -->
                </div> <!-- Fecha o cards-container -->
                
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-cog"></i> Configurar Romaneio</h3>
                    
                    <div class="form-container">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="romaneioTitle" class="required">T√≠tulo do Romaneio</label>
                                <input type="text" id="romaneioTitle" placeholder="Ex: Romaneio para Obra X" value="Romaneio de Ferramentas">
                            </div>
                            <div class="form-group">
                                <label for="romaneioDestination">Destino</label>
                                <input type="text" id="romaneioDestination" placeholder="Ex: Obra Centro, Cliente Y">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="romaneioResponsible">Respons√°vel</label>
                                <input type="text" id="romaneioResponsible" placeholder="Nome do respons√°vel">
                            </div>
                            <div class="form-group">
                                <label for="romaneioDate">Data do Romaneio</label>
                                <input type="date" id="romaneioDate" value="">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="romaneioObservations">Observa√ß√µes</label>
                            <textarea id="romaneioObservations" rows="3" placeholder="Observa√ß√µes adicionais sobre o romaneio..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="romaneioIncludeImages">Incluir no Excel:</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="romaneioIncludeImages" checked>
                                    <span>Imagens das ferramentas</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="romaneioIncludeQR" checked>
                                    <span>C√≥digos QR</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="romaneioIncludePrices" checked>
                                    <span>Pre√ßos</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="romaneioIncludeLocation" checked>
                                    <span>Localiza√ß√£o</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="romaneioIncludeNCM" checked>
                                    <span>N.C.M.</span>
                                            
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bot√µes de A√ß√£o -->
                <div style="text-align: center; margin-top: 30px;">
                    <div class="btn-group">
                        <button type="button" class="btn btn-success" id="generateRomaneioBtn">
                            <i class="fas fa-file-excel"></i> Gerar Romaneio Excel
                        </button>
                        <button type="button" class="btn btn-primary" id="previewRomaneioBtn">
                            <i class="fas fa-eye"></i> Visualizar Romaneio
                        </button>
                        <button type="button" class="btn btn-warning" id="clearRomaneioBtn">
                            <i class="fas fa-eraser"></i> Limpar Sele√ß√£o
                        </button>
                        <button type="button" class="btn btn-info" id="saveRomaneioTemplateBtn">
                            <i class="fas fa-save"></i> Salvar como Modelo
                        </button>
                    </div>
                </div>
                
                <!-- Pr√©-visualiza√ß√£o do Romaneio -->
                <div class="card" style="margin-top: 30px; display: none;" id="romaneioPreviewCard">
                    <h3 class="card-title"><i class="fas fa-eye"></i> Pr√©-visualiza√ß√£o do Romaneio</h3>
                    <div class="table-container">
                        <table id="romaneioPreviewTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>C√≥digo</th>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>N.C.M.</th>
                                    <th>Quantidade</th>
                                    <th>Localiza√ß√£o</th>
                                    <th>Status</th>
                                    <th>Patrim√¥nio</th>
                                </tr>
                            </thead>
                            <tbody id="romaneioPreviewBody">
                                <!-- Pr√©-visualiza√ß√£o ser√° preenchida aqui -->
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn btn-success" id="exportPreviewBtn">
                            <i class="fas fa-download"></i> Exportar Este Romaneio
                        </button>
                    </div>
                </div>
            </div>
                
            <!-- Banco de Dados Online Tab -->
            <div id="database" class="tab-content">
                <h2 class="section-title"><i class="fas fa-database"></i> Banco de Dados Online</h2>
                
                <div class="config-container">
                    <div class="storage-status">
                        <div class="status-indicator" id="dbStatusIndicator"></div>
                        <h3 id="dbStatusText">Status: <span id="connectionStatus">Verificando...</span></h3>
                    </div>
                    
                    <div class="config-step">
                        <h4 class="step-title"><i class="fas fa-cloud"></i> Configura√ß√£o Autom√°tica</h4>
                        <div class="step-content">
                            <div class="form-group">
                                <label>URL do Projeto</label>
                                <div style="background-color: #f5f5f5; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                                    <strong>https://azlgjkjzitbolyfyyaip.supabase.co</strong>
                                    <p style="margin-top: 5px; font-size: 12px; color: var(--gray-color);">
                                        Configurada automaticamente no sistema
                                    </p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Chave da API</label>
                                <div style="background-color: #f5f5f5; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                                    <strong>Configura√ß√£o Autom√°tica</strong>
                                    <p style="margin-top: 5px; font-size: 12px; color: var(--gray-color);">
                                        Conex√£o autom√°tica com o banco de dados corporativo
                                    </p>
                                </div>
                            </div>
                            
                            <p style="margin-top: 15px; color: var(--success-color);">
                                <i class="fas fa-check-circle"></i> O sistema conecta automaticamente ao banco de dados ao iniciar.
                            </p>
                        </div>
                    </div>
                    
                    <div class="config-step">
                        <h4 class="step-title"><i class="fas fa-sync-alt"></i> Sincroniza√ß√£o</h4>
                        <div class="step-content">
                            <p>Gerencie a sincroniza√ß√£o dos dados com a nuvem:</p>
                            <div class="btn-group">
                                <button type="button" class="btn btn-success" id="syncToOnlineBtn">
                                    <i class="fas fa-cloud-upload-alt"></i> Enviar para Nuvem
                                </button>
                                <button type="button" class="btn btn-primary" id="syncFromOnlineBtn2">
                                    <i class="fas fa-cloud-download-alt"></i> Buscar da Nuvem
                                </button>
                                <button type="button" class="btn btn-warning" id="syncBothBtn">
                                    <i class="fas fa-exchange-alt"></i> Sincronizar Ambos
                                </button>
                            </div>
                            
                            <div class="storage-info" style="margin-top: 15px;">
                                <p><strong>Configura√ß√£o de Sincroniza√ß√£o:</strong></p>
                                <div class="form-group">
                                    <label for="syncLimit">Limite de itens por sincroniza√ß√£o:</label>
                                    <select id="syncLimit" class="form-control">
                                        <option value="50">50 itens</option>
                                        <option value="100">100 itens</option>
                                        <option value="200">200 itens</option>
                                        <option value="500" selected>500 itens</option>
                                        <option value="0">Todos (n√£o recomendado)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-step">
                        <h4 class="step-title"><i class="fas fa-info-circle"></i> Status da Conex√£o</h4>
                        <div class="step-content">
                            <div id="connectionDetails">
                                <p><strong>Status atual:</strong> <span id="currentConnectionStatus">Verificando...</span></p>
                                <p><strong>Modo de opera√ß√£o:</strong> <span id="operationMode">Local</span></p>
                                <p><strong>√öltima sincroniza√ß√£o:</strong> <span id="lastSyncTime">Nunca</span></p>
                                <p><strong>Itens locais:</strong> <span id="localItemsCount">0</span></p>
                                <p><strong>Itens na nuvem:</strong> <span id="cloudItemsCount">Carregando...</span></p>
                                <!-- ADICIONE ESTA LINHA -->
                                <p><strong>Colaboradores na nuvem:</strong> <span id="cloudColaboradoresCount">Carregando...</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal para visualizar item -->
        <div id="toolModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Detalhes do Item</h3>
                    <button class="modal-close" id="closeModalBtn">&times;</button>
                </div>
                <div class="modal-body" id="toolModalBody">
                    <!-- Conte√∫do do modal ser√° preenchido via JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Modal QR Code -->
        <div id="qrModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">QR Code do Item</h3>
                    <button class="modal-close" id="closeQRModalBtn">&times;</button>
                </div>
                <div class="modal-body" id="qrModalBody">
                    <!-- QR Code ser√° gerado aqui -->
                </div>
            </div>
        </div>
        
        <!-- Modal para Mapa -->
        <div id="mapModal" class="modal">
            <div class="modal-content" style="max-width: 1200px;">
                <div class="modal-header">
                    <h3 class="modal-title">Mapa do Container</h3>
                    <button class="modal-close" id="closeMapModalBtn">&times;</button>
                </div>
                <div class="modal-body" id="mapModalBody">
                    <!-- Conte√∫do do mapa ser√° preenchido via JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Input para upload de imagem (oculto) -->
        <input type="file" id="imageUploadInput" accept="image/*" capture="environment" style="display: none;">
        
        <!-- Input para restaurar backup (oculto) -->
        <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
        </div>

        <footer class="site-footer">
            <div class="footer-content">
                <p>Desenvolvido por F√°bio Mendes Rodrigues, Planejador da F.W. Company</p>
                <p class="footer-version">Vers√£o 3.0_rev03 | √öltima atualiza√ß√£o: <span id="currentDate"></span></p>
            </div>
        </footer>

        <!-- Bot√£o de Enviar para Nuvem Fixo -->
        <button class="cloud-upload-btn" id="fixedCloudUploadBtn" style="display: none;">
            <i class="fas fa-cloud-upload-alt"></i> Enviar para a Nuvem
        </button>

    <script>
        // ============================================
        // M√ìDULO 1: AUTENTICA√á√ÉO E CONFIGURA√á√ÉO B√ÅSICA
        // ============================================
        
        // 1. CONFIGURA√á√ÉO SUPABASE (FIXA)
        const FIXED_SUPABASE_CONFIG = {
            url: 'https://azlgjkjzitbolyfyyaip.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6bGdqa2p6aXRib2x5Znl5YWlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MTQ1NjcsImV4cCI6MjA4MTk5MDU2N30.PefjFNb5Phq2ZkR26-RlJdb-pnFUbYp1PxjYwI1LUpA'
        };

        // ============================================
        // SISTEMA DE AUTENTICA√á√ÉO E GERENCIAMENTO
        // ============================================

        // Dados de usu√°rios
        const users = {
            'fabio@fwcompany.com.br': {
                password: 'FabioFW123@',
                role: 'dev',
                name: 'F√°bio Mendes',
                email: 'fabio@fwcompany.com.br'
            },
            'emerson.silva@fwcompany.com.br': {
                password: 'EmersonFW1@',
                role: 'almoxarife',
                name: 'Emerson Silva',
                email: 'emerson.silva@fwcompany.com.br'
            },
            'fwuser': {
                password: 'User123',
                role: 'user',
                name: 'Usu√°rio Gen√©rico',
                email: 'fwuser@fwcompany.com.br'
            },
            'raquel@fwcompany.com.br': {
                password: 'RaqueL1234',
                role: 'user',
                name: 'Raquel',
                email: 'raquel@fwcompany.com.br'
            }
        };
        // ============================================
        // M√ìDULO 2: FERRAMENTAS E COLABORADORES
        // ============================================

        // Estado da aplica√ß√£o
        let currentUser = null;
        let tools = [];
        let currentToolImage = null;
        let chartInstance = null;
        let isEditing = false;
        let editingToolId = null;
        let supabaseClient = null;
        let isOnlineMode = false;
        let currentStorageType = 'localStorage';
        let lastSyncTime = null;
        let currentStatusFilter = 'all';

        // ============================================
        // SISTEMA DE COLABORADORES
        // ============================================

        // Array para armazenar colaboradores
        let colaboradores = [];
        let isEditingColaborador = false;
        let currentColaboradorId = null;
        let colaboradorSelecionado = null;

        // Dados de exemplo para colaboradores
        function getExampleColaboradores() {
            return [
                {
                    id: 1,
                    nome: 'Jo√£o da Silva',
                    matricula: 'MAT-001',
                    setor: 'Manuten√ß√£o',
                    cargo: 'T√©cnico de Manuten√ß√£o',
                    telefone: '(11) 99999-9999',
                    email: 'joao@empresa.com',
                    observacoes: 'Colaborador dedicado e cuidadoso com ferramentas',
                    dataCadastro: new Date().toISOString().split('T')[0],
                    usuarioCadastro: 'Sistema',
                    ferramentasAtribuidas: [] // Array de IDs de ferramentas atribu√≠das
                },
                {
                    id: 2,
                    nome: 'Maria Santos',
                    matricula: 'MAT-002',
                    setor: 'El√©trica',
                    cargo: 'Eletricista',
                    telefone: '(11) 98888-8888',
                    email: 'maria@empresa.com',
                    observacoes: 'Especialista em instala√ß√µes el√©tricas',
                    dataCadastro: new Date().toISOString().split('T')[0],
                    usuarioCadastro: 'Sistema',
                    ferramentasAtribuidas: []
                }
            ];
        }

        // Array para hist√≥rico de atribui√ß√µes
        let historicoAtribuicoes = [];
// ============================================
// GERADOR DE C√ìDIGO AUTOM√ÅTICO PARA COLABORADORES
// ============================================

// Fun√ß√£o para gerar c√≥digo autom√°tico (ex: A-0001)
function gerarCodigoColaborador() {
    // Letras poss√≠veis (A-Z)
    const letras = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    
    // Tentar encontrar a √∫ltima letra usada nos colaboradores existentes
    let ultimaLetra = 'A';
    let ultimoNumero = 0;
    
    if (colaboradores.length > 0) {
        // Extrair todos os c√≥digos existentes
        const codigosExistentes = colaboradores
            .map(c => c.matricula)
            .filter(matricula => matricula && matricula.match(/^[A-Z]-\d{4}$/));
        
        if (codigosExistentes.length > 0) {
            // Encontrar o maior c√≥digo
            codigosExistentes.sort((a, b) => {
                const numA = parseInt(a.split('-')[1]);
                const numB = parseInt(b.split('-')[1]);
                return numB - numA;
            });
            
            const ultimoCodigo = codigosExistentes[0];
            const [letra, numero] = ultimoCodigo.split('-');
            ultimaLetra = letra;
            ultimoNumero = parseInt(numero);
        }
    }
    
    // Gerar novo c√≥digo
    let novaLetra = ultimaLetra;
    let novoNumero = ultimoNumero + 1;
    
    // Se o n√∫mero passar de 9999, avan√ßa para a pr√≥xima letra
    if (novoNumero > 9999) {
        const letraIndex = letras.indexOf(novaLetra);
        novaLetra = letraIndex < letras.length - 1 ? letras[letraIndex + 1] : 'A';
        novoNumero = 1; // Reinicia do 0001
    }
    
    // Formatar o n√∫mero com 4 d√≠gitos
    const numeroFormatado = novoNumero.toString().padStart(4, '0');
    
    return `${novaLetra}-${numeroFormatado}`;
}

// Fun√ß√£o para verificar se um c√≥digo j√° existe
function codigoColaboradorExiste(codigo) {
    return colaboradores.some(c => c.matricula === codigo);
}

// Fun√ß√£o para inicializar o gerador de c√≥digo
function inicializarGeradorCodigoColaborador() {
    const gerarBtn = document.getElementById('gerarMatriculaBtn');
    const matriculaInput = document.getElementById('colaboradorMatricula');
    
    if (!gerarBtn || !matriculaInput) return;
    
    // Gerar c√≥digo inicial ao carregar o formul√°rio
    const codigoInicial = gerarCodigoColaborador();
    matriculaInput.value = codigoInicial;
    
    // Evento para o bot√£o gerar
    gerarBtn.addEventListener('click', function() {
        let tentativas = 0;
        let codigoGerado;
        let codigoUnico = false;
        
        // Tentar gerar um c√≥digo √∫nico (m√°ximo 10 tentativas)
        while (tentativas < 10 && !codigoUnico) {
            codigoGerado = gerarCodigoColaborador();
            if (!codigoColaboradorExiste(codigoGerado)) {
                codigoUnico = true;
            } else {
                // Avan√ßar para o pr√≥ximo c√≥digo
                const [letra, numero] = codigoGerado.split('-');
                const novoNumero = (parseInt(numero) + 1).toString().padStart(4, '0');
                codigoGerado = `${letra}-${novoNumero}`;
                tentativas++;
            }
        }
        
        if (codigoUnico) {
            matriculaInput.value = codigoGerado;
            showNotification(`C√≥digo gerado: ${codigoGerado}`, 'success');
            
            // Efeito visual
            gerarBtn.innerHTML = '<i class="fas fa-check"></i> Gerado!';
            gerarBtn.style.backgroundColor = 'var(--success-color)';
            
            setTimeout(() => {
                gerarBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Gerar C√≥digo';
                gerarBtn.style.backgroundColor = '';
            }, 1500);
        } else {
            showNotification('Erro ao gerar c√≥digo √∫nico. Tente novamente.', 'error');
        }
    });
    
    // Permitir edi√ß√£o manual se necess√°rio
    matriculaInput.addEventListener('focus', function() {
        this.removeAttribute('readonly');
        this.style.backgroundColor = 'var(--light-color)';
    });
    
    matriculaInput.addEventListener('blur', function() {
        // Validar formato ao perder o foco
        const valor = this.value.trim().toUpperCase();
        
        if (valor) {
            // Validar formato (A-0001)
            const regex = /^[A-Z]-\d{4}$/;
            
            if (!regex.test(valor)) {
                this.classList.add('error');
                document.getElementById('colaboradorMatriculaError').textContent = 
                    'Formato inv√°lido. Use: Letra-4 d√≠gitos (ex: A-0001)';
                document.getElementById('colaboradorMatriculaError').style.display = 'block';
            } else if (codigoColaboradorExiste(valor) && (!isEditingColaborador || valor !== colaboradores.find(c => c.id === currentColaboradorId)?.matricula)) {
                this.classList.add('error');
                document.getElementById('colaboradorMatriculaError').textContent = 
                    'Este c√≥digo j√° existe';
                document.getElementById('colaboradorMatriculaError').style.display = 'block';
            } else {
                this.classList.remove('error');
                document.getElementById('colaboradorMatriculaError').style.display = 'none';
                this.value = valor; // Garantir mai√∫sculas
            }
        }
        
        this.setAttribute('readonly', true);
        this.style.backgroundColor = '';
    });
}
// ===== BOT√ïES DE SINCRONIZA√á√ÉO DE ATRIBUI√á√ïES =====
document.getElementById('enviarAtribuicoesBtn')?.addEventListener('click', async function() {
    if (!isOnlineMode || !supabaseClient) {
        showNotification('N√£o conectado √† nuvem.', 'error');
        return;
    }
    
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    
    try {
        const success = await syncAtribuicoesToSupabase();
        if (success) {
            showAtribuicoesStatus('success', '‚úÖ Atribui√ß√µes enviadas para a nuvem!');
        }
    } catch (error) {
        showAtribuicoesStatus('error', `‚ùå Erro: ${error.message}`);
    } finally {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Enviar para Nuvem';
    }
});

document.getElementById('buscarAtribuicoesBtn')?.addEventListener('click', async function() {
    if (!isOnlineMode || !supabaseClient) {
        showNotification('N√£o conectado √† nuvem.', 'error');
        return;
    }
    
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
    
    try {
        const success = await fetchAtribuicoesFromSupabase();
        if (success) {
            showAtribuicoesStatus('success', '‚úÖ Atribui√ß√µes atualizadas da nuvem!');
        }
    } catch (error) {
        showAtribuicoesStatus('error', `‚ùå Erro: ${error.message}`);
    } finally {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Buscar da Nuvem';
    }
});

document.getElementById('sincronizarTudoAtribBtn')?.addEventListener('click', async function() {
    if (!isOnlineMode || !supabaseClient) {
        showNotification('N√£o conectado √† nuvem.', 'error');
        return;
    }
    
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';
    
    try {
        // Primeiro enviar
        await syncAtribuicoesToSupabase();
        // Depois buscar atualiza√ß√µes
        await fetchAtribuicoesFromSupabase();
        
        showAtribuicoesStatus('success', '‚úÖ Sincroniza√ß√£o completa!');
    } catch (error) {
        showAtribuicoesStatus('error', `‚ùå Erro: ${error.message}`);
    } finally {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-sync-alt"></i> Sincronizar Tudo';
    }
});

// Fun√ß√£o para mostrar status
function showAtribuicoesStatus(type, message) {
    const statusDiv = document.getElementById('atribuicoesSyncStatus');
    if (!statusDiv) return;
    
    statusDiv.style.display = 'block';
    statusDiv.className = '';
    
    switch(type) {
        case 'success':
            statusDiv.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
            statusDiv.style.border = '1px solid var(--success-color)';
            statusDiv.style.color = 'var(--success-color)';
            break;
        case 'error':
            statusDiv.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
            statusDiv.style.border = '1px solid var(--danger-color)';
            statusDiv.style.color = 'var(--danger-color)';
            break;
        case 'info':
            statusDiv.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            statusDiv.style.border = '1px solid var(--secondary-color)';
            statusDiv.style.color = 'var(--secondary-color)';
            break;
    }
    
    statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
            ${type === 'success' ? '<i class="fas fa-check-circle"></i>' : 
              type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : 
              '<i class="fas fa-info-circle"></i>'}
            <span>${message}</span>
        </div>
    `;
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

// Atualizar contagem de atribui√ß√µes locais
function updateLocalAtribuicoesCount() {
    const countElement = document.getElementById('localAtribuicoesCount');
    if (countElement) {
        const ativas = historicoAtribuicoes.filter(a => !a.dataDevolucao).length;
        countElement.textContent = `${historicoAtribuicoes.length} (${ativas} ativas)`;
    }
    
    const statusElement = document.getElementById('atribuicoesCloudStatus');
    if (statusElement) {
        if (isOnlineMode) {
            statusElement.textContent = 'Conectado';
            statusElement.style.color = 'var(--success-color)';
        } else {
            statusElement.textContent = 'Desconectado';
            statusElement.style.color = 'var(--danger-color)';
        }
    }
}

// Chame esta fun√ß√£o quando atualizar atribui√ß√µes
function updateAtribuicoesUI() {
    updateLocalAtribuicoesCount();
}
// Fun√ß√£o para carregar letras dispon√≠veis baseadas nos colaboradores existentes
function getLetrasDisponiveis() {
    const letrasUsadas = new Set();
    
    colaboradores.forEach(colaborador => {
        if (colaborador.matricula && colaborador.matricula.match(/^[A-Z]-\d{4}$/)) {
            const letra = colaborador.matricula.split('-')[0];
            letrasUsadas.add(letra);
        }
    });
    
    const todasLetras = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    const letrasDisponiveis = todasLetras.filter(letra => !letrasUsadas.has(letra));
    
    return letrasDisponiveis.length > 0 ? letrasDisponiveis : todasLetras;
}

// Fun√ß√£o para sugerir c√≥digos dispon√≠veis
function sugerirCodigosDisponiveis() {
    const letrasDisponiveis = getLetrasDisponiveis();
    const sugestoes = [];
    
    letrasDisponiveis.forEach(letra => {
        // Encontrar o maior n√∫mero usado para esta letra
        const codigosDestaLetra = colaboradores
            .map(c => c.matricula)
            .filter(matricula => matricula && matricula.startsWith(letra + '-'))
            .map(matricula => parseInt(matricula.split('-')[1]));
        
        const maxNumero = codigosDestaLetra.length > 0 ? Math.max(...codigosDestaLetra) : 0;
        const proximoNumero = (maxNumero + 1).toString().padStart(4, '0');
        
        sugestoes.push(`${letra}-${proximoNumero}`);
    });
    
    return sugestoes;
}
// ============================================
// FUN√á√ÉO CORRIGIDA: Converter atribui√ß√£o para formato Supabase
// ============================================

function convertAtribuicaoToSupabaseFormat(atribuicao) {
    return {
        id: atribuicao.id,
        tool_id: atribuicao.toolId, // Nome do campo ajustado
        tool_code: atribuicao.toolCodigo,
        tool_name: atribuicao.toolNome,
        collaborator_id: atribuicao.colaboradorId,
        collaborator_registration: atribuicao.colaboradorMatricula,
        collaborator_name: atribuicao.colaboradorNome,
        assignment_date: atribuicao.dataAtribuicao,
        assignment_type: 'collaborator',
        assigned_to_type: 'colaborador',
        assigned_to_id: atribuicao.colaboradorId.toString(),
        assigned_to_name: atribuicao.colaboradorNome,
        status: atribuicao.dataDevolucao ? 'returned' : 'active',
        observations: atribuicao.observacao || null,
        user_assigned: atribuicao.usuarioAtribuicao,
        user_returned: atribuicao.usuarioDevolucao || null,
        returned_date: atribuicao.dataDevolucao || null,
        expected_return_date: null, // Adicione este campo se necess√°rio
        actual_return_date: atribuicao.dataDevolucao || null,
        created_at: atribuicao.createdAt || new Date().toISOString(),
        updated_at: new Date().toISOString()
    };
}

// ============================================
// FUN√á√ÉO CORRIGIDA: Salvar atribui√ß√£o no Supabase
// ============================================

async function saveAtribuicaoToSupabase(atribuicao) {
    try {
        if (!supabaseClient || !isOnlineMode) {
            return false;
        }
        
        const atribuicaoData = convertAtribuicaoToSupabaseFormat(atribuicao);
        
        // Verificar se j√° existe uma atribui√ß√£o ativa para esta ferramenta
        const { data: existingActive } = await supabaseClient
            .from('tool_assignments')
            .select('id')
            .eq('tool_code', atribuicao.toolCodigo)
            .eq('status', 'active')
            .maybeSingle();
        
        if (existingActive) {
            // Se existe ativa e estamos marcando como devolvida
            if (atribuicao.dataDevolucao) {
                const { error } = await supabaseClient
                    .from('tool_assignments')
                    .update({
                        status: 'returned',
                        user_returned: atribuicao.usuarioDevolucao,
                        returned_date: atribuicao.dataDevolucao,
                        actual_return_date: atribuicao.dataDevolucao,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', existingActive.id);
                
                if (error) throw error;
            } else {
                // Atualizar atribui√ß√£o existente
                const { error } = await supabaseClient
                    .from('tool_assignments')
                    .update(atribuicaoData)
                    .eq('id', existingActive.id);
                
                if (error) throw error;
            }
        } else if (atribuicao.dataDevolucao) {
            // N√£o fazer nada se for apenas devolu√ß√£o sem atribui√ß√£o ativa
            return true;
        } else {
            // Inserir nova atribui√ß√£o
            const { data, error } = await supabaseClient
                .from('tool_assignments')
                .insert([atribuicaoData])
                .select();
            
            if (error) throw error;
            
            // Atualizar o ID local com o ID gerado pelo Supabase
            if (data && data[0]) {
                atribuicao.id = data[0].id;
            }
        }
        
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao salvar atribui√ß√£o no Supabase:', error);
        console.error('Detalhes do erro:', {
            message: error.message,
            details: error.details,
            hint: error.hint,
            code: error.code
        });
        
        // Verificar se √© erro de coluna inexistente
        if (error.message && error.message.includes('column')) {
            showNotification('Erro: Coluna n√£o existe na tabela do banco de dados.', 'error');
        } else {
            showNotification('Erro ao salvar atribui√ß√£o na nuvem.', 'warning');
        }
        
        return false;
    }
}
// ============================================
// BUSCAR ATRIBUI√á√ïES DO SUPABASE
// ============================================

async function fetchAtribuicoesFromSupabase() {
    try {
        if (!supabaseClient || !isOnlineMode) {
            return false;
        }
        
        console.log('üîÑ Buscando atribui√ß√µes do Supabase...');
        
        const { data, error } = await supabaseClient
            .from('tool_assignments')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (error) {
            if (error.message.includes('does not exist')) {
                console.log('üìã Tabela tool_assignments n√£o existe ainda');
                return false;
            }
            throw error;
        }
        
        if (data && data.length > 0) {
            console.log(`üì• ${data.length} atribui√ß√µes recebidas do Supabase`);
            
            // Converter para formato local
            const convertedAtribuicoes = data.map(item => ({
                id: item.id,
                colaboradorId: item.collaborator_id,
                colaboradorNome: item.collaborator_name,
                colaboradorMatricula: item.collaborator_registration,
                toolId: item.tool_id,
                toolNome: item.tool_name,
                toolCodigo: item.tool_code,
                dataAtribuicao: item.assignment_date,
                dataDevolucao: item.returned_date || item.actual_return_date,
                observacao: item.observations,
                usuarioAtribuicao: item.user_assigned,
                usuarioDevolucao: item.user_returned,
                createdAt: item.created_at,
                updatedAt: item.updated_at,
                status: item.status
            }));
            
            // Mesclar com atribui√ß√µes locais
            await processMergeAtribuicoes(convertedAtribuicoes);
            
            return true;
        } else {
            console.log('üì≠ Nenhuma atribui√ß√£o encontrada na nuvem');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Erro ao buscar atribui√ß√µes do Supabase:', error);
        showNotification(`Erro ao buscar atribui√ß√µes: ${error.message}`, 'error');
        return false;
    }
}
// ============================================
// PROCESSAR MESCLAGEM DE ATRIBUI√á√ïES
// ============================================

async function processMergeAtribuicoes(cloudAtribuicoes) {
    try {
        // Criar mapa das atribui√ß√µes da nuvem
        const cloudMap = new Map();
        cloudAtribuicoes.forEach(atribuicao => {
            // Usar chave composta para identificar unicamente
            const key = `${atribuicao.toolCodigo}_${atribuicao.colaboradorMatricula}_${atribuicao.dataAtribuicao}`;
            cloudMap.set(key, atribuicao);
        });
        
        let updatedCount = 0;
        let addedCount = 0;
        
        // Atualizar atribui√ß√µes existentes
        historicoAtribuicoes.forEach((localAtribuicao, index) => {
            const key = `${localAtribuicao.toolCodigo}_${localAtribuicao.colaboradorMatricula}_${localAtribuicao.dataAtribuicao}`;
            const cloudAtribuicao = cloudMap.get(key);
            
            if (cloudAtribuicao) {
                // Mesclar dados, mantendo prioridade da nuvem para campos conflitantes
                historicoAtribuicoes[index] = {
                    ...localAtribuicao,
                    ...cloudAtribuicao,
                    id: cloudAtribuicao.id // Usar ID da nuvem
                };
                updatedCount++;
                cloudMap.delete(key);
            }
        });
        
        // Adicionar novas atribui√ß√µes da nuvem
        const newAtribuicoes = Array.from(cloudMap.values());
        if (newAtribuicoes.length > 0) {
            historicoAtribuicoes = [...historicoAtribuicoes, ...newAtribuicoes];
            addedCount = newAtribuicoes.length;
        }
        
        // Salvar localmente
        await saveColaboradores(); // Esta fun√ß√£o salva tamb√©m o historicoAtribuicoes
        
        // Atualizar interface
        updateColaboradoresList();
        
        // Feedback
        if (updatedCount > 0 || addedCount > 0) {
            showNotification(`${updatedCount} atribui√ß√µes atualizadas, ${addedCount} novas da nuvem!`, 'success');
            console.log(`‚úÖ ${updatedCount} atualizadas, ${addedCount} novas atribui√ß√µes`);
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao processar mesclagem de atribui√ß√µes:', error);
        throw error;
    }
}
// Sincronizar todas as atribui√ß√µes ativas para o Supabase
async function syncAtribuicoesToSupabase() {
    try {
        if (!supabaseClient || !isOnlineMode) {
            showNotification('N√£o conectado √† nuvem.', 'warning');
            return;
        }
        
        // Filtrar apenas atribui√ß√µes ativas (n√£o devolvidas)
        const atribuicoesAtivas = historicoAtribuicoes.filter(atribuicao => !atribuicao.dataDevolucao);
        
        if (atribuicoesAtivas.length === 0) {
            showNotification('Nenhuma atribui√ß√£o ativa para sincronizar.', 'info');
            return;
        }
        
        let successCount = 0;
        let errorCount = 0;
        
        for (const atribuicao of atribuicoesAtivas) {
            try {
                const result = await saveAtribuicaoToSupabase(atribuicao);
                if (result) successCount++;
                else errorCount++;
            } catch (error) {
                errorCount++;
                console.error(`Erro ao sincronizar atribui√ß√£o ${atribuicao.id}:`, error);
            }
        }
        
        if (errorCount === 0) {
            showNotification(`${successCount} atribui√ß√µes sincronizadas com sucesso!`, 'success');
        } else {
            showNotification(`${successCount} sucessos, ${errorCount} erros na sincroniza√ß√£o de atribui√ß√µes.`, 'warning');
        }
        
        return true;
    } catch (error) {
        console.error('Erro na sincroniza√ß√£o de atribui√ß√µes:', error);
        showNotification('Erro na sincroniza√ß√£o de atribui√ß√µes.', 'error');
        return false;
    }
}

// ============================================
// MODIFICA√á√ïES NA FUN√á√ÉO DE VALIDA√á√ÉO
// ============================================

// Atualize a fun√ß√£o validateColaboradorForm() para incluir valida√ß√£o do formato:
function validateColaboradorForm() {
    let isValid = true;
    
    const nome = document.getElementById('colaboradorNome').value.trim();
    const matricula = document.getElementById('colaboradorMatricula').value.trim().toUpperCase();
    
    // Limpar erros
    document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
    document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
    
    // Validar campos obrigat√≥rios
    if (!nome) {
        document.getElementById('colaboradorNome').classList.add('error');
        document.getElementById('colaboradorNomeError').style.display = 'block';
        isValid = false;
    }
    
    if (!matricula) {
        document.getElementById('colaboradorMatricula').classList.add('error');
        document.getElementById('colaboradorMatriculaError').textContent = 'A matr√≠cula √© obrigat√≥ria';
        document.getElementById('colaboradorMatriculaError').style.display = 'block';
        isValid = false;
    } else {
        // Validar formato (A-0001)
        const regex = /^[A-Z]-\d{4}$/;
        
        if (!regex.test(matricula)) {
            document.getElementById('colaboradorMatricula').classList.add('error');
            document.getElementById('colaboradorMatriculaError').textContent = 
                'Formato inv√°lido. Use: Letra-4 d√≠gitos (ex: A-0001)';
            document.getElementById('colaboradorMatriculaError').style.display = 'block';
            isValid = false;
        } else if (isEditingColaborador) {
            if (colaboradores.some(c => c.matricula === matricula && c.id !== currentColaboradorId)) {
                document.getElementById('colaboradorMatricula').classList.add('error');
                document.getElementById('colaboradorMatriculaError').textContent = 'J√° existe um colaborador com esta matr√≠cula';
                document.getElementById('colaboradorMatriculaError').style.display = 'block';
                isValid = false;
            }
        } else {
            if (colaboradores.some(c => c.matricula === matricula)) {
                document.getElementById('colaboradorMatricula').classList.add('error');
                document.getElementById('colaboradorMatriculaError').textContent = 'J√° existe um colaborador com esta matr√≠cula';
                document.getElementById('colaboradorMatriculaError').style.display = 'block';
                isValid = false;
            }
        }
    }
    
    return isValid;
}

// ============================================
// MODIFICA√á√ïES NA FUN√á√ÉO clearColaboradorForm
// ============================================

// Atualize a fun√ß√£o clearColaboradorForm() para gerar c√≥digo automaticamente:
function clearColaboradorForm() {
    document.getElementById('colaboradorForm').reset();
    document.getElementById('colaboradorId').value = '';
    document.getElementById('excluirColaboradorBtn').style.display = 'none';
    isEditingColaborador = false;
    currentColaboradorId = null;
    document.getElementById('salvarColaboradorBtn').innerHTML = '<i class="fas fa-save"></i> Salvar Colaborador';
    
    // Gerar novo c√≥digo autom√°tico ao limpar formul√°rio
    const matriculaInput = document.getElementById('colaboradorMatricula');
    if (matriculaInput) {
        const novoCodigo = gerarCodigoColaborador();
        matriculaInput.value = novoCodigo;
        matriculaInput.setAttribute('readonly', true);
        matriculaInput.style.backgroundColor = '';
    }
}

// ============================================
// ADICIONAR AO EVENT LISTENER DOMContentLoaded
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    // ... (c√≥digo existente) ...
    
    // Inicializar gerador de c√≥digo para colaboradores
    inicializarGeradorCodigoColaborador();
    
    // ... (restante do c√≥digo) ...
});

// ============================================
// ATUALIZAR FUN√á√ÉO editColaborador
// ============================================

// Atualize a fun√ß√£o editColaborador para n√£o mudar o c√≥digo ao editar:
function editColaborador(colaboradorId) {
    // Verificar permiss√£o
    if (currentUser.role === 'user') {
        showNotification('Usu√°rio n√£o tem permiss√£o para editar colaboradores.', 'error');
        return;
    }
    
    const colaborador = colaboradores.find(c => c.id === colaboradorId);
    if (!colaborador) return;
    
    // Preencher formul√°rio
    document.getElementById('colaboradorNome').value = colaborador.nome;
    document.getElementById('colaboradorMatricula').value = colaborador.matricula;
    document.getElementById('colaboradorSetor').value = colaborador.setor || '';
    document.getElementById('colaboradorCargo').value = colaborador.cargo || '';
    document.getElementById('colaboradorTelefone').value = colaborador.telefone || '';
    document.getElementById('colaboradorEmail').value = colaborador.email || '';
    document.getElementById('colaboradorObservacoes').value = colaborador.observacoes || '';
    document.getElementById('colaboradorId').value = colaborador.id;
    
    // N√£o gerar novo c√≥digo ao editar - manter o existente
    const matriculaInput = document.getElementById('colaboradorMatricula');
    matriculaInput.value = colaborador.matricula;
    matriculaInput.removeAttribute('readonly');
    matriculaInput.style.backgroundColor = 'var(--light-color)';
    
    isEditingColaborador = true;
    currentColaboradorId = colaboradorId;
    
    document.getElementById('salvarColaboradorBtn').innerHTML = '<i class="fas fa-save"></i> Atualizar Colaborador';
    document.getElementById('excluirColaboradorBtn').style.display = 'inline-flex';
    
    showNotification('Editando colaborador. Atualize os dados.', 'warning');
}
        // ============================================
        // FUN√á√ïES DE COLABORADORES
        // ============================================

        // ============================================
        // FUN√á√ÉO AUXILIAR: Verificar se ferramenta est√° atribu√≠da
        // ============================================

        function isToolAssigned(toolId) {
            if (!colaboradores || !Array.isArray(colaboradores)) return false;
    
            for (const colaborador of colaboradores) {
                if (colaborador.ferramentasAtribuidas && 
                Array.isArray(colaborador.ferramentasAtribuidas) && 
                colaborador.ferramentasAtribuidas.includes(toolId)) {
                return true;
            }
        }
        return false;
    }
        // ============================================
        // FUN√á√ïES DE SUPABASE PARA COLABORADORES
        // ============================================

        // Converter para formato Supabase (colaboradores)
        function convertColaboradorToSupabaseFormat(colaborador) {
            return {
                id: colaborador.id,
                name: colaborador.nome,
                registration: colaborador.matricula,
                sector: colaborador.setor || '',
                position: colaborador.cargo || '',
                admission_date: colaborador.dataCadastro || new Date().toISOString().split('T')[0],
                status: 'active', // Status padr√£o
                email: colaborador.email || null,
                phone: colaborador.telefone || null,
                observations: colaborador.observacoes || null,
                created_at: colaborador.createdAt || new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
        }

        // Salvar colaborador no Supabase
        async function saveColaboradorToSupabase(colaborador) {
               try {
        if (!supabaseClient || !isOnlineMode) {
            return false;
        }
        
        const colaboradorData = convertColaboradorToSupabaseFormat(colaborador);
        
        // Verificar se j√° existe
        const { data: existing } = await supabaseClient
            .from('collaborators')
            .select('id')
            .eq('registration', colaborador.matricula)
            .maybeSingle();
        
        if (existing) {
            // Atualizar
            const { error } = await supabaseClient
                .from('collaborators')
                .update(colaboradorData)
                .eq('registration', colaborador.matricula);
            
            if (error) throw error;
        } else {
            // Inserir
            const { error } = await supabaseClient
                .from('collaborators')
                .insert([colaboradorData]);
            
            if (error) throw error;
        }
        
        return true;
    } catch (error) {
                console.error('Erro ao salvar colaborador no Supabase:', error);
                showNotification('Erro ao salvar colaborador na nuvem.', 'warning');
                return false;
            }
        }

        // ============================================
// BUSCA AUTOM√ÅTICA DE COLABORADORES DA NUVEM
// ============================================

// Modifique a fun√ß√£o initializeSystem para buscar colaboradores da nuvem
async function initializeSystem() {
    try {
        console.log('üîß INICIALIZANDO SISTEMA para:', currentUser?.email);
        
        // 1. Adicionar campo oculto para usu√°rio
        const usuarioField = document.createElement('input');
        usuarioField.type = 'hidden';
        usuarioField.id = 'usuarioCadastroField';
        usuarioField.value = currentUser ? currentUser.name : 'Sistema';
        document.getElementById('toolForm').appendChild(usuarioField);
        
        // 2. Carregar dados locais
        await loadInitialTools();
        console.log('üìÅ Dados locais carregados:', tools.length, 'itens');
        
        // 3. Carregar colaboradores LOCAIS primeiro
        loadColaboradores();
        console.log('üë• Colaboradores locais:', colaboradores.length);
        
        // 4. Verificar status do IndexedDB
        await updateIndexedDBStatus();
        
        // 5. ATUALIZAR INTERFACE INICIAL
        updateHeaderStats();
        updateStatistics();
        loadToolsList();
        updateColaboradoresList();
        // 5. Inicializar sistema de romaneio
        initializeRomaneioListeners();
        loadRomaneioTemplates();
        // 6. Configurar data atual
        document.getElementById('dataCadastro').value = new Date().toISOString().split('T')[0];
        document.getElementById('dataAtribuicao').value = new Date().toISOString().split('T')[0];
        
        // 7. INICIALIZAR GERADOR DE C√ìDIGO PARA COLABORADORES
        inicializarGeradorCodigoColaborador();
        
        // 8. SEMPRE tentar conectar ao Supabase com credenciais fixas
        console.log('‚òÅÔ∏è Conectando automaticamente ao Supabase...');
        console.log('URL:', FIXED_SUPABASE_CONFIG.url);
        
        const connected = await setupSupabaseClient();
        
        if (connected) {
            console.log('‚úÖ Conectado ao Supabase! Buscando dados...');
            
            // 9. BUSCA AUTOM√ÅTICA DE COLABORADORES DA NUVEM (com delay)
            setTimeout(async () => {
                try {
                    console.log('üîÑ Buscando colaboradores da nuvem...');
                    
                    // Primeiro, buscar colaboradores da nuvem
                    const fetchedColabs = await fetchColaboradoresFromSupabase();
                    
                    // Depois, buscar ferramentas da nuvem
                    const fetchedTools = await fetchFromSupabase();
                    
                    if (fetchedColabs || fetchedTools) {
                        console.log('‚úÖ Dados sincronizados da nuvem');
                        lastSyncTime = new Date();
                        updateConnectionStatus();
                        
                        // Atualizar contagem de colaboradores na interface
                        updateColaboradoresCountUI();
                    }
                } catch (syncError) {
                    console.error('‚ùå Erro na sincroniza√ß√£o autom√°tica:', syncError);
                    showNotification('Erro na sincroniza√ß√£o autom√°tica da nuvem.', 'warning');
                }
            }, 1000); // Delay de 1.0 segundos para n√£o sobrecarregar
            
        } else {
            console.log('‚ö†Ô∏è Modo local ativo');
            showNotification('Modo local ativo.', 'info');
        }
        
        // 10. Mostrar bot√£o de enviar para nuvem (se tiver permiss√£o)
        showCloudUploadButton();
        
        // 11. Atualizar status da conex√£o
        updateConnectionStatus();
        
        showNotification('Sistema inicializado!', 'success');
        console.log('‚úÖ Sistema inicializado com sucesso');
        
    } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        showNotification('Erro ao inicializar.', 'error');
    }
}
// ============================================
// ADICIONAR BOT√ïES DE SINCRONIZA√á√ÉO DE ATRIBUI√á√ïES
// ============================================

function addAtribuicoesSyncButtons() {
    // Encontrar √°rea apropriada (aba de colaboradores ou configura√ß√£o)
    const colaboradoresCard = document.querySelector('#controle-colaborador .cards-container .card:nth-child(2)');
    
    if (colaboradoresCard && !document.getElementById('atribuicoesSyncButtons')) {
        const buttonsContainer = document.createElement('div');
        buttonsContainer.id = 'atribuicoesSyncButtons';
        buttonsContainer.style.cssText = `
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        `;
        
        buttonsContainer.innerHTML = `
            <h5 style="color: var(--primary-color) !important; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-sync-alt"></i> Sincronizar Atribui√ß√µes
            </h5>
            
            <div class="btn-group" style="justify-content: center; flex-wrap: wrap; gap: 8px;">
                <button type="button" class="btn btn-sm btn-success" id="syncAtribuicoesToCloudBtn">
                    <i class="fas fa-cloud-upload-alt"></i> Enviar para Nuvem
                </button>
                
                <button type="button" class="btn btn-sm btn-primary" id="syncAtribuicoesFromCloudBtn">
                    <i class="fas fa-cloud-download-alt"></i> Buscar da Nuvem
                </button>
                
                <button type="button" class="btn btn-sm btn-info" id="checkAtribuicoesStatusBtn">
                    <i class="fas fa-chart-bar"></i> Estat√≠sticas
                </button>
            </div>
            
            <div id="atribuicoesSyncStatus" style="margin-top: 10px; padding: 8px; border-radius: 6px; display: none; font-size: 12px;">
            </div>
        `;
        
        // Adicionar ao card
        colaboradoresCard.appendChild(buttonsContainer);
        
        // Adicionar event listeners
        addAtribuicoesSyncEventListeners();
    }
}

function addAtribuicoesSyncEventListeners() {
    // Bot√£o: Enviar para Nuvem
    document.getElementById('syncAtribuicoesToCloudBtn')?.addEventListener('click', async function() {
        if (!isOnlineMode || !supabaseClient) {
            showNotification('N√£o conectado √† nuvem.', 'error');
            return;
        }
        
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        
        try {
            const success = await syncAtribuicoesToSupabase();
            if (success) {
                showSyncAtribuicoesStatus('success', '‚úÖ Atribui√ß√µes enviadas para a nuvem!');
            }
        } catch (error) {
            showSyncAtribuicoesStatus('error', `‚ùå Erro: ${error.message}`);
        } finally {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Enviar para Nuvem';
        }
    });
    
    // Bot√£o: Buscar da Nuvem
    document.getElementById('syncAtribuicoesFromCloudBtn')?.addEventListener('click', async function() {
        if (!isOnlineMode || !supabaseClient) {
            showNotification('N√£o conectado √† nuvem.', 'error');
            return;
        }
        
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
        
        try {
            const success = await fetchAtribuicoesFromSupabase();
            if (success) {
                showSyncAtribuicoesStatus('success', '‚úÖ Atribui√ß√µes atualizadas da nuvem!');
            }
        } catch (error) {
            showSyncAtribuicoesStatus('error', `‚ùå Erro: ${error.message}`);
        } finally {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Buscar da Nuvem';
        }
    });
    
    // Bot√£o: Estat√≠sticas
    document.getElementById('checkAtribuicoesStatusBtn')?.addEventListener('click', function() {
        checkAtribuicoesStatus();
    });
}

function showSyncAtribuicoesStatus(type, message) {
    const statusDiv = document.getElementById('atribuicoesSyncStatus');
    if (!statusDiv) return;
    
    statusDiv.style.display = 'block';
    statusDiv.className = '';
    
    switch(type) {
        case 'success':
            statusDiv.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
            statusDiv.style.border = '1px solid var(--success-color)';
            statusDiv.style.color = 'var(--success-color)';
            break;
        case 'error':
            statusDiv.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
            statusDiv.style.border = '1px solid var(--danger-color)';
            statusDiv.style.color = 'var(--danger-color)';
            break;
        case 'info':
            statusDiv.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            statusDiv.style.border = '1px solid var(--secondary-color)';
            statusDiv.style.color = 'var(--secondary-color)';
            break;
    }
    
    statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
            ${type === 'success' ? '<i class="fas fa-check-circle"></i>' : 
              type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : 
              '<i class="fas fa-info-circle"></i>'}
            <span>${message}</span>
        </div>
    `;
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

async function checkAtribuicoesStatus() {
    if (!isOnlineMode || !supabaseClient) {
        showNotification('N√£o conectado √† nuvem.', 'error');
        return;
    }
    
    try {
        const { count: cloudCount } = await supabaseClient
            .from('tool_assignments')
            .select('*', { count: 'exact', head: true });
        
        const localCount = historicoAtribuicoes.length;
        const localAtivas = historicoAtribuicoes.filter(a => !a.dataDevolucao).length;
        
        showSyncAtribuicoesStatus('info', 
            `Local: ${localCount} (${localAtivas} ativas) | Nuvem: ${cloudCount || 0}`
        );
        
    } catch (error) {
        showSyncAtribuicoesStatus('error', `‚ùå Erro ao verificar: ${error.message}`);
    }
}
// Fun√ß√£o para atualizar contagem de colaboradores na UI
function updateColaboradoresCountUI() {
    const colaboradoresCountElement = document.getElementById('colaboradoresCount');
    if (colaboradoresCountElement) {
        colaboradoresCountElement.textContent = colaboradores.length;
    }
    
    // Tamb√©m atualizar no painel de status do banco de dados
    const localColaboradoresElement = document.getElementById('localColaboradoresCount');
    if (localColaboradoresElement) {
        localColaboradoresElement.textContent = colaboradores.length;
    }
}

// Modifique a fun√ß√£o fetchColaboradoresFromSupabase para melhor feedback
async function fetchColaboradoresFromSupabase() {
    try {
        if (!supabaseClient || !isOnlineMode) {
            showNotification('N√£o conectado √† nuvem.', 'warning');
            return false;
        }
        
        console.log('üîÑ Buscando colaboradores do Supabase...');
        
        // Mostrar loader se poss√≠vel
        showLoading('Buscando colaboradores da nuvem...');
        
        const { data, error } = await supabaseClient
            .from('collaborators')
            .select('*')
            .order('updated_at', { ascending: false });
        
        if (error) {
            if (error.message.includes('does not exist')) {
                // Tabela n√£o existe, podemos criar mais tarde
                console.log('üìã Tabela de colaboradores n√£o existe ainda');
                hideLoading();
                return false;
            }
            throw error;
        }
        
        hideLoading();
        
        if (data && data.length > 0) {
            console.log(`üì• ${data.length} colaboradores recebidos do Supabase`);
            
            // Converter para formato local
            const convertedColaboradores = data.map(item => ({
                id: item.id || Date.now(),
                nome: item.name,
                matricula: item.registration,
                setor: item.sector,
                cargo: item.position,
                telefone: item.phone,
                email: item.email,
                observacoes: item.observations,
                dataCadastro: item.admission_date,
                status: item.status || 'active',
                usuarioCadastro: item.created_by || 'Sistema',
                ferramentasAtribuidas: [], // Ser√° preenchido separadamente
                createdAt: item.created_at,
                updatedAt: item.updated_at
            }));
            
            // Processar mesclagem de dados
            await processMergeColaboradores(convertedColaboradores);
            
            return true;
        } else {
            console.log('üì≠ Nenhum colaborador encontrado na nuvem');
            showNotification('Nenhum colaborador encontrado na nuvem.', 'info');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Erro ao buscar colaboradores do Supabase:', error);
        showNotification(`Erro ao buscar colaboradores: ${error.message}`, 'error');
        return false;
    }
}

// Fun√ß√£o para processar mesclagem de colaboradores
async function processMergeColaboradores(cloudColaboradores) {
    try {
        // 1. Criar mapa dos dados da nuvem pela matr√≠cula
        const cloudMap = new Map();
        cloudColaboradores.forEach(colaborador => {
            cloudMap.set(colaborador.matricula, colaborador);
        });
        
        // 2. Atualizar colaboradores existentes e adicionar novos
        let updatedCount = 0;
        let addedCount = 0;
        
        colaboradores.forEach((localColab, index) => {
            const cloudColab = cloudMap.get(localColab.matricula);
            if (cloudColab) {
                // Preservar ferramentas atribu√≠das do colaborador local
                const ferramentasAtribuidas = colaboradores[index].ferramentasAtribuidas || [];
                
                // Mesclar dados, mantendo ferramentas atribu√≠das locais
                colaboradores[index] = {
                    ...localColab,
                    ...cloudColab,
                    id: localColab.id, // Mant√©m o ID local
                    ferramentasAtribuidas: ferramentasAtribuidas,
                    updatedAt: new Date().toISOString()
                };
                updatedCount++;
                cloudMap.delete(localColab.matricula); // Remove do mapa para n√£o adicionar novamente
            }
        });
        
        // 3. Adicionar colaboradores que n√£o existiam localmente
        const newColaboradores = Array.from(cloudMap.values());
        if (newColaboradores.length > 0) {
            colaboradores = [...colaboradores, ...newColaboradores];
            addedCount = newColaboradores.length;
        }
        
        // 4. Salvar localmente e atualizar interface
        await saveColaboradores();
        updateColaboradoresList();
        updateColaboradoresCountUI();
        
        // 5. Feedback ao usu√°rio
        if (updatedCount > 0 || addedCount > 0) {
            showNotification(`${updatedCount} colaboradores atualizados, ${addedCount} novos da nuvem!`, 'success');
            console.log(`‚úÖ ${updatedCount} atualizados, ${addedCount} novos colaboradores`);
        } else {
            showNotification('Dados de colaboradores j√° sincronizados.', 'info');
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao processar mesclagem de colaboradores:', error);
        throw error;
    }
}

// Fun√ß√µes auxiliares para loading
function showLoading(message = 'Processando...') {
    // Remover loading existente
    hideLoading();
    
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'globalLoading';
    loadingDiv.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        color: white;
    `;
    
    loadingDiv.innerHTML = `
        <div class="loader" style="width: 60px; height: 60px; border: 5px solid #f3f3f3; border-top: 5px solid var(--secondary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 20px; font-size: 16px;">${message}</p>
    `;
    
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const existingLoading = document.getElementById('globalLoading');
    if (existingLoading) {
        existingLoading.remove();
    }
}

        // Sincronizar colaboradores para o Supabase
        async function syncColaboradoresToSupabase() {
        try {
        if (!supabaseClient || !isOnlineMode) {
            showNotification('N√£o conectado √† nuvem.', 'warning');
            return;
        }
        
        let successCount = 0;
        let errorCount = 0;
        
        for (const colaborador of colaboradores) {
            try {
                const result = await saveColaboradorToSupabase(colaborador);
                if (result) successCount++;
                else errorCount++;
            } catch (error) {
                errorCount++;
                console.error(`Erro ao sincronizar ${colaborador.nome}:`, error);
            }
        }
        
        if (errorCount === 0) {
            showNotification(`${successCount} colaboradores sincronizados com sucesso!`, 'success');
        } else {
            showNotification(`${successCount} sucessos, ${errorCount} erros na sincroniza√ß√£o de colaboradores.`, 'warning');
        }
        
        return true;
    } catch (error) {
        console.error('Erro na sincroniza√ß√£o de colaboradores:', error);
        showNotification('Erro na sincroniza√ß√£o de colaboradores.', 'error');
        return false;
    }
}

// ============================================
// ADICIONAR BOT√ïES DE SINCRONIZA√á√ÉO NA ABA COLABORADOR
// ============================================

// Fun√ß√£o para adicionar bot√µes na aba de colaboradores
function addSyncButtonsToColaboradoresTab() {
    // Encontrar o container do formul√°rio de colaboradores
    const colaboradorCard = document.querySelector('#controle-colaborador .cards-container .card:first-child');
    
    if (!colaboradorCard) {
        console.log('Card de colaborador n√£o encontrado');
        return;
    }
    
    // Verificar se os bot√µes j√° existem
    if (document.getElementById('colaboradoresSyncButtons')) {
        return;
    }
    
    // Adicionar container para os bot√µes ap√≥s o formul√°rio
    const formContainer = colaboradorCard.querySelector('.form-container');
    if (formContainer) {
        const buttonsContainer = document.createElement('div');
        buttonsContainer.id = 'colaboradoresSyncButtons';
        buttonsContainer.style.cssText = `
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        `;
        
        buttonsContainer.innerHTML = `
            <h4 style="color: var(--primary-color) !important; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-cloud"></i> Sincroniza√ß√£o com a Nuvem
            </h4>
            
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--warning-color);">
                <p style="color: var(--text-color) !important; margin: 0; font-size: 14px;">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Colaboradores Locais:</strong> ${colaboradores.length} | 
                    <strong>Status:</strong> <span id="colaboradoresCloudStatus">${isOnlineMode ? 'Conectado' : 'Desconectado'}</span>
                </p>
            </div>
            
            <div class="btn-group" style="justify-content: center; flex-wrap: wrap; gap: 10px;">
                <button type="button" class="btn btn-success" id="fetchColaboradoresBtn" 
                        style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-cloud-download-alt"></i> Buscar da Nuvem
                </button>
                
                <button type="button" class="btn btn-primary" id="pushColaboradoresBtn" 
                        style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-cloud-upload-alt"></i> Enviar para Nuvem
                </button>
                
                <button type="button" class="btn btn-warning" id="syncAllColaboradoresBtn" 
                        style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-sync-alt"></i> Sincronizar Tudo
                </button>
                
                <button type="button" class="btn btn-info" id="checkColaboradoresBtn" 
                        style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-search"></i> Verificar Status
                </button>
            </div>
            
            <div id="colaboradoresSyncStatus" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;">
                <!-- Status ser√° preenchido dinamicamente -->
            </div>
        `;
        
        // Inserir ap√≥s o formul√°rio
        formContainer.parentNode.insertBefore(buttonsContainer, formContainer.nextSibling);
        
        // Adicionar event listeners
        addColaboradoresSyncEventListeners();
    }
}

// Adicionar event listeners aos bot√µes
function addColaboradoresSyncEventListeners() {
    // Bot√£o: Buscar da Nuvem
    document.getElementById('fetchColaboradoresBtn').addEventListener('click', async function() {
        if (!isOnlineMode || !supabaseClient) {
            showNotification('N√£o conectado √† nuvem.', 'error');
            return;
        }
        
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
        
        try {
            const success = await fetchColaboradoresFromSupabase();
            if (success) {
                showSyncStatus('success', `‚úÖ Colaboradores buscados da nuvem com sucesso!`);
                updateColaboradoresList();
            }
        } catch (error) {
            showSyncStatus('error', `‚ùå Erro ao buscar colaboradores: ${error.message}`);
        } finally {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Buscar da Nuvem';
        }
    });
    
    // Bot√£o: Enviar para Nuvem
    document.getElementById('pushColaboradoresBtn').addEventListener('click', async function() {
        if (!isOnlineMode || !supabaseClient) {
            showNotification('N√£o conectado √† nuvem.', 'error');
            return;
        }
        
        if (colaboradores.length === 0) {
            showNotification('Nenhum colaborador local para enviar.', 'warning');
            return;
        }
        
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        
        try {
            const success = await syncColaboradoresToSupabase();
            if (success) {
                showSyncStatus('success', `‚úÖ ${colaboradores.length} colaboradores enviados para a nuvem!`);
            }
        } catch (error) {
            showSyncStatus('error', `‚ùå Erro ao enviar colaboradores: ${error.message}`);
        } finally {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Enviar para Nuvem';
        }
    });
    
    // Bot√£o: Sincronizar Tudo (busca e envia)
    document.getElementById('syncAllColaboradoresBtn').addEventListener('click', async function() {
        if (!isOnlineMode || !supabaseClient) {
            showNotification('N√£o conectado √† nuvem.', 'error');
            return;
        }
        
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';
        
        try {
            showSyncStatus('info', 'üîÑ Iniciando sincroniza√ß√£o completa...');
            
            // Primeiro enviar dados locais
            await syncColaboradoresToSupabase();
            
            // Depois buscar dados atualizados
            await fetchColaboradoresFromSupabase();
            
            showSyncStatus('success', '‚úÖ Sincroniza√ß√£o completa realizada com sucesso!');
            updateColaboradoresList();
            
        } catch (error) {
            showSyncStatus('error', `‚ùå Erro na sincroniza√ß√£o: ${error.message}`);
        } finally {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-sync-alt"></i> Sincronizar Tudo';
        }
    });
    
    // Bot√£o: Verificar Status
    document.getElementById('checkColaboradoresBtn').addEventListener('click', async function() {
        checkColaboradoresCloudStatus();
    });
}

// Fun√ß√£o para mostrar status da sincroniza√ß√£o
function showSyncStatus(type, message) {
    const statusDiv = document.getElementById('colaboradoresSyncStatus');
    if (!statusDiv) return;
    
    statusDiv.style.display = 'block';
    statusDiv.className = '';
    
    switch(type) {
        case 'success':
            statusDiv.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
            statusDiv.style.border = '1px solid var(--success-color)';
            statusDiv.style.color = 'var(--success-color)';
            break;
        case 'error':
            statusDiv.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
            statusDiv.style.border = '1px solid var(--danger-color)';
            statusDiv.style.color = 'var(--danger-color)';
            break;
        case 'info':
            statusDiv.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            statusDiv.style.border = '1px solid var(--secondary-color)';
            statusDiv.style.color = 'var(--secondary-color)';
            break;
        case 'warning':
            statusDiv.style.backgroundColor = 'rgba(243, 156, 18, 0.1)';
            statusDiv.style.border = '1px solid var(--warning-color)';
            statusDiv.style.color = 'var(--warning-color)';
            break;
    }
    
    statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            ${type === 'success' ? '<i class="fas fa-check-circle"></i>' : 
              type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : 
              type === 'warning' ? '<i class="fas fa-exclamation-triangle"></i>' : 
              '<i class="fas fa-info-circle"></i>'}
            <span>${message}</span>
        </div>
    `;
    
    // Auto-esconder ap√≥s 5 segundos
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

// Verificar status dos colaboradores na nuvem
async function checkColaboradoresCloudStatus() {
    const statusElement = document.getElementById('colaboradoresCloudStatus');
    if (!statusElement) return;
    
    if (!isOnlineMode || !supabaseClient) {
        statusElement.textContent = 'Desconectado';
        statusElement.style.color = 'var(--danger-color)';
        showSyncStatus('error', '‚ùå N√£o conectado √† nuvem');
        return;
    }
    
    try {
        statusElement.textContent = 'Verificando...';
        statusElement.style.color = 'var(--warning-color)';
        
        // Contar colaboradores na nuvem
        const { count: cloudCount } = await supabaseClient
            .from('collaborators')
            .select('*', { count: 'exact', head: true });
        
        const localCount = colaboradores.length;
        
        statusElement.textContent = `Nuvem: ${cloudCount || 0} | Local: ${localCount}`;
        
        if (cloudCount === localCount) {
            statusElement.style.color = 'var(--success-color)';
            showSyncStatus('success', `‚úÖ Sincronizado! ${localCount} colaboradores locais e na nuvem.`);
        } else if (cloudCount > localCount) {
            statusElement.style.color = 'var(--warning-color)';
            showSyncStatus('warning', `‚ö†Ô∏è A nuvem tem ${cloudCount - localCount} colaboradores a mais que o local.`);
        } else {
            statusElement.style.color = 'var(--warning-color)';
            showSyncStatus('warning', `‚ö†Ô∏è O local tem ${localCount - cloudCount} colaboradores a mais que a nuvem.`);
        }
        
    } catch (error) {
        statusElement.textContent = 'Erro ao verificar';
        statusElement.style.color = 'var(--danger-color)';
        showSyncStatus('error', `‚ùå Erro ao verificar status: ${error.message}`);
    }
}

// Atualizar status ao carregar a aba
function updateColaboradoresCloudStatusUI() {
    const statusElement = document.getElementById('colaboradoresCloudStatus');
    if (statusElement) {
        if (isOnlineMode) {
            statusElement.textContent = `Conectado (${colaboradores.length} locais)`;
            statusElement.style.color = 'var(--success-color)';
        } else {
            statusElement.textContent = 'Desconectado';
            statusElement.style.color = 'var(--danger-color)';
        }
    }
}

// ============================================
// MODIFICAR FUN√á√ÉO PARA CARREGAR A ABA COLABORADORES
// ============================================

// Adicione este c√≥digo ao event listener da aba de colaboradores
document.querySelector('[data-tab="controle-colaborador"]')?.addEventListener('click', function() {
    // Carregar lista de colaboradores
    updateColaboradoresList();
    
    // Adicionar bot√µes de sincroniza√ß√£o (se ainda n√£o existirem)
    setTimeout(() => {
        addSyncButtonsToColaboradoresTab();
        updateColaboradoresCloudStatusUI();
    }, 100);
    
    // For√ßar modo noturno se necess√°rio
    setTimeout(forceDarkModeForColaboradores, 100);
});

// ============================================
// ATUALIZAR O DOMContentLoaded
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    // ... (c√≥digo existente) ...
    
    // Inicializar gerador de c√≥digo para colaboradores
    inicializarGeradorCodigoColaborador();
    
    // ... (restante do c√≥digo) ...
});

// ============================================
// FUN√á√ÉO PARA ATUALIZAR CONTAGEM NO CABE√áALHO
// ============================================

// Adicione esta fun√ß√£o para mostrar contagem no cabe√ßalho
function updateHeaderStats() {
    document.getElementById('totalTools').textContent = tools.length;
    
    // Calcular valor total
    const totalValue = tools.reduce((sum, tool) => {
        const preco = parseFloat(tool.preco) || 0;
        const quantidade = parseInt(tool.quantidade) || 1;
        return sum + (preco * quantidade);
    }, 0);
    
    document.getElementById('totalValue').textContent = formatCurrency(totalValue);
    document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('pt-BR');
    
    // Adicionar contagem de colaboradores se o elemento existir
    const colaboradoresCountElement = document.getElementById('colaboradoresCount');
    if (!colaboradoresCountElement) {
        // Adicionar elemento se n√£o existir
        const projectInfo = document.querySelector('.project-info');
        if (projectInfo) {
            const colaboradoresItem = document.createElement('div');
            colaboradoresItem.className = 'info-item';
            colaboradoresItem.innerHTML = `
                <div class="info-label">Colaboradores</div>
                <div class="info-value" id="colaboradoresCount">${colaboradores.length}</div>
            `;
            projectInfo.insertBefore(colaboradoresItem, projectInfo.children[2]);
        }
    } else {
        colaboradoresCountElement.textContent = colaboradores.length;
    }
}
        // Fun√ß√µes de colaboradores atualizadas (salvar e excluir):

        // Criar novo colaborador (ATUALIZADA)
        async function createColaborador(colaboradorData) {
            const newColaborador = {
            id: Date.now(),
            ...colaboradorData,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
    
        colaboradores.push(newColaborador);
    
        await saveColaboradores();
    
        // Salvar no Supabase se estiver conectado
        if (isOnlineMode && supabaseClient) {
            await saveColaboradorToSupabase(newColaborador);
        }
    
        updateColaboradoresList();
        showNotification('Colaborador cadastrado com sucesso!', 'success');
        clearColaboradorForm();
    }

        // Atualizar colaborador existente (ATUALIZADA)
        async function updateColaborador(colaboradorId, colaboradorData) {
            const colaboradorIndex = colaboradores.findIndex(c => c.id === colaboradorId);
    
        if (colaboradorIndex === -1) {
            showNotification('Colaborador n√£o encontrado!', 'error');
            return false;
        }
    
        // Manfer ferramentas atribu√≠das
        const ferramentasAtribuidas = colaboradores[colaboradorIndex].ferramentasAtribuidas || [];
    
        const updatedColaborador = {
        ...colaboradores[colaboradorIndex],
        ...colaboradorData,
        ferramentasAtribuidas: ferramentasAtribuidas,
        updatedAt: new Date().toISOString()
    };
    
    colaboradores[colaboradorIndex] = updatedColaborador;
    
    await saveColaboradores();
    
    // Atualizar no Supabase se estiver conectado
    if (isOnlineMode && supabaseClient) {
        await saveColaboradorToSupabase(updatedColaborador);
    }
    
    updateColaboradoresList();
    showNotification('Colaborador atualizado com sucesso!', 'success');
    clearColaboradorForm();
    
    return true;
}

    // Excluir colaborador (ATUALIZADA)
    async function deleteColaborador(colaboradorId) {
        const colaborador = colaboradores.find(c => c.id === colaboradorId);
        if (!colaborador) {
            showNotification('Colaborador n√£o encontrado!', 'error');
            return;
        }
    
    // Verificar se tem ferramentas atribu√≠das
    if (colaborador.ferramentasAtribuidas && colaborador.ferramentasAtribuidas.length > 0) {
        if (!confirm('Este colaborador tem ferramentas atribu√≠das. Deseja realmente excluir? As ferramentas ser√£o marcadas como dispon√≠veis.')) {
            return;
        }
        
        // Remover atribui√ß√£o das ferramentas
        colaborador.ferramentasAtribuidas.forEach(toolId => {
            const toolIndex = tools.findIndex(t => t.id === toolId);
            if (toolIndex !== -1) {
                tools[toolIndex].status = 'Dispon√≠vel';
                // Remover do hist√≥rico
                historicoAtribuicoes = historicoAtribuicoes.filter(h => 
                    !(h.colaboradorId === colaboradorId && h.toolId === toolId && !h.dataDevolucao)
                );
            }
        });
        
        await saveTools();
    }
    
    // Remover colaborador localmente
    colaboradores = colaboradores.filter(c => c.id !== colaboradorId);
    await saveColaboradores();
    
    // Remover do Supabase se estiver conectado
    if (isOnlineMode && supabaseClient) {
        try {
            await supabaseClient
                .from('collaborators')
                .delete()
                .eq('registration', colaborador.matricula);
        } catch (error) {
            console.error('Erro ao excluir colaborador do Supabase:', error);
        }
    }
    
    // Se era o colaborador selecionado, limpar sele√ß√£o
    if (colaboradorSelecionado && colaboradorSelecionado.id === colaboradorId) {
        colaboradorSelecionado = null;
        updateAtribuicaoUI();
    }
    
    updateColaboradoresList();
    showNotification('Colaborador exclu√≠do com sucesso!', 'success');
    clearColaboradorForm();
}

    // ============================================
    // MODIFICA√á√ÉO NA FUN√á√ÉO DE SINCRONIZA√á√ÉO
    // ============================================

    // Fun√ß√£o principal de sincroniza√ß√£o (ATUALIZADA)
    async function syncBoth() {
        try {
        showNotification('Iniciando sincroniza√ß√£o completa...', 'info');
        
        // 1. Sincronizar ferramentas para a nuvem
        await syncToSupabase();
        
        // 2. Sincronizar colaboradores para a nuvem
        await syncColaboradoresToSupabase();
        
        // 3. Buscar dados atualizados da nuvem
        await fetchFromSupabase();
        await fetchColaboradoresFromSupabase();
        
        showNotification('Sincroniza√ß√£o completa realizada com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro na sincroniza√ß√£o completa:', error);
        showNotification('Erro na sincroniza√ß√£o completa.', 'error');
    }
}

        // ============================================
        // MODIFICA√á√ÉO NA INICIALIZA√á√ÉO DO SISTEMA
        // ============================================

        // Na fun√ß√£o initializeSystem(), adicione ap√≥s a sincroniza√ß√£o das ferramentas:
    async function initializeSystem() {
        try {
        console.log('üîß INICIALIZANDO SISTEMA para:', currentUser?.email);
        
        // ... (c√≥digo existente) ...
        
        // 8. Para TODOS os usu√°rios, buscar dados da nuvem
        setTimeout(async () => {
            try {
                // Sincronizar ferramentas
                const fetchedTools = await fetchFromSupabase();
                
                // Sincronizar colaboradores
                const fetchedColabs = await fetchColaboradoresFromSupabase();
                
                if (fetchedTools || fetchedColabs) {
                    console.log('‚úÖ Dados sincronizados da nuvem');
                    lastSyncTime = new Date();
                    updateConnectionStatus();
                }
            } catch (syncError) {
                console.error('‚ùå Erro na sincroniza√ß√£o autom√°tica:', syncError);
            }
        }, 1000);
        
        // ... (restante do c√≥digo) ...
        
    } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        showNotification('Erro ao inicializar.', 'error');
    }
}

        // ============================================
        // ADICIONAR BOT√ïES DE SINCRONIZA√á√ÉO DE COLABORADORES
        // ============================================

        // Adicione estes bot√µes na aba "Banco de Dados" ou crie uma nova se√ß√£o:
        function addSyncButtonsToUI() {
        // Procure pela √°rea de sincroniza√ß√£o na aba Database
        const syncSection = document.querySelector('#database .config-step:has(.btn-group)');
    
        if (syncSection) {
        // Adicionar bot√µes espec√≠ficos para colaboradores
        const newButtonGroup = document.createElement('div');
        newButtonGroup.className = 'btn-group';
        newButtonGroup.style.marginTop = '15px';
        newButtonGroup.innerHTML = `
            <p><strong>Sincroniza√ß√£o de Colaboradores:</strong></p>
            <button type="button" class="btn btn-success" id="syncColaboradoresToOnlineBtn">
                <i class="fas fa-user-upload"></i> Enviar Colaboradores para Nuvem
            </button>
            <button type="button" class="btn btn-primary" id="syncColaboradoresFromOnlineBtn">
                <i class="fas fa-user-download"></i> Buscar Colaboradores da Nuvem
            </button>
        `;
        
        syncSection.querySelector('.step-content').appendChild(newButtonGroup);
        
        // Adicionar event listeners aos novos bot√µes
        document.getElementById('syncColaboradoresToOnlineBtn').addEventListener('click', syncColaboradoresToSupabase);
        document.getElementById('syncColaboradoresFromOnlineBtn').addEventListener('click', fetchColaboradoresFromSupabase);
    }
}

// ============================================
// ADICIONAR AO EVENT LISTENER DOMContentLoaded
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    // ... (c√≥digo existente) ...
    
    // Adicionar bot√µes de sincroniza√ß√£o de colaboradores
    addSyncButtonsToUI();
    
    // ... (restante do c√≥digo) ...
});

// ============================================
// MODIFICA√á√ÉO NO BACKUP/RESTAURA√á√ÉO
// ============================================

// Na fun√ß√£o createBackup(), inclua os colaboradores:
async function createBackup() {
    try {
        const backupData = {
            tools: tools,
            colaboradores: colaboradores, // Incluindo colaboradores
            historicoAtribuicoes: historicoAtribuicoes,
            timestamp: new Date().toISOString(),
            count: tools.length,
            colaboradoresCount: colaboradores.length, // Contagem separada
            usuarios: Array.from(new Set(tools.map(t => t.usuarioCadastro).filter(Boolean)))
        };
        
        // ... (restante da fun√ß√£o) ...
    } catch (error) {
        console.error('Erro ao criar backup:', error);
        showNotification('Erro ao criar backup.', 'error');
    }
}

// Na fun√ß√£o handleRestoreBackup(), restaurar colaboradores:
function handleRestoreBackup(file) {
    const reader = new FileReader();
    
    reader.onload = async function(event) {
        try {
            const backupData = JSON.parse(event.target.result);
            
            if (!backupData.tools || !Array.isArray(backupData.tools)) {
                showNotification('Arquivo de backup inv√°lido.', 'error');
                return;
            }
            
            if (!confirm(`Restaurar backup com ${backupData.tools.length} ferramentas e ${backupData.colaboradores?.length || 0} colaboradores? Os dados atuais ser√£o substitu√≠dos.`)) {
                return;
            }
            
            // Restaurar dados
            tools = backupData.tools;
            colaboradores = backupData.colaboradores || [];
            historicoAtribuicoes = backupData.historicoAtribuicoes || [];
            
            await saveTools();
            await saveColaboradores();
            updateInterface();
            
            // Sincronizar com a nuvem se estiver conectado
            if (isOnlineMode && supabaseClient) {
                showNotification('Sincronizando dados restaurados com a nuvem...', 'info');
                
                // Sincronizar ferramentas
                await syncToSupabase();
                
                // Sincronizar colaboradores
                await syncColaboradoresToSupabase();
                
                showNotification('Dados restaurados e sincronizados com a nuvem!', 'success');
            } else {
                showNotification(`${backupData.tools.length} ferramentas e ${colaboradores.length} colaboradores restaurados!`, 'success');
            }
            
        } catch (error) {
            console.error('Erro ao restaurar backup:', error);
            showNotification('Erro ao restaurar backup.', 'error');
        }
    };
    
    reader.onerror = function() {
        showNotification('Erro ao ler arquivo.', 'error');
    };
    
    reader.readAsText(file);
}
// Fun√ß√£o para for√ßar modo noturno na aba de colaboradores
function forceDarkModeForColaboradores() {
    if (document.body.classList.contains('dark-mode')) {
        // Selecionar todos os elementos problem√°ticos
        const elements = document.querySelectorAll('#controle-colaborador *');
        
        elements.forEach(element => {
            // Remover estilos inline de cores
            if (element.style.color && (
                element.style.color.includes('var(--text-color)') ||
                element.style.color.includes('var(--primary-color)') ||
                element.style.color.includes('var(--gray-color)')
            )) {
                element.style.color = '#e0e0e0';
            }
            
            // Remover estilos inline de background
            if (element.style.backgroundColor && (
                element.style.backgroundColor === 'white' ||
                element.style.backgroundColor.includes('#f5f5f5') ||
                element.style.backgroundColor.includes('#f8f9fa')
            )) {
                element.style.backgroundColor = '#3d3d3d';
            }
        });
    }
}

            // Chamar esta fun√ß√£o quando alternar para a aba de colaboradores
            document.querySelector('[data-tab="controle-colaborador"]')?.addEventListener('click', function() {
            setTimeout(forceDarkModeForColaboradores, 100);
        });

            // Tamb√©m chamar quando alternar o modo noturno
            document.getElementById('modeToggleBtn')?.addEventListener('click', function() {
            setTimeout(() => {
            if (document.querySelector('[data-tab="controle-colaborador"]')?.classList.contains('active')) {
            forceDarkModeForColaboradores();
            }
            }, 100);
        });
            // Carregar colaboradores do localStorage
            function loadColaboradores() {
            try {
                const saved = localStorage.getItem('colaboradores');
                if (saved) {
                    colaboradores = JSON.parse(saved);
                } else {
                    colaboradores = getExampleColaboradores();
                    saveColaboradores();
                }
                
                // Carregar hist√≥rico de atribui√ß√µes
                const savedHistorico = localStorage.getItem('historicoAtribuicoes');
                if (savedHistorico) {
                    historicoAtribuicoes = JSON.parse(savedHistorico);
                }
                
            } catch (error) {
                console.error('Erro ao carregar colaboradores:', error);
                colaboradores = getExampleColaboradores();
            }
        }

        // Salvar colaboradores no localStorage
        function saveColaboradores() {
            try {
                localStorage.setItem('colaboradores', JSON.stringify(colaboradores));
                localStorage.setItem('historicoAtribuicoes', JSON.stringify(historicoAtribuicoes));
                return true;
            } catch (error) {
                console.error('Erro ao salvar colaboradores:', error);
                return false;
            }
        }

        // Validar formul√°rio de colaborador
        function validateColaboradorForm() {
            let isValid = true;
            
            const nome = document.getElementById('colaboradorNome').value.trim();
            const matricula = document.getElementById('colaboradorMatricula').value.trim();
            
            // Limpar erros
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            
            // Validar campos obrigat√≥rios
            if (!nome) {
                document.getElementById('colaboradorNome').classList.add('error');
                document.getElementById('colaboradorNomeError').style.display = 'block';
                isValid = false;
            }
            
            if (!matricula) {
                document.getElementById('colaboradorMatricula').classList.add('error');
                document.getElementById('colaboradorMatriculaError').style.display = 'block';
                isValid = false;
            } else if (isEditingColaborador) {
                if (colaboradores.some(c => c.matricula === matricula && c.id !== currentColaboradorId)) {
                    document.getElementById('colaboradorMatricula').classList.add('error');
                    document.getElementById('colaboradorMatriculaError').textContent = 'J√° existe um colaborador com esta matr√≠cula';
                    document.getElementById('colaboradorMatriculaError').style.display = 'block';
                    isValid = false;
                }
            } else {
                if (colaboradores.some(c => c.matricula === matricula)) {
                    document.getElementById('colaboradorMatricula').classList.add('error');
                    document.getElementById('colaboradorMatriculaError').textContent = 'J√° existe um colaborador com esta matr√≠cula';
                    document.getElementById('colaboradorMatriculaError').style.display = 'block';
                    isValid = false;
                }
            }
            
            return isValid;
        }
        // Fun√ß√£o principal para gerar romaneio com formata√ß√£o
        async function generateRomaneioExcelWithCustomFormat() {
            console.log('‚úÖ generateRomaneioExcelWithCustomFormat CHAMADA!'); 
    
            if (romaneioSelectedTools.length === 0) {
                showNotification('Selecione ferramentas primeiro!', 'error');
                return;
            }
    
            try {
        // Mostrar loader
        const loader = document.createElement('div');
        loader.className = 'loader';
        loader.style.display = 'block';
        loader.style.margin = '20px auto';
        document.querySelector('#romaneio .btn-group').appendChild(loader);
        
        // Obter configura√ß√µes do formul√°rio
        const title = document.getElementById('romaneioTitle').value || 'Romaneio de Ferramentas';
        const destination = document.getElementById('romaneioDestination').value || '';
        const responsible = document.getElementById('romaneioResponsible').value || '';
        const romaneioDate = document.getElementById('romaneioDate').value || new Date().toISOString().split('T')[0];
        const observations = document.getElementById('romaneioObservations').value || '';
        
        // Gerar n√∫mero do romaneio
        const romaneioNum = 'RM-' + new Date().getFullYear() + '-' + 
                           String(new Date().getTime()).slice(-6);
        
        // Filtrar ferramentas selecionadas
        const selectedTools = tools.filter(tool => 
            romaneioSelectedTools.includes(tool.id)
        );
        
        // Criar um NOVO workbook (em vez de carregar template)
        // Isso d√° mais controle sobre a formata√ß√£o
        const workbook = new ExcelJS.Workbook();
        
        // ============================================
        // CONFIGURA√á√ïES GERAIS DO WORKBOOK
        // ============================================
        workbook.creator = 'Sistema de Controle de Ferramentas';
        workbook.lastModifiedBy = currentUser?.name || 'Sistema';
        workbook.created = new Date();
        workbook.modified = new Date();
        
        // ============================================
        // CRIAR WORKSHEET "DI√ÅRIO"
        // ============================================
        const worksheet = workbook.addWorksheet('DI√ÅRIO', {
            pageSetup: {
            paperSize: 9, // A4
            orientation: 'portrait',
            margins: {
            left: 0.50, right: 0.50,
            top: 0.50, bottom: 0.50,
            header: 0.5, footer: 0.5
        }
    },
    properties: {
        defaultColWidth: 10,
        defaultRowHeight: 20
    }
});

        // ============================================
        // CONFIGURAR LARGURAS DAS COLUNAS (A-R)
        // ============================================
        const columnWidths = [];
        for (let i = 0; i < 18; i++) {
            const colLetter = String.fromCharCode(65 + i); // A a R
            let width = 5; // largura padr√£o
    
        // Configurar larguras espec√≠ficas baseadas no novo Excel
        switch (colLetter) {
        case 'A': width = 0; break;   // Coluna A vazia
        case 'B': width = 4; break;   // N¬∫
        case 'C': width = 9; break;  // DESCRI√á√ÉO DE MATERIAL
        case 'K': width = 7; break;  // FINAL DA DESCRI√á√ÉO
        case 'L': width = 10; break;  // N.C.M.
        case 'M': width = 10; break;  // N¬∫ PATR.
        case 'N': width = 5; break;   // QTD.
        case 'O': width = 12; break;  // DESCRI√á√ÉO
        case 'R': width = 13; break;  // VAL. UNIT
        default: width = 5; break;
    }
    
    columnWidths.push({ key: colLetter, width });
}
worksheet.columns = columnWidths;

        // ============================================
// DEFINI√á√ÉO DE ESTILOS (CORES E FONTES)
// ============================================
const styles = {
    headerMain: {
        font: {
            name: 'Arial',
            size: 18,
            bold: true,
            color: { argb: 'FFFFFF' }
        },
        fill: {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: '2C3E50' }
        },
        alignment: {
            horizontal: 'center',
            vertical: 'middle'
        },
        border: {
            top: { style: 'thin', color: { argb: '1C2C3C' } },
            bottom: { style: 'thin', color: { argb: '1C2C3C' } },
            left: { style: 'thin', color: { argb: '1C2C3C' } },
            right: { style: 'thin', color: { argb: '1C2C3C' } }
        }
    },
    
    sectionTitle: {
        font: {
            name: 'Arial',
            size: 11,
            bold: true,
            color: { argb: '2C3E50' }
        },
        fill: {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'ECF0F1' }
        },
        alignment: {
            vertical: 'middle'
        }
    },
    
    fieldLabel: {
        font: {
            name: 'Arial',
            size: 10,
            bold: true,
            color: { argb: '34495E' }
        }
    },
    
    fieldValue: {
        font: {
            name: 'Arial',
            size: 10,
            color: { argb: '2C3E50' }
        },
        fill: {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'F8F9FA' }
        }
    },
    
    tableHeader: {
        font: {
            name: 'Arial',
            size: 10,
            bold: true,
            color: { argb: 'FFFFFF' }
        },
        fill: {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: '3498DB' }
        },
        alignment: {
            horizontal: 'center',
            vertical: 'middle'
        },
        border: {
            top: { style: 'thin', color: { argb: '2980B9' } },
            bottom: { style: 'thin', color: { argb: '2980B9' } },
            left: { style: 'thin', color: { argb: '2980B9' } },
            right: { style: 'thin', color: { argb: '2980B9' } }
        }
    },
    
    tableRowEven: {
        font: {
            name: 'Arial',
            size: 10,
            color: { argb: '2C3E50' }
        },
        fill: {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF' }
        },
        border: {
            bottom: { style: 'thin', color: { argb: 'ECF0F1' } }
        }
    },
    
    tableRowOdd: {
        font: {
            name: 'Arial',
            size: 10,
            color: { argb: '2C3E50' }
        },
        fill: {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'F8F9FA' }
        },
        border: {
            bottom: { style: 'thin', color: { argb: 'ECF0F1' } }
        }
    },
    
    currency: {
        font: {
            name: 'Arial',
            size: 10,
            color: { argb: '27AE60' }
        },
        numFmt: '"R$" #,##0.00'
    },
    
    total: {
        font: {
            name: 'Arial',
            size: 11,
            bold: true,
            color: { argb: 'FFFFFF' }
        },
        fill: {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: '2C3E50' }
        }
    },
    
    observations: {
        font: {
            name: 'Arial',
            size: 10,
            italic: true,
            color: { argb: '7F8C8D' }
        }
    }
};

// ============================================
// FUN√á√ÉO AUXILIAR PARA DEFINIR ESTILO COM SEGURAN√áA
// ============================================
function safeSetStyle(cell, style) {
    if (cell) {
        cell.style = style;
        return true;
    }
    return false;
}

// ============================================
// PREENCHIMENTO DO ROMANEIO - NOVO LAYOUT
// ============================================

// Linha 2: ROMANEIO (mesclar B2:R2)
worksheet.mergeCells('B2:R2');
const titleCell = worksheet.getCell('B2');
titleCell.value = 'ROMANEIO';
Object.assign(titleCell, styles.headerMain); // CORRE√á√ÉO AQUI
worksheet.getRow(2).height = 30;

// Linha 3: N√∫mero do romaneio
worksheet.mergeCells('C3:E3');
const numLabelCell = worksheet.getCell('B3');
numLabelCell.value = 'N¬∫';
Object.assign(numLabelCell, styles.fieldLabel); // CORRE√á√ÉO AQUI
// Para ExcelJS, use assim:
numLabelCell.alignment = { horizontal: 'left', vertical: 'middle' };

const numValueCell = worksheet.getCell('C3');
numValueCell.value = romaneioNum || 'RM-2026-798754';
Object.assign(numValueCell, styles.fieldValue);

// DATA (coluna Q)
const dateLabelCell = worksheet.getCell('Q3');
dateLabelCell.value = 'DATA:';
Object.assign(dateLabelCell, styles.fieldLabel);
// Adicionar alinhamento √† esquerda:
dateLabelCell.alignment = { horizontal: 'left', vertical: 'middle' };

const dateValueCell = worksheet.getCell('R3');
dateValueCell.value = new Date(romaneioDate || '2026-01-23');
dateValueCell.numFmt = 'DD/MM/YYYY';
Object.assign(dateValueCell, styles.fieldValue);

// Linha 5: REMETENTE e DESTINAT√ÅRIO
worksheet.mergeCells('B5:C5');
const remetenteLabel = worksheet.getCell('B5');
remetenteLabel.value = 'REMETENTE:';
safeSetStyle(remetenteLabel, styles.sectionTitle);
remetenteLabel.alignment = { horizontal: 'left', vertical: 'middle' };

worksheet.mergeCells('D5:K5');
const remetenteValue = worksheet.getCell('D5');
remetenteValue.value = 'Delservin Com√©rcio e Servi√ßos Industriais Ltda-ME';
safeSetStyle(remetenteValue, styles.fieldValue);
remetenteValue.alignment = { horizontal: 'left', vertical: 'middle' };

worksheet.mergeCells('L5:M5');
const destinatarioLabel = worksheet.getCell('L5');
destinatarioLabel.value = 'DESTINAT√ÅRIO:';
safeSetStyle(destinatarioLabel, styles.sectionTitle);
destinatarioLabel.alignment = { horizontal: 'left', vertical: 'middle' };

// DESTINAT√ÅRIO - CORRE√á√ÉO COMPLETA:
worksheet.mergeCells('N5:R5');
const destinatarioValue = worksheet.getCell('N5');
destinatarioValue.value = destination || 'Galp√£o FW, Imperatriz-MA';
safeSetStyle(destinatarioValue, styles.fieldValue);
destinatarioValue.alignment = { horizontal: 'left', vertical: 'middle' };

// Linha 6: END. REMT. e CNPJ DEST.
worksheet.mergeCells('B6:C6');
const endRemLabel = worksheet.getCell('B6');
endRemLabel.value = 'END. REMT.:';
Object.assign(endRemLabel, styles.fieldLabel);
// Adicionar alinhamento √† esquerda:
endRemLabel.alignment = { horizontal: 'left', vertical: 'middle' };

worksheet.mergeCells('D6:K6');
const endRemValue = worksheet.getCell('D6');
endRemValue.value = 'Rua da Urca, 213 - Jd. Guanabara / Americana-SP';
Object.assign(endRemValue, styles.fieldValue);

worksheet.mergeCells('L6:M6');
const cnpjDestLabel = worksheet.getCell('L6');
cnpjDestLabel.value = 'CNPJ:';
Object.assign(cnpjDestLabel, styles.fieldLabel);
// Adicionar alinhamento √† esquerda:
cnpjDestLabel.alignment = { horizontal: 'left', vertical: 'middle' };

const cnpjDestValue = worksheet.getCell('N6');
cnpjDestValue.value = '';
Object.assign(cnpjDestValue, styles.fieldValue);
worksheet.mergeCells('N6:R6');

// Linha 7: CNPJ REM. e END. DEST.
worksheet.mergeCells('B7:C7');
const cnpjRemLabel = worksheet.getCell('B7');
cnpjRemLabel.value = 'CNPJ:';
Object.assign(cnpjRemLabel, styles.fieldLabel);
cnpjRemLabel.alignment = { horizontal: 'left', vertical: 'middle' };

worksheet.mergeCells('D7:K7');
const cnpjRemValue = worksheet.getCell('D7');
cnpjRemValue.value = '01.864.998/0001-35';
Object.assign(cnpjRemValue, styles.fieldValue);

worksheet.mergeCells('L7:M7');
const endDestLabel = worksheet.getCell('L7');
endDestLabel.value = 'END.:';
Object.assign(endDestLabel, styles.fieldLabel);
endDestLabel.alignment = { horizontal: 'left', vertical: 'middle' };

const endDestValue = worksheet.getCell('N7');
endDestValue.value = '';
Object.assign(endDestValue, styles.fieldValue);
worksheet.mergeCells('N7:R7');

// Linha 8: MOTORISTA e CEP DEST.
worksheet.mergeCells('B8:C8');
const motoristaLabel = worksheet.getCell('B8');
motoristaLabel.value = 'MOTORISTA:';
Object.assign(motoristaLabel, styles.fieldLabel);

// Adicionar alinhamento √† esquerda:
motoristaLabel.alignment = { horizontal: 'left', vertical: 'middle' };

worksheet.mergeCells('D8:K8');
const motoristaValue = worksheet.getCell('D8');
motoristaValue.value = responsible || 'Fabio Mendes R';
Object.assign(motoristaValue, styles.fieldValue);

worksheet.mergeCells('L8:M8');
const cepLabel = worksheet.getCell('L8');
cepLabel.value = 'CEP:';
Object.assign(cepLabel, styles.fieldLabel);
// Adicionar alinhamento √† esquerda:
cepLabel.alignment = { horizontal: 'left', vertical: 'middle' };

const cepValue = worksheet.getCell('N8');
cepValue.value = '';
Object.assign(cepValue, styles.fieldValue);
worksheet.mergeCells('N8:R8');

// Linha 9: TRANSPORTE e CEN. DE CUST.
worksheet.mergeCells('B9:C9');
const transporteLabel = worksheet.getCell('B9');
transporteLabel.value = 'TRANSPORTE:';
Object.assign(transporteLabel, styles.fieldLabel);
// Adicionar alinhamento √† esquerda:
transporteLabel.alignment = { horizontal: 'left', vertical: 'middle' };

worksheet.mergeCells('D9:K9');
const transporteValue = worksheet.getCell('D9');
transporteValue.value = '';
Object.assign(transporteValue, styles.fieldValue);

worksheet.mergeCells('L9:M9');
const centroCustoLabel = worksheet.getCell('L9');
centroCustoLabel.value = 'CEN. DE CUST.:';
Object.assign(centroCustoLabel, styles.fieldLabel);
// Adicionar alinhamento √† esquerda:
centroCustoLabel.alignment = { horizontal: 'left', vertical: 'middle' };

const centroCustoValue = worksheet.getCell('N9');
centroCustoValue.value = '';
Object.assign(centroCustoValue, styles.fieldValue);
worksheet.mergeCells('N9:R9');

// Linha 11: Cabe√ßalho da tabela
worksheet.getRow(11).height = 25;

// N¬∫ (B11)
const headerNum = worksheet.getCell('B11');
headerNum.value = 'N¬∫';
Object.assign(headerNum, styles.tableHeader);
headerNum.alignment = { horizontal: 'center', vertical: 'middle' }; // Centralizado

// DESCRI√á√ÉO DE MATERIAL (C11)
worksheet.mergeCells('C11:K11');
const headerDesc = worksheet.getCell('C11');
headerDesc.value = 'DESCRI√á√ÉO DE MATERIAL';
Object.assign(headerDesc, styles.tableHeader);
headerDesc.alignment = { horizontal: 'center', vertical: 'middle' }; // Centralizado

// N.C.M. (L11)
const headerNCM = worksheet.getCell('L11');
headerNCM.value = 'N.C.M.';
Object.assign(headerNCM, styles.tableHeader);
headerNCM.alignment = { horizontal: 'center', vertical: 'middle' }; // Centralizado

// N¬∫ PATR. (M11)
const headerPatrimonio = worksheet.getCell('M11');
headerPatrimonio.value = 'N¬∫ PATR.';
Object.assign(headerPatrimonio, styles.tableHeader);
headerPatrimonio.alignment = { horizontal: 'center', vertical: 'middle' }; // Centralizado

// QTD. (N11)
const headerQtd = worksheet.getCell('N11');
headerQtd.value = 'QTD.';
Object.assign(headerQtd, styles.tableHeader);
headerQtd.alignment = { horizontal: 'center', vertical: 'middle' }; // Centralizado

// DESCRI√á√ÉO (O11)
worksheet.mergeCells('O11:Q11');
const headerDesc2 = worksheet.getCell('O11');
headerDesc2.value = 'DESCRI√á√ÉO';
Object.assign(headerDesc2, styles.tableHeader);
headerDesc2.alignment = { horizontal: 'center', vertical: 'middle' }; // Centralizado

// VAL. UNIT (R11)
const headerValor = worksheet.getCell('R11');
headerValor.value = 'VAL. UNIT';
Object.assign(headerValor, styles.tableHeader);
headerValor.alignment = { horizontal: 'center', vertical: 'middle' }; // Centralizado

// ============================================
// DADOS DAS FERRAMENTAS (exemplo do Excel)
// ============================================
let currentRow = 12;
let totalValor = 0;
let totalQuantidade = 0;

// Se n√£o houver selectedTools, usar dados de exemplo do novo Excel
const toolsData = (selectedTools && selectedTools.length > 0) ? selectedTools : [
    { name: 'Carregador GAL 1880 CV', ncm: '8504.40.10', patrimonio: '1825-C', quantidade: 1, category: 'Ferramentas √† Bateria', preco: 0 },
    { name: 'Escada Plataforma 3 Degraus', ncm: '7326.90.00', patrimonio: '1828', quantidade: 1, category: 'Ferramentas Manuais', preco: 0 },
    { name: 'Esmerilhadeira Angular Bosch GWS 700 4\'', ncm: '', patrimonio: 'SN-1', quantidade: 1, category: 'M√°quinas', preco: 800 },
    { name: 'Furadeira Impacto 12 680W - Milwaukee', ncm: '', patrimonio: 'IP-1706', quantidade: 1, category: 'Ferramentas Manuais', preco: 1300 },
    { name: 'Furadeira Martelete Hilti t2', ncm: '8467.29.93', patrimonio: '0973', quantidade: 1, category: 'Ferramentas El√©tricas', preco: 0 },
    { name: 'M√°quina de Solda 200A MINI200', ncm: '', patrimonio: '0594', quantidade: 1, category: 'Ferramentas El√©tricas', preco: 2500 },
    { name: 'M√°quina de Solda 200A MINI200', ncm: '', patrimonio: 'IP-0655', quantidade: 1, category: 'M√°quinas', preco: 2000 },
    { name: 'Paleteira Hidr√°ulica TN 2500', ncm: '8428.90.90', patrimonio: '1847', quantidade: 1, category: 'Ve√≠culos', preco: 0 },
    { name: 'Serra Circular Bosch GKS 190 Professional 1400w', ncm: '', patrimonio: '1206', quantidade: 1, category: 'Ferramentas El√©tricas', preco: 2600 },
    { name: 'Serra Circular Bosch GKS 190 Professional 1400w', ncm: '', patrimonio: '', quantidade: 1, category: 'Ferramentas El√©tricas', preco: 2600 }
];

toolsData.forEach((tool, index) => {
    const row = worksheet.getRow(currentRow);
    row.height = 20;
    
    // Alternar cores das linhas (zebrado)
    const rowStyle = index % 2 === 0 ? styles.tableRowEven : styles.tableRowOdd;
    
    // N¬∫ sequencial (B)
    const cellNum = worksheet.getCell(`B${currentRow}`);
    cellNum.value = index + 1;
    safeSetStyle(cellNum, rowStyle);
    
    // DESCRI√á√ÉO DE MATERIAL (C-K)
    worksheet.mergeCells(`C${currentRow}:K${currentRow}`);
    const cellDesc = worksheet.getCell(`C${currentRow}`);
    cellDesc.value = tool.name;
    safeSetStyle(cellDesc, rowStyle);
    
    // N.C.M. (L)
    const cellNCM = worksheet.getCell(`L${currentRow}`);
    cellNCM.value = tool.ncm || '';
    safeSetStyle(cellNCM, rowStyle);
    
    // N¬∫ PATR. (M)
    const cellPatrimonio = worksheet.getCell(`M${currentRow}`);
    cellPatrimonio.value = tool.patrimonio || '';
    safeSetStyle(cellPatrimonio, rowStyle);
    
    // QTD. (N)
    const cellQtd = worksheet.getCell(`N${currentRow}`);
    const quantidade = tool.quantidade || 1;
    cellQtd.value = quantidade;
    safeSetStyle(cellQtd, rowStyle);
    totalQuantidade += quantidade;
    
    // DESCRI√á√ÉO (O-Q) - Categoria
    worksheet.mergeCells(`O${currentRow}:Q${currentRow}`);
    const cellCategoria = worksheet.getCell(`O${currentRow}`);
    cellCategoria.value = tool.category || '';
    safeSetStyle(cellCategoria, rowStyle);
    
    // VAL. UNIT (R)
    const cellValor = worksheet.getCell(`R${currentRow}`);
    const valor = tool.preco || 0;
    cellValor.value = valor;
    
    // Aplicar estilo de moeda com formata√ß√£o
    if (valor > 0) {
        cellValor.numFmt = '"R$" #,##0.00';
        const currencyStyle = { ...rowStyle };
        currencyStyle.font = currencyStyle.font || {};
        currencyStyle.font.color = { argb: '27AE60' }; // Verde para valores
        safeSetStyle(cellValor, currencyStyle);
    } else {
        safeSetStyle(cellValor, rowStyle);
    }
    
    totalValor += valor * quantidade;
    
    currentRow++;
});

    // ============================================
    // LINHA DE TOTAL
    // ============================================
    const totalRow = currentRow;
    worksheet.getRow(totalRow).height = 25;

    // Mesclar c√©lulas para o r√≥tulo TOTAL (B-P)
    worksheet.mergeCells(`B${totalRow}:Q${totalRow}`);
    const totalLabel = worksheet.getCell(`B${totalRow}`);
    totalLabel.value = 'TOTAL';
    safeSetStyle(totalLabel, styles.total);
    if (totalLabel.style) {
        totalLabel.style.alignment = { horizontal: 'right', vertical: 'middle' };
    }

    // Total valor (R)
    const totalValorCell = worksheet.getCell(`R${totalRow}`);
    totalValorCell.value = totalValor;
    safeSetStyle(totalValorCell, styles.total);
    totalValorCell.numFmt = '"R$" #,##0.00';
    if (totalValorCell.style) {
        totalValorCell.style.alignment = { horizontal: 'right', vertical: 'middle' };
    }

    // ============================================
    // OBSERVA√á√ïES
    // ============================================
    const obsRow = totalRow + 2;
    if (observations) {
        worksheet.mergeCells(`B${obsRow}:R${obsRow}`);
        const obsCell = worksheet.getCell(`B${obsRow}`);
        obsCell.value = `OBSERVA√á√ïES: ${observations}`;
        obsCell.style = styles.observations;
    } else {
        // Se n√£o houver observa√ß√µes, usar as do exemplo
        worksheet.mergeCells(`B${obsRow}:R${obsRow}`);
        const obsCell = worksheet.getCell(`B${obsRow}`);
        obsCell.value = `OBSERVA√á√ïES: Teste geral`;
        obsCell.style = styles.observations;
    }

    // ============================================
    // ASSINATURAS
    // ============================================
    const assinaturaRow = obsRow + 4;

    // Respons√°vel pelo romaneio
    worksheet.mergeCells(`B${assinaturaRow}:K${assinaturaRow}`);
    const respRomaneioCell = worksheet.getCell(`B${assinaturaRow}`);
    respRomaneioCell.value = 'Respons√°vel pelo Romaneio:';
    respRomaneioCell.style = {
        font: {
            name: 'Arial',
            size: 10,
            bold: true,
            color: { argb: '2C3E50' }
        }
    };

    // Linha para assinatura
    const linhaAssinatura = assinaturaRow + 3;
    worksheet.mergeCells(`B${linhaAssinatura}:K${linhaAssinatura}`);
    const linhaCell = worksheet.getCell(`B${linhaAssinatura}`);
    linhaCell.value = '________________________________________';
    linhaCell.style = {
        font: {
            name: 'Arial',
            size: 10,
            color: { argb: '95A5A6' }
        }
    };

    // Nome do respons√°vel
    const nomeRespRow = linhaAssinatura + 1;
    worksheet.mergeCells(`B${nomeRespRow}:K${nomeRespRow}`);
    const nomeRespCell = worksheet.getCell(`B${nomeRespRow}`);
    nomeRespCell.value = responsible || 'Fabio Mendes R';
    nomeRespCell.style = {
        font: {
            name: 'Arial',
            size: 10,
            color: { argb: '2C3E50' }
        }
    };

    // ============================================
    // ADICIONAR LOGOTIPO
    // ============================================
    try {
        // Adicionar logo da FW Company (canto superior esquerdo)
        const logoFWResponse = await fetch('FW Logo.png');
        const logoFWBuffer = await logoFWResponse.arrayBuffer();
        
        const imageIdFW = workbook.addImage({
            buffer: logoFWBuffer,
            extension: 'png'
        });
        
    // Posicionar logo FW (coluna B, linha 2)
    worksheet.addImage(imageIdFW, {
        tl: { col: 1, row: 1 }, // B2
        ext: { width: 90, height: 40 }
    });
    
    // Adicionar logo Delservin (canto superior direito)
    const logoDelservinResponse = await fetch('Delservin Logo.png');
    const logoDelservinBuffer = await logoDelservinResponse.arrayBuffer();
    
    const imageIdDelservin = workbook.addImage({
        buffer: logoDelservinBuffer,
        extension: 'png'
    });
    
    // Posicionar logo Delservin (coluna R, linha 2)
    worksheet.addImage(imageIdDelservin, {
        tl: { col: 17, row: 1 }, // R2 (16 = Q, pois A=0)
        ext: { width: 90, height: 40 }
    });
    
} catch (logoError) {
    console.log('Logos n√£o encontrados, continuando sem eles...');
    // Caso n√£o encontre os logos, podemos adicionar textos alternativos
    const fwTextCell = worksheet.getCell('A1');
    fwTextCell.value = 'FW';
    fwTextCell.style = {
        font: {
            name: 'Arial',
            size: 12,
            bold: true,
            color: { argb: '2C3E50' }
        }
    };
    
    const delservinTextCell = worksheet.getCell('N1');
    delservinTextCell.value = 'DELSERVIN';
    delservinTextCell.style = {
        font: {
            name: 'Arial',
            size: 10,
            bold: true,
            color: { argb: '2C3E50' }
        }
    };
}

    // ============================================
    // APLICAR FORMATA√á√ïES ADICIONAIS
    // ============================================

    // Ajustar alinhamento horizontal das c√©lulas
    for (let row = 1; row <= currentRow; row++) {
        const currentRowObj = worksheet.getRow(row);
        
    // N√∫meros sequenciais e quantidades centralizados
    const numCell = worksheet.getCell(`B${row}`);
    if (numCell && numCell.value !== undefined && numCell.value !== null) {
        numCell.alignment = { horizontal: 'center', vertical: 'middle' };
    }
    
    const qtdCell = worksheet.getCell(`N${row}`);
    if (qtdCell && qtdCell.value !== undefined && qtdCell.value !== null) {
        qtdCell.alignment = { horizontal: 'center', vertical: 'middle' };
    }
    
    // Valores alinhados √† direita
    const valorCell = worksheet.getCell(`R${row}`);
    if (valorCell && valorCell.value !== undefined && valorCell.value !== null) {
        valorCell.alignment = { horizontal: 'right', vertical: 'middle' };
    }
    
    // Categorias centralizadas
    const catCell = worksheet.getCell(`O${row}`);
    if (catCell && catCell.value !== undefined && catCell.value !== null) {
        catCell.alignment = { horizontal: 'center', vertical: 'middle' };
    }
}

    // Ajustar bordas finais
    const lastDataRow = totalRow;
    for (let col = 1; col <= 18; col++) {
        const colLetter = String.fromCharCode(64 + col);
        const cell = worksheet.getCell(`${colLetter}${lastDataRow}`);
        if (cell.style && cell.style.border) {
            cell.style.border.bottom = { style: 'medium', color: { argb: '2C3E50' } };
        }
    }
    
        console.log('Romaneio gerado com sucesso! Total: R$', totalValor);
        
        // ============================================
        // SALVAR ARQUIVO
        // ============================================
        const fileName = `ROMANEIO_${romaneioNum}_${title.replace(/[^a-z0-9]/gi, '_')}.xlsx`;
        
        // Gerar buffer e salvar
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { 
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        });
        
        saveAs(blob, fileName);
        
        // Remover loader
        loader.remove();
        
        // Registrar no hist√≥rico
        addToRomaneioHistory(title, selectedTools.length, totalValor);
        
        showNotification(`‚úÖ Romaneio "${title}" gerado com design personalizado!`, 'success');
        
        } catch (error) {
        console.error('Erro ao gerar romaneio formatado:', error);
        
        // Remover loader
        const loader = document.querySelector('#romaneio .loader');
        if (loader) loader.remove();
        
        showNotification(`Erro: ${error.message}`, 'error');
            }
        }

        // Atualizar o bot√£o de gerar romaneio para usar a nova fun√ß√£o
        document.getElementById('generateRomaneioBtn').addEventListener('click', generateRomaneioExcelWithCustomFormat);
        // Salvar colaborador
        async function saveColaborador() {
            if (!validateColaboradorForm()) {
                showNotification('Preencha todos os campos obrigat√≥rios!', 'error');
                return false;
            }
            
            // Verificar permiss√£o
            if (currentUser.role === 'user') {
                showNotification('Usu√°rio n√£o tem permiss√£o para salvar colaboradores.', 'error');
                return false;
            }
            
            try {
                const colaboradorData = getColaboradorFormData();
                
                if (isEditingColaborador && currentColaboradorId) {
                    await updateColaborador(currentColaboradorId, colaboradorData);
                } else {
                    await createColaborador(colaboradorData);
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar colaborador:', error);
                showNotification('Erro ao salvar colaborador.', 'error');
                return false;
            }
        }

        // Obter dados do formul√°rio de colaborador
        function getColaboradorFormData() {
            const usuario = currentUser ? currentUser.name : 'Sistema';
            
            return {
                nome: document.getElementById('colaboradorNome').value.trim(),
                matricula: document.getElementById('colaboradorMatricula').value.trim(),
                setor: document.getElementById('colaboradorSetor').value,
                cargo: document.getElementById('colaboradorCargo').value.trim(),
                telefone: document.getElementById('colaboradorTelefone').value.trim(),
                email: document.getElementById('colaboradorEmail').value.trim(),
                observacoes: document.getElementById('colaboradorObservacoes').value.trim(),
                dataCadastro: new Date().toISOString().split('T')[0],
                usuarioCadastro: usuario,
                ferramentasAtribuidas: isEditingColaborador ? 
                    (colaboradores.find(c => c.id === currentColaboradorId)?.ferramentasAtribuidas || []) : []
            };
        }

        // Criar novo colaborador
        async function createColaborador(colaboradorData) {
            const newColaborador = {
                id: Date.now(),
                ...colaboradorData,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            colaboradores.push(newColaborador);
            
            await saveColaboradores();
            
            updateColaboradoresList();
            showNotification('Colaborador cadastrado com sucesso!', 'success');
            clearColaboradorForm();
        }

        // Atualizar colaborador existente
        async function updateColaborador(colaboradorId, colaboradorData) {
            const colaboradorIndex = colaboradores.findIndex(c => c.id === colaboradorId);
            
            if (colaboradorIndex === -1) {
                showNotification('Colaborador n√£o encontrado!', 'error');
                return false;
            }
            
            // Manter ferramentas atribu√≠das
            const ferramentasAtribuidas = colaboradores[colaboradorIndex].ferramentasAtribuidas || [];
            
            const updatedColaborador = {
                ...colaboradores[colaboradorIndex],
                ...colaboradorData,
                ferramentasAtribuidas: ferramentasAtribuidas,
                updatedAt: new Date().toISOString()
            };
            
            colaboradores[colaboradorIndex] = updatedColaborador;
            
            await saveColaboradores();
            
            updateColaboradoresList();
            showNotification('Colaborador atualizado com sucesso!', 'success');
            clearColaboradorForm();
            
            return true;
        }

        // Limpar formul√°rio de colaborador
        function clearColaboradorForm() {
            document.getElementById('colaboradorForm').reset();
            document.getElementById('colaboradorId').value = '';
            document.getElementById('excluirColaboradorBtn').style.display = 'none';
            isEditingColaborador = false;
            currentColaboradorId = null;
            document.getElementById('salvarColaboradorBtn').innerHTML = '<i class="fas fa-save"></i> Salvar Colaborador';
        }

        // Editar colaborador
        function editColaborador(colaboradorId) {
            // Verificar permiss√£o
            if (currentUser.role === 'user') {
                showNotification('Usu√°rio n√£o tem permiss√£o para editar colaboradores.', 'error');
                return;
            }
            
            const colaborador = colaboradores.find(c => c.id === colaboradorId);
            if (!colaborador) return;
            
            // Preencher formul√°rio
            document.getElementById('colaboradorNome').value = colaborador.nome;
            document.getElementById('colaboradorMatricula').value = colaborador.matricula;
            document.getElementById('colaboradorSetor').value = colaborador.setor || '';
            document.getElementById('colaboradorCargo').value = colaborador.cargo || '';
            document.getElementById('colaboradorTelefone').value = colaborador.telefone || '';
            document.getElementById('colaboradorEmail').value = colaborador.email || '';
            document.getElementById('colaboradorObservacoes').value = colaborador.observacoes || '';
            document.getElementById('colaboradorId').value = colaborador.id;
            
            isEditingColaborador = true;
            currentColaboradorId = colaboradorId;
            
            document.getElementById('salvarColaboradorBtn').innerHTML = '<i class="fas fa-save"></i> Atualizar Colaborador';
            document.getElementById('excluirColaboradorBtn').style.display = 'inline-flex';
            
            showNotification('Editando colaborador. Atualize os dados.', 'warning');
        }

        // Excluir colaborador
        async function deleteColaborador(colaboradorId) {
            // Verificar permiss√£o
            if (currentUser.role === 'user') {
                showNotification('Usu√°rio n√£o tem permiss√£o para excluir colaboradores.', 'error');
                return;
            }
            
            const colaborador = colaboradores.find(c => c.id === colaboradorId);
            if (!colaborador) {
                showNotification('Colaborador n√£o encontrado!', 'error');
                return;
            }
            
            // Verificar se tem ferramentas atribu√≠das
            if (colaborador.ferramentasAtribuidas && colaborador.ferramentasAtribuidas.length > 0) {
                if (!confirm('Este colaborador tem ferramentas atribu√≠das. Deseja realmente excluir? As ferramentas ser√£o marcadas como dispon√≠veis.')) {
                    return;
                }
                
                // Remover atribui√ß√£o das ferramentas
                colaborador.ferramentasAtribuidas.forEach(toolId => {
                    const toolIndex = tools.findIndex(t => t.id === toolId);
                    if (toolIndex !== -1) {
                        tools[toolIndex].status = 'Dispon√≠vel';
                        // Remover do hist√≥rico
                        historicoAtribuicoes = historicoAtribuicoes.filter(h => 
                            !(h.colaboradorId === colaboradorId && h.toolId === toolId && !h.dataDevolucao)
                        );
                    }
                });
                
                await saveTools();
                await saveColaboradores();
            }
            
            // Remover colaborador
            colaboradores = colaboradores.filter(c => c.id !== colaboradorId);
            await saveColaboradores();
            
            // Se era o colaborador selecionado, limpar sele√ß√£o
            if (colaboradorSelecionado && colaboradorSelecionado.id === colaboradorId) {
                colaboradorSelecionado = null;
                updateAtribuicaoUI();
            }
            
            updateColaboradoresList();
            showNotification('Colaborador exclu√≠do com sucesso!', 'success');
            clearColaboradorForm();
        }

        // Atualizar lista de colaboradores
        function updateColaboradoresList(searchTerm = '') {
            const tbody = document.getElementById('colaboradoresTableBody');
            const noColaboradoresRow = document.getElementById('noColaboradoresRow');
            
            tbody.innerHTML = '';
            tbody.appendChild(noColaboradoresRow);
            
            let filteredColaboradores = colaboradores;
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredColaboradores = colaboradores.filter(colaborador => 
                    colaborador.nome.toLowerCase().includes(term) ||
                    colaborador.matricula.toLowerCase().includes(term) ||
                    (colaborador.setor && colaborador.setor.toLowerCase().includes(term)) ||
                    (colaborador.cargo && colaborador.cargo.toLowerCase().includes(term))
                );
            }
            
            if (filteredColaboradores.length === 0) {
                noColaboradoresRow.style.display = 'table-row';
                noColaboradoresRow.innerHTML = `<td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-color);">
                    Nenhum colaborador encontrado${searchTerm ? ' para "' + searchTerm + '"' : ''}
                </td>`;
                return;
            }
            
            noColaboradoresRow.style.display = 'none';
            
            filteredColaboradores.forEach(colaborador => {
                const row = document.createElement('tr');
                row.innerHTML = createColaboradorTableRow(colaborador);
                tbody.appendChild(row);
            });
            
            addColaboradorRowEventListeners();
        }

        // Criar linha da tabela de colaboradores
        function createColaboradorTableRow(colaborador) {
            const ferramentasCount = colaborador.ferramentasAtribuidas ? colaborador.ferramentasAtribuidas.length : 0;
            const statusClass = ferramentasCount > 0 ? 'status-ontrack' : 'status-completed';
            const statusText = ferramentasCount > 0 ? `${ferramentasCount} ferramentas` : 'Sem ferramentas';
            
            // Verificar permiss√µes para a√ß√µes
            const canEdit = currentUser.role !== 'user';
            
            return `
                <td><strong>${colaborador.nome}</strong></td>
                <td>${colaborador.matricula}</td>
                <td>${colaborador.setor || '-'}</td>
                <td>${colaborador.cargo || '-'}</td>
                <td>${colaborador.telefone || '-'}</td>
                <td>${colaborador.email || '-'}</td>
                <td>${ferramentasCount}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn action-btn-view" data-id="${colaborador.id}" title="Visualizar ferramentas">
                            <i class="fas fa-tools"></i>
                        </button>
                        <button class="action-btn action-btn-view" data-id="${colaborador.id}" title="Selecionar para atribui√ß√£o">
                            <i class="fas fa-user-check"></i>
                        </button>
                        ${canEdit ? `
                            <button class="action-btn action-btn-edit" data-id="${colaborador.id}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn action-btn-delete" data-id="${colaborador.id}" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
        }

        // Adicionar event listeners √†s linhas de colaboradores
        function addColaboradorRowEventListeners() {
            // Bot√£o para visualizar ferramentas
            document.querySelectorAll('.action-btn-view').forEach(btn => {
                if (btn.querySelector('.fa-tools')) {
                    btn.addEventListener('click', function() {
                        const colaboradorId = parseInt(this.getAttribute('data-id'));
                        viewColaboradorFerramentas(colaboradorId);
                    });
                }
            });
            
            // Bot√£o para selecionar para atribui√ß√£o
            document.querySelectorAll('.action-btn-view').forEach(btn => {
                if (btn.querySelector('.fa-user-check')) {
                    btn.addEventListener('click', function() {
                        const colaboradorId = parseInt(this.getAttribute('data-id'));
                        selectColaboradorForAtribuicao(colaboradorId);
                    });
                }
            });
            
            // Bot√£o para editar colaborador
            document.querySelectorAll('.action-btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const colaboradorId = parseInt(this.getAttribute('data-id'));
                    editColaborador(colaboradorId);
                });
            });
            
            // Bot√£o para excluir colaborador
            document.querySelectorAll('.action-btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const colaboradorId = parseInt(this.getAttribute('data-id'));
                    deleteColaborador(colaboradorId);
                });
            });
        }

        // Visualizar ferramentas do colaborador
        function viewColaboradorFerramentas(colaboradorId) {
            const colaborador = colaboradores.find(c => c.id === colaboradorId);
            if (!colaborador) return;
            
            const modalBody = document.getElementById('ferramentasColaboradorBody');
            
            let ferramentasHTML = '';
            
            if (colaborador.ferramentasAtribuidas && colaborador.ferramentasAtribuidas.length > 0) {
                ferramentasHTML = `
                    <h4 style="margin-bottom: 20px;">${colaborador.nome} - Ferramentas Atribu√≠das</h4>
                    <div class="tools-list">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th>Data Atribui√ß√£o</th>
                                        <th>Observa√ß√£o</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                colaborador.ferramentasAtribuidas.forEach(toolId => {
                    const tool = tools.find(t => t.id === toolId);
                    if (tool) {
                        const atribuicao = historicoAtribuicoes.find(h => 
                            h.colaboradorId === colaboradorId && 
                            h.toolId === toolId && 
                            !h.dataDevolucao
                        );
                        
                        ferramentasHTML += `
                            <tr>
                                <td><strong>${tool.code}</strong></td>
                                <td>${tool.name}</td>
                                <td>${tool.category}</td>
                                <td>${atribuicao ? formatDate(atribuicao.dataAtribuicao) : '-'}</td>
                                <td>${atribuicao && atribuicao.observacao ? atribuicao.observacao : '-'}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn action-btn-view" onclick="viewToolDetails(${tool.id})" title="Ver detalhes">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="action-btn action-btn-danger" onclick="devolverFerramenta(${colaboradorId}, ${tool.id})" title="Devolver ferramenta">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                });
                
                ferramentasHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                ferramentasHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-tools" style="font-size: 60px; color: var(--gray-color); margin-bottom: 20px;"></i>
                        <h3>Nenhuma ferramenta atribu√≠da</h3>
                        <p>Este colaborador n√£o possui ferramentas atribu√≠das no momento.</p>
                    </div>
                `;
            }
            
            modalBody.innerHTML = ferramentasHTML;
            document.getElementById('ferramentasColaboradorModal').style.display = 'flex';
        }

        // Devolver ferramenta do colaborador (CORRIGIDA)
        async function devolverFerramenta(colaboradorId, toolId) {
        // Verificar permiss√£o
        if (currentUser.role === 'user') {
        showNotification('Usu√°rio n√£o tem permiss√£o para devolver ferramentas.', 'error');
        return;
        }
    
        const colaborador = colaboradores.find(c => c.id === colaboradorId);
        const tool = tools.find(t => t.id === toolId);
    
        if (!colaborador || !tool) {
        showNotification('Colaborador ou ferramenta n√£o encontrada!', 'error');
        return;
        }
    
        if (!confirm(`Devolver "${tool.name}" do colaborador ${colaborador.nome}?`)) {
        return;
    }
    
        try {
        // Atualizar status da ferramenta para "Dispon√≠vel"
        tool.status = 'Dispon√≠vel';
        
        // Remover ferramenta da lista do colaborador
        colaborador.ferramentasAtribuidas = colaborador.ferramentasAtribuidas.filter(id => id !== toolId);
        
        // Atualizar hist√≥rico de atribui√ß√µes
        const atribuicaoIndex = historicoAtribuicoes.findIndex(h => 
            h.colaboradorId === colaboradorId && 
            h.toolId === toolId && 
            !h.dataDevolucao
        );
        
        if (atribuicaoIndex !== -1) {
            historicoAtribuicoes[atribuicaoIndex].dataDevolucao = new Date().toISOString().split('T')[0];
            historicoAtribuicoes[atribuicaoIndex].usuarioDevolucao = currentUser.name;
        }
        
        // Salvar altera√ß√µes
        await saveTools();
        await saveColaboradores();
        
        // Atualizar interfaces
        updateColaboradoresList();
        updateAtribuicaoUI();
        loadToolsList(currentStatusFilter); // Atualiza lista de ferramentas
        loadFerramentasDisponiveis(); // Atualiza lista de dispon√≠veis
        updateLocalAtribuicoesCount(); // ADICIONE ESTA LINHA
        // Fechar modal se estiver aberto
        document.getElementById('ferramentasColaboradorModal').style.display = 'none';
        
        showNotification(`Ferramenta "${tool.name}" devolvida com sucesso!`, 'success');
        
        } catch (error) {
        console.error('Erro ao devolver ferramenta:', error);
        showNotification('Erro ao devolver ferramenta.', 'error');
        }
    }

        // Selecionar colaborador para atribui√ß√£o
        function selectColaboradorForAtribuicao(colaboradorId) {
            colaboradorSelecionado = colaboradores.find(c => c.id === colaboradorId);
            
            if (!colaboradorSelecionado) {
                showNotification('Colaborador n√£o encontrado!', 'error');
                return;
            }
            
            updateAtribuicaoUI();
            loadFerramentasDisponiveis();
        }

        // Atualizar interface de atribui√ß√£o
        function updateAtribuicaoUI() {
            const atribuicaoContainer = document.getElementById('atribuicaoContainer');
            const semColaborador = document.getElementById('semColaboradorSelecionado');
            
            if (colaboradorSelecionado) {
                atribuicaoContainer.style.display = 'block';
                semColaborador.style.display = 'none';
                
                document.getElementById('colaboradorSelecionadoNome').textContent = colaboradorSelecionado.nome;
                document.getElementById('colaboradorSelecionadoMatricula').textContent = colaboradorSelecionado.matricula;
                
                const ferramentasCount = colaboradorSelecionado.ferramentasAtribuidas ? colaboradorSelecionado.ferramentasAtribuidas.length : 0;
                document.getElementById('colaboradorFerramentasAtuais').textContent = `${ferramentasCount} ferramentas atribu√≠das`;
                
                // Verificar limite de 20 ferramentas
                if (ferramentasCount >= 20) {
                    document.getElementById('atribuirFerramentaBtn').disabled = true;
                    document.getElementById('atribuirFerramentaBtn').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Limite Atingido (20)';
                    showNotification('Este colaborador j√° atingiu o limite de 20 ferramentas!', 'warning');
                } else {
                    document.getElementById('atribuirFerramentaBtn').disabled = false;
                    document.getElementById('atribuirFerramentaBtn').innerHTML = '<i class="fas fa-link"></i> Atribuir Ferramenta';
                }
                
            } else {
                atribuicaoContainer.style.display = 'none';
                semColaborador.style.display = 'block';
            }
            
            // Configurar data atual
            document.getElementById('dataAtribuicao').value = new Date().toISOString().split('T')[0];
        }

        // Carregar ferramentas dispon√≠veis para atribui√ß√£o (CORRIGIDA)
           function loadFerramentasDisponiveis() {
            const select = document.getElementById('ferramentaParaAtribuir');
            select.innerHTML = '<option value="">Selecione uma ferramenta</option>';
    
           if (!colaboradorSelecionado) return;
    
        // Identificar quais ferramentas j√° est√£o atribu√≠das a QUALQUER colaborador
            const todasFerramentasAtribuidas = [];
    
        colaboradores.forEach(colaborador => {
        if (colaborador.ferramentasAtribuidas && colaborador.ferramentasAtribuidas.length > 0) {
            todasFerramentasAtribuidas.push(...colaborador.ferramentasAtribuidas);
        }
    });
    
        // Filtrar ferramentas:
            // 1. Que est√£o dispon√≠veis OU em uso (porque se j√° est√° em uso, significa que est√° com algu√©m)
        // 2. E que N√ÉO est√£o atribu√≠das a nenhum colaborador atualmente
        tools
        .filter(tool => {
            // Verificar se a ferramenta N√ÉO est√° na lista de ferramentas atribu√≠das
            const naoAtribuida = !todasFerramentasAtribuidas.includes(tool.id);
            
            // Verificar se est√° dispon√≠vel ou reservada (n√£o em uso)
            const statusValido = tool.status === 'Dispon√≠vel' || tool.status === 'Reservado';
            
            return naoAtribuida && statusValido;
        })
        .forEach(tool => {
            const option = document.createElement('option');
            option.value = tool.id;
            option.textContent = `${tool.code} - ${tool.name} (${tool.category}) | ${tool.status}`;
            select.appendChild(option);
        });
    
        // Se n√£o houver ferramentas dispon√≠veis
        if (select.options.length === 1) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "Nenhuma ferramenta dispon√≠vel para atribui√ß√£o";
        option.disabled = true;
        option.selected = true;
        select.appendChild(option);
        }
    }

        // Atribuir ferramenta ao colaborador
        async function atribuirFerramenta() {
        // Verificar permiss√£o
        if (currentUser.role === 'user') {
        showNotification('Usu√°rio n√£o tem permiss√£o para atribuir ferramentas.', 'error');
        return;
    }
    
        if (!colaboradorSelecionado) {
        showNotification('Selecione um colaborador primeiro!', 'error');
        return;
    }
    
    const toolId = parseInt(document.getElementById('ferramentaParaAtribuir').value);
    const dataAtribuicao = document.getElementById('dataAtribuicao').value;
    const observacao = document.getElementById('observacaoAtribuicao').value.trim();
    
    if (!toolId) {
        showNotification('Selecione uma ferramenta!', 'error');
        return;
    }
    
    const tool = tools.find(t => t.id === toolId);
    if (!tool) {
        showNotification('Ferramenta n√£o encontrada!', 'error');
        return;
    }
    
    // Verificar limite de 20 ferramentas
    const ferramentasCount = colaboradorSelecionado.ferramentasAtribuidas ? colaboradorSelecionado.ferramentasAtribuidas.length : 0;
    if (ferramentasCount >= 20) {
        showNotification('Este colaborador j√° atingiu o limite de 20 ferramentas!', 'error');
        return;
    }
    
    try {
        // Atualizar status da ferramenta
        tool.status = 'Em Uso';
        
        // Adicionar ferramenta √† lista do colaborador
        if (!colaboradorSelecionado.ferramentasAtribuidas) {
            colaboradorSelecionado.ferramentasAtribuidas = [];
        }
        colaboradorSelecionado.ferramentasAtribuidas.push(toolId);
        
        // Adicionar ao hist√≥rico de atribui√ß√µes
        const historicoItem = {
            id: Date.now(),
            colaboradorId: colaboradorSelecionado.id,
            colaboradorNome: colaboradorSelecionado.nome,
            toolId: toolId,
            toolNome: tool.name,
            toolCodigo: tool.code,
            dataAtribuicao: dataAtribuicao,
            observacao: observacao,
            usuarioAtribuicao: currentUser.name,
            dataDevolucao: null,
            usuarioDevolucao: null
        };
        
        historicoAtribuicoes.push(historicoItem);
        
        // Salvar altera√ß√µes
        await saveTools();
        await saveColaboradores();
        
        // Atualizar interfaces
        updateColaboradoresList();
        updateAtribuicaoUI();
        loadToolsList(currentStatusFilter);
        updateLocalAtribuicoesCount(); // ADICIONE ESTA LINHA
        
        // Limpar formul√°rio de atribui√ß√£o
        document.getElementById('ferramentaParaAtribuir').value = '';
        document.getElementById('observacaoAtribuicao').value = '';
        document.getElementById('dataAtribuicao').value = new Date().toISOString().split('T')[0];
        
        showNotification(`Ferramenta "${tool.name}" atribu√≠da a ${colaboradorSelecionado.nome}!`, 'success');
        
    } catch (error) {
        console.error('Erro ao atribuir ferramenta:', error);
        showNotification('Erro ao atribuir ferramenta.', 'error');
    }
}

        // ============================================
        // M√ìDULO 3: FUNCIONALIDADES AVAN√áADAS
        // ============================================

        // SISTEMA DE VISUALIZA√á√ÉO DE IMAGEM AMPLIADA

        // Fun√ß√£o para visualizar imagem ampliada
        function viewEnlargedImage(toolId) {
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            
            // Verificar se a imagem existe
            if (!tool.image) {
                viewToolDetails(toolId);
                return;
            }
            
            // Remover qualquer modal de imagem existente
            const existingModal = document.querySelector('.image-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Criar modal para imagem ampliada
            const modal = document.createElement('div');
            modal.className = 'modal image-modal';
            
            modal.innerHTML = `
                <div style="position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background-color: rgba(0, 0, 0, 0.95);">
                    <div style="position: relative; max-width: 90vw; max-height: 90vh;">
                        <button class="image-modal-close" id="closeImageModalBtn" style="position: absolute; top: 20px; right: 20px; background: rgba(128, 128, 128, 0.7); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                <i class="fas fa-times"></i>
                </button>
                        <img src="${tool.image}" 
                             alt="${tool.name}" 
                             style="max-width: 100%; max-height: 85vh; object-fit: contain; border-radius: 8px; cursor: pointer;">
                        <div class="image-caption">
                            <h4>${tool.name}</h4>
                            <p>${tool.code} | ${tool.category}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            
            // Fechar modal ao clicar no bot√£o
            modal.querySelector('#closeImageModalBtn').addEventListener('click', function() {
                modal.remove();
            });
            
            // Fechar modal ao clicar fora da imagem
            modal.addEventListener('click', function(e) {
                if (e.target === modal || e.target.classList.contains('image-modal')) {
                    modal.remove();
                }
            });
            
            // Fechar com ESC
            const closeOnEsc = function(e) {
                if (e.key === 'Escape') {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                    document.removeEventListener('keydown', closeOnEsc);
                }
            };
            
            document.addEventListener('keydown', closeOnEsc);
        }


        // Adicionar event listeners para miniaturas
        function addThumbnailEventListeners() {
            // Remover event listeners anteriores para evitar duplica√ß√£o
            document.querySelectorAll('.tool-thumbnail').forEach(img => {
                img.replaceWith(img.cloneNode(true));
            });
            
            // Para miniaturas com imagem
            document.querySelectorAll('.tool-thumbnail').forEach(img => {
                img.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const toolId = parseInt(this.getAttribute('data-id'));
                    viewEnlargedImage(toolId);
                });
            });
            
            // Para placeholders sem imagem
            document.querySelectorAll('.no-image-placeholder').forEach(placeholder => {
                placeholder.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const toolId = parseInt(this.getAttribute('data-id'));
                    viewToolDetails(toolId);
                });
            });
        }

        // Atualize a fun√ß√£o addRowEventListeners para incluir as miniaturas:
        function addRowEventListeners() {
            // Adicionar eventos para as miniaturas primeiro
            addThumbnailEventListeners();
            
            // Depois os eventos existentes
            document.querySelectorAll('.action-btn-view').forEach(btn => {
                // Verificar se √© bot√£o de visualiza√ß√£o (n√£o QR code)
                if (!btn.title.includes('QR')) {
                    btn.addEventListener('click', function() {
                        const toolId = parseInt(this.getAttribute('data-id'));
                        viewToolDetails(toolId);
                    });
                }
            });
            
            document.querySelectorAll('.action-btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const toolId = parseInt(this.getAttribute('data-id'));
                    editTool(toolId);
                });
            });
            
            document.querySelectorAll('.action-btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const toolId = parseInt(this.getAttribute('data-id'));
                    deleteTool(toolId);
                });
            });
        }

        // Fun√ß√£o para baixar PDFs dos mapas
        function downloadMapPDF() {
            // Criar modal de sele√ß√£o
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
    
            modal.innerHTML = `
            <div style="background: white; border-radius: 12px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--light-color); padding-bottom: 15px;">
                <h3 style="color: var(--primary-color); margin: 0;">
                    <i class="fas fa-file-pdf"></i> Baixar Mapa em PDF
                </h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; color: var(--gray-color); cursor: pointer;">
                    &times;
                </button>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500; color: var(--primary-color);">
                    <i class="fas fa-map"></i> Selecione o mapa para baixar:
                </label>
                <select id="pdfMapSelector" style="width: 100%; padding: 12px 15px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 16px; background: white; color: var(--text-color);">
                    <option value="">-- Selecione um mapa --</option>
                    <option value="container_eletrico">Container de Ferramentas El√©tricas</option>
                    <option value="almoxarifado_central">Almoxarifado Central</option>
                </select>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid var(--warning-color);">
                <p style="margin: 0; color: var(--text-color); font-size: 14px;">
                    <i class="fas fa-info-circle"></i> Os arquivos PDF ser√£o baixados do servidor local.
                </p>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 15px;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; background: var(--light-color); border: none; border-radius: 6px; color: var(--text-color); cursor: pointer;">
                    Cancelar
                </button>
                <button onclick="confirmPDFDownload()" style="padding: 10px 20px; background: var(--danger-color); border: none; border-radius: 6px; color: white; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-download"></i> Baixar PDF
                </button>
            </div>
        </div>
    `;
    
            document.body.appendChild(modal);
    
            // Fechar ao clicar fora
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

            // Fun√ß√£o para confirmar e baixar o PDF
            function confirmPDFDownload() {
                const selector = document.getElementById('pdfMapSelector');
                const selectedMap = selector.value;
    
            if (!selectedMap) {
        showNotification('Selecione um mapa primeiro!', 'error');
        return;
    }
    
        // Definir nomes dos arquivos PDF
        const pdfFiles = {
        'container_eletrico': 'Container de Ferramentas El√©tricas (Mapa).pdf',
        'almoxarifado_central': 'Almoxarifado Central (Mapa).pdf'
    };
    
    const fileName = pdfFiles[selectedMap];
    
    // Remover o modal
    document.querySelector('.modal').remove();
    
    // Tentar baixar o arquivo
    try {
        // Criar link para download
        const link = document.createElement('a');
        link.href = fileName;
        link.download = fileName;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification(`Download iniciado: ${fileName}`, 'success');
        
        } catch (error) {
            console.error('Erro ao baixar PDF:', error);
        
        // Se falhar, mostrar mensagem de ajuda
        showNotification(`Arquivo n√£o encontrado: ${fileName}`, 'error');
        
        // Mostrar ajuda
            setTimeout(() => {
            showNotification('Verifique se o arquivo PDF est√° na mesma pasta do sistema', 'warning');
        }, 1500);
    }
}

        // ============================================
        // FUN√á√ïES PARA A ABA MAPEAMENTO
        // ============================================

        // Fun√ß√£o para visualizar mapa completo
        function viewMapDetails(mapId) {
        const mapModalBody = document.getElementById('mapModalBody');
    
        if (mapId === 'container_eletrico') {
        mapModalBody.innerHTML = `
            <h3 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">
                <i class="fas fa-map-marked-alt"></i> Container de Ferramentas El√©tricas - Mapa Completo
            </h3>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <p><strong>Dimens√µes:</strong> 2.35m / 7ft de altura</p>
                <p><strong>Organiza√ß√£o:</strong> 4 prateleiras L (esquerda) + 10 prateleiras R (direita)</p>
                <p><strong>Total de posi√ß√µes:</strong> 70 posi√ß√µes identificadas (a-e em cada prateleira)</p>
                <p><strong>Data do Mapa:</strong> √öltima atualiza√ß√£o: ${new Date().toLocaleDateString('pt-BR')}</p>
            </div>
            
            <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                <!-- Mapa em imagem -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="position: relative; display: inline-block; max-width: 100%;">
                        <img id="mapImage" 
         src="mapa_container_eletrico.png"  // ‚Üê SEU NOME REAL AQUI
         alt="Mapa do Container de Ferramentas El√©tricas" 
         style="max-width: 100%; max-height: 600px; border-radius: 8px; border: 2px solid var(--border-color); cursor: zoom-in;"
         onclick="zoomMapImage()"
         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgdmlld0JveD0iMCAwIDgwMCA2MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiBmaWxsPSIjRjVGN0ZBIi8+Cjx0ZXh0IHg9IjUwJSIgeT0iMzAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5NUE1QTYiPk1hcGEgbmFvIGNhcnJlZ2FkbzwvdGV4dD4KPHRleHQgeD0iNTAlIiB5PSI1MCUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWxseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5NUE1QTYiPm1hcGFfY29udGFpbmVyX2VsZXRyaWNvLnBuZzwvdGV4dD4KPC9zdmc+';">
                        <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px;">
                            <i class="fas fa-search-plus"></i> Clique para ampliar
                        </div>
                    </div>
                    <p style="margin-top: 10px; color: var(--gray-color); font-size: 14px;">
                        Clique na imagem para visualizar em tela cheia
                    </p>
                </div>
                
                <!-- Controles da imagem -->
                <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-primary" onclick="zoomInMap()">
                        <i class="fas fa-search-plus"></i> Aumentar Zoom
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="zoomOutMap()">
                        <i class="fas fa-search-minus"></i> Diminuir Zoom
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="resetMapZoom()">
                        <i class="fas fa-sync-alt"></i> Zoom Original
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="rotateMapImage()">
                        <i class="fas fa-redo"></i> Girar 90¬∞
                    </button>
                </div>
                
                <!-- Legenda do Mapa -->
                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h5 style="color: var(--primary-color); margin-bottom: 10px;">
                        <i class="fas fa-info-circle"></i> Legenda do Mapa
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 4px;"></div>
                            <span><strong>L1-L4:</strong> Prateleiras Esquerda</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 4px;"></div>
                            <span><strong>R1-R10:</strong> Prateleiras Direita</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background-color: #e8f5e9; border: 1px solid #81c784; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px;">a-e</div>
                            <span><strong>Posi√ß√µes:</strong> Cada prateleira tem 5 posi√ß√µes (a,b,c,d,e)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background-color: #fff3e0; border: 1px solid #ffb74d; border-radius: 4px;"></div>
                            <span><strong>Zona de Acesso:</strong> √Årea para movimenta√ß√£o</span>
                        </div>
                    </div>
                </div>
                
                <!-- Detalhes da Organiza√ß√£o -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <h5 style="color: var(--secondary-color); margin-bottom: 10px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px;">
                            <i class="fas fa-layer-group"></i> Prateleiras L (Esquerda)
                        </h5>
                        <ul style="padding-left: 20px;">
                            <li><strong>L1:</strong> Ferramentas leves e acess√≥rios</li>
                            <li><strong>L2:</strong> Equipamentos de medi√ß√£o</li>
                            <li><strong>L3:</strong> Ferramentas manuais especiais</li>
                            <li><strong>L4:</strong> Reserva e componentes</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h5 style="color: var(--secondary-color); margin-bottom: 10px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px;">
                            <i class="fas fa-layer-group"></i> Prateleiras R (Direita)
                        </h5>
                        <ul style="padding-left: 20px;">
                            <li><strong>R1-R3:</strong> Ferramentas el√©tricas principais</li>
                            <li><strong>R4-R6:</strong> Equipamentos √† bateria</li>
                            <li><strong>R7-R8:</strong> M√°quinas estacion√°rias</li>
                            <li><strong>R9-R10:</strong> Acess√≥rios e consum√≠veis</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Bot√µes de A√ß√£o -->
                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                    
                    <button class="btn btn-primary" onclick="downloadMapImage()">
                        <i class="fas fa-download"></i> Baixar Imagem
                    </button>
                    <button class="btn btn-warning" onclick="assignItemsToPositions()">
                        <i class="fas fa-tasks"></i> Atribuir Itens
                    </button>
                    <button class="btn btn-info" onclick="showMapQRCode()">
                        <i class="fas fa-qrcode"></i> QR Code do Mapa
                    </button>
                </div>
            </div>
        `;
        
        // Inicializar controles de zoom
        initializeMapControls();
        } else if (mapId === 'almoxarifado_central') {
           mapModalBody.innerHTML = `
        <h3 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">
            <i class="fas fa-warehouse"></i> Almoxarifado Central - Mapa Completo
        </h3>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <p><strong>Dimens√µes:</strong> 10.4m / 34ft</p>
            <p><strong>Organiza√ß√£o:</strong> 5 Se√ß√µes (A-E) + 15 Ruas (A-H)</p>
            <p><strong>Total de posi√ß√µes:</strong> 70+ posi√ß√µes identificadas</p>
            <p><strong>Data do Mapa:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
        </div>
        
        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="position: relative; display: inline-block; max-width: 100%;">
                    <img id="mapImage" 
                         src="mapa_almoxarifado_central.png" 
                         alt="Mapa do Almoxarifado Central" 
                         style="max-width: 100%; max-height: 600px; border-radius: 8px; border: 2px solid var(--border-color); cursor: zoom-in;"
                         onclick="zoomMapImage()"
                         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgdmlld0JveD0iMCAwIDgwMCA2MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiBmaWxsPSIjRjVGN0ZBIi8+Cjx0ZXh0IHg9IjUwJSIgeT0iMzAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5NUE1QTYiPk1hcGEgbmFvIGNhcnJlZ2FkbzwvdGV4dD4KPHRleHQgeD0iNTAlIiB5PSI1MCUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWxseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5NUE1QTYiPm1hcGFfYW1veGFyaWZhZG9fY2VudHJhbC5wbmc8L3RleHQ+Cjwvc3ZnPg==';">
                    <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px;">
                        <i class="fas fa-search-plus"></i> Clique para ampliar
                    </div>
                </div>
                <p style="margin-top: 10px; color: var(--gray-color); font-size: 14px;">
                    Clique na imagem para visualizar em tela cheia
                </p>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                <button class="btn btn-sm btn-primary" onclick="zoomInMap()">
                    <i class="fas fa-search-plus"></i> Aumentar Zoom
                </button>
                <button class="btn btn-sm btn-primary" onclick="zoomOutMap()">
                    <i class="fas fa-search-minus"></i> Diminuir Zoom
                </button>
                <button class="btn btn-sm btn-secondary" onclick="resetMapZoom()">
                    <i class="fas fa-sync-alt"></i> Zoom Original
                </button>
                <button class="btn btn-sm btn-warning" onclick="rotateMapImage()">
                    <i class="fas fa-redo"></i> Girar 90¬∞
                </button>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                
                <button class="btn btn-primary" onclick="downloadMapImage()">
                    <i class="fas fa-download"></i> Baixar Imagem
                </button>
                <button class="btn btn-warning" onclick="assignItemsToPositions()">
                    <i class="fas fa-tasks"></i> Atribuir Itens
                </button>
                <button class="btn btn-info" onclick="showMapQRCode()">
                    <i class="fas fa-qrcode"></i> QR Code do Mapa
                </button>
            </div>
        </div>
    `;
    
    // Inicializar controles de zoom
    initializeMapControls();
    } else {
        // C√≥digo para outros mapas permanece o mesmo...
        mapModalBody.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-map-marked-alt" style="font-size: 60px; color: var(--gray-color); margin-bottom: 20px;"></i>
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">Mapa em Desenvolvimento</h3>
                <p style="color: var(--gray-color); margin-bottom: 25px;">O mapa para este local ainda n√£o foi configurado.</p>
                <button class="btn btn-primary" onclick="addNewMap('${mapId}')">
                    <i class="fas fa-plus-circle"></i> Criar Mapa para este Local
                </button>
            </div>
        `;
    }
    
    document.getElementById('mapModal').style.display = 'flex';
}

        // Vari√°veis para controle do zoom e rota√ß√£o
        let mapZoomLevel = 1;
        let mapRotation = 0;

        // Inicializar controles do mapa
        function initializeMapControls() {
            mapZoomLevel = 1;
            mapRotation = 0;
            updateMapImage();
        }

        // Atualizar imagem do mapa com transforma√ß√µes
        function updateMapImage() {
            const mapImage = document.getElementById('mapImage');
            if (mapImage) {
                mapImage.style.transform = `scale(${mapZoomLevel}) rotate(${mapRotation}deg)`;
                mapImage.style.transition = 'transform 0.3s ease';
            }
        }

        // Zoom in
        function zoomInMap() {
           if (mapZoomLevel < 3) {
                mapZoomLevel += 0.1;
                updateMapImage();
            }
        }

        // Zoom out
        function zoomOutMap() {
            if (mapZoomLevel > 0.5) {
                mapZoomLevel -= 0.1;
                updateMapImage();
            }
        }

        // Reset zoom
        function resetMapZoom() {
            mapZoomLevel = 1;
            mapRotation = 0;
            updateMapImage();
        }

        // Rotacionar imagem
        function rotateMapImage() {
            mapRotation += 90;
            if (mapRotation >= 360) {
        mapRotation = 0;
            }
            updateMapImage();
        }

        // Visualizar imagem em tela cheia
        function zoomMapImage() {
        const mapImage = document.getElementById('mapImage');
            if (mapImage) {
                viewEnlargedImageObject(mapImage.src, 'Mapa do Container de Ferramentas El√©tricas');
           }
        }

        // Fun√ß√£o gen√©rica para visualizar imagem ampliada
        function viewEnlargedImageObject(imageSrc, title) {
            // Remover qualquer modal de imagem existente
            const existingModal = document.querySelector('.image-modal');
            if (existingModal) {
                existingModal.remove();
            }
    
            // Criar modal para imagem ampliada
            const modal = document.createElement('div');
            modal.className = 'modal image-modal';
    
            modal.innerHTML = `
                <div style="position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background-color: rgba(0, 0, 0, 0.95);">
                    <div style="position: relative; max-width: 95vw; max-height: 95vh;">
                        <button class="image-modal-close" id="closeImageModalBtn" style="position: absolute; top: 20px; right: 20px; background: rgba(128, 128, 128, 0.8); border: 2px solid rgba(255, 255, 255, 0.5); color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 26px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.4);">
            <i class="fas fa-times"></i>
        </button>
                        <img src="${imageSrc}" 
                             alt="${title}" 
                             style="max-width: 95vw; max-height: 95vh; object-fit: contain; border-radius: 8px; cursor: pointer;">
                        <div class="image-caption">
                            <h4>${title}</h4>
                            <p>Container de Ferramentas El√©tricas | Dimens√µes: 2.35m x 7ft</p>
                        </div>
                    </div>
                </div>
            `;
    
            document.body.appendChild(modal);
            modal.style.display = 'flex';
    
            // Fechar modal ao clicar no bot√£o
            modal.querySelector('#closeImageModalBtn').addEventListener('click', function() {
                modal.remove();
            });
    
            // Fechar modal ao clicar fora da imagem
            modal.addEventListener('click', function(e) {
                if (e.target === modal || e.target.classList.contains('image-modal')) {
                    modal.remove();
                }
            });
    
            // Fechar com ESC
            const closeOnEsc = function(e) {
                if (e.key === 'Escape') {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                    document.removeEventListener('keydown', closeOnEsc);
                }
            };
    
            document.addEventListener('keydown', closeOnEsc);
        }

        // Baixar imagem do mapa
        function downloadMapImage() {
            const mapImage = document.getElementById('mapImage');
            if (mapImage) {
                const link = document.createElement('a');
                link.download = `mapa_container_eletrico_${new Date().toISOString().slice(0, 10)}.jpg`;
                link.href = mapImage.src;
               link.click();
                showNotification('Imagem do mapa baixada!', 'success');
            } else {
                showNotification('Imagem n√£o encontrada.', 'error');
            }
        }

        // Mostrar QR Code do mapa
        function showMapQRCode() {
            const qrContent = JSON.stringify({
                mapa: 'Container de Ferramentas El√©tricas',
                dimensoes: '2.35m x 7ft',
                prateleiras_l: 4,
                prateleiras_r: 10,
                posicoes: 70,
                data_atualizacao: new Date().toISOString().split('T')[0],
                url_imagem: document.getElementById('mapImage')?.src || ''
            }, null, 2);
    
            const qrModalBody = document.getElementById('qrModalBody');
            qrModalBody.innerHTML = `
                <div class="qrcode-container">
                    <h4 style="margin-bottom: 20px;">QR Code do Mapa</h4>
                    <p style="margin-bottom: 15px;">Container de Ferramentas El√©tricas</p>
                    <div id="qrcodeCanvas" style="margin: 0 auto 20px;"></div>
                    <p style="margin-top: 20px; color: var(--gray-color); font-size: 14px;">
                        Use este QR Code para acessar o mapa digitalmente.
                    </p>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="downloadQRCodeBtn">
                            <i class="fas fa-download"></i> Baixar QR Code
                        </button>
                        <button class="btn btn-success" id="printQRCodeBtn">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                    </div>
                </div>
            `;
    
        // Gerar QR Code
        QRCode.toCanvas(document.getElementById('qrcodeCanvas'), qrContent, {
            width: 200,
            margin: 2,
            color: { dark: '#000000', light: '#FFFFFF' }
        });
    
        // Configurar bot√µes
        document.getElementById('downloadQRCodeBtn').onclick = function() {
            const canvas = document.querySelector('#qrcodeCanvas canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = `QRCode_Mapa_Container_Eletrico.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        };
        
        document.getElementById('printQRCodeBtn').onclick = function() {
            window.print();
        };
        
        document.getElementById('qrModal').style.display = 'flex';
    }

        // Gerar HTML para as prateleiras
        function generateShelvesHTML(side, count) {
            let html = '';
            const colors = side === 'L' 
                ? ['#e3f2fd', '#bbdefb', '#90caf9', '#64b5f6']
                : ['#f3e5f5', '#e1bee7', '#ce93d8', '#ba68c8'];
            
            for (let i = 1; i <= count; i++) {
                const colorIndex = (i - 1) % colors.length;
                html += `
                    <div style="background-color: ${colors[colorIndex]}; border: 1px solid ${colors[colorIndex].replace(')', ', 0.8)').replace('rgb', 'rgba')}; border-radius: 6px; padding: 12px; text-align: center;">
                        <div style="font-weight: bold; margin-bottom: 8px; color: var(--primary-color);">
                            ${side}${i}
                        </div>
                        <div style="display: flex; justify-content: center; gap: 5px; font-size: 12px;">
                            <span style="background-color: white; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">a</span>
                            <span style="background-color: white; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">b</span>
                            <span style="background-color: white; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">c</span>
                            <span style="background-color: white; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">d</span>
                            <span style="background-color: white; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">e</span>
                        </div>
                        <div style="font-size: 11px; color: var(--gray-color); margin-top: 5px;">
                            ${getRandomItemCount()} itens
                        </div>
                    </div>
                `;
            }
            return html;
        }

        // Fun√ß√£o auxiliar para n√∫mero aleat√≥rio de itens
        function getRandomItemCount() {
            const counts = [0, 1, 2, 3, 4, 5];
            return counts[Math.floor(Math.random() * counts.length)];
        }

        // Adicionar novo mapa
        function addNewMap(mapId = '') {
            showNotification('Funcionalidade em desenvolvimento.', 'info');
        }


        // Exportar mapa para PDF
        function exportMapToPDF() {
            showNotification('Exporta√ß√£o para PDF em desenvolvimento.', 'info');
        }

        // Atribuir itens a posi√ß√µes
        function assignItemsToPositions() {
            showNotification('Funcionalidade de atribui√ß√£o em desenvolvimento.', 'info');
        }

        // ============================================
        // FUN√á√ïES DE AUTENTICA√á√ÉO
        // ============================================

        // Fun√ß√£o de login
        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            // Verificar credenciais
            let user = null;
            let userKey = null;
            
            // Verificar por email
            if (users[email]) {
                user = users[email];
                userKey = email;
            }
            
            // Se n√£o encontrou por email, tentar por nome de usu√°rio
            if (!user && email === 'fwuser') {
                user = users['fwuser'];
                userKey = 'fwuser';
            }
            
            if (user && user.password === password) {
                // Login bem-sucedido
                currentUser = {
                    ...user,
                    key: userKey
                };
                
                // Salvar sess√£o
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // SEMPRE usar as credenciais fixas do Supabase
                dbConfig = FIXED_SUPABASE_CONFIG;
                localStorage.setItem('supabaseConfig', JSON.stringify(dbConfig));
                
                // Mostrar dashboard
                showDashboard();
                
                // Configurar interface baseada no perfil
                setupUserInterface();
                
                // Inicializar sistema - PARA TODOS OS USU√ÅRIOS
                initializeSystem();

                // 11. Inicializar modo noturno
                initializeDarkMode();
                
            } else {
                // Login falhou
                errorDiv.classList.add('show');
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 3000);
            }
        }

        // Logout
        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                showLogin();
            }
        }
        // ============================================
        // SISTEMA DE MODO NOTURNO
        // ============================================

        // Verificar prefer√™ncia salva
        function checkDarkModePreference() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            return isDarkMode;
        }

        // Aplicar modo noturno
        function applyDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('modeToggleBtn').innerHTML = '<i class="fas fa-sun"></i>';
                document.getElementById('modeToggleBtn').title = 'Alternar para modo claro';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('modeToggleBtn').innerHTML = '<i class="fas fa-moon"></i>';
                document.getElementById('modeToggleBtn').title = 'Alternar para modo escuro';
                // ===== MODO NOTURNO =====
                document.getElementById('modeToggleBtn').addEventListener('click', toggleDarkMode);
            }

            // Salvar prefer√™ncia
            localStorage.setItem('darkMode', isDark);

            // Atualizar gr√°ficos se existirem
            updateChartsForDarkMode(isDark);
        }

        // Alternar modo
        function toggleDarkMode() {
            const isCurrentlyDark = document.body.classList.contains('dark-mode');
            applyDarkMode(!isCurrentlyDark);

            // Feedback visual
            const icon = document.querySelector('#modeToggleBtn i');
            icon.style.transform = 'rotate(360deg)';
            icon.style.transition = 'transform 0.5s ease';

            setTimeout(() => {
                icon.style.transform = 'rotate(0deg)';
            }, 500);

            showNotification(`Modo ${!isCurrentlyDark ? 'escuro' : 'claro'} ativado`, 'info');
        }

        // Atualizar gr√°ficos para modo escuro
        function updateChartsForDarkMode(isDark) {
            if (chartInstance) {
                // Atualizar cores do gr√°fico
                chartInstance.options.plugins.tooltip.backgroundColor = isDark ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.8)';
                chartInstance.options.plugins.tooltip.titleColor = isDark ? '#e0e0e0' : '#2c3e50';
                chartInstance.options.plugins.tooltip.bodyColor = isDark ? '#e0e0e0' : '#2c3e50';

                chartInstance.update();
            }
        }

        // Inicializar modo noturno
        function initializeDarkMode() {
            const isDarkMode = checkDarkModePreference();
            applyDarkMode(isDarkMode);

            // Detectar prefer√™ncia do sistema
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

            // Se for a primeira vez, usar prefer√™ncia do sistema
            if (localStorage.getItem('darkMode') === null) {
                applyDarkMode(prefersDarkScheme.matches);
            }

            // Escutar mudan√ßas na prefer√™ncia do sistema
            prefersDarkScheme.addEventListener('change', (e) => {
                if (localStorage.getItem('darkMode') === null) {
                    applyDarkMode(e.matches);
                }
            });
        }
        // Verificar sess√£o ativa
        function checkSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    
                    // Verificar se o usu√°rio ainda existe
                    if (users[currentUser.key] && users[currentUser.key].password === currentUser.password) {
                        // Configurar dbConfig com credenciais fixas
                        dbConfig = FIXED_SUPABASE_CONFIG;
                        
                        showDashboard();
                        setupUserInterface();
                        initializeSystem();
                        return;
                    }
                } catch (e) {
                    console.error('Erro ao restaurar sess√£o:', e);
                }
            }
            
            // Se n√£o houver sess√£o v√°lida, mostrar login
            showLogin();
        }

        // Mostrar tela de login
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('fixedCloudUploadBtn').style.display = 'none';
            
            // Limpar campos
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Mostrar dashboard
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            
            // Atualizar informa√ß√µes do usu√°rio
            if (currentUser) {
                document.getElementById('userWelcomeText').textContent = `Bem-vindo, ${currentUser.name}`;
                document.getElementById('userRoleBadge').textContent = getRoleDisplayName(currentUser.role);
                document.getElementById('userRoleBadge').className = `user-badge ${getRoleBadgeClass(currentUser.role)}`;
            }
        }

        // Configurar interface baseada no perfil
        function setupUserInterface() {
            if (!currentUser) return;
            
            const role = currentUser.role;
            
            // Esconder elementos baseado no perfil
            const cadastroTab = document.getElementById('cadastroTab');
            const databaseTab = document.getElementById('databaseTab');
            const backupCard = document.getElementById('backupCard');
            const storageInfo = document.getElementById('storageInfo');
            const imageCaptureContainer = document.getElementById('imageCaptureContainer');
            
            switch(role) {
                case 'dev':
                    // Acesso total - mostrar tudo
                    cadastroTab.classList.remove('hidden');
                    databaseTab.classList.remove('hidden');
                    if (backupCard) backupCard.classList.remove('hidden');
                    if (storageInfo) storageInfo.classList.remove('hidden');
                    if (imageCaptureContainer) imageCaptureContainer.classList.remove('hidden');
                    break;
                    
                case 'almoxarife':
                    // Acesso: Dashboard, Cadastro, Cat√°logo, Exportar
                    cadastroTab.classList.remove('hidden');
                    databaseTab.classList.add('hidden');
                    if (backupCard) backupCard.classList.add('hidden');
                    if (storageInfo) storageInfo.classList.remove('hidden');
                    if (imageCaptureContainer) imageCaptureContainer.classList.remove('hidden');
                    break;
                    
                case 'user':
                    // Acesso: Dashboard, Cat√°logo, Exportar (apenas consulta)
                    cadastroTab.classList.add('hidden');
                    databaseTab.classList.add('hidden');
                    if (backupCard) backupCard.classList.add('hidden');
                    if (storageInfo) storageInfo.classList.add('hidden');
                    if (imageCaptureContainer) imageCaptureContainer.classList.add('hidden');
                    
                    // Desabilitar a√ß√µes nos formul√°rios
                    const formElements = document.querySelectorAll('#toolForm input, #toolForm select, #toolForm textarea');
                    formElements.forEach(el => el.disabled = true);
                    
                    // Esconder bot√µes de a√ß√£o no cat√°logo
                    const actionButtons = document.querySelectorAll('.action-btn-edit, .action-btn-delete');
                    actionButtons.forEach(btn => btn.style.display = 'none');
                    break;
            }
        }

        // Fun√ß√µes auxiliares para perfis
        function getRoleDisplayName(role) {
            switch(role) {
                case 'dev': return 'DEV';
                case 'almoxarife': return 'Almoxarife';
                case 'user': return 'Usu√°rio';
                default: return 'Usu√°rio';
            }
        }

        function getRoleBadgeClass(role) {
            switch(role) {
                case 'dev': return 'status-completed';
                case 'almoxarife': return 'status-ontrack';
                case 'user': return 'status-delayed';
                default: return '';
            }
        }

        // ============================================
        // FUN√á√ïES PRINCIPAIS DO SISTEMA
        // ============================================

        // Inicializar sistema com conex√£o autom√°tica
        async function initializeSystem() {
            try {
                console.log('üîß INICIALIZANDO SISTEMA para:', currentUser?.email);
                
                // 1. Adicionar campo oculto para usu√°rio
                const usuarioField = document.createElement('input');
                usuarioField.type = 'hidden';
                usuarioField.id = 'usuarioCadastroField';
                usuarioField.value = currentUser ? currentUser.name : 'Sistema';
                document.getElementById('toolForm').appendChild(usuarioField);
                
                // 2. Carregar dados locais
                await loadInitialTools();
                console.log('üìÅ Dados locais carregados:', tools.length, 'itens');
                
                // 3. Carregar colaboradores
                loadColaboradores();
                console.log('üë• Colaboradores carregados:', colaboradores.length);
                
                // 4. Verificar status do IndexedDB
                await updateIndexedDBStatus();
                
                // 5. ATUALIZAR INTERFACE INICIAL
                updateHeaderStats();
                updateStatistics();
                loadToolsList();
                updateColaboradoresList();
                updateLocalAtribuicoesCount(); // ADICIONE ESTA LINHA
                 // 5. Inicializar sistema de romaneio
                initializeRomaneioListeners();
                loadRomaneioTemplates();
                // 6. Configurar data atual
                document.getElementById('dataCadastro').value = new Date().toISOString().split('T')[0];
                document.getElementById('dataAtribuicao').value = new Date().toISOString().split('T')[0];
                
                // 7. SEMPRE tentar conectar ao Supabase com credenciais fixas
                console.log('‚òÅÔ∏è Conectando automaticamente ao Supabase...');
                console.log('URL:', FIXED_SUPABASE_CONFIG.url);
                
                const connected = await setupSupabaseClient();
                
                if (connected) {
                    console.log('‚úÖ Conectado ao Supabase! Buscando dados...');
                    
                    // 8. Para TODOS os usu√°rios, buscar dados da nuvem
                    setTimeout(async () => {
                        try {
                            const fetched = await fetchFromSupabase();
                            if (fetched) {
                                console.log('‚úÖ Dados sincronizados da nuvem');
                                lastSyncTime = new Date();
                                updateConnectionStatus();
                            }
                        } catch (syncError) {
                            console.error('‚ùå Erro na sincroniza√ß√£o autom√°tica:', syncError);
                        }
                    }, 1000);
                    
                } else {
                    console.log('‚ö†Ô∏è Modo local ativo');
                    showNotification('Modo local ativo.', 'info');
                }
                
                // 9. Mostrar bot√£o de enviar para nuvem (se tiver permiss√£o)
                showCloudUploadButton();
                
                // 10. Atualizar status da conex√£o
                updateConnectionStatus();
                
                showNotification('Sistema inicializado!', 'success');
                console.log('‚úÖ Sistema inicializado com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                showNotification('Erro ao inicializar.', 'error');
            }
        }

        // Mostrar bot√£o de enviar para nuvem
        function showCloudUploadButton() {
            const cloudUploadBtn = document.getElementById('fixedCloudUploadBtn');
            
            // Mostrar apenas se usu√°rio tiver permiss√£o
            if (currentUser.role !== 'user') {
                cloudUploadBtn.style.display = 'flex';
            } else {
                cloudUploadBtn.style.display = 'none';
            }
        }

        // Verificar status do IndexedDB
        function checkIndexedDBStatus() {
            return new Promise((resolve) => {
                if (!window.indexedDB) {
                    resolve({ available: false, status: 'N√£o suportado' });
                    return;
                }

                const request = indexedDB.open('testConnection', 1);
                let dbConnected = false;

                request.onsuccess = () => {
                    dbConnected = true;
                    request.result.close();
                    resolve({ available: true, status: 'Conectado' });
                };

                request.onerror = () => {
                    resolve({ available: false, status: 'Erro' });
                };

                request.onblocked = () => {
                    resolve({ available: false, status: 'Bloqueado' });
                };

                // Timeout para detectar se est√° muito lento
                setTimeout(() => {
                    if (!dbConnected) {
                        resolve({ available: false, status: 'Timeout' });
                    }
                }, 1000);
            });
        }

        // Fun√ß√£o para atualizar o status do IndexedDB na interface
        async function updateIndexedDBStatus() {
            try {
                const status = await checkIndexedDBStatus();
                const statusElement = document.getElementById('indexedDBStatus');
                
                if (status.available && status.status === 'Conectado') {
                    statusElement.textContent = 'Conectado';
                    statusElement.className = 'status-badge status-completed';
                } else {
                    statusElement.textContent = 'Desconectado';
                    statusElement.className = 'status-badge status-delayed';
                }
                
                return status.available;
            } catch (error) {
                console.error('Erro ao verificar IndexedDB:', error);
                const statusElement = document.getElementById('indexedDBStatus');
                statusElement.textContent = 'Erro';
                statusElement.className = 'status-badge status-delayed';
                return false;
            }
        }

        // ============================================
        // DADOS DE EXEMPLO
        // ============================================

        function getExampleTools() {
            return [
                {
                    id: 1,
                    name: 'Martelo de Borracha',
                    code: 'MART-001',
                    patrimonio: 'PAT-2023-001',
                    ncm: '8205.70.00',
                    category: 'Ferramentas Manuais',
                    status: 'Dispon√≠vel',
                    location: 'Almoxarifado Central',
                    condition: 'Bom',
                    notaFiscal: 'NF-2023-001234',
                    unidade: 'UN',
                    preco: 45.90,
                    quantidade: 5,
                    estoqueMinimo: 2,
                    estoqueMaximo: 10,
                    dataCadastro: '2023-10-15',
                    description: 'Martelo de borracha para montagens delicadas',
                    observations: 'Novo em folha',
                    image: null,
                    usuarioCadastro: 'Sistema',
                    dataHoraCadastro: '2023-10-15T10:30:00Z',
                    createdAt: '2023-10-15T10:30:00Z',
                    updatedAt: '2023-10-15T10:30:00Z'
                },
                {
                    id: 2,
                    name: 'Parafusadeira El√©trica',
                    code: 'PARAF-001',
                    patrimonio: 'PAT-2023-002',
                    ncm: '8467.21.00',
                    category: 'Ferramentas El√©tricas',
                    status: 'Em Uso',
                    location: 'Oficina',
                    condition: 'Novo',
                    notaFiscal: 'NF-2023-001235',
                    unidade: 'UN',
                    preco: 289.90,
                    quantidade: 3,
                    estoqueMinimo: 1,
                    estoqueMaximo: 5,
                    dataCadastro: '2023-10-16',
                    description: 'Parafusadeira el√©trica 18V com bateria',
                    observations: 'Em uso pelo t√©cnico Jo√£o',
                    image: null,
                    usuarioCadastro: 'Emerson Silva',
                    dataHoraCadastro: '2023-10-16T14:20:00Z',
                    createdAt: '2023-10-16T14:20:00Z',
                    updatedAt: '2023-10-16T14:20:00Z'
                },
                {
                    id: 3,
                    name: 'Capacete de Seguran√ßa',
                    code: 'EPI-001',
                    patrimonio: 'PAT-2023-003',
                    ncm: '6506.10.00',
                    category: 'EPI',
                    status: 'Dispon√≠vel',
                    location: 'Container Mec√¢nica',
                    condition: 'Bom',
                    notaFiscal: 'NF-2023-001236',
                    unidade: 'UN',
                    preco: 89.50,
                    quantidade: 12,
                    estoqueMinimo: 5,
                    estoqueMaximo: 20,
                    dataCadastro: '2023-10-17',
                    description: 'Capacete de seguran√ßa industrial',
                    observations: 'Com jugular ajust√°vel',
                    image: null,
                    usuarioCadastro: 'F√°bio Mendes',
                    dataHoraCadastro: '2023-10-17T09:15:00Z',
                    createdAt: '2023-10-17T09:15:00Z',
                    updatedAt: '2023-10-17T09:15:00Z'
                }
            ];
        }

        // Carregar dados iniciais
        async function loadInitialTools() {
            try {
                const localData = localStorage.getItem('tools');
                if (localData) {
                    tools = JSON.parse(localData) || [];
                } else {
                    tools = getExampleTools();
                    await saveTools();
                }
                
                updateStorageInfo();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                tools = getExampleTools();
            }
        }

        // Salvar dados localmente
        async function saveTools() {
            try {
                localStorage.setItem('tools', JSON.stringify(tools));
                updateStorageInfo();
                updateConnectionStatus();
                return true;
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                showNotification('Erro ao salvar dados localmente.', 'error');
                return false;
            }
        }

        // Configurar cliente Supabase
        async function setupSupabaseClient() {
            try {
                console.log('üõ†Ô∏è Configurando cliente Supabase...');
                console.log('URL:', FIXED_SUPABASE_CONFIG.url);
                console.log('KEY:', FIXED_SUPABASE_CONFIG.key ? 'Presente' : 'Ausente');
                
                // Verificar credenciais
                if (!FIXED_SUPABASE_CONFIG.url || !FIXED_SUPABASE_CONFIG.key) {
                    console.error('‚ùå Credenciais ausentes');
                    return false;
                }
                
                // Criar cliente
                supabaseClient = supabase.createClient(FIXED_SUPABASE_CONFIG.url, FIXED_SUPABASE_CONFIG.key);
                isOnlineMode = true;
                
                console.log('üîå Testando conex√£o...');
                const connectionResult = await testSupabaseConnection();
                console.log('Resultado do teste:', connectionResult);
                
                if (connectionResult.success) {
                    document.getElementById('storageStatus').textContent = 'Online';
                    document.getElementById('storageStatus').className = 'status-badge status-completed';
                    
                    console.log('‚úÖ Conectado ao Supabase com sucesso!');
                    showNotification('Conectado √† nuvem!', 'success');
                    
                    // Atualizar info do banco
                    updateDatabaseInfo();
                    updateConnectionStatus();
                    
                    return true;
                } else {
                    isOnlineMode = false;
                    console.error('‚ùå Falha na conex√£o:', connectionResult.message);
                    showNotification(`Falha: ${connectionResult.message}`, 'error');
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao configurar Supabase:', error);
                isOnlineMode = false;
                showNotification('Erro de conex√£o com a nuvem.', 'error');
                return false;
            }
        }

        // Testar conex√£o com Supabase
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabaseClient
                    .from('tools')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    if (error.message.includes('does not exist')) {
                        return { success: false, message: 'Tabela n√£o existe.' };
                    }
                    throw error;
                }
                
                return { success: true, message: 'Conex√£o estabelecida!' };
            } catch (error) {
                return { success: false, message: `Erro: ${error.message}` };
            }
        }

        // ============================================
        // FUN√á√ÉO CORRIGIDA: BUSCAR DADOS DO SUPABASE
        // ============================================

        // Buscar dados do Supabase (CORRIGIDA)
        async function fetchFromSupabase() {
            try {
                // Verificar se est√° conectado
                if (!isOnlineMode || !supabaseClient) {
                    showNotification('N√£o conectado √† nuvem.', 'warning');
                    return false;
                }
                
                const limit = parseInt(document.getElementById('syncLimit')?.value) || 100;
                
                console.log(`üîÑ Buscando at√© ${limit} itens do Supabase...`);
                
                const { data, error } = await supabaseClient
                    .from('tools')
                    .select('*')
                    .order('updated_at', { ascending: false })
                    .limit(limit);
                
                if (error) {
                    if (error.message.includes('does not exist')) {
                        showNotification('Tabela n√£o existe no banco de dados.', 'error');
                        return false;
                    }
                    throw error;
                }
                
                if (data && data.length > 0) {
                    console.log(`üì• ${data.length} itens recebidos do Supabase`);
                    
                    // Converter para formato local
                    const convertedTools = data.map(item => ({
                        id: item.id || Date.now(),
                        name: item.name,
                        code: item.code,
                        patrimonio: item.patrimonio,
                        ncm: item.ncm,
                        category: item.category,
                        status: item.status,
                        location: item.location,
                        condition: item.condition,
                        notaFiscal: item.nota_fiscal,
                        unidade: item.unidade,
                        preco: item.preco,
                        quantidade: item.quantidade,
                        estoqueMinimo: item.estoque_minimo,
                        estoqueMaximo: item.estoque_maximo,
                        description: item.description,
                        observations: item.observations,
                        image: item.image_url,
                        usuarioCadastro: item.usuario_cadastro || 'Sistema',
                        dataCadastro: item.data_cadastro,
                        createdAt: item.created_at,
                        updatedAt: item.updated_at
                    }));
                    
                    // CORRE√á√ÉO PRINCIPAL: Mesclar dados corretamente
                    // 1. Criar mapa dos dados da nuvem pelo c√≥digo
                    const cloudMap = new Map();
                    convertedTools.forEach(tool => {
                        cloudMap.set(tool.code, tool);
                    });
                    
                    // 2. Atualizar itens existentes e adicionar novos
                    let updatedCount = 0;
                    let addedCount = 0;
                    
                    tools.forEach((localTool, index) => {
                        const cloudTool = cloudMap.get(localTool.code);
                        if (cloudTool) {
                            // Se j√° existe localmente, atualiza com dados da nuvem
                            tools[index] = {
                                ...localTool,
                                ...cloudTool,
                                id: localTool.id, // Mant√©m o ID local
                                updatedAt: new Date().toISOString()
                            };
                            updatedCount++;
                            cloudMap.delete(localTool.code); // Remove do mapa para n√£o adicionar novamente
                        }
                    });
                    
                    // 3. Adicionar itens que n√£o existiam localmente
                    const newTools = Array.from(cloudMap.values());
                    if (newTools.length > 0) {
                        tools = [...tools, ...newTools];
                        addedCount = newTools.length;
                    }
                    
                    // 4. Salvar e atualizar interface
                    await saveTools();
                    updateInterface();
                    lastSyncTime = new Date();
                    updateConnectionStatus();
                    
                    if (updatedCount > 0 || addedCount > 0) {
                        showNotification(`${updatedCount} itens atualizados, ${addedCount} novos adicionados da nuvem!`, 'success');
                        console.log(`‚úÖ ${updatedCount} atualizados, ${addedCount} novos`);
                    } else {
                        showNotification('Dados j√° sincronizados.', 'info');
                    }
                    
                    return true;
                } else {
                    showNotification('Nenhum dado encontrado na nuvem.', 'info');
                    return false;
                }
            } catch (error) {
                console.error('Erro ao buscar do Supabase:', error);
                showNotification(`Erro ao buscar dados: ${error.message}`, 'error');
                return false;
            }
        }

        // ============================================
        // FUN√á√ïES DE INTERFACE
        // ============================================

        // Atualizar cabe√ßalho
        function updateHeaderStats() {
            document.getElementById('totalTools').textContent = tools.length;
            
            // Calcular valor total
            const totalValue = tools.reduce((sum, tool) => {
                const preco = parseFloat(tool.preco) || 0;
                const quantidade = parseInt(tool.quantidade) || 1;
                return sum + (preco * quantidade);
            }, 0);
            
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('pt-BR');
        }

        // Atualizar informa√ß√µes de armazenamento
        function updateStorageInfo() {
            const storageInfoText = document.getElementById('storageInfoText');
            if (storageInfoText) {
                const dataSize = JSON.stringify(tools).length;
                const sizeKB = Math.round(dataSize / 1024);
                storageInfoText.textContent = `Itens: ${tools.length} | Tamanho: ${sizeKB} KB`;
            }
        }

        // Atualizar estat√≠sticas
        function updateStatistics() {
            const total = tools.length;
            
            if (total === 0) {
                resetStats();
                return;
            }
            
            const availableCount = tools.filter(tool => tool.status === 'Dispon√≠vel').length;
            const inUseCount = tools.filter(tool => tool.status === 'Em Uso').length;
            const maintenanceCount = tools.filter(tool => tool.status === 'Manuten√ß√£o').length;
            const damagedCount = tools.filter(tool => tool.status === 'Danificado').length;
            
            updateProgressBars(total, availableCount, inUseCount, maintenanceCount, damagedCount);
            updateValueStats();
            updateLowStockItems();
            updateLocationChart();
        }

        function resetStats() {
            document.getElementById('availablePercent').textContent = '0%';
            document.getElementById('inUsePercent').textContent = '0%';
            document.getElementById('maintenancePercent').textContent = '0%';
            document.getElementById('damagedPercent').textContent = '0%';
            
            document.getElementById('availableBar').style.width = '0%';
            document.getElementById('inUseBar').style.width = '0%';
            document.getElementById('maintenanceBar').style.width = '0%';
            document.getElementById('damagedBar').style.width = '0%';
            
            document.getElementById('valueStats').innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Nenhum item cadastrado</p>';
            document.getElementById('lowStockItems').innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Nenhum item cadastrado</p>';
            
            if (chartInstance) {
                chartInstance.destroy();
            }
        }

        function updateProgressBars(total, available, inUse, maintenance, damaged) {
            const availablePercent = Math.round((available / total) * 100);
            const inUsePercent = Math.round((inUse / total) * 100);
            const maintenancePercent = Math.round((maintenance / total) * 100);
            const damagedPercent = Math.round((damaged / total) * 100);
            
            document.getElementById('availablePercent').textContent = `${availablePercent}%`;
            document.getElementById('inUsePercent').textContent = `${inUsePercent}%`;
            document.getElementById('maintenancePercent').textContent = `${maintenancePercent}%`;
            document.getElementById('damagedPercent').textContent = `${damagedPercent}%`;
            
            document.getElementById('availableBar').style.width = `${availablePercent}%`;
            document.getElementById('inUseBar').style.width = `${inUsePercent}%`;
            document.getElementById('maintenanceBar').style.width = `${maintenancePercent}%`;
            document.getElementById('damagedBar').style.width = `${damagedPercent}%`;
        }

        function updateValueStats() {
            const categoryValue = {};
            tools.forEach(tool => {
                const preco = parseFloat(tool.preco) || 0;
                const quantidade = parseInt(tool.quantidade) || 1;
                const valor = preco * quantidade;
                
                if (!categoryValue[tool.category]) {
                    categoryValue[tool.category] = 0;
                }
                categoryValue[tool.category] += valor;
            });
            
            const totalValue = Object.values(categoryValue).reduce((a, b) => a + b, 0);
            let valueHTML = '';
            
            for (const [category, value] of Object.entries(categoryValue)) {
                const percent = totalValue > 0 ? Math.round((value / totalValue) * 100) : 0;
                valueHTML += `
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>${category}</span>
                            <span>${formatCurrency(value)}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%; background-color: ${getRandomColor()}"></div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('valueStats').innerHTML = valueHTML || '<p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Nenhum valor cadastrado</p>';
        }

        function updateLowStockItems() {
            const lowStockItems = tools.filter(tool => {
                const quantidade = parseInt(tool.quantidade) || 0;
                const estoqueMinimo = parseInt(tool.estoqueMinimo) || 0;
                return estoqueMinimo > 0 && quantidade <= estoqueMinimo;
            }).slice(0, 5);
            
            if (lowStockItems.length > 0) {
                let lowStockHTML = '';
                lowStockItems.forEach(item => {
                    lowStockHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
                            <div>
                                <p style="font-weight: 500; margin-bottom: 2px;">${item.name}</p>
                                <p style="font-size: 12px; color: var(--gray-color);">${item.code} | Estoque: ${item.quantidade} | M√≠nimo: ${item.estoqueMinimo}</p>
                            </div>
                            <span class="status-badge status-delayed">Baixo</span>
                        </div>
                    `;
                });
                document.getElementById('lowStockItems').innerHTML = lowStockHTML;
            } else {
                document.getElementById('lowStockItems').innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Nenhum item com estoque baixo</p>';
            }
        }

        function updateLocationChart() {
            const ctx = document.getElementById('locationChart').getContext('2d');
            
            const locations = {};
            tools.forEach(tool => {
                locations[tool.location] = (locations[tool.location] || 0) + 1;
            });
            
            const locationLabels = Object.keys(locations);
            const locationData = Object.values(locations);
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            if (locationLabels.length > 0) {
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: locationLabels,
                        datasets: [{
                            label: 'Itens',
                            data: locationData,
                            backgroundColor: locationLabels.map(() => getRandomColor()),
                            borderColor: 'rgba(255, 255, 255, 0.8)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw} itens`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }
        }

        // ============================================
        // FUN√á√ïES AUXILIARES
        // ============================================

        // Formatar data
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                return new Date(dateString).toLocaleDateString('pt-BR');
            } catch (e) {
                return dateString;
            }
        }

        // Formatar moeda
        function formatCurrency(value) {
            if (!value && value !== 0) return 'R$ 0,00';
            return `R$ ${parseFloat(value).toFixed(2).replace('.', ',')}`;
        }

        // Formatar moeda para exporta√ß√£o
        function formatCurrencyForExport(value) {
            if (!value && value !== 0) return '0,00';
            return parseFloat(value).toFixed(2).replace('.', ',');
        }

        // Gerar cor aleat√≥ria
        function getRandomColor() {
            const colors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Mostrar notifica√ß√£o
        function showNotification(message, type) {
            const existing = document.querySelectorAll('.notification');
            existing.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Limpar formul√°rio
        function clearForm() {
            document.getElementById('toolForm').reset();
            document.getElementById('dataCadastro').value = new Date().toISOString().split('T')[0];
            document.getElementById('cameraPlaceholder').style.display = 'block';
            document.getElementById('toolImagePreview').style.display = 'none';
            document.getElementById('toolImagePreview').src = '';
            currentToolImage = null;
            
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            
            isEditing = false;
            editingToolId = null;
            
            const saveBtn = document.getElementById('saveToolBtn');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Item';
        }

        // Atualizar interface completa
        function updateInterface() {
            updateHeaderStats();
            updateStatistics();
            loadToolsList(currentStatusFilter);
            updateStorageInfo();
            updateConnectionStatus();
            updateColaboradoresList();
        }

        // ============================================
        // FUN√á√ïES DE FORMUL√ÅRIO
        // ============================================

        // Validar formul√°rio
        function validateForm() {
            let isValid = true;
            
            const toolName = document.getElementById('toolName').value.trim();
            const toolCode = document.getElementById('toolCode').value.trim();
            const ncmCode = document.getElementById('ncmCode').value.trim();
            const toolCategory = document.getElementById('toolCategory').value;
            const toolStatus = document.getElementById('toolStatus').value;
            const toolLocation = document.getElementById('toolLocation').value;
            const toolCondition = document.getElementById('toolCondition').value;
            
            // Limpar erros
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            
            // Validar campos obrigat√≥rios
            if (!toolName) {
                document.getElementById('toolName').classList.add('error');
                document.getElementById('toolNameError').style.display = 'block';
                isValid = false;
            }
            
            if (!toolCode) {
                document.getElementById('toolCode').classList.add('error');
                document.getElementById('toolCodeError').textContent = 'O c√≥digo √© obrigat√≥rio';
                document.getElementById('toolCodeError').style.display = 'block';
                isValid = false;
            } else if (isEditing) {
                if (tools.some(tool => tool.code === toolCode && tool.id !== editingToolId)) {
                    document.getElementById('toolCode').classList.add('error');
                    document.getElementById('toolCodeError').textContent = 'J√° existe um item com este c√≥digo';
                    document.getElementById('toolCodeError').style.display = 'block';
                    isValid = false;
                }
            } else {
                if (tools.some(tool => tool.code === toolCode)) {
                    document.getElementById('toolCode').classList.add('error');
                    document.getElementById('toolCodeError').textContent = 'J√° existe um item com este c√≥digo';
                    document.getElementById('toolCodeError').style.display = 'block';
                    isValid = false;
                }
            }
            
            if (!toolCategory) {
                document.getElementById('toolCategory').classList.add('error');
                document.getElementById('toolCategoryError').style.display = 'block';
                isValid = false;
            }
            
            if (!toolStatus) {
                document.getElementById('toolStatus').classList.add('error');
                document.getElementById('toolStatusError').style.display = 'block';
                isValid = false;
            }
            
            if (!toolLocation) {
                document.getElementById('toolLocation').classList.add('error');
                document.getElementById('toolLocationError').style.display = 'block';
                isValid = false;
            }
            
            if (!toolCondition) {
                document.getElementById('toolCondition').classList.add('error');
                document.getElementById('toolConditionError').style.display = 'block';
                isValid = false;
            }
            
            return isValid;
        }

        // Salvar item
        async function saveTool() {
            if (!validateForm()) {
                showNotification('Preencha todos os campos obrigat√≥rios!', 'error');
                return false;
            }
            
            // Verificar permiss√£o
            if (currentUser.role === 'user') {
                showNotification('Usu√°rio n√£o tem permiss√£o para salvar itens.', 'error');
                return false;
            }
            
            try {
                const toolData = getFormData();
                
                if (isEditing && editingToolId) {
                    await updateTool(editingToolId, toolData);
                } else {
                    await createTool(toolData);
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                showNotification('Erro ao salvar item.', 'error');
                return false;
            }
        }

        function getFormData() {
            const usuario = currentUser ? currentUser.name : 'Sistema';
            
            return {
                name: document.getElementById('toolName').value.trim(),
                code: document.getElementById('toolCode').value.trim(),
                patrimonio: document.getElementById('patrimonioNumber').value.trim(),
                ncm: document.getElementById('ncmCode').value.trim(),
                category: document.getElementById('toolCategory').value,
                status: document.getElementById('toolStatus').value,
                location: document.getElementById('toolLocation').value,
                condition: document.getElementById('toolCondition').value,
                notaFiscal: document.getElementById('notaFiscal').value.trim(),
                unidade: document.getElementById('unidadeMedida').value,
                preco: parseFloat(document.getElementById('preco').value) || 0,
                quantidade: parseInt(document.getElementById('quantidadeAtual').value) || 1,
                estoqueMinimo: parseInt(document.getElementById('estoqueMinimo').value) || 0,
                estoqueMaximo: parseInt(document.getElementById('estoqueMaximo').value) || 0,
                dataCadastro: document.getElementById('dataCadastro').value,
                description: document.getElementById('toolDescription').value.trim(),
                observations: document.getElementById('toolObservations').value.trim(),
                image: currentToolImage,
                usuarioCadastro: usuario,
                dataHoraCadastro: new Date().toISOString()
            };
        }

        async function createTool(toolData) {
            const newTool = {
                id: Date.now(),
                ...toolData,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            tools.push(newTool);
            
            await saveTools();
            
            // Salvar no Supabase se estiver conectado
            if (isOnlineMode && supabaseClient) {
                await saveToolToSupabase(newTool);
            }
            
            updateInterface();
            showNotification('Item cadastrado com sucesso!', 'success');
            clearForm();
        }

        async function updateTool(toolId, toolData) {
            const toolIndex = tools.findIndex(t => t.id === toolId);
            
            if (toolIndex === -1) {
                showNotification('Item n√£o encontrado!', 'error');
                return false;
            }
            
            const updatedTool = {
                ...tools[toolIndex],
                ...toolData,
                updatedAt: new Date().toISOString()
            };
            
            tools[toolIndex] = updatedTool;
            
            await saveTools();
            
            // Atualizar no Supabase se estiver conectado
            if (isOnlineMode && supabaseClient) {
                await saveToolToSupabase(updatedTool);
            }
            
            updateInterface();
            showNotification('Item atualizado com sucesso!', 'success');
            clearForm();
            
            return true;
        }

        // Converter para formato Supabase
        function convertToSupabaseFormat(tool) {
            return {
                name: tool.name,
                code: tool.code,
                patrimonio: tool.patrimonio || null,
                ncm: tool.ncm,
                category: tool.category,
                status: tool.status,
                location: tool.location,
                condition: tool.condition,
                nota_fiscal: tool.notaFiscal || null,
                unidade: tool.unidade || 'UN',
                preco: tool.preco || 0,
                quantidade: tool.quantidade || 1,
                estoque_minimo: tool.estoqueMinimo || 0,
                estoque_maximo: tool.estoqueMaximo || 0,
                description: tool.description || null,
                observations: tool.observations || null,
                image_url: tool.image || null,
                usuario_cadastro: tool.usuarioCadastro || (currentUser ? currentUser.name : 'Sistema'),
                data_cadastro: tool.dataCadastro || new Date().toISOString().split('T')[0],
                updated_at: new Date().toISOString()
            };
        }

        // Salvar no Supabase
        async function saveToolToSupabase(tool) {
            try {
                const toolData = convertToSupabaseFormat(tool);
                
                // Verificar se j√° existe
                const { data: existing } = await supabaseClient
                    .from('tools')
                    .select('id')
                    .eq('code', tool.code)
                    .maybeSingle();
                
                if (existing) {
                    // Atualizar
                    const { error } = await supabaseClient
                        .from('tools')
                        .update(toolData)
                        .eq('code', tool.code);
                    
                    if (error) throw error;
                } else {
                    // Inserir
                    toolData.created_at = tool.createdAt || new Date().toISOString();
                    
                    const { error } = await supabaseClient
                        .from('tools')
                        .insert([toolData]);
                    
                    if (error) throw error;
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar no Supabase:', error);
                showNotification('Erro ao salvar na nuvem.', 'warning');
                return false;
            }
        }

        // ============================================
        // FUN√á√ïES DE LISTAGEM ATUALIZADAS
        // ============================================

        // Carregar lista de itens com filtro por status
        function loadToolsList(statusFilter = 'all') {
            currentStatusFilter = statusFilter;
            const tbody = document.getElementById('toolsTableBody');
            const noToolsRow = document.getElementById('noToolsRow');
            
            tbody.innerHTML = '';
            tbody.appendChild(noToolsRow);
            
            let filteredTools = tools;
            
            // Aplicar filtro de status (CORRIGIDO)
                if (statusFilter !== 'all') {
                    filteredTools = tools.filter(tool => {
                    // Verificar se a ferramenta est√° atribu√≠da
                    const estaAtribuida = isToolAssigned(tool.id);
        
                if (statusFilter === 'Em Uso') {
            // Para filtro "Em Uso", mostrar tanto ferramentas com status "Em Uso"
            // QUANTO ferramentas atribu√≠das (mesmo se status for "Dispon√≠vel")
                return tool.status === 'Em Uso' || estaAtribuida;
               } else {
            // Para outros filtros, usar apenas o status
                return tool.status === statusFilter;
               }
            });
        }
            
            // Aplicar filtro de estoque baixo
            const lowStockBtn = document.getElementById('filterLowStockBtn');
            const isLowStockFilter = lowStockBtn.classList.contains('active');
            
            if (isLowStockFilter) {
                filteredTools = filteredTools.filter(tool => {
                    const quantidade = parseInt(tool.quantidade) || 0;
                    const estoqueMinimo = parseInt(tool.estoqueMinimo) || 0;
                    return estoqueMinimo > 0 && quantidade <= estoqueMinimo;
                });
            }
            
            const searchTerm = document.getElementById('searchTool')?.value.toLowerCase();
            if (searchTerm) {
                filteredTools = filteredTools.filter(tool => 
                    tool.name.toLowerCase().includes(searchTerm) ||
                    tool.code.toLowerCase().includes(searchTerm) ||
                    (tool.patrimonio && tool.patrimonio.toLowerCase().includes(searchTerm)) ||
                    tool.category.toLowerCase().includes(searchTerm) ||
                    (tool.usuarioCadastro && tool.usuarioCadastro.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredTools.length === 0) {
                noToolsRow.style.display = 'table-row';
                noToolsRow.innerHTML = `<td colspan="14" style="text-align: center; padding: 40px; color: var(--gray-color);">
                    Nenhum item encontrado${searchTerm ? ' para "' + searchTerm + '"' : ''}
                </td>`;
                return;
            }
            
            noToolsRow.style.display = 'none';
            
            filteredTools.forEach(tool => {
                const row = document.createElement('tr');
                row.innerHTML = createTableRow(tool);
                tbody.appendChild(row);
            });
            
            addRowEventListeners();
        }

           function createTableRow(tool) {
        // VERIFICAR SE A FERRAMENTA EST√Å ATRIBU√çDA
            const estaAtribuida = isToolAssigned(tool.id);
    
        // Se estiver atribu√≠da, mostrar "Em Uso" mesmo se estiver marcada como "Dispon√≠vel"
            const statusParaExibir = estaAtribuida ? 'Em Uso' : tool.status;
            const statusClass = getStatusClass(statusParaExibir);
            const stockInfo = getStockInfo(tool);
    
        // Verificar permiss√µes para a√ß√µes
            const canEdit = currentUser.role !== 'user';
    
        // Gerar HTML para a miniatura da imagem
            let imageHTML = '';
            if (tool.image) {
            imageHTML = `
                <div class="tool-thumbnail-container" style="position: relative; display: inline-block;">
                    <img src="${tool.image}" 
                         alt="${tool.name}" 
                         class="tool-thumbnail" 
                         data-id="${tool.id}"
                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 2px solid #ddd; cursor: zoom-in;"
                         title="Clique para ampliar">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                               background: rgba(0,0,0,0.2); border-radius: 6px; opacity: 0; 
                               transition: opacity 0.3s; pointer-events: none;">
                        <i class="fas fa-search-plus" style="position: absolute; top: 50%; left: 50%; 
                           transform: translate(-50%, -50%); color: white; font-size: 14px;"></i>
                    </div>
                </div>
            `;
        } else {
            imageHTML = `
                <div class="no-image-placeholder" data-id="${tool.id}" 
                     style="width: 50px; height: 50px; background: #f5f5f5; border-radius: 6px; 
                            display: flex; align-items: center; justify-content: center; 
                            border: 2px solid #ddd; cursor: pointer;" 
                     title="Sem imagem - Clique para ver detalhes">
                    <i class="fas fa-image" style="color: #ccc; font-size: 20px;"></i>
                </div>
            `;
        }
        
        return `
                <td style="text-align: center; vertical-align: middle; padding: 8px;">
                    ${imageHTML}
                </td>
                <td><strong>${tool.code}</strong></td>
                <td>${tool.name}</td>
                <td>${tool.patrimonio || '-'}</td>
                <td>${tool.category}</td>
                <td><span class="status-badge ${statusClass}">${statusParaExibir}</span></td>
                <td>${tool.location}</td>
                <td>${tool.condition}</td>
                <td>${tool.unidade || 'UN'}</td>
                <td class="${stockInfo.class}">${stockInfo.text}</td>
                <td>${tool.preco ? formatCurrency(tool.preco) : '-'}</td>
                <td>${formatDate(tool.dataCadastro)}</td>
                <td>${tool.usuarioCadastro || '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn action-btn-view" data-id="${tool.id}" title="Visualizar">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${canEdit ? `
                           <button class="action-btn action-btn-edit" data-id="${tool.id}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn action-btn-delete" data-id="${tool.id}" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                        <button class="action-btn action-btn-view" data-id="${tool.id}" title="Gerar QR Code" style="color: #8e44ad;">
                            <i class="fas fa-qrcode"></i>
                        </button>
                    </div>
                </td>
            `;
        }

        function getStatusClass(status) {
            switch(status) {
                case 'Dispon√≠vel': return 'status-completed';
                case 'Em Uso': return 'status-ontrack';
                case 'Manuten√ß√£o': return 'status-delayed';
                case 'Danificado': return 'status-delayed';
                case 'Reservado': return 'status-delayed';
                case 'Descartado': return 'status-delayed';
                default: return 'status-ontrack';
            }
        }

        function getStockInfo(tool) {
            const quantidade = parseInt(tool.quantidade) || 0;
            const estoqueMinimo = parseInt(tool.estoqueMinimo) || 0;
            
            if (estoqueMinimo > 0 && quantidade <= estoqueMinimo) {
                return { class: 'stock-low', text: `${quantidade} ‚ö†Ô∏è` };
            } else if (tool.estoqueMaximo && quantidade >= tool.estoqueMaximo) {
                return { class: 'stock-high', text: quantidade };
            } else {
                return { class: 'stock-normal', text: quantidade };
            }
        }

        // ============================================
        // FUN√á√ïES DE VISUALIZA√á√ÉO E EDI√á√ÉO
        // ============================================

        // Visualizar detalhes
        function viewToolDetails(toolId) {
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            
            const modalBody = document.getElementById('toolModalBody');
            modalBody.innerHTML = createToolDetailsHTML(tool);
            
            // Adicionar evento para clicar na imagem no modal
            const modalImage = modalBody.querySelector('img');
            if (modalImage) {
                modalImage.style.cursor = 'pointer';
                modalImage.addEventListener('click', function() {
                    viewEnlargedImage(toolId);
                });
            }
            
            document.getElementById('toolModal').style.display = 'flex';
        }

        function createToolDetailsHTML(tool) {
            return `
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                    <div>
                        ${tool.image ? 
                            `<img src="${tool.image}" alt="${tool.name}" style="width: 100%; border-radius: 8px; cursor: pointer;">` :
                            '<div style="background-color: #f5f5f5; height: 200px; display: flex; align-items: center; justify-content: center; border-radius: 8px;"><i class="fas fa-box" style="font-size: 60px; color: #ccc;"></i></div>'
                        }
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="generateQRCodeForTool(${tool.id})">
                                <i class="fas fa-qrcode"></i> Gerar QR Code
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 10px; color: var(--primary-color);">${tool.name}</h3>
                        <p style="color: var(--gray-color); margin-bottom: 20px;">C√≥digo: ${tool.code} | Patrim√¥nio: ${tool.patrimonio || 'N√£o informado'}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div><strong>N.C.M.:</strong> ${tool.ncm || '-'}</div>
                            <div><strong>Categoria:</strong> ${tool.category}</div>
                            <div><strong>Status:</strong> <span class="status-badge ${getStatusClass(tool.status)}">${tool.status}</span></div>
                            <div><strong>Localiza√ß√£o:</strong> ${tool.location}</div>
                            <div><strong>Condi√ß√£o:</strong> ${tool.condition}</div>
                            <div><strong>Unidade:</strong> ${tool.unidade || 'UN'}</div>
                            <div><strong>Nota Fiscal:</strong> ${tool.notaFiscal || '-'}</div>
                            <div><strong>Pre√ßo:</strong> ${formatCurrency(tool.preco)}</div>
                            <div><strong>Quantidade:</strong> ${tool.quantidade || 1}</div>
                            <div><strong>Estoque M√≠n:</strong> ${tool.estoqueMinimo || 0}</div>
                            <div><strong>Estoque M√°x:</strong> ${tool.estoqueMaximo || 0}</div>
                            <div><strong>Data Cadastro:</strong> ${formatDate(tool.dataCadastro)}</div>
                            <div><strong>Usu√°rio Cadastro:</strong> ${tool.usuarioCadastro || 'Sistema'}</div>
                        </div>
                        
                        ${tool.description ? `
                            <div style="margin-bottom: 15px;">
                                <strong>Descri√ß√£o:</strong>
                                <p>${tool.description}</p>
                            </div>
                        ` : ''}
                        
                        ${tool.observations ? `
                            <div style="margin-bottom: 15px;">
                                <strong>Observa√ß√µes:</strong>
                                <p>${tool.observations}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Editar item
        function editTool(toolId) {
            // Verificar permiss√£o
            if (currentUser.role === 'user') {
                showNotification('Usu√°rio n√£o tem permiss√£o para editar itens.', 'error');
                return;
            }
            
            // Mudar para aba de cadastro
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector('[data-tab="cadastro"]').classList.add('active');
            document.getElementById('cadastro').classList.add('active');
            
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            
            // Preencher formul√°rio
            document.getElementById('toolName').value = tool.name;
            document.getElementById('toolCode').value = tool.code;
            document.getElementById('patrimonioNumber').value = tool.patrimonio || '';
            document.getElementById('ncmCode').value = tool.ncm || '';
            document.getElementById('toolCategory').value = tool.category;
            document.getElementById('toolStatus').value = tool.status;
            document.getElementById('toolLocation').value = tool.location;
            document.getElementById('toolCondition').value = tool.condition;
            document.getElementById('notaFiscal').value = tool.notaFiscal || '';
            document.getElementById('unidadeMedida').value = tool.unidade || 'UN';
            document.getElementById('preco').value = tool.preco || '';
            document.getElementById('quantidadeAtual').value = tool.quantidade || 1;
            document.getElementById('estoqueMinimo').value = tool.estoqueMinimo || 0;
            document.getElementById('estoqueMaximo').value = tool.estoqueMaximo || 0;
            document.getElementById('dataCadastro').value = tool.dataCadastro || '';
            document.getElementById('toolDescription').value = tool.description || '';
            document.getElementById('toolObservations').value = tool.observations || '';
            
            if (tool.image) {
                currentToolImage = tool.image;
                document.getElementById('cameraPlaceholder').style.display = 'none';
                document.getElementById('toolImagePreview').style.display = 'block';
                document.getElementById('toolImagePreview').src = tool.image;
            }
            
            isEditing = true;
            editingToolId = toolId;
            
            document.getElementById('saveToolBtn').innerHTML = '<i class="fas fa-save"></i> Atualizar Item';
            
            showNotification('Editando item. Atualize os dados.', 'warning');
        }

        // Excluir item
        async function deleteTool(toolId) {
            // Verificar permiss√£o
            if (currentUser.role === 'user') {
                showNotification('Usu√°rio n√£o tem permiss√£o para excluir itens.', 'error');
                return;
            }
            
            if (!confirm('Tem certeza que deseja excluir este item?')) {
                return;
            }
            
            const tool = tools.find(t => t.id === toolId);
            if (!tool) {
                showNotification('Item n√£o encontrado!', 'error');
                return;
            }
            
            // Remover localmente
            tools = tools.filter(t => t.id !== toolId);
            await saveTools();
            
            // Remover do Supabase
            if (isOnlineMode && supabaseClient) {
                try {
                    await supabaseClient
                        .from('tools')
                        .delete()
                        .eq('code', tool.code);
                } catch (error) {
                    console.error('Erro ao excluir do Supabase:', error);
                }
            }
            
            updateInterface();
            showNotification('Item exclu√≠do com sucesso!', 'success');
        }

        // Gerar QR Code
        window.generateQRCodeForTool = function(toolId) {
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            
            const qrContent = JSON.stringify({
                nome: tool.name,
                codigo: tool.code,
                patrimonio: tool.patrimonio,
                ncm: tool.ncm,
                categoria: tool.category,
                status: tool.status,
                localizacao: tool.location,
                condicao: tool.condition,
                data_cadastro: tool.dataCadastro,
                usuario_cadastro: tool.usuarioCadastro
            }, null, 2);
            
            const qrModalBody = document.getElementById('qrModalBody');
            qrModalBody.innerHTML = `
                <div class="qrcode-container">
                    <h4 style="margin-bottom: 20px;">QR Code para: ${tool.name}</h4>
                    <div id="qrcodeCanvas" style="margin: 0 auto 20px;"></div>
                    <p style="margin-top: 20px; color: var(--gray-color); font-size: 14px;">
                        Use este QR Code para identificar rapidamente o item.
                    </p>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="downloadQRCodeBtn">
                            <i class="fas fa-download"></i> Baixar QR Code
                        </button>
                        <button class="btn btn-success" id="printQRCodeBtn">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                    </div>
                </div>
            `;
            
            // Gerar QR Code
            QRCode.toCanvas(document.getElementById('qrcodeCanvas'), qrContent, {
                width: 200,
                margin: 2,
                color: { dark: '#000000', light: '#FFFFFF' }
            });
            
            // Configurar bot√µes
            document.getElementById('downloadQRCodeBtn').onclick = function() {
                const canvas = document.querySelector('#qrcodeCanvas canvas');
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = `QRCode_${tool.code}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }
            };
            
            document.getElementById('printQRCodeBtn').onclick = function() {
                window.print();
            };
            
            document.getElementById('qrModal').style.display = 'flex';
        };

        // ============================================
        // FUN√á√ïES DE SINCRONIZA√á√ÉO
        // ============================================

        // Enviar dados para Supabase
        async function syncToSupabase() {
            try {
                // Verificar permiss√£o
                if (currentUser.role === 'user') {
                    showNotification('Usu√°rio n√£o tem permiss√£o para sincronizar.', 'error');
                    return;
                }
                
                if (!isOnlineMode || !supabaseClient) {
                    showNotification('N√£o conectado √† nuvem.', 'warning');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const tool of tools) {
                    try {
                        const result = await saveToolToSupabase(tool);
                        if (result) successCount++;
                        else errorCount++;
                    } catch (error) {
                        errorCount++;
                        console.error(`Erro ao sincronizar ${tool.code}:`, error);
                    }
                }
                
                if (errorCount === 0) {
                    showNotification(`${successCount} itens sincronizados com sucesso!`, 'success');
                    lastSyncTime = new Date();
                    updateConnectionStatus();
                } else {
                    showNotification(`${successCount} sucessos, ${errorCount} erros na sincroniza√ß√£o.`, 'warning');
                }
                
                return true;
            } catch (error) {
                console.error('Erro na sincroniza√ß√£o:', error);
                showNotification('Erro na sincroniza√ß√£o.', 'error');
                return false;
            }
        }

        // Sincronizar ambos (enviar e buscar)
        async function syncBoth() {
            await syncToSupabase();
            await fetchFromSupabase();
        }

        // Atualizar status da conex√£o na interface
        function updateConnectionStatus() {
            const connectionStatus = document.getElementById('currentConnectionStatus');
            const operationMode = document.getElementById('operationMode');
            const lastSync = document.getElementById('lastSyncTime');
            const localItems = document.getElementById('localItemsCount');
            const statusIndicator = document.getElementById('dbStatusIndicator');
            const statusText = document.getElementById('connectionStatus');
            
            if (isOnlineMode && supabaseClient) {
                connectionStatus.textContent = 'Conectado';
                connectionStatus.style.color = 'var(--success-color)';
                operationMode.textContent = 'Online';
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = 'Conectado √† Nuvem';
                statusText.style.color = 'var(--success-color)';
            } else {
                connectionStatus.textContent = 'Desconectado';
                connectionStatus.style.color = 'var(--danger-color)';
                operationMode.textContent = 'Local';
                statusIndicator.className = 'status-indicator';
                statusText.textContent = 'Modo Local';
                statusText.style.color = 'var(--warning-color)';
            }
            
            if (lastSyncTime) {
                lastSync.textContent = lastSyncTime.toLocaleString('pt-BR');
            } else {
                lastSync.textContent = 'Nunca';
            }
            
            localItems.textContent = tools.length;
            
            // ADICIONE ESTAS DUAS LINHAS:
    const localColaboradores = document.getElementById('localColaboradoresCount');
    if (localColaboradores) {
        localColaboradores.textContent = colaboradores.length;
    }
    
    // Atualizar contagem de itens na nuvem
    updateCloudItemsCount();
    }
    // Adicionar contagem de colaboradores na nuvem
        const cloudColaboradores = document.getElementById('cloudColaboradoresCount');
    if (cloudColaboradores) {
        cloudColaboradores.textContent = isOnlineMode ? 'Carregando...' : 'Offline';
    }
        // E atualizar a fun√ß√£o updateCloudItemsCount() para incluir colaboradores:
    async function updateCloudItemsCount() {
    const cloudItems = document.getElementById('cloudItemsCount');
    const cloudColaboradores = document.getElementById('cloudColaboradoresCount');
    
    if (isOnlineMode && supabaseClient) {
        try {
            // Contar ferramentas
            const { count: toolsCount } = await supabaseClient
                .from('tools')
                .select('*', { count: 'exact', head: true });
            
            // Contar colaboradores
            const { count: colabsCount } = await supabaseClient
                .from('collaborators')
                .select('*', { count: 'exact', head: true });
            
            cloudItems.textContent = toolsCount || 0;
            if (cloudColaboradores) {
                cloudColaboradores.textContent = colabsCount || 0;
            }
        } catch (error) {
            cloudItems.textContent = 'Erro';
            if (cloudColaboradores) {
                cloudColaboradores.textContent = 'Erro';
            }
        }
    } else {
        cloudItems.textContent = 'Offline';
        if (cloudColaboradores) {
            cloudColaboradores.textContent = 'Offline';
        }
    }
}

        // Atualizar informa√ß√µes do banco
        async function updateDatabaseInfo() {
            if (!supabaseClient) return;
            
            try {
                const { count } = await supabaseClient
                    .from('tools')
                    .select('*', { count: 'exact', head: true });
                
                updateConnectionStatus();
            } catch (error) {
                console.error('Erro ao atualizar info do banco:', error);
            }
        }

        // ============================================
        // FUN√á√ïES DE BACKUP E EXPORTA√á√ÉO
        // ============================================

        // Fazer backup
        async function createBackup() {
            // Verificar permiss√£o
            if (currentUser.role === 'user') {
                showNotification('Usu√°rio n√£o tem permiss√£o para fazer backup.', 'error');
                return;
            }
            
            try {
                const backupData = {
                    tools: tools,
                    colaboradores: colaboradores,
                    historicoAtribuicoes: historicoAtribuicoes,
                    timestamp: new Date().toISOString(),
                    count: tools.length,
                    usuarios: Array.from(new Set(tools.map(t => t.usuarioCadastro).filter(Boolean)))
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { 
                    type: 'application/json' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_ferramentas_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Backup criado com ${tools.length} itens e ${colaboradores.length} colaboradores!`, 'success');
                
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                showNotification('Erro ao criar backup.', 'error');
            }
        }

        // Restaurar backup
        function handleRestoreBackup(file) {
            // Verificar permiss√£o
            if (currentUser.role === 'user') {
                showNotification('Usu√°rio n√£o tem permiss√£o para restaurar backup.', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = async function(event) {
                try {
                    const backupData = JSON.parse(event.target.result);
                    
                    if (!backupData.tools || !Array.isArray(backupData.tools)) {
                        showNotification('Arquivo de backup inv√°lido.', 'error');
                        return;
                    }
                    
                    if (!confirm(`Restaurar backup com ${backupData.tools.length} itens e ${backupData.colaboradores?.length || 0} colaboradores? Os dados atuais ser√£o substitu√≠dos.`)) {
                        return;
                    }
                    
                    tools = backupData.tools;
                    colaboradores = backupData.colaboradores || [];
                    historicoAtribuicoes = backupData.historicoAtribuicoes || [];
                    
                    await saveTools();
                    await saveColaboradores();
                    updateInterface();
                    
                    showNotification(`${backupData.tools.length} itens e ${colaboradores.length} colaboradores restaurados!`, 'success');
                    
                } catch (error) {
                    console.error('Erro ao restaurar backup:', error);
                    showNotification('Erro ao restaurar backup.', 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('Erro ao ler arquivo.', 'error');
            };
            
            reader.readAsText(file);
        }

        // Exportar para Excel
        async function exportToExcel(range = 'all') {
            try {
                // Mostrar loader
                const loader = document.getElementById('exportLoader');
                loader.style.display = 'block';
                
                // Filtrar itens
                let filteredTools = tools;
                
                if (range === 'available') {
                    filteredTools = tools.filter(tool => tool.status === 'Dispon√≠vel');
                } else if (range === 'inuse') {
                    filteredTools = tools.filter(tool => tool.status === 'Em Uso');
                } else if (range === 'maintenance') {
                    filteredTools = tools.filter(tool => tool.status === 'Manuten√ß√£o');
                } else if (range === 'lowstock') {
                    filteredTools = tools.filter(tool => {
                        const quantidade = parseInt(tool.quantidade) || 0;
                        const estoqueMinimo = parseInt(tool.estoqueMinimo) || 0;
                        return estoqueMinimo > 0 && quantidade <= estoqueMinimo;
                    });
                }
                
                if (filteredTools.length === 0) {
                    loader.style.display = 'none';
                    showNotification('Nenhum item para exportar!', 'error');
                    return;
                }
                
                // Aba principal: Ferramentas
                const exportData = filteredTools.map(tool => ({
                    'C√≥digo': tool.code,
                    'Nome do Produto': tool.name,
                    'Patrim√¥nio': tool.patrimonio || '',
                    'N.C.M.': tool.ncm,
                    'Categoria': tool.category,
                    'Status': tool.status,
                    'Localiza√ß√£o': tool.location,
                    'Condi√ß√£o': tool.condition,
                    'Nota Fiscal': tool.notaFiscal || '',
                    'Unidade': tool.unidade || 'UN',
                    'Pre√ßo': tool.preco ? formatCurrencyForExport(tool.preco) : '0,00',
                    'Quantidade': tool.quantidade || 1,
                    'Estoque M√≠nimo': tool.estoqueMinimo || 0,
                    'Estoque M√°ximo': tool.estoqueMaximo || 0,
                    'Descri√ß√£o': tool.description || '',
                    'Observa√ß√µes': tool.observations || '',
                    'Data Cadastro': tool.dataCadastro || '',
                    'Usu√°rio Cadastro': tool.usuarioCadastro || 'Sistema',
                    'Data/Hora Cadastro': tool.dataHoraCadastro || ''
                }));
                
                // Aba Usu√°rios: Resumo por usu√°rio
                const usuariosMap = new Map();
                
                filteredTools.forEach(tool => {
                    const usuario = tool.usuarioCadastro || 'Sistema';
                    if (!usuariosMap.has(usuario)) {
                        usuariosMap.set(usuario, {
                            usuario: usuario,
                            totalItens: 0,
                            valorTotal: 0,
                            categorias: new Set(),
                            itensPorStatus: {}
                        });
                    }
                    
                    const userData = usuariosMap.get(usuario);
                    userData.totalItens += 1;
                    
                    const preco = parseFloat(tool.preco) || 0;
                    const quantidade = parseInt(tool.quantidade) || 1;
                    userData.valorTotal += preco * quantidade;
                    
                    userData.categorias.add(tool.category);
                    userData.itensPorStatus[tool.status] = (userData.itensPorStatus[tool.status] || 0) + 1;
                });
                
                const usuariosData = Array.from(usuariosMap.values()).map(userData => ({
                    'Usu√°rio': userData.usuario,
                    'Total de Itens': userData.totalItens,
                    'Valor Total (R$)': formatCurrencyForExport(userData.valorTotal),
                    'Categorias': Array.from(userData.categorias).join(', '),
                    'Dispon√≠veis': userData.itensPorStatus['Dispon√≠vel'] || 0,
                    'Em Uso': userData.itensPorStatus['Em Uso'] || 0,
                    'Manuten√ß√£o': userData.itensPorStatus['Manuten√ß√£o'] || 0,
                    'Danificados': userData.itensPorStatus['Danificado'] || 0,
                    'Reservados': userData.itensPorStatus['Reservado'] || 0,
                    'M√©dia por Item (R$)': userData.totalItens > 0 ? 
                        formatCurrencyForExport(userData.valorTotal / userData.totalItens) : '0,00'
                }));
                
                // Aba Colaboradores: Colaboradores e ferramentas atribu√≠das
                const colaboradoresData = colaboradores.map(colaborador => ({
                    'Nome': colaborador.nome,
                    'Matr√≠cula': colaborador.matricula,
                    'Setor': colaborador.setor || '',
                    'Cargo': colaborador.cargo || '',
                    'Telefone': colaborador.telefone || '',
                    'Email': colaborador.email || '',
                    'Total Ferramentas': colaborador.ferramentasAtribuidas ? colaborador.ferramentasAtribuidas.length : 0,
                    'Observa√ß√µes': colaborador.observacoes || '',
                    'Data Cadastro': colaborador.dataCadastro || '',
                    'Usu√°rio Cadastro': colaborador.usuarioCadastro || ''
                }));
                
                // Aba Hist√≥rico: Hist√≥rico de atribui√ß√µes
                const historicoData = historicoAtribuicoes.map(item => ({
                    'Colaborador': item.colaboradorNome,
                    'Ferramenta': `${item.toolCodigo} - ${item.toolNome}`,
                    'Data Atribui√ß√£o': item.dataAtribuicao,
                    'Data Devolu√ß√£o': item.dataDevolucao || 'N√£o devolvido',
                    'Observa√ß√£o': item.observacao || '',
                    'Usu√°rio Atribui√ß√£o': item.usuarioAtribuicao,
                    'Usu√°rio Devolu√ß√£o': item.usuarioDevolucao || ''
                }));
                
                // Criar worksheets
                const wsTools = XLSX.utils.json_to_sheet(exportData);
                const wsUsuarios = XLSX.utils.json_to_sheet(usuariosData);
                const wsColaboradores = XLSX.utils.json_to_sheet(colaboradoresData);
                const wsHistorico = XLSX.utils.json_to_sheet(historicoData);
                
                // Criar workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, wsTools, 'Ferramentas');
                XLSX.utils.book_append_sheet(wb, wsUsuarios, 'Usu√°rios');
                XLSX.utils.book_append_sheet(wb, wsColaboradores, 'Colaboradores');
                XLSX.utils.book_append_sheet(wb, wsHistorico, 'Hist√≥rico Atribui√ß√µes');
                
                // Ajustar largura das colunas
                const wscolsTools = [
                    { wch: 15 }, { wch: 30 }, { wch: 20 }, { wch: 15 }, { wch: 20 },
                    { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 20 }, { wch: 10 },
                    { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 40 },
                    { wch: 40 }, { wch: 15 }, { wch: 20 }, { wch: 25 }
                ];
                wsTools['!cols'] = wscolsTools;
                
                const wscolsUsuarios = [
                    { wch: 25 }, { wch: 15 }, { wch: 20 }, { wch: 40 }, 
                    { wch: 12 }, { wch: 10 }, { wch: 12 }, { wch: 12 }, 
                    { wch: 12 }, { wch: 20 }
                ];
                wsUsuarios['!cols'] = wscolsUsuarios;
                
                const wscolsColaboradores = [
                    { wch: 25 }, { wch: 15 }, { wch: 20 }, { wch: 20 },
                    { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 40 },
                    { wch: 15 }, { wch: 20 }
                ];
                wsColaboradores['!cols'] = wscolsColaboradores;
                
                const wscolsHistorico = [
                    { wch: 25 }, { wch: 30 }, { wch: 15 }, { wch: 15 },
                    { wch: 40 }, { wch: 20 }, { wch: 20 }
                ];
                wsHistorico['!cols'] = wscolsHistorico;
                
                // Adicionar t√≠tulos
                XLSX.utils.sheet_add_aoa(wsUsuarios, [[`Relat√≥rio por Usu√°rio - Gerado em ${new Date().toLocaleDateString('pt-BR')}`]], { origin: -1 });
                XLSX.utils.sheet_add_aoa(wsTools, [[`Relat√≥rio de Ferramentas (${range}) - Gerado em ${new Date().toLocaleDateString('pt-BR')}`]], { origin: -1 });
                XLSX.utils.sheet_add_aoa(wsColaboradores, [[`Relat√≥rio de Colaboradores - Gerado em ${new Date().toLocaleDateString('pt-BR')}`]], { origin: -1 });
                XLSX.utils.sheet_add_aoa(wsHistorico, [[`Hist√≥rico de Atribui√ß√µes - Gerado em ${new Date().toLocaleDateString('pt-BR')}`]], { origin: -1 });
                
                // Gerar nome do arquivo
                const fileName = `ferramentas_${range}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                
                // Salvar arquivo
                XLSX.writeFile(wb, fileName);
                
                // Adicionar ao hist√≥rico
                addToExportHistory(range, filteredTools.length);
                
                showNotification(`${filteredTools.length} itens exportados em 4 abas!`, 'success');
                
            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                showNotification('Erro ao exportar.', 'error');
            } finally {
                document.getElementById('exportLoader').style.display = 'none';
            }
        }

        function addToExportHistory(range, count) {
            const exportHistory = document.getElementById('exportHistory');
            if (!exportHistory) return;
            
            const rangeText = {
                'all': 'Todos os itens',
                'available': 'Itens dispon√≠veis',
                'inuse': 'Itens em uso',
                'maintenance': 'Itens em manuten√ß√£o',
                'lowstock': 'Itens com estoque baixo'
            }[range] || range;
            
            const historyItem = document.createElement('div');
            historyItem.style.cssText = `
                display: flex; justify-content: space-between; align-items: center;
                padding: 15px; border-bottom: 1px solid var(--border-color);
            `;
            
            historyItem.innerHTML = `
                <div>
                    <p style="font-weight: 500; margin-bottom: 5px;">${rangeText}</p>
                    <p style="font-size: 14px; color: var(--gray-color);">${count} itens exportados</p>
                    <p style="font-size: 12px; color: var(--secondary-color); margin-top: 5px;">
                        <i class="fas fa-file-excel"></i> 4 abas: Ferramentas + Usu√°rios + Colaboradores + Hist√≥rico
                    </p>
                </div>
                <div>
                    <span class="status-badge status-ontrack">Excel</span>
                    <p style="font-size: 14px; color: var(--gray-color); margin-top: 5px;">${new Date().toLocaleString('pt-BR')}</p>
                </div>
            `;
            
            if (exportHistory.querySelector('p')) {
                exportHistory.innerHTML = '';
            }
            
            exportHistory.insertBefore(historyItem, exportHistory.firstChild);
        }

        // ============================================
        // EVENT LISTENERS - CORRIGIDOS
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            // Verificar sess√£o ativa
            checkSession();
            
            // Configurar data atual no rodap√©
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-BR');
            
            // ===== LOGIN =====
            document.getElementById('loginBtn').addEventListener('click', login);
            
            // Permitir login com Enter
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }

             // ===== ROMANEIO =====
            document.getElementById('generateRomaneioBtn').addEventListener('click', generateRomaneioExcelWithCustomFormat);                

            });
            
            // ===== LOGOUT =====
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // ===== TABS =====
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    if (tabId === 'catalogo') {
                        loadToolsList(currentStatusFilter);
                    }
                    
                    if (tabId === 'controle-colaborador') {
                        updateColaboradoresList();
                    }
                                        
                    if (tabId === 'romaneio') {
                        loadRomaneioData();
                    }

                    if (tabId !== 'cadastro') {
                        isEditing = false;
                        editingToolId = null;
                        document.getElementById('saveToolBtn').innerHTML = '<i class="fas fa-save"></i> Salvar Item';
                    }
                    
                    if (tabId !== 'controle-colaborador') {
                        isEditingColaborador = false;
                        currentColaboradorId = null;
                        clearColaboradorForm();
                        colaboradorSelecionado = null;
                        updateAtribuicaoUI();
                    }
                });
            });
            
            // ===== BOT√ÉO FIXO DE ENVIAR PARA NUVEM =====
            document.getElementById('fixedCloudUploadBtn').addEventListener('click', syncToSupabase);
            
            // ===== SINCRONIZA√á√ÉO =====
            document.getElementById('syncToOnlineBtn').addEventListener('click', syncToSupabase);
            document.getElementById('syncFromOnlineBtn2').addEventListener('click', fetchFromSupabase);
            document.getElementById('syncBothBtn').addEventListener('click', syncBoth);
            
            // ===== BOT√ïES DE FILTRO POR STATUS =====
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remover classe active de todos os bot√µes de status
                    document.querySelectorAll('.status-filter-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // Adicionar classe active no bot√£o clicado
                    this.classList.add('active');
                    
                    // Remover active do bot√£o de estoque baixo se estiver ativo
                    const lowStockBtn = document.getElementById('filterLowStockBtn');
                    if (lowStockBtn.classList.contains('active')) {
                        lowStockBtn.classList.remove('active');
                    }
                    
                    // Carregar lista com o filtro selecionado
                    const status = this.getAttribute('data-status');
                    loadToolsList(status);
                });
            });
            
            // ===== BOT√ÉO DE ESTOQUE BAIXO =====
            document.getElementById('filterLowStockBtn').addEventListener('click', function() {
                // Remover classe active de todos os bot√µes de status
                document.querySelectorAll('.status-filter-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                // Adicionar active no bot√£o de estoque baixo
                this.classList.toggle('active');
                
                // Remover active do bot√£o "Todos" e carregar lista
                const isActive = this.classList.contains('active');
                if (isActive) {
                    loadToolsList('all'); // Carrega todos e filtra por estoque baixo
                } else {
                    document.querySelector('[data-status="all"]').classList.add('active');
                    loadToolsList('all');
                }
            });
            
            // ===== IMAGEM =====
            document.getElementById('captureImageBtn').addEventListener('click', function() {
                if (currentUser.role === 'user') {
                    showNotification('Usu√°rio n√£o tem permiss√£o para adicionar imagens.', 'error');
                    return;
                }
                document.getElementById('imageUploadInput').click();
            });
            
            document.getElementById('uploadImageBtn').addEventListener('click', function() {
                if (currentUser.role === 'user') {
                    showNotification('Usu√°rio n√£o tem permiss√£o para adicionar imagens.', 'error');
                    return;
                }
                document.getElementById('imageUploadInput').click();
            });
            
            document.getElementById('clearImageBtn').addEventListener('click', function() {
                if (currentUser.role === 'user') {
                    showNotification('Usu√°rio n√£o tem permiss√£o para modificar imagens.', 'error');
                    return;
                }
                document.getElementById('cameraPlaceholder').style.display = 'block';
                document.getElementById('toolImagePreview').style.display = 'none';
                document.getElementById('toolImagePreview').src = '';
                currentToolImage = null;
            });
            
            document.getElementById('imageUploadInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.match('image.*')) {
                    showNotification('Selecione uma imagem!', 'error');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('A imagem √© muito grande. M√°ximo: 5MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentToolImage = event.target.result;
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                    document.getElementById('toolImagePreview').style.display = 'block';
                    document.getElementById('toolImagePreview').src = currentToolImage;
                };
                reader.readAsDataURL(file);
                
                this.value = '';
            });
            
            // ===== FORMUL√ÅRIO =====
            document.getElementById('saveToolBtn').addEventListener('click', saveTool);
            
            document.getElementById('saveAndNewBtn').addEventListener('click', async function() {
                if (await saveTool()) {
                    clearForm();
                    if (document.getElementById('catalogo').classList.contains('active')) {
                        loadToolsList(currentStatusFilter);
                    }
                }
            });
            
            document.getElementById('clearFormBtn').addEventListener('click', clearForm);
            
            document.getElementById('generateQRCodeBtn').addEventListener('click', function() {
                showNotification('Preencha o formul√°rio primeiro.', 'info');
            });
            
            // ===== BUSCA =====
            document.getElementById('searchTool')?.addEventListener('input', () => loadToolsList(currentStatusFilter));
            document.getElementById('searchColaborador')?.addEventListener('input', function() {
                updateColaboradoresList(this.value);
            });
            
            // ===== BACKUP =====
            document.getElementById('backupBtn').addEventListener('click', createBackup);
            document.getElementById('quickBackupBtn').addEventListener('click', createBackup);
            
            document.getElementById('restoreBtn').addEventListener('click', function() {
                if (currentUser.role === 'user') {
                    showNotification('Usu√°rio n√£o tem permiss√£o para restaurar backup.', 'error');
                    return;
                }
                document.getElementById('restoreFileInput').click();
            });
            
            document.getElementById('restoreFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.name.endsWith('.json')) {
                    showNotification('Selecione um arquivo JSON.', 'error');
                    return;
                }
                
                handleRestoreBackup(file);
                this.value = '';
            });
            
            // ===== EXPORTA√á√ÉO =====
            document.getElementById('exportExcelBtn').addEventListener('click', function() {
                const range = document.getElementById('exportRange').value;
                exportToExcel(range);
            });

            // ===== MODO NOTURNO =====
            document.getElementById('modeToggleBtn').addEventListener('click', toggleDarkMode);

            // ===== COLABORADORES =====
            document.getElementById('salvarColaboradorBtn').addEventListener('click', saveColaborador);
            document.getElementById('limparColaboradorBtn').addEventListener('click', clearColaboradorForm);
            document.getElementById('excluirColaboradorBtn').addEventListener('click', function() {
                if (currentColaboradorId) {
                    deleteColaborador(currentColaboradorId);
                }
            });
            
            document.getElementById('atribuirFerramentaBtn').addEventListener('click', atribuirFerramenta);
            document.getElementById('limparAtribuicaoBtn').addEventListener('click', function() {
                document.getElementById('ferramentaParaAtribuir').value = '';
                document.getElementById('observacaoAtribuicao').value = '';
                document.getElementById('dataAtribuicao').value = new Date().toISOString().split('T')[0];
            });
            
            // ===== MODAIS =====
            document.getElementById('closeModalBtn').addEventListener('click', function() {
                document.getElementById('toolModal').style.display = 'none';
            });
            
            document.getElementById('closeQRModalBtn').addEventListener('click', function() {
                document.getElementById('qrModal').style.display = 'none';
            });
            
            document.getElementById('closeMapModalBtn').addEventListener('click', function() {
                document.getElementById('mapModal').style.display = 'none';
            });
            
            document.getElementById('closeFerramentasModalBtn').addEventListener('click', function() {
                document.getElementById('ferramentasColaboradorModal').style.display = 'none';
            });
            
            document.getElementById('toolModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            document.getElementById('qrModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            document.getElementById('mapModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            document.getElementById('ferramentasColaboradorModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // ===== LIMPAR CACHE - CORRIGIDO =====
            document.getElementById('clearCacheBtn').addEventListener('click', async function() {
                if (currentUser.role === 'user') {
                    showNotification('Usu√°rio n√£o tem permiss√£o para limpar cache.', 'error');
                    return;
                }
                
                if (confirm('Limpar todos os dados locais? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    try {
                        // 1. Limpa os dados
                        localStorage.removeItem('tools');
                        localStorage.removeItem('colaboradores');
                        localStorage.removeItem('historicoAtribuicoes');
                        
                        // 2. Carrega dados de exemplo
                        tools = getExampleTools();
                        colaboradores = getExampleColaboradores();
                        historicoAtribuicoes = [];
                        
                        // 3. Salva dados
                        await saveTools();
                        await saveColaboradores();
                        
                        // 4. Reconecta ao Supabase
                        isOnlineMode = false; // For√ßa reinicializa√ß√£o
                        const connected = await setupSupabaseClient(); // Reconecta ao Supabase
                        
                        // 5. Atualiza interface
                        updateInterface();
                        updateAtribuicaoUI();
                        
                        // 6. Feedback
                        if (connected) {
                            showNotification('Dados limpos e reconectado √† nuvem!', 'success');
                        } else {
                            showNotification('Dados limpos. Modo local ativo.', 'warning');
                        }
                    } catch (error) {
                        console.error('Erro ao limpar cache:', error);
                        console.error('Erro detalhado:', error.message);
                        showNotification(`Erro: ${error.message}`, 'error');
                    }
                }
            });
            
            // ===== OTIMIZAR =====
            document.getElementById('optimizeStorageBtn').addEventListener('click', function() {
                showNotification('Sistema otimizado!', 'success');
            });
        });

                // ============================================
        // SISTEMA DE ROMANEIO
        // ============================================

        // Array para armazenar ferramentas selecionadas para romaneio
        let romaneioSelectedTools = [];
        let romaneioTemplates = [];

        // Carregar templates salvos
        function loadRomaneioTemplates() {
            try {
                const saved = localStorage.getItem('romaneioTemplates');
                if (saved) {
                    romaneioTemplates = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Erro ao carregar templates:', error);
                romaneioTemplates = [];
            }
        }

        // Salvar templates
        function saveRomaneioTemplates() {
            try {
                localStorage.setItem('romaneioTemplates', JSON.stringify(romaneioTemplates));
                return true;
            } catch (error) {
                console.error('Erro ao salvar templates:', error);
                return false;
            }
        }

        // Carregar lista de ferramentas para o romaneio
        function loadRomaneioToolsList(searchTerm = '') {
            const tbody = document.getElementById('romaneioToolsList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            let filteredTools = tools;
            
            // Filtrar por busca
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredTools = tools.filter(tool => 
                    tool.name.toLowerCase().includes(term) ||
                    tool.code.toLowerCase().includes(term) ||
                    tool.category.toLowerCase().includes(term) ||
                    (tool.ncm && tool.ncm.toLowerCase().includes(term))
                );
            }
            
            // Ordenar por nome
            filteredTools.sort((a, b) => a.name.localeCompare(b.name));
            
            filteredTools.forEach((tool, index) => {
                const isSelected = romaneioSelectedTools.includes(tool.id);
                const estaAtribuida = isToolAssigned(tool.id);
                const statusParaExibir = estaAtribuida ? 'Em Uso' : tool.status;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 10px; text-align: center; vertical-align: middle;">
                        <input type="checkbox" class="romaneio-tool-checkbox" 
                               data-id="${tool.id}" 
                               ${isSelected ? 'checked' : ''}>
                    </td>
                    <td style="padding: 10px; vertical-align: middle;">
                        <strong>${tool.code}</strong>
                    </td>
                    <td style="padding: 10px; vertical-align: middle;">${tool.name}</td>
                    <td style="padding: 10px; vertical-align: middle;">${tool.category}</td>
                    <td style="padding: 10px; vertical-align: middle;">${tool.ncm || '-'}</td>
                    <td style="padding: 10px; vertical-align: middle;">${tool.location}</td>
                    <td style="padding: 10px; text-align: center; vertical-align: middle;">
                        ${tool.quantidade || 1}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateRomaneioSelectionCount();
            addRomaneioCheckboxListeners();
        }

        // Atualizar contagem de sele√ß√£o
        function updateRomaneioSelectionCount() {
            const countElement = document.getElementById('romaneioSelectionCount');
            if (!countElement) return;
            
            const count = romaneioSelectedTools.length;
            if (count === 0) {
                countElement.textContent = 'Nenhuma ferramenta selecionada';
                countElement.style.color = 'var(--gray-color)';
            } else {
                countElement.textContent = `${count} ferramenta${count !== 1 ? 's' : ''} selecionada${count !== 1 ? 's' : ''}`;
                countElement.style.color = 'var(--success-color)';
            }
        }

        // Adicionar listeners aos checkboxes
        function addRomaneioCheckboxListeners() {
            // Checkbox "Selecionar Todos"
            const checkAll = document.getElementById('checkAllRomaneio');
            if (checkAll) {
                checkAll.onclick = function() {
                    const checkboxes = document.querySelectorAll('.romaneio-tool-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                        const toolId = parseInt(cb.getAttribute('data-id'));
                        updateRomaneioSelection(toolId, this.checked);
                    });
                    updateRomaneioSelectionCount();
                };
            }
            
            // Checkboxes individuais
            document.querySelectorAll('.romaneio-tool-checkbox').forEach(checkbox => {
                checkbox.onclick = function() {
                    const toolId = parseInt(this.getAttribute('data-id'));
                    updateRomaneioSelection(toolId, this.checked);
                    updateRomaneioSelectionCount();
                    
                    // Atualizar "Selecionar Todos"
                    const allCheckboxes = document.querySelectorAll('.romaneio-tool-checkbox');
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    const anyChecked = Array.from(allCheckboxes).some(cb => cb.checked);
                    
                    const checkAll = document.getElementById('checkAllRomaneio');
                    if (checkAll) {
                        checkAll.checked = allChecked;
                        checkAll.indeterminate = !allChecked && anyChecked;
                    }
                };
            });
        }

        // Atualizar sele√ß√£o de ferramentas
        function updateRomaneioSelection(toolId, isSelected) {
            if (isSelected) {
                if (!romaneioSelectedTools.includes(toolId)) {
                    romaneioSelectedTools.push(toolId);
                }
            } else {
                const index = romaneioSelectedTools.indexOf(toolId);
                if (index > -1) {
                    romaneioSelectedTools.splice(index, 1);
                }
            }
        }

        // Selecionar todas as ferramentas
        function selectAllRomaneioTools() {
            const checkAll = document.getElementById('checkAllRomaneio');
            if (checkAll) {
                checkAll.checked = true;
                checkAll.click();
            }
        }

        // Limpar sele√ß√£o
        function clearRomaneioSelection() {
            romaneioSelectedTools = [];
            const checkAll = document.getElementById('checkAllRomaneio');
            if (checkAll) {
                checkAll.checked = false;
                checkAll.indeterminate = false;
            }
            
            document.querySelectorAll('.romaneio-tool-checkbox').forEach(cb => {
                cb.checked = false;
            });
            
            updateRomaneioSelectionCount();
            hideRomaneioPreview();
        }

        // Mostrar/ocultar pr√©-visualiza√ß√£o
        function showRomaneioPreview() {
            const previewCard = document.getElementById('romaneioPreviewCard');
            if (previewCard) {
                previewCard.style.display = 'block';
            }
        }

        function hideRomaneioPreview() {
            const previewCard = document.getElementById('romaneioPreviewCard');
            if (previewCard) {
                previewCard.style.display = 'none';
            }
        }

        // Gerar pr√©-visualiza√ß√£o do romaneio
        function generateRomaneioPreview() {
            if (romaneioSelectedTools.length === 0) {
                showNotification('Selecione ferramentas primeiro!', 'error');
                return;
            }
            
            const previewBody = document.getElementById('romaneioPreviewBody');
            if (!previewBody) return;
            
            previewBody.innerHTML = '';
            
            const selectedTools = tools.filter(tool => 
                romaneioSelectedTools.includes(tool.id)
            );
            
            selectedTools.forEach((tool, index) => {
                const estaAtribuida = isToolAssigned(tool.id);
                const statusParaExibir = estaAtribuida ? 'Em Uso' : tool.status;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${tool.code}</strong></td>
                    <td>${tool.name}</td>
                    <td>${tool.category}</td>
                    <td>${tool.ncm || '-'}</td>
                    <td>${tool.quantidade || 1}</td>
                    <td>${tool.location}</td>
                    <td><span class="status-badge ${getStatusClass(statusParaExibir)}">${statusParaExibir}</span></td>
                    <td>${tool.patrimonio || '-'}</td>
                `;
                previewBody.appendChild(row);
            });
            
            showRomaneioPreview();
            showNotification(`${selectedTools.length} ferramentas na pr√©-visualiza√ß√£o`, 'success');
        }

        // Gerar romaneio Excel usando a planilha base
async function generateRomaneioExcel() {
    if (romaneioSelectedTools.length === 0) {
        showNotification('Selecione ferramentas primeiro!', 'error');
        return;
    }
    
    try {
        // Mostrar loader
        const loader = document.createElement('div');
        loader.className = 'loader';
        loader.style.display = 'block';
        loader.style.margin = '20px auto';
        document.querySelector('#romaneio .btn-group').appendChild(loader);
        
        // Obter configura√ß√µes
        const title = document.getElementById('romaneioTitle').value || 'Romaneio de Ferramentas';
        const destination = document.getElementById('romaneioDestination').value || '';
        const responsible = document.getElementById('romaneioResponsible').value || '';
        const romaneioDate = document.getElementById('romaneioDate').value || new Date().toISOString().split('T')[0];
        const observations = document.getElementById('romaneioObservations').value || '';
        
        // Filtrar ferramentas selecionadas
        const selectedTools = tools.filter(tool => 
            romaneioSelectedTools.includes(tool.id)
        );
        
        // Calcular totais
        const totalQuantity = selectedTools.reduce((sum, tool) => sum + (tool.quantidade || 1), 0);
        const totalValue = selectedTools.reduce((sum, tool) => {
            const preco = parseFloat(tool.preco) || 0;
            const quantidade = parseInt(tool.quantidade) || 1;
            return sum + (preco * quantidade);
        }, 0);
        
        // Carregar a planilha base
        const response = await fetch('ROMANEIO (Base) - Copia.xlsx');
        if (!response.ok) {
            throw new Error('N√£o foi poss√≠vel carregar a planilha base');
        }
        
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        
        // Acessar a aba "DI√ÅRIO"
        const worksheet = workbook.Sheets[workbook.SheetNames[0]]; // Primeira aba
        
        // Preencher informa√ß√µes do cabe√ßalho
        const headerData = {
            // N√∫mero do romaneio (usar timestamp)
            'N¬∫': new Date().getTime().toString().slice(-6),
            
            // Data
            'DATA:': formatDateForExcel(romaneioDate),
            
            // Remetente (fixo da planilha)
            'REMETENTE:': 'Delservin Com√©rcio e Servi√ßos Industriais Ltda-ME',
            'END. REMT.:': 'Rua da Urca, 213 - Jd. Guanabara / Americana-SP',
            'CNPJ:': '01.864.998/0001-35',
            
            // Destinat√°rio (do formul√°rio)
            'DESTINAT√ÅRIO:': destination,
            'CNPJ:': '', // Preencher se tiver campo no formul√°rio
            'ENDERE√áO:': '', // Preencher se tiver campo no formul√°rio
            'CEP:': '', // Preencher se tiver campo no formul√°rio
            
            // Respons√°vel
            'MOTORISTA:': responsible,
            'TRANSPORTE:': '', // Preencher se tiver campo no formul√°rio
            'CENTRO DE CUST.:': '', // Preencher se tiver campo no formul√°rio
        };
        
        // Mapeamento das c√©lulas na planilha (voc√™ precisa ajustar baseado na sua planilha real)
        // Estas s√£o coordenadas aproximadas - voc√™ precisa verificar onde cada campo est√° na sua planilha
        const cellMap = {
            'N¬∫': 'Z8', // N√∫mero do romaneio
            'DATA:': 'AJ8', // Data
            
            // Remetente
            'ENDERE√áO:': 'D11',
            'END. REMT.:': 'D12',
            'CNPJ:': 'D13',
            
            // Destinat√°rio
            'DESTINAT√ÅRIO:': 'V11',
            'CNPJ:': 'V12',
            'ENDERE√áO:': 'V13',
            'CEP:': 'V14',
            
            // Outros campos
            'MOTORISTA:': 'D15',
            'TRANSPORTE:': 'D16',
            'CENTRO DE CUST.:': 'V15',
        };
        
        // Preencher cabe√ßalho
        Object.entries(headerData).forEach(([key, value]) => {
            if (cellMap[key]) {
                const cell = cellMap[key];
                worksheet[cell] = { t: 's', v: value };
                
                // Se for o n√∫mero do romaneio, tamb√©m preencher a c√©lula ao lado
                if (key === 'N¬∫') {
                    worksheet[cell] = { t: 'n', v: parseInt(value) };
                }
            }
        });
        
        
        // Carregar ferramentas dispon√≠veis para sa√≠da
        function loadFerramentasDisponiveisSaida() {
            const container = document.getElementById('ferramentasDisponiveisList');
            if (!container) return;

            container.innerHTML = '';

            // Filtrar ferramentas dispon√≠veis (n√£o atribu√≠das e status Dispon√≠vel)
            const ferramentasDisponiveis = tools.filter(tool => {
                // Verificar se est√° atribu√≠da a algum colaborador
                const estaAtribuida = isToolAssigned(tool.id);

                // Verificar se est√° em alguma sa√≠da ativa/atrasada
                const emSaidaAtiva = saidas.some(saida => 
                    (saida.status === 'ativa' || saida.status === 'atrasada') && 
                    saida.ferramentas.includes(tool.id)
                );

                return !estaAtribuida && !emSaidaAtiva && tool.status === 'Dispon√≠vel';
            });

            if (ferramentasDisponiveis.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--gray-color);">
                        <i class="fas fa-tools" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <p>Nenhuma ferramenta dispon√≠vel para sa√≠da</p>
                    </div>
                `;
                return;
            }

            ferramentasDisponiveis.forEach(tool => {
                const containerDiv = document.createElement('div');
                containerDiv.className = 'ferramenta-checkbox-container';

                const checkboxId = `ferramenta_${tool.id}`;
                const isSelected = saidaSelecionada?.ferramentas?.includes(tool.id) || false;

                containerDiv.innerHTML = `
                    <input type="checkbox" 
                           id="${checkboxId}" 
                           class="ferramenta-checkbox" 
                           value="${tool.id}"
                           ${isSelected ? 'checked' : ''}>
                    <div class="ferramenta-info">
                        <div class="ferramenta-nome">${tool.name}</div>
                        <div class="ferramenta-detalhes">
                            ${tool.code} | ${tool.category} | ${tool.location}
                        </div>
                    </div>
                `;

                // Adicionar evento de clique
                containerDiv.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });

                const checkbox = containerDiv.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        containerDiv.classList.add('selected');
                    } else {
                        containerDiv.classList.remove('selected');
                    }
                    updateSaidaResumo();
                });

                // Aplicar classe selected se j√° estiver selecionado
                if (isSelected) {
                    containerDiv.classList.add('selected');
                }

                container.appendChild(containerDiv);
            });
        }

        // Atualizar resumo da sa√≠da
        function updateSaidaResumo() {
            const resumoDiv = document.getElementById('saidaResumo');
            if (!resumoDiv) return;

            const checkboxes = document.querySelectorAll('.ferramenta-checkbox:checked');
            const selectedTools = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (selectedTools.length === 0) {
                resumoDiv.innerHTML = '<p>Nenhuma ferramenta selecionada</p>';
                document.getElementById('gerarTermoSaidaBtn').style.display = 'none';
                return;
            }

            // Calcular totais
            const selectedToolDetails = tools.filter(tool => selectedTools.includes(tool.id));
            const totalQuantidade = selectedToolDetails.reduce((sum, tool) => sum + (tool.quantidade || 1), 0);
            const totalValor = selectedToolDetails.reduce((sum, tool) => {
                const preco = parseFloat(tool.preco) || 0;
                const quantidade = parseInt(tool.quantidade) || 1;
                return sum + (preco * quantidade);
            }, 0);

            let resumoHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div><strong>Ferramentas Selecionadas:</strong></div>
                    <div><strong>${selectedTools.length}</strong></div>
                    <div><strong>Quantidade Total:</strong></div>
                    <div><strong>${totalQuantidade}</strong></div>
                    <div><strong>Valor Total Aproximado:</strong></div>
                    <div><strong>${formatCurrency(totalValor)}</strong></div>
                </div>
                <div style="max-height: 150px; overflow-y: auto;">
                    <ul style="margin: 0; padding-left: 20px;">
            `;

            selectedToolDetails.forEach(tool => {
                resumoHTML += `<li>${tool.code} - ${tool.name} (${tool.quantidade || 1} un)</li>`;
            });

            resumoHTML += `
                    </ul>
                </div>
            `;

            resumoDiv.innerHTML = resumoHTML;
            document.getElementById('gerarTermoSaidaBtn').style.display = 'inline-flex';
        }

        // Validar formul√°rio de sa√≠da
        function validateSaidaForm() {
            let isValid = true;

            const colaborador = document.getElementById('saidaColaborador').value;
            const dataSaida = document.getElementById('saidaData').value;
            const dataRetorno = document.getElementById('saidaRetornoPrevisto').value;
            const localUso = document.getElementById('saidaLocalUso').value.trim();

            // Limpar erros
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

            // Validar campos obrigat√≥rios
            if (!colaborador) {
                document.getElementById('saidaColaborador').classList.add('error');
                document.getElementById('saidaColaboradorError').style.display = 'block';
                isValid = false;
            }

            if (!dataSaida) {
                document.getElementById('saidaData').classList.add('error');
                isValid = false;
            }

            if (!dataRetorno) {
                document.getElementById('saidaRetornoPrevisto').classList.add('error');
                isValid = false;
            } else if (dataRetorno && dataSaida) {
                const saidaDate = new Date(dataSaida);
                const retornoDate = new Date(dataRetorno);
                if (retornoDate <= saidaDate) {
                    document.getElementById('saidaRetornoPrevisto').classList.add('error');
                    showNotification('A data de retorno deve ser posterior √† data de sa√≠da', 'error');
                    isValid = false;
                }
            }

            if (!localUso) {
                document.getElementById('saidaLocalUso').classList.add('error');
                isValid = false;
            }

            // Validar se h√° ferramentas selecionadas
            const checkboxes = document.querySelectorAll('.ferramenta-checkbox:checked');
            if (checkboxes.length === 0) {
                document.getElementById('ferramentasError').style.display = 'block';
                isValid = false;
    }

            return isValid;
                }

        // Registrar nova sa√≠da
        async function registrarSaida() {
            // Verificar permiss√£o
            if (currentUser.role === 'user') {
                showNotification('Usu√°rio n√£o tem permiss√£o para registrar sa√≠das.', 'error');
                return;
            }

            if (!validateSaidaForm()) {
                showNotification('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            try {
                // Obter dados do formul√°rio
                const colaboradorId = parseInt(document.getElementById('saidaColaborador').value);
                const colaborador = colaboradores.find(c => c.id === colaboradorId);

                if (!colaborador) {
                    showNotification('Colaborador n√£o encontrado!', 'error');
                    return;
                }

                const dataSaida = document.getElementById('saidaData').value;
                const dataRetornoPrevisto = document.getElementById('saidaRetornoPrevisto').value;
                const localUso = document.getElementById('saidaLocalUso').value.trim();
                const observacoes = document.getElementById('saidaObservacoes').value.trim();

                // Obter ferramentas selecionadas
                const checkboxes = document.querySelectorAll('.ferramenta-checkbox:checked');
                const ferramentasSelecionadas = Array.from(checkboxes).map(cb => parseInt(cb.value));

                // Verificar se as ferramentas ainda est√£o dispon√≠veis
                for (const toolId of ferramentasSelecionadas) {
                    const tool = tools.find(t => t.id === toolId);
                    if (!tool) {
                        showNotification(`Ferramenta n√£o encontrada (ID: ${toolId})`, 'error');
                        return;
                    }
                        
                // Verificar se ferramenta j√° est√° em sa√≠da ativa
                const emSaidaAtiva = saidas.some(saida => 
                    (saida.status === 'ativa' || saida.status === 'atrasada') && 
                    saida.ferramentas.includes(toolId)
                );
                    
                if (emSaidaAtiva) {
                    showNotification(`A ferramenta "${tool.name}" j√° est√° em uma sa√≠da ativa`, 'error');
                    return;
                }
            }
            
                // Criar objeto da sa√≠da
                const novaSaida = {
                    id: Date.now(),
                    colaboradorId: colaboradorId,
                    colaboradorNome: colaborador.nome,
                    colaboradorMatricula: colaborador.matricula,
                    dataSaida: dataSaida,
                    dataRetornoPrevisto: dataRetornoPrevisto,
                    dataRetornoReal: null,
                    localUso: localUso,
                    observacoes: observacoes,
                    status: 'ativa',
                    ferramentas: ferramentasSelecionadas,
                    ferramentasRetornadas: [],
                    usuarioRegistro: currentUser.name,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // Atualizar status das ferramentas para "Em Uso"
                ferramentasSelecionadas.forEach(toolId => {
                    const toolIndex = tools.findIndex(t => t.id === toolId);
                    if (toolIndex !== -1) {
                    tools[toolIndex].status = 'Em Uso';
                    tools[toolIndex].updatedAt = new Date().toISOString();
                }
            });
            
                // Adicionar √† lista de sa√≠das
                saidas.push(novaSaida);

                // Salvar altera√ß√µes
                await saveTools();
                await saveSaidas();
            
                // Atualizar interfaces
                updateSaidasList();
                updateSaidaStats();
                updateInterface(); // Atualiza a interface principal

                // Limpar formul√°rio
                limparFormularioSaida();

                showNotification(`Sa√≠da registrada para ${colaborador.nome} com ${ferramentasSelecionadas.length} ferramentas!`, 'success');

                // Gerar termo automaticamente se configurado
                const autoGerarTermo = localStorage.getItem('autoGerarTermoSaida') === 'true';
                if (autoGerarTermo) {
                    setTimeout(() => gerarTermoSaida(novaSaida.id), 1000);
                }

                } catch (error) {
                console.error('Erro ao registrar sa√≠da:', error);
                    showNotification('Erro ao registrar sa√≠da.', 'error');
                }
            }

                // Limpar formul√°rio de sa√≠da
                function limparFormularioSaida() {
                document.getElementById('saidaForm').reset();
    
                // Configurar datas padr√£o
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
    
                document.getElementById('saidaData').value = now.toISOString().slice(0, 16);
                document.getElementById('saidaRetornoPrevisto').value = tomorrow.toISOString().slice(0, 16);
    
                // Limpar sele√ß√£o de ferramentas
                document.querySelectorAll('.ferramenta-checkbox').forEach(cb => {
                cb.checked = false;
                cb.parentElement.classList.remove('selected');
            });
    
                document.getElementById('saidaId').value = '';
                document.getElementById('gerarTermoSaidaBtn').style.display = 'none';
    
                updateSaidaResumo();
    
                // Recarregar lista de ferramentas dispon√≠veis
                loadFerramentasDisponiveisSaida();
            }

                // Atualizar lista de sa√≠das
                function updateSaidasList(searchTerm = '') {
                const tbody = document.getElementById('saidasTableBody');
                const noSaidasRow = document.getElementById('noSaidasRow');
    
                if (!tbody) return;
    
                tbody.innerHTML = '';
                tbody.appendChild(noSaidasRow);
    
                let filteredSaidas = saidas;
    
                // Aplicar filtro de status
                if (currentSaidaFilter === 'ativas') {
                filteredSaidas = saidas.filter(s => s.status === 'ativa');
                } else if (currentSaidaFilter === 'atrasadas') {
                filteredSaidas = saidas.filter(s => s.status === 'atrasada');
                } else if (currentSaidaFilter === 'finalizadas') {
                filteredSaidas = saidas.filter(s => s.status === 'finalizada');
                }
    
                // Aplicar filtro de busca
                if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredSaidas = filteredSaidas.filter(saida => 
                saida.colaboradorNome.toLowerCase().includes(term) ||
                saida.colaboradorMatricula.toLowerCase().includes(term) ||
                saida.localUso.toLowerCase().includes(term) ||
                saida.observacoes.toLowerCase().includes(term) ||
                // Verificar se alguma ferramenta corresponde √† busca
                saida.ferramentas.some(toolId => {
                const tool = tools.find(t => t.id === toolId);
                return tool && (
                tool.name.toLowerCase().includes(term) ||
                tool.code.toLowerCase().includes(term)
                    );
                })
            );
        }
    
                // Ordenar por data de sa√≠da (mais recentes primeiro)
                filteredSaidas.sort((a, b) => new Date(b.dataSaida) - new Date(a.dataSaida));
    
                if (filteredSaidas.length === 0) {
            noSaidasRow.style.display = 'table-row';
            noSaidasRow.innerHTML = `<td colspan="8" style="text-align: center; padding: 40px; color: var(--gray-color);">
                Nenhuma sa√≠da encontrada${searchTerm ? ' para "' + searchTerm + '"' : ''}
            </td>`;
            return;
        }
    
                noSaidasRow.style.display = 'none';
    
                filteredSaidas.forEach(saida => {
            const row = document.createElement('tr');
            row.innerHTML = createSaidaTableRow(saida);
            tbody.appendChild(row);
        });
    
            addSaidasRowEventListeners();
            }

            // Criar linha da tabela de sa√≠das
            function createSaidaTableRow(saida) {
            // Contar ferramentas pendentes de retorno
            const ferramentasPendentes = saida.ferramentas.length - (saida.ferramentasRetornadas?.length || 0);

            // Formatar datas
            const dataSaidaFormatada = formatDateTime(saida.dataSaida);
            const dataPrevistaFormatada = formatDateTime(saida.dataRetornoPrevisto);

            // Determinar classe de status
            let statusClass = '';
            let statusText = '';

            switch(saida.status) {
                case 'ativa':
                    statusClass = 'status-ativa';
                    statusText = 'Ativa';
                    break;
                case 'atrasada':
                    statusClass = 'status-atrasada';
                    statusText = 'Atrasada';
                    break;
                case 'finalizada':
                    statusClass = 'status-finalizada';
                    statusText = 'Finalizada';
                break;
            default:
                statusClass = 'status-ontrack';
                statusText = saida.status;
        }
        
            // Verificar permiss√µes para a√ß√µes
            const canEdit = currentUser.role !== 'user';

            return `
                <td><strong>#${saida.id.toString().slice(-4)}</strong></td>
                <td>
                    <div><strong>${saida.colaboradorNome}</strong></div>
                    <div style="font-size: 12px; color: var(--gray-color);">${saida.colaboradorMatricula}</div>
                </td>
                <td>
                    <div>${saida.ferramentas.length} ferramentas</div>
                    <div style="font-size: 12px; color: var(--gray-color);">
                        ${ferramentasPendentes} pendentes
                    </div>
                </td>
                <td>${dataSaidaFormatada}</td>
                <td>${dataPrevistaFormatada}</td>
                <td>${saida.localUso}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn action-btn-view" data-id="${saida.id}" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${canEdit && saida.status !== 'finalizada' ? `
                            <button class="action-btn action-btn-success" data-id="${saida.id}" title="Registrar retorno">
                                <i class="fas fa-undo"></i>
                            </button>
                        ` : ''}
                        ${canEdit ? `
                            <button class="action-btn action-btn-edit" data-id="${saida.id}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn action-btn-danger" data-id="${saida.id}" title="Cancelar">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                        <button class="action-btn action-btn-view" data-id="${saida.id}" title="Gerar termo" style="color: #8e44ad;">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                    </div>
                </td>
            `;
        }

            // Adicionar event listeners √†s linhas de sa√≠das
            function addSaidasRowEventListeners() {
            // Bot√£o para ver detalhes
            document.querySelectorAll('.action-btn-view').forEach(btn => {
            if (btn.querySelector('.fa-eye')) {
            btn.addEventListener('click', function() {
                const saidaId = parseInt(this.getAttribute('data-id'));
                viewSaidaDetails(saidaId);
            });
        }
    });
    
            // Bot√£o para registrar retorno
            document.querySelectorAll('.action-btn-success').forEach(btn => {
                if (btn.querySelector('.fa-undo')) {
                btn.addEventListener('click', function() {
                    const saidaId = parseInt(this.getAttribute('data-id'));
                    showRetornoModal(saidaId);
            });
        }
    });
    
            // Bot√£o para editar
        document.querySelectorAll('.action-btn-edit').forEach(btn => {
            if (btn.querySelector('.fa-edit')) {
            btn.addEventListener('click', function() {
                const saidaId = parseInt(this.getAttribute('data-id'));
                editSaida(saidaId);
            });
        }
    });
    
    // Bot√£o para cancelar
    document.querySelectorAll('.action-btn-danger').forEach(btn => {
        if (btn.querySelector('.fa-times')) {
            btn.addEventListener('click', function() {
                const saidaId = parseInt(this.getAttribute('data-id'));
                cancelarSaida(saidaId);
            });
        }
    });
    
    // Bot√£o para gerar termo
    document.querySelectorAll('.action-btn-view').forEach(btn => {
        if (btn.querySelector('.fa-file-pdf')) {
            btn.addEventListener('click', function() {
                const saidaId = parseInt(this.getAttribute('data-id'));
                gerarTermoSaida(saidaId);
            });
        }
    });
}

// Ver detalhes da sa√≠da
function viewSaidaDetails(saidaId) {
    const saida = saidas.find(s => s.id === saidaId);
    if (!saida) return;
    
    const modalBody = document.getElementById('toolModalBody');
    if (!modalBody) return;
    
    const ferramentasPendentes = saida.ferramentas.length - (saida.ferramentasRetornadas?.length || 0);
    const statusClass = getSaidaStatusClass(saida.status);
    
    let ferramentasHTML = '';
    saida.ferramentas.forEach(toolId => {
        const tool = tools.find(t => t.id === toolId);
        if (tool) {
            const foiRetornada = saida.ferramentasRetornadas?.includes(toolId) || false;
            ferramentasHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                    <div>
                        <strong>${tool.code}</strong> - ${tool.name}
                        <div style="font-size: 12px; color: var(--gray-color);">
                            ${tool.category} | ${tool.location}
                        </div>
                    </div>
                    <span class="status-badge ${foiRetornada ? 'status-completed' : 'status-ontrack'}">
                        ${foiRetornada ? 'Retornada' : 'Pendente'}
                    </span>
                </div>
            `;
        }
    });
    
    modalBody.innerHTML = `
        <div style="max-width: 800px;">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">
                Sa√≠da #${saida.id.toString().slice(-4)} - ${saida.colaboradorNome}
            </h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                <div>
                    <h4 style="color: var(--secondary-color); margin-bottom: 10px;">
                        <i class="fas fa-user"></i> Informa√ß√µes do Colaborador
                    </h4>
                    <p><strong>Nome:</strong> ${saida.colaboradorNome}</p>
                    <p><strong>Matr√≠cula:</strong> ${saida.colaboradorMatricula}</p>
                    <p><strong>Usu√°rio Registro:</strong> ${saida.usuarioRegistro}</p>
                </div>
                
                <div>
                    <h4 style="color: var(--secondary-color); margin-bottom: 10px;">
                        <i class="fas fa-calendar-alt"></i> Datas
                    </h4>
                    <p><strong>Data de Sa√≠da:</strong> ${formatDateTime(saida.dataSaida)}</p>
                    <p><strong>Previsto Retorno:</strong> ${formatDateTime(saida.dataRetornoPrevisto)}</p>
                    ${saida.dataRetornoReal ? `
                        <p><strong>Retorno Real:</strong> ${formatDateTime(saida.dataRetornoReal)}</p>
                    ` : ''}
                </div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h4 style="color: var(--secondary-color); margin-bottom: 10px;">
                    <i class="fas fa-map-marker-alt"></i> Local de Uso
                </h4>
                <p>${saida.localUso}</p>
                ${saida.observacoes ? `
                    <div style="margin-top: 10px;">
                        <strong>Observa√ß√µes:</strong>
                        <p>${saida.observacoes}</p>
                    </div>
                ` : ''}
            </div>
            
            <div style="margin-bottom: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: var(--secondary-color); margin: 0;">
                        <i class="fas fa-tools"></i> Ferramentas (${saida.ferramentas.length})
                    </h4>
                    <span class="status-badge ${statusClass}">${saida.status}</span>
                </div>
                
                <div style="background-color: #f8f9fa; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    ${ferramentasHTML}
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <div style="text-align: center; padding: 10px; background-color: white; border-radius: 6px;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--success-color);">
                            ${saida.ferramentasRetornadas?.length || 0}
                        </div>
                        <div style="font-size: 12px; color: var(--gray-color);">Retornadas</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background-color: white; border-radius: 6px;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--warning-color);">
                            ${ferramentasPendentes}
                        </div>
                        <div style="font-size: 12px; color: var(--gray-color);">Pendentes</div>
                    </div>
                </div>
            </div>
            
            <div class="btn-group" style="justify-content: center;">
                <button class="btn btn-primary" onclick="gerarTermoSaida(${saida.id})">
                    <i class="fas fa-file-pdf"></i> Gerar Termo
                </button>
                ${saida.status !== 'finalizada' && currentUser.role !== 'user' ? `
                    <button class="btn btn-success" onclick="showRetornoModal(${saida.id})">
                        <i class="fas fa-undo"></i> Registrar Retorno
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('toolModal').style.display = 'flex';
}

// Obter classe CSS para status da sa√≠da
function getSaidaStatusClass(status) {
    switch(status) {
        case 'ativa': return 'status-ativa';
        case 'atrasada': return 'status-atrasada';
        case 'finalizada': return 'status-finalizada';
        default: return 'status-ontrack';
    }
}

// Mostrar modal de retorno
function showRetornoModal(saidaId) {
    saidaSelecionada = saidas.find(s => s.id === saidaId);
    if (!saidaSelecionada) return;
    
    const modalBody = document.getElementById('retornoModalBody');
    if (!modalBody) return;
    
    let ferramentasHTML = '';
    saidaSelecionada.ferramentas.forEach(toolId => {
        const tool = tools.find(t => t.id === toolId);
        if (tool) {
            const foiRetornada = saidaSelecionada.ferramentasRetornadas?.includes(toolId) || false;
            ferramentasHTML += `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 10px;">
                    <input type="checkbox" 
                           id="retorno_tool_${tool.id}" 
                           class="retorno-checkbox" 
                           value="${tool.id}"
                           ${foiRetornada ? 'checked disabled' : ''}>
                    <div style="flex-grow: 1;">
                        <strong>${tool.code}</strong> - ${tool.name}
                        <div style="font-size: 12px; color: var(--gray-color);">
                            ${tool.category} | Condi√ß√£o: ${tool.condition}
                        </div>
                    </div>
                    ${foiRetornada ? `
                        <span class="status-badge status-completed" style="font-size: 12px;">
                            <i class="fas fa-check"></i> Retornada
                        </span>
                    ` : ''}
                </div>
            `;
        }
    });
    
    modalBody.innerHTML = `
        <div>
            <h4 style="margin-bottom: 15px; color: var(--primary-color);">
                Registrar Retorno - ${saidaSelecionada.colaboradorNome}
            </h4>
            
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p><strong>Sa√≠da #${saidaSelecionada.id.toString().slice(-4)}</strong></p>
                <p><strong>Data de Sa√≠da:</strong> ${formatDateTime(saidaSelecionada.dataSaida)}</p>
                <p><strong>Previsto Retorno:</strong> ${formatDateTime(saidaSelecionada.dataRetornoPrevisto)}</p>
            </div>
            
            <div class="form-group">
                <label for="retornoData" class="required">Data do Retorno</label>
                <input type="datetime-local" id="retornoData" class="form-control" value="${new Date().toISOString().slice(0, 16)}">
            </div>
            
            <div class="form-group">
                <label>Condi√ß√£o das Ferramentas Retornadas</label>
                <select id="retornoCondicao" class="form-control">
                    <option value="">Selecione a condi√ß√£o</option>
                    <option value="Bom">Bom</option>
                    <option value="Regular">Regular</option>
                    <option value="Precisa de Reparo">Precisa de Reparo</option>
                    <option value="Danificado">Danificado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="retornoObservacoes">Observa√ß√µes do Retorno</label>
                <textarea id="retornoObservacoes" rows="3" class="form-control" placeholder="Observa√ß√µes sobre o retorno das ferramentas..."></textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label><strong>Selecionar Ferramentas Retornadas</strong></label>
                <div style="margin-top: 10px; max-height: 300px; overflow-y: auto;">
                    ${ferramentasHTML}
                </div>
            </div>
            
            <div class="btn-group" style="justify-content: center;">
                <button class="btn btn-success" id="registrarRetornoBtn">
                    <i class="fas fa-check-circle"></i> Registrar Retorno
                </button>
                <button class="btn btn-warning" id="retornarTodasBtn">
                    <i class="fas fa-check-double"></i> Retornar Todas
                </button>
            </div>
        </div>
    `;
    
    // Adicionar eventos
    document.getElementById('registrarRetornoBtn').onclick = () => registrarRetorno(saidaId);
    document.getElementById('retornarTodasBtn').onclick = () => {
        document.querySelectorAll('.retorno-checkbox:not(:disabled)').forEach(cb => {
            cb.checked = true;
        });
    };
    
    document.getElementById('retornoModal').style.display = 'flex';
}

// Registrar retorno de ferramentas
async function registrarRetorno(saidaId) {
    const saidaIndex = saidas.findIndex(s => s.id === saidaId);
    if (saidaIndex === -1) {
        showNotification('Sa√≠da n√£o encontrada!', 'error');
        return;
    }
    
    const dataRetorno = document.getElementById('retornoData').value;
    const condicao = document.getElementById('retornoCondicao').value;
    const observacoes = document.getElementById('retornoObservacoes').value.trim();
    
    if (!dataRetorno) {
        showNotification('Informe a data do retorno!', 'error');
        return;
    }
    
    // Obter ferramentas selecionadas para retorno
    const checkboxes = document.querySelectorAll('.retorno-checkbox:checked');
    const ferramentasRetornadas = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (ferramentasRetornadas.length === 0) {
        showNotification('Selecione pelo menos uma ferramenta para retorno!', 'error');
        return;
    }
    
    try {
        const saida = saidas[saidaIndex];
        
        // Adicionar √†s ferramentas retornadas (evitando duplicatas)
        ferramentasRetornadas.forEach(toolId => {
            if (!saida.ferramentasRetornadas?.includes(toolId)) {
                if (!saida.ferramentasRetornadas) saida.ferramentasRetornadas = [];
                saida.ferramentasRetornadas.push(toolId);
            }
            
            // Atualizar status da ferramenta para "Dispon√≠vel" se todas foram retornadas
            const todasRetornadas = saida.ferramentas.length === saida.ferramentasRetornadas.length;
            if (todasRetornadas) {
                const toolIndex = tools.findIndex(t => t.id === toolId);
                if (toolIndex !== -1) {
                    tools[toolIndex].status = 'Dispon√≠vel';
                    tools[toolIndex].condition = condicao || tools[toolIndex].condition;
                    tools[toolIndex].observations = observacoes 
                        ? `${tools[toolIndex].observations || ''} | Retorno: ${observacoes}`.trim()
                        : tools[toolIndex].observations;
                    tools[toolIndex].updatedAt = new Date().toISOString();
                }
            }
        });
        
        // Atualizar datas e status da sa√≠da
        saida.dataRetornoReal = dataRetorno;
        saida.updatedAt = new Date().toISOString();
        
        // Verificar se todas as ferramentas foram retornadas
        if (saida.ferramentas.length === saida.ferramentasRetornadas.length) {
            saida.status = 'finalizada';
            saida.observacoes = saida.observacoes 
                ? `${saida.observacoes} | Retorno completo em ${formatDateTime(dataRetorno)}: ${observacoes}`.trim()
                : `Retorno completo em ${formatDateTime(dataRetorno)}: ${observacoes}`.trim();
        } else {
            // Atualizar status para atrasada se passou da data prevista
            const dataPrevista = new Date(saida.dataRetornoPrevisto);
            const dataAtual = new Date();
            if (dataAtual > dataPrevista) {
                saida.status = 'atrasada';
            }
        }
        
        // Salvar altera√ß√µes
        await saveTools();
        await saveSaidas();
        
        // Atualizar interfaces
        updateSaidasList();
        updateSaidaStats();
        updateInterface();
        
        // Fechar modal
        document.getElementById('retornoModal').style.display = 'none';
        
        showNotification(`${ferramentasRetornadas.length} ferramentas retornadas com sucesso!`, 'success');
        
    } catch (error) {
        console.error('Erro ao registrar retorno:', error);
        showNotification('Erro ao registrar retorno.', 'error');
    }
}

// Fun√ß√£o auxiliar para formatar data e hora
function formatDateTime(dateTimeString) {
    if (!dateTimeString) return '-';
    
    try {
        const date = new Date(dateTimeString);
        return date.toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateTimeString;
    }
}

// Adicione esta fun√ß√£o ao inicializeSystem():
async function initializeSaidaModule() {
    loadSaidas();
    loadColaboradoresSelect();
    loadFerramentasDisponiveisSaida();
    updateSaidasList();
    updateSaidaStats();
    
    // Configurar datas padr√£o no formul√°rio
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const saidaDataInput = document.getElementById('saidaData');
    const retornoDataInput = document.getElementById('saidaRetornoPrevisto');
    
    if (saidaDataInput) {
        saidaDataInput.value = now.toISOString().slice(0, 16);
    }
    
    if (retornoDataInput) {
        retornoDataInput.value = tomorrow.toISOString().slice(0, 16);
    }
}

// E adicione este evento listener para quando a aba for clicada:
document.querySelector('[data-tab="saida-ferramentas"]')?.addEventListener('click', function() {
    initializeSaidaModule();
});


        // Preencher itens (come√ßando da linha 20, coluna B)
        let startRow = 20; // Linha onde come√ßa a lista de itens
        
        selectedTools.forEach((tool, index) => {
            const row = startRow + index;
            
            // N√∫mero sequencial
            worksheet[`B${row}`] = { t: 'n', v: index + 1 };
            
            // Descri√ß√£o do material (coluna C)
            worksheet[`C${row}`] = { t: 's', v: tool.name };
            
            // N.C.M. (coluna Q)
            worksheet[`Q${row}`] = { t: 's', v: tool.ncm || '' };
            
            // N√∫mero do patrim√¥nio (coluna W)
            worksheet[`W${row}`] = { t: 's', v: tool.patrimonio || '' };
            
            // Quantidade (coluna AG)
            worksheet[`AG${row}`] = { t: 'n', v: tool.quantidade || 1 };
            
            // Descri√ß√£o adicional (coluna AI) - pode ser categoria ou observa√ß√µes
            worksheet[`AI${row}`] = { t: 's', v: tool.category };
            
            // Valor unit√°rio (coluna AK)
            worksheet[`AK${row}`] = { t: 'n', v: tool.preco || 0 };
            
            // Se voc√™ tem mais colunas, ajuste aqui:
            // - C√≥digo do produto
            // - Unidade de medida
            // - Valor total (quantidade √ó valor unit√°rio)
        });
        
        // Remover f√≥rmulas das linhas restantes (se houver)
        for (let i = startRow + selectedTools.length; i <= startRow + 50; i++) {
            if (worksheet[`B${i}`] && worksheet[`B${i}`].f) {
                delete worksheet[`B${i}`].f; // Remover f√≥rmula
                worksheet[`B${i}`] = { t: 's', v: '' }; // Deixar vazio
            }
        }
        
        // Criar nova planilha com os dados processados
        const processedWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(processedWorkbook, worksheet, 'DI√ÅRIO');
        
        // Adicionar uma aba extra com informa√ß√µes resumidas
        const summaryData = [
            ['RESUMO DO ROMANEIO'],
            ['T√≠tulo:', title],
            ['Destino:', destination],
            ['Respons√°vel:', responsible],
            ['Data:', romaneioDate],
            ['Observa√ß√µes:', observations],
            [''],
            ['TOTAL DE ITENS:', selectedTools.length],
            ['QUANTIDADE TOTAL:', totalQuantity],
            ['VALOR TOTAL:', formatCurrencyForExport(totalValue)],
            [''],
            ['Itens inclu√≠dos:'],
            ...selectedTools.map(tool => [
                tool.code,
                tool.name,
                tool.quantidade || 1,
                tool.unidade || 'UN',
                formatCurrencyForExport(tool.preco || 0)
            ])
        ];
        
        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(processedWorkbook, summarySheet, 'Resumo');
        
        // Gerar nome do arquivo
        const fileName = `ROMANEIO_${title.replace(/[^a-z0-9]/gi, '_')}_${romaneioDate}.xlsx`;
        
        // Salvar arquivo
        XLSX.writeFile(processedWorkbook, fileName);
        
        // Remover loader
        loader.remove();
        
        // Registrar no hist√≥rico
        addToRomaneioHistory(title, selectedTools.length, totalValue);
        
        showNotification(`Romaneio "${title}" gerado com ${selectedTools.length} itens!`, 'success');
        
    } catch (error) {
        console.error('Erro ao gerar romaneio:', error);
        
        // Remover loader se houver erro
        const loader = document.querySelector('#romaneio .loader');
        if (loader) loader.remove();
        
        showNotification(`Erro ao gerar romaneio: ${error.message}`, 'error');
        
        // Se falhar ao carregar a planilha base, usar o m√©todo antigo como fallback
        if (error.message.includes('planilha base')) {
            showNotification('Usando formato padr√£o...', 'warning');
            generateRomaneioExcelFallback();
        }
    }
}

        // Fun√ß√£o fallback caso a planilha base n√£o esteja dispon√≠vel
        function generateRomaneioExcelFallback() {
        // C√≥digo original da fun√ß√£o generateRomaneioExcel aqui
        // (mantenha o c√≥digo antigo como backup)
    
        showNotification('Gerando romaneio em formato padr√£o...', 'info');
        // ... resto do c√≥digo original ...
    }

        // Fun√ß√£o auxiliar para formatar data para Excel
        function formatDateForExcel(dateString) {
        if (!dateString) return '';
    
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        } catch (e) {
            return dateString;
        }
    }
        
        // Adicionar ao hist√≥rico de romaneios
        function addToRomaneioHistory(title, itemCount, totalValue) {
            const historyItem = {
                id: Date.now(),
                title: title,
                date: new Date().toISOString(),
                itemCount: itemCount,
                totalValue: totalValue,
                tools: romaneioSelectedTools.slice()
            };
            
            // Adicionar ao in√≠cio do array
            romaneioTemplates.unshift(historyItem);
            
            // Manter apenas os √∫ltimos 10
            if (romaneioTemplates.length > 10) {
                romaneioTemplates = romaneioTemplates.slice(0, 10);
            }
            
            saveRomaneioTemplates();
        }

        // Salvar como template
        function saveRomaneioTemplate() {
            if (romaneioSelectedTools.length === 0) {
                showNotification('Selecione ferramentas primeiro!', 'error');
                return;
            }
            
            const title = document.getElementById('romaneioTitle').value || 'Romaneio de Ferramentas';
            const templateName = prompt('Nome para este template:', title);
            
            if (!templateName) return;
            
            const template = {
                id: Date.now(),
                name: templateName,
                date: new Date().toISOString(),
                title: title,
                destination: document.getElementById('romaneioDestination').value || '',
                responsible: document.getElementById('romaneioResponsible').value || '',
                observations: document.getElementById('romaneioObservations').value || '',
                includeImages: document.getElementById('romaneioIncludeImages').checked,
                includeQR: document.getElementById('romaneioIncludeQR').checked,
                includePrices: document.getElementById('romaneioIncludePrices').checked,
                includeLocation: document.getElementById('romaneioIncludeLocation').checked,
                includeNCM: document.getElementById('romaneioIncludeNCM').checked,
                tools: romaneioSelectedTools.slice()
            };
            
            romaneioTemplates.push(template);
            saveRomaneioTemplates();
            
            showNotification(`Template "${templateName}" salvo!`, 'success');
        }

        // Carregar template
        function loadRomaneioTemplate(templateId) {
            const template = romaneioTemplates.find(t => t.id === templateId);
            if (!template) {
                showNotification('Template n√£o encontrado!', 'error');
                return;
            }
            
            // Preencher configura√ß√µes
            document.getElementById('romaneioTitle').value = template.title;
            document.getElementById('romaneioDestination').value = template.destination || '';
            document.getElementById('romaneioResponsible').value = template.responsible || '';
            document.getElementById('romaneioObservations').value = template.observations || '';
            document.getElementById('romaneioIncludeImages').checked = template.includeImages;
            document.getElementById('romaneioIncludeQR').checked = template.includeQR;
            document.getElementById('romaneioIncludePrices').checked = template.includePrices;
            document.getElementById('romaneioIncludeLocation').checked = template.includeLocation;
            document.getElementById('romaneioIncludeNCM').checked = template.includeNCM;
            
            // Carregar ferramentas
            romaneioSelectedTools = template.tools.slice();
            
            // Atualizar checkboxes
            document.querySelectorAll('.romaneio-tool-checkbox').forEach(cb => {
                const toolId = parseInt(cb.getAttribute('data-id'));
                cb.checked = romaneioSelectedTools.includes(toolId);
            });
            
            updateRomaneioSelectionCount();
            showNotification(`Template "${template.name}" carregado!`, 'success');
        }

                // ============================================
        // EVENT LISTENERS PARA ROMANEIO
        // ============================================

        // Fun√ß√£o para inicializar event listeners do romaneio
        function initializeRomaneioListeners() {
            // Bot√£o "Selecionar Todas"
            const selectAllBtn = document.getElementById('selectAllToolsBtn');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', selectAllRomaneioTools);
            }
            
            // Bot√£o "Gerar Romaneio Excel" - USAR A NOVA FUN√á√ÉO
            const generateBtn = document.getElementById('generateRomaneioBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', generateRomaneioExcelWithCustomFormat);
            }
            
            // Bot√£o "Visualizar Romaneio"
            const previewBtn = document.getElementById('previewRomaneioBtn');
            if (previewBtn) {
                previewBtn.addEventListener('click', generateRomaneioPreview);
            }
            
            // Bot√£o "Limpar Sele√ß√£o"
            const clearBtn = document.getElementById('clearRomaneioBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearRomaneioSelection);
            }
            
            // Bot√£o "Salvar como Modelo"
            const saveTemplateBtn = document.getElementById('saveRomaneioTemplateBtn');
            if (saveTemplateBtn) {
                saveTemplateBtn.addEventListener('click', saveRomaneioTemplate);
            }
            
            // Bot√£o "Exportar Este Romaneio" (na pr√©-visualiza√ß√£o)
            const exportPreviewBtn = document.getElementById('exportPreviewBtn');
            if (exportPreviewBtn) {
                exportPreviewBtn.addEventListener('click', generateRomaneioExcel);
            }
            
            // Busca na lista de ferramentas
            const searchInput = document.getElementById('searchRomaneio');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    loadRomaneioToolsList(this.value);
                });
            }
            
            // Configurar data atual
            const romaneioDateInput = document.getElementById('romaneioDate');
            if (romaneioDateInput) {
                romaneioDateInput.value = new Date().toISOString().split('T')[0];
            }
        }

        // Fun√ß√£o para carregar dados do romaneio quando a aba for aberta
        function loadRomaneioData() {
            loadRomaneioToolsList();
            loadRomaneioTemplates();
            updateRomaneioSelectionCount();
            hideRomaneioPreview();
            
            // Configurar data atual
            const romaneioDateInput = document.getElementById('romaneioDate');
            if (romaneioDateInput && !romaneioDateInput.value) {
                romaneioDateInput.value = new Date().toISOString().split('T')[0];
            }
        }
        
    </script>
</body>
</html>


