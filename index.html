<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    <title>Sistema de Ferramentas Mobile</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="fw_mini.ICO">
    <link rel="shortcut icon" href="fw_mini.ICO" type="image/x-icon">
    <link rel="apple-touch-icon" href="fw_mini.ICO">
    
    <!-- CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- Biblioteca para scanner de QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #2980b9;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --gray-color: #95a5a6;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            background-color: #f5f7fa;
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        
        /* Login Screen */
        .login-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .login-box {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 16px;
            padding: 30px 25px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        /* Dashboard Mobile */
        .mobile-dashboard {
            display: none;
            flex-direction: column;
            height: 100vh;
        }
        
        .mobile-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            padding: 15px;
            padding-top: calc(15px + env(safe-area-inset-top, 0));
            color: white;
        }
        
        .mobile-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 70px;
            -webkit-overflow-scrolling: touch;
        }
        
        .mobile-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            padding: 10px 0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0));
            z-index: 100;
        }
        
        /* Menu Lateral */
        .mobile-sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background: white;
            z-index: 2000;
            transition: right 0.3s;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }
        
        .mobile-sidebar.open {
            right: 0;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }
        
        .menu-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }
        
        .menu-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .menu-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            color: var(--text-color);
            font-size: 16px;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }
        
        .menu-item:hover {
            background: var(--light-color);
        }
        
        .menu-item i {
            margin-right: 12px;
            width: 24px;
            text-align: center;
            color: var(--secondary-color);
        }
        
        .menu-item.logout {
            color: var(--danger-color);
        }
        
        .menu-item.logout i {
            color: var(--danger-color);
        }
        
        /* Tabs */
        .tab-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            padding: 8px 5px;
            color: var(--gray-color);
            font-size: 11px;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: var(--secondary-color);
        }
        
        .tab-button i {
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        /* Miniaturas de Imagens */
        .thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-color);
            font-size: 24px;
        }
        
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        /* Loader */
        .loader {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            transform: translateY(-100%);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.success {
            background: var(--success-color);
        }
        
        .notification.error {
            background: var(--danger-color);
        }
        
        .notification.warning {
            background: var(--warning-color);
        }
        
        /* Formulário */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: white;
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* Botões */
        .mobile-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .mobile-btn-primary {
            background: var(--secondary-color);
            color: white;
        }
        
        /* Scanner */
        .scanner-container {
            width: 100%;
            height: 300px;
            background: var(--light-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 2px solid #00ff00;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
        }
        
        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #00ff00;
            box-shadow: 0 0 8px #00ff00;
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        /* Tool Actions */
        .tool-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .action-btn.view {
            background: var(--secondary-color);
            color: white;
        }
        
        .action-btn.qr {
            background: #8e44ad;
            color: white;
        }
        
        /* Image Preview */
        .image-preview {
            width: 100%;
            height: 200px;
            background: var(--light-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* Canvas do Scanner */
        #qr-canvas {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <div class="login-box">
                <div style="text-align: center; margin-bottom: 30px;">
                    <!-- Logo Delservin simples e centralizado -->
                    <div style="margin-bottom: 20px;">
                        <img src="Delservin Logo.PNG" alt="Delservin" 
                             style="height: 50px; width: auto;"
                             onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"
                    </div>
                    
                    <h1 style="font-size: 24px; margin-bottom: 10px;">Sistema de Ferramentas</h1>
                    <p style="opacity: 0.9;">Login Mobile</p>
                </div>
                
                <div id="loginError" class="notification error" style="display: none; position: relative; top: 0; transform: none; opacity: 1; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-circle"></i> Credenciais inválidas
                </div>
                
                <div class="form-group">
                    <label for="loginEmail">Email ou Usuário</label>
                    <input type="text" id="loginEmail" placeholder="fabio@fwcompany.com.br" autocapitalize="off" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha" autocomplete="current-password">
                </div>
                
                <button type="button" class="mobile-btn mobile-btn-primary" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
            </div>
        </div>
        
        <!-- Dashboard Mobile -->
        <div id="mobileDashboard" class="mobile-dashboard">
            <!-- Header -->
            <header class="mobile-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h1 style="font-size: 18px; font-weight: bold;">Sistema de Ferramentas</h1>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                            <span id="userBadge" style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px;">DEV</span>
                            <span id="connectionStatus" style="background: rgba(231,76,60,0.2); color: #e74c3c; padding: 4px 10px; border-radius: 12px; font-size: 12px;">Offline</span>
                        </div>
                    </div>
                    <button id="menuBtn" style="background: rgba(255,255,255,0.2); border: none; width: 44px; height: 44px; border-radius: 50%; color: white; font-size: 20px;">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                
                <!-- Stats -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Itens</div>
                        <div style="font-size: 20px; font-weight: bold;" id="totalItems">0/0</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Valor</div>
                        <div style="font-size: 20px; font-weight: bold;" id="totalValue">R$ 0</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Status</div>
                        <div style="font-size: 20px; font-weight: bold;" id="syncStatus">Local</div>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <div class="mobile-content">
                <!-- Dashboard Tab -->
                <div id="tabDashboard" class="tab-content active">
                    <h2 style="margin-bottom: 20px; font-size: 20px;">Dashboard</h2>
                    
                    <!-- Card de Controle de Sincronização -->
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">Controle de Sincronização</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <button id="syncAllBtn" class="mobile-btn" style="background: #8e44ad; color: white;">
                                <i class="fas fa-database"></i> Buscar Tudo
                            </button>
                            <button id="syncUpdatesBtn" class="mobile-btn" style="background: #3498db; color: white;">
                                <i class="fas fa-sync"></i> Só Atualizações
                            </button>
                        </div>
                        <div style="font-size: 12px; color: var(--gray-color); text-align: center;">
                            <span id="syncInfo">Última sincronização: Nunca</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-pie" style="color: var(--secondary-color);"></i>
                            Status dos Itens
                        </h3>
                        <div id="statusStats">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px;">Carregando...</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">Ações Rápidas</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <button class="mobile-btn" id="addItemBtn" style="background: var(--secondary-color); color: white;">
                                <i class="fas fa-plus"></i> Novo Item
                            </button>
                            <button class="mobile-btn" id="syncNowBtn" style="background: var(--success-color); color: white;">
                                <i class="fas fa-sync-alt"></i> Sincronizar
                            </button>
                            <button class="mobile-btn" id="clearCacheBtn" style="background: var(--warning-color); color: white; grid-column: span 2;">
                                <i class="fas fa-trash-alt"></i> Limpar Cache
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Itens Recentes</h3>
                            <button id="viewAllBtn" style="background: none; border: none; color: var(--secondary-color); font-size: 14px;">
                                Ver Todos
                            </button>
                        </div>
                        <div id="recentItems">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px;">Nenhum item cadastrado</p>
                        </div>
                    </div>
                </div>
                
                <!-- Cadastro Tab -->
                <div id="tabCadastro" class="tab-content" style="display: none;">
                    <h2 style="margin-bottom: 20px; font-size: 20px;">Cadastrar Item</h2>
                    <div id="cadastroForm">
                        <!-- Form será carregado aqui -->
                    </div>
                </div>
                
                <!-- Catálogo Tab -->
                <div id="tabCatalogo" class="tab-content" style="display: none;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div style="flex: 1; position: relative;">
                            <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray-color);"></i>
                            <input type="text" id="searchInput" placeholder="Buscar..." style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 16px;">
                        </div>
                        <button id="filterBtn" style="background: var(--light-color); border: none; width: 50px; border-radius: 10px;">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 15px; font-size: 14px; color: var(--gray-color); text-align: center;">
                        <span id="toolsCount">0 de 0 itens carregados</span>
                        <button id="loadMoreBtn" style="background: none; border: none; color: var(--secondary-color); font-size: 14px; margin-left: 10px; display: none;">
                            Carregar mais
                        </button>
                    </div>
                    
                    <div id="toolsList">
                        <!-- Lista será carregada aqui -->
                    </div>
                </div>
                
                <!-- Scanner Tab -->
                <div id="tabScanner" class="tab-content" style="display: none;">
                    <h2 style="margin-bottom: 20px; font-size: 20px;">Scanner QR Code</h2>
                    
                    <div class="card">
                        <div class="scanner-container" id="scannerContainer">
                            <i class="fas fa-qrcode" style="font-size: 60px; color: var(--gray-color); margin-bottom: 15px;"></i>
                            <p style="text-align: center; color: var(--gray-color);">Área do scanner</p>
                            <p style="text-align: center; font-size: 12px; color: var(--gray-color); margin-top: 10px;">
                                Toque para ativar a câmera
                            </p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button id="startScannerBtn" class="mobile-btn" style="background: var(--secondary-color); color: white;">
                                <i class="fas fa-camera"></i> Iniciar Scanner
                            </button>
                            <button id="stopScannerBtn" class="mobile-btn" style="background: var(--danger-color); color: white; display: none;">
                                <i class="fas fa-stop"></i> Parar Scanner
                            </button>
                        </div>
                        
                        <div id="scannerResult" style="margin-top: 20px; display: none;">
                            <h4 style="margin-bottom: 10px;">Resultado:</h4>
                            <div id="scannedData" style="background: var(--light-color); padding: 15px; border-radius: 8px; font-size: 14px;">
                                <!-- Dados escaneados aparecerão aqui -->
                            </div>
                            <div style="margin-top: 15px;">
                                <button id="viewScannedItemBtn" class="mobile-btn" style="background: var(--secondary-color); color: white; display: none;">
                                    <i class="fas fa-eye"></i> Ver Item
                                </button>
                                <button id="scanAgainBtn" class="mobile-btn" style="background: var(--warning-color); color: white;">
                                    <i class="fas fa-redo"></i> Escanear Novamente
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Config Tab -->
                <div id="tabConfig" class="tab-content" style="display: none;">
                    <h2 style="margin-bottom: 20px; font-size: 20px;">Configurações</h2>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">Configurações do Sistema</h3>
                        
                        <div class="form-group">
                            <label for="syncLimit">Limite de itens por sincronização:</label>
                            <select id="syncLimit" class="form-control">
                                <option value="100">100 itens</option>
                                <option value="500" selected>500 itens</option>
                                <option value="1000">1000 itens</option>
                                <option value="0">Todos os itens</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="cacheSize">Tamanho máximo do cache (MB):</label>
                            <input type="number" id="cacheSize" min="10" max="1000" value="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="autoSync">Sincronização automática:</label>
                            <select id="autoSync" class="form-control">
                                <option value="disabled">Desativada</option>
                                <option value="enabled" selected>Ativada</option>
                            </select>
                        </div>
                        
                        <button id="saveConfigBtn" class="mobile-btn" style="background: var(--success-color); color: white;">
                            <i class="fas fa-save"></i> Salvar Configurações
                        </button>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 10px;">Informações do Sistema</h4>
                            <div style="font-size: 14px;">
                                <p><strong>Versão:</strong> 1.0.0</p>
                                <p><strong>Itens locais:</strong> <span id="localItemsCount">0</span></p>
                                <p><strong>Última sincronização:</strong> <span id="lastSyncTime">Nunca</span></p>
                                <p><strong>Armazenamento usado:</strong> <span id="storageUsed">0 MB</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loader -->
                <div id="loader" class="loader"></div>
            </div>
            
            <!-- Footer Tabs -->
            <footer class="mobile-footer">
                <button class="tab-button active" data-tab="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Início</span>
                </button>
                <button class="tab-button" data-tab="cadastro">
                    <i class="fas fa-plus-circle"></i>
                    <span>Novo</span>
                </button>
                <button class="tab-button" data-tab="catalogo">
                    <i class="fas fa-list"></i>
                    <span>Itens</span>
                </button>
                <button class="tab-button" data-tab="scanner">
                    <i class="fas fa-qrcode"></i>
                    <span>Scanner</span>
                </button>
                <button class="tab-button" data-tab="config">
                    <i class="fas fa-cog"></i>
                    <span>Config</span>
                </button>
            </footer>
        </div>
        
        <!-- Menu Lateral -->
        <div id="menuOverlay" class="menu-overlay"></div>
        <div id="mobileSidebar" class="mobile-sidebar">
            <div class="menu-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h3 id="menuUserName">Usuário</h3>
                        <p id="menuUserEmail" style="font-size: 14px; opacity: 0.9;">email@exemplo.com</p>
                        <p id="menuUserRole" style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; display: inline-block;">DEV</p>
                    </div>
                </div>
            </div>
            
            <div class="menu-content">
                <button class="menu-item" onclick="showUserProfile()">
                    <i class="fas fa-user-circle"></i> Meu Perfil
                </button>
                <button class="menu-item" onclick="switchTab('config')">
                    <i class="fas fa-cog"></i> Configurações
                </button>
                <button class="menu-item" onclick="showAbout()">
                    <i class="fas fa-info-circle"></i> Sobre o Sistema
                </button>
                <button class="menu-item" onclick="showHelp()">
                    <i class="fas fa-question-circle"></i> Ajuda
                </button>
                
                <div style="margin: 20px 0; padding: 0 15px; font-size: 12px; color: var(--gray-color); text-transform: uppercase;">
                    Administração
                </div>
                
                <button class="menu-item" onclick="manageUsers()">
                    <i class="fas fa-users"></i> Gerenciar Usuários
                </button>
                <button class="menu-item" onclick="showReports()">
                    <i class="fas fa-chart-bar"></i> Relatórios
                </button>
                <button class="menu-item" onclick="backupData()">
                    <i class="fas fa-database"></i> Backup de Dados
                </button>
            </div>
            
            <div class="menu-footer">
                <button class="menu-item logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Sair do Sistema
                </button>
            </div>
        </div>
        
        <!-- Modal para Detalhes do Item -->
        <div id="itemModal" class="modal-overlay">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px;" id="modalTitle">Detalhes do Item</h3>
                    <button id="closeModalBtn" style="background: none; border: none; font-size: 20px; color: var(--gray-color);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="modalBody">
                    <!-- Conteúdo do modal será carregado aqui -->
                </div>
            </div>
        </div>
        
        <!-- Modal QR Code -->
        <div id="qrModal" class="modal-overlay">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px;">QR Code do Item</h3>
                    <button id="closeQRModalBtn" style="background: none; border: none; font-size: 20px; color: var(--gray-color);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="qrModalBody" style="text-align: center;">
                    <!-- QR Code será gerado aqui -->
                </div>
            </div>
        </div>
        
        <!-- Notification Toast -->
        <div id="notification" class="notification">
            <div id="notificationContent"></div>
        </div>
    </div>

    <!-- Canvas oculto para processamento do QR Code -->
    <canvas id="qr-canvas" style="display: none;"></canvas>

    <script>
        // ============================================
        // CONFIGURAÇÃO SUPABASE
        // ============================================
        const SUPABASE_CONFIG = {
            url: 'https://azlgjkjzitbolyfyyaip.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6bGdqa2p6aXRib2x5Znl5YWlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MTQ1NjcsImV4cCI6MjA4MTk5MDU2N30.PefjFNb5Phq2ZkR26-RlJdb-pnFUbYp1PxjYwI1LUpA'
        };

        // ============================================
        // VARIÁVEIS GLOBAIS
        // ============================================
        let currentUser = null;
        let tools = [];
        let supabaseClient = null;
        let isOnline = navigator.onLine;
        let currentTab = 'dashboard';
        let db = null;
        let loadedToolsCount = 0;
        let totalToolsInDB = 0;
        let scannerActive = false;
        let videoStream = null;
        let scanningInterval = null;
        let currentScannedData = null;

        // ============================================
        // FUNÇÕES DE CONTROLE DE MODAL
        // ============================================

        function setupModalEvents() {
            // Fechar modal principal
            const closeModalBtn = document.getElementById('closeModalBtn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeItemModal);
            }
            
            // Fechar modal QR Code
            const closeQRModalBtn = document.getElementById('closeQRModalBtn');
            if (closeQRModalBtn) {
                closeQRModalBtn.addEventListener('click', closeQRModal);
            }
            
            // Fechar modais clicando fora do conteúdo
            const itemModal = document.getElementById('itemModal');
            const qrModal = document.getElementById('qrModal');
            
            if (itemModal) {
                itemModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeItemModal();
                    }
                });
            }
            
            if (qrModal) {
                qrModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeQRModal();
                    }
                });
            }
        }

        function closeItemModal() {
            document.getElementById('itemModal').style.display = 'none';
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // ============================================
        // FUNÇÕES AUSENTES QUE ESTAVAM FALTANDO
        // ============================================
        
        // FUNÇÃO: Atualizar estatísticas de status
        function updateStatusStats() {
            const statsElement = document.getElementById('statusStats');
            
            if (tools.length === 0) {
                statsElement.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px;">Nenhum item cadastrado</p>';
                return;
            }
            
            // Contar status
            const stats = {
                'Disponível': 0,
                'Em Uso': 0,
                'Manutenção': 0,
                'Danificado': 0,
                'Outro': 0
            };
            
            tools.forEach(tool => {
                if (stats[tool.status] !== undefined) {
                    stats[tool.status]++;
                } else {
                    stats['Outro']++;
                }
            });
            
            // Gerar HTML
            let html = '';
            const total = tools.length;
            
            for (const [status, count] of Object.entries(stats)) {
                if (count > 0) {
                    const percent = Math.round((count / total) * 100);
                    const color = getStatusColor(status);
                    
                    html += `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px;">
                                <span>${status}</span>
                                <span>${count} (${percent}%)</span>
                            </div>
                            <div style="height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percent}%; height: 100%; background: ${color};"></div>
                            </div>
                        </div>
                    `;
                }
            }
            
            statsElement.innerHTML = html;
        }

        // FUNÇÃO: Atualizar itens recentes
        function updateRecentItems() {
            const recentElement = document.getElementById('recentItems');
            const recent = tools.slice(0, 5); // Primeiros 5 itens (mais recentes)
            
            if (recent.length === 0) {
                recentElement.innerHTML = '<p style="text-align: center; color: var(--gray-color);">Nenhum item recente</p>';
                return;
            }
            
            let html = '';
            recent.forEach(tool => {
                const thumbnailHTML = tool.image ? 
                    `<img src="${tool.image}" alt="${tool.name}" style="width:40px;height:40px;border-radius:8px;object-fit:cover;" onerror="this.parentElement.innerHTML='<i class=\'fas fa-tools\'></i>'">` :
                    `<i class="fas fa-tools"></i>`;
                
                html += `
                    <div style="display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0;">
                        <div class="thumbnail" style="width: 40px; height: 40px; margin-right: 12px;">
                            ${thumbnailHTML}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 14px;">${tool.name}</div>
                            <div style="font-size: 12px; color: var(--gray-color);">${tool.code} | ${tool.location}</div>
                        </div>
                        <div style="font-size: 14px; font-weight: 500; color: ${getStatusColor(tool.status)};">
                            ${tool.status}
                        </div>
                    </div>
                `;
            });
            
            recentElement.innerHTML = html;
        }

        // FUNÇÃO: Atualizar informações de sincronização
        function updateSyncInfo() {
            const lastSync = localStorage.getItem('lastSync');
            const totalItems = localStorage.getItem('totalItems') || '?';
            const syncInfo = document.getElementById('syncInfo');
            
            if (syncInfo) {
                if (lastSync) {
                    const date = new Date(lastSync);
                    syncInfo.textContent = 
                        `Última: ${date.toLocaleDateString()} ${date.toLocaleTimeString()} | Total: ${totalItems} itens`;
                } else {
                    syncInfo.textContent = 'Última sincronização: Nunca';
                }
            }
        }

        // FUNÇÃO: Carregar formulário de cadastro
        function loadCadastroForm() {
            document.getElementById('cadastroForm').innerHTML = `
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Cadastrar Novo Item</h3>
                    
                    <div class="form-group">
                        <label for="cadastroNome">Nome do Produto *</label>
                        <input type="text" id="cadastroNome" placeholder="Ex: Martelo de Borracha">
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroCodigo">Código *</label>
                        <input type="text" id="cadastroCodigo" placeholder="Ex: MART-001">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="cadastroCategoria">Categoria</label>
                            <select id="cadastroCategoria">
                                <option value="">Selecione</option>
                                <option value="Ferramentas Manuais">Ferramentas Manuais</option>
                                <option value="Ferramentas Elétricas">Ferramentas Elétricas</option>
                                <option value="EPI">EPI</option>
                                <option value="Material de Consumo">Material de Consumo</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="cadastroStatus">Status</label>
                            <select id="cadastroStatus">
                                <option value="Disponível">Disponível</option>
                                <option value="Em Uso">Em Uso</option>
                                <option value="Manutenção">Manutenção</option>
                                <option value="Danificado">Danificado</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroLocalizacao">Localização</label>
                        <select id="cadastroLocalizacao">
                            <option value="">Selecione</option>
                            <option value="Almoxarifado Central">Almoxarifado Central</option>
                            <option value="Container Mecânica">Container Mecânica</option>
                            <option value="Oficina">Oficina</option>
                            <option value="Campo">Campo</option>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="cadastroQuantidade">Quantidade</label>
                            <input type="number" id="cadastroQuantidade" value="1" min="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="cadastroPreco">Preço (R$)</label>
                            <input type="number" id="cadastroPreco" step="0.01" placeholder="0,00">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroImagem">Imagem (URL)</label>
                        <input type="text" id="cadastroImagem" placeholder="URL da imagem ou deixe em branco">
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroDescricao">Descrição</label>
                        <textarea id="cadastroDescricao" rows="3" placeholder="Descrição detalhada..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px;">
                        <button id="salvarItemBtn" class="mobile-btn" style="background: var(--success-color); color: white;">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                        <button id="limparFormBtn" class="mobile-btn" style="background: var(--warning-color); color: white;">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                    
                    <p style="font-size: 12px; color: var(--gray-color); margin-top: 15px; text-align: center;">
                        * Campos obrigatórios
                    </p>
                </div>
            `;
            
            // Adicionar eventos aos botões
            document.getElementById('salvarItemBtn').addEventListener('click', saveNewItem);
            document.getElementById('limparFormBtn').addEventListener('click', clearCadastroForm);
        }

        // FUNÇÃO: Salvar novo item
        async function saveNewItem() {
            const nome = document.getElementById('cadastroNome').value.trim();
            const codigo = document.getElementById('cadastroCodigo').value.trim();
            
            if (!nome || !codigo) {
                showNotification('Preencha nome e código!', 'error');
                return;
            }
            
            const novoItem = {
                id: Date.now(),
                name: nome,
                code: codigo,
                category: document.getElementById('cadastroCategoria').value || 'Outros',
                status: document.getElementById('cadastroStatus').value,
                location: document.getElementById('cadastroLocalizacao').value || 'Almoxarifado Central',
                quantidade: parseInt(document.getElementById('cadastroQuantidade').value) || 1,
                preco: parseFloat(document.getElementById('cadastroPreco').value) || 0,
                image: document.getElementById('cadastroImagem').value.trim() || null,
                description: document.getElementById('cadastroDescricao').value.trim(),
                usuarioCadastro: currentUser ? currentUser.name : 'Mobile User',
                dataCadastro: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            try {
                // Adicionar localmente
                tools.unshift(novoItem);
                
                // Salvar no IndexedDB
                await saveToIndexedDB(tools);
                
                // Salvar no Supabase se conectado
                if (supabaseClient) {
                    await saveItemToSupabase(novoItem);
                }
                
                showNotification('Item cadastrado com sucesso!', 'success');
                clearCadastroForm();
                
                // Atualizar interface
                updateUI();
                
                // Voltar para dashboard
                switchTab('dashboard');
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showNotification('Erro ao salvar item', 'error');
            }
        }

        // FUNÇÃO: Limpar formulário de cadastro
        function clearCadastroForm() {
            if (document.getElementById('cadastroNome')) {
                document.getElementById('cadastroNome').value = '';
                document.getElementById('cadastroCodigo').value = '';
                document.getElementById('cadastroCategoria').value = '';
                document.getElementById('cadastroStatus').value = 'Disponível';
                document.getElementById('cadastroLocalizacao').value = '';
                document.getElementById('cadastroQuantidade').value = '1';
                document.getElementById('cadastroPreco').value = '';
                document.getElementById('cadastroImagem').value = '';
                document.getElementById('cadastroDescricao').value = '';
            }
        }

        // FUNÇÃO: Salvar item no Supabase
        async function saveItemToSupabase(item) {
            try {
                const itemData = {
                    name: item.name,
                    code: item.code,
                    category: item.category,
                    status: item.status,
                    location: item.location,
                    quantidade: item.quantidade,
                    preco: item.preco,
                    image_url: item.image,
                    description: item.description,
                    usuario_cadastro: item.usuarioCadastro,
                    data_cadastro: item.dataCadastro,
                    updated_at: new Date().toISOString()
                };
                
                const { error } = await supabaseClient
                    .from('tools')
                    .insert([itemData]);
                
                if (error) throw error;
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar no Supabase:', error);
                return false;
            }
        }

        // ============================================
        // SCANNER QR CODE
        // ============================================
        async function startScanner() {
            try {
                showNotification('Iniciando scanner...', 'info');
                
                // Verificar permissão de câmera
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showNotification('Câmera não disponível neste dispositivo', 'error');
                    return;
                }

                // Solicitar acesso à câmera traseira
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });

                // Criar elemento de vídeo
                const video = document.createElement('video');
                video.id = 'scanner-video';
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                video.setAttribute('playsinline', 'true');
                video.setAttribute('autoplay', 'true');
                video.setAttribute('muted', 'true');

                // Criar overlay de scanner
                const overlay = document.createElement('div');
                overlay.className = 'scanner-overlay';
                overlay.innerHTML = `
                    <div class="scanner-frame">
                        <div class="scanner-line"></div>
                    </div>
                `;

                // Limpar container e adicionar elementos
                const container = document.getElementById('scannerContainer');
                container.innerHTML = '';
                container.appendChild(video);
                container.appendChild(overlay);

                // Configurar vídeo
                video.srcObject = videoStream;
                
                // Aguardar o vídeo carregar
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play()
                            .then(resolve)
                            .catch(reject);
                    };
                });

                // Atualizar botões
                document.getElementById('startScannerBtn').style.display = 'none';
                document.getElementById('stopScannerBtn').style.display = 'block';
                document.getElementById('scannerResult').style.display = 'none';
                
                scannerActive = true;
                
                // Iniciar loop de escaneamento
                startScanningLoop(video);
                
                showNotification('Scanner ativo. Aponte para um QR Code.', 'success');
                
            } catch (error) {
                console.error('Erro ao iniciar scanner:', error);
                
                if (error.name === 'NotAllowedError') {
                    showNotification('Permissão da câmera negada', 'error');
                } else if (error.name === 'NotFoundError') {
                    showNotification('Câmera não encontrada', 'error');
                } else {
                    showNotification(`Erro: ${error.message}`, 'error');
                }
                
                resetScannerUI();
            }
        }

        function startScanningLoop(video) {
            const canvas = document.getElementById('qr-canvas');
            const context = canvas.getContext('2d');
            
            // Limpar qualquer intervalo anterior
            if (scanningInterval) {
                clearInterval(scanningInterval);
            }
            
            // Configurar tamanho do canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Função de escaneamento
            scanningInterval = setInterval(() => {
                if (!scannerActive || !video.readyState === video.HAVE_ENOUGH_DATA) {
                    return;
                }
                
                // Desenhar o frame do vídeo no canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Obter dados da imagem
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                
                // Tentar decodificar QR Code
                try {
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        handleQRCodeDetected(code.data);
                    }
                } catch (error) {
                    console.log('Erro na leitura do QR Code:', error);
                }
            }, 250);
        }

        function handleQRCodeDetected(data) {
            try {
                // Tentar parsear como JSON
                let parsedData;
                try {
                    parsedData = JSON.parse(data);
                    currentScannedData = parsedData;
                    
                    // Mostrar resultado formatado
                    showScannerResult(parsedData);
                    
                    // Parar scanner temporariamente
                    stopScanningTemporarily();
                    
                    // Verificar se o item existe localmente
                    const itemExists = tools.some(tool => 
                        tool.id == parsedData.id || 
                        tool.code === parsedData.codigo
                    );
                    
                    if (itemExists) {
                        document.getElementById('viewScannedItemBtn').style.display = 'block';
                    }
                    
                } catch (jsonError) {
                    // Se não for JSON, mostrar texto puro
                    currentScannedData = { texto: data };
                    showScannerResult({ texto: data, formato: 'Texto' });
                    stopScanningTemporarily();
                }
                
            } catch (error) {
                console.error('Erro ao processar QR Code:', error);
                showNotification('Erro ao processar QR Code', 'error');
            }
        }

        function showScannerResult(data) {
            const resultContainer = document.getElementById('scannerResult');
            const dataContainer = document.getElementById('scannedData');
            
            let html = '';
            
            if (data.id) {
                // É um item do sistema
                html = `
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--success-color);">✓ QR Code Válido</strong>
                    </div>
                    <p><strong>Item ID:</strong> ${data.id}</p>
                    <p><strong>Nome:</strong> ${data.nome || 'N/A'}</p>
                    <p><strong>Código:</strong> ${data.codigo || 'N/A'}</p>
                    <p><strong>Categoria:</strong> ${data.categoria || 'N/A'}</p>
                    <p><strong>Status:</strong> ${data.status || 'N/A'}</p>
                    <p><strong>Localização:</strong> ${data.localizacao || 'N/A'}</p>
                `;
            } else if (data.texto) {
                // É texto simples
                html = `
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--warning-color);">⚠ Texto Detectado</strong>
                    </div>
                    <p><strong>Conteúdo:</strong></p>
                    <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
                        ${data.texto}
                    </div>
                `;
            }
            
            dataContainer.innerHTML = html;
            resultContainer.style.display = 'block';
            
            // Scroll para o resultado
            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Beep sonoro
            playScanSound();
        }

        function playScanSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                console.log('Audio não disponível');
            }
        }

        function stopScanningTemporarily() {
            scannerActive = false;
            
            if (scanningInterval) {
                clearInterval(scanningInterval);
                scanningInterval = null;
            }
            
            showNotification('QR Code detectado!', 'success');
            
            document.getElementById('scanAgainBtn').onclick = function() {
                resumeScanner();
            };
            
            document.getElementById('viewScannedItemBtn').onclick = function() {
                if (currentScannedData && currentScannedData.id) {
                    showToolFromQR(currentScannedData.id);
                }
            };
        }

        function resumeScanner() {
            scannerActive = true;
            document.getElementById('scannerResult').style.display = 'none';
            
            const video = document.getElementById('scanner-video');
            if (video) {
                startScanningLoop(video);
            }
            
            showNotification('Scanner reiniciado. Continue escaneando.', 'info');
        }

        function stopScanner() {
            scannerActive = false;
            
            if (scanningInterval) {
                clearInterval(scanningInterval);
                scanningInterval = null;
            }
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            resetScannerUI();
            
            showNotification('Scanner parado', 'warning');
        }

        function resetScannerUI() {
            const container = document.getElementById('scannerContainer');
            container.innerHTML = `
                <i class="fas fa-qrcode" style="font-size: 60px; color: var(--gray-color); margin-bottom: 15px;"></i>
                <p style="text-align: center; color: var(--gray-color);">Área do scanner</p>
                <p style="text-align: center; font-size: 12px; color: var(--gray-color); margin-top: 10px;">
                    Toque para ativar a câmera
                </p>
            `;
            
            document.getElementById('startScannerBtn').style.display = 'block';
            document.getElementById('stopScannerBtn').style.display = 'none';
            document.getElementById('scannerResult').style.display = 'none';
        }

        function showToolFromQR(toolId) {
            const tool = tools.find(t => t.id == toolId || t.code === toolId);
            
            if (tool) {
                stopScanner();
                showToolDetails(tool.id ? tool.id : tool.code);
            } else {
                showNotification('Item não encontrado no cache local', 'error');
            }
        }

        // ============================================
        // INDEXEDDB
        // ============================================
        const DB_NAME = 'FerramentasDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'tools';

        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    reject('IndexedDB não suportado');
                    return;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('❌ Erro ao abrir IndexedDB:', event.target.error);
                    reject(event.target.error);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('✅ IndexedDB inicializado');
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { 
                            keyPath: 'id'
                        });
                        
                        store.createIndex('code', 'code', { unique: true });
                        store.createIndex('category', 'category', { unique: false });
                        store.createIndex('status', 'status', { unique: false });
                        store.createIndex('updatedAt', 'updatedAt', { unique: false });
                    }
                };
            });
        }

        // ============================================
        // FUNÇÕES DE SINCRONIZAÇÃO
        // ============================================
        async function fetchAllFromSupabase() {
            try {
                if (!supabaseClient) {
                    showNotification('Não conectado à nuvem', 'warning');
                    return { success: false, count: 0, total: 0 };
                }
                
                showLoader(true);
                showNotification('Buscando todos os itens...', 'warning');
                
                const { count, error: countError } = await supabaseClient
                    .from('tools')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) throw countError;
                
                totalToolsInDB = count || 0;
                console.log(`📊 Total de itens: ${totalToolsInDB}`);
                
                if (totalToolsInDB === 0) {
                    showNotification('Nenhum item encontrado', 'warning');
                    return { success: false, count: 0, total: 0 };
                }
                
                const BATCH_SIZE = 1000;
                let allTools = [];
                let currentPage = 0;
                
                while (allTools.length < totalToolsInDB) {
                    const { data, error } = await supabaseClient
                        .from('tools')
                        .select('*')
                        .range(currentPage * BATCH_SIZE, (currentPage * BATCH_SIZE) + BATCH_SIZE - 1)
                        .order('id', { ascending: true });
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        allTools = [...allTools, ...data];
                        console.log(`📦 Página ${currentPage + 1}: ${data.length} itens`);
                        
                        const progress = Math.round((allTools.length / totalToolsInDB) * 100);
                        showNotification(`Progresso: ${progress}%`, 'info');
                        
                        currentPage++;
                        
                        if (allTools.length < totalToolsInDB) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    } else {
                        break;
                    }
                }
                
                console.log(`✅ Total recebido: ${allTools.length} itens`);
                
                const convertedTools = allTools.map(item => ({
                    id: item.id,
                    name: item.name,
                    code: item.code,
                    patrimonio: item.patrimonio,
                    ncm: item.ncm,
                    category: item.category,
                    status: item.status,
                    location: item.location,
                    condition: item.condition,
                    notaFiscal: item.nota_fiscal,
                    unidade: item.unidade,
                    preco: item.preco,
                    quantidade: item.quantidade,
                    estoqueMinimo: item.estoque_minimo,
                    estoqueMaximo: item.estoque_maximo,
                    description: item.description,
                    observations: item.observations,
                    image: item.image_url,
                    usuarioCadastro: item.usuario_cadastro,
                    dataCadastro: item.data_cadastro,
                    createdAt: item.created_at,
                    updatedAt: item.updated_at
                }));
                
                await saveToIndexedDB(convertedTools);
                
                tools = await loadFromIndexedDB(100);
                
                updateUI();
                
                localStorage.setItem('lastSync', new Date().toISOString());
                localStorage.setItem('totalItems', totalToolsInDB.toString());
                
                showNotification(`✅ ${allTools.length} itens sincronizados!`, 'success');
                updateSyncInfo();
                
                return { 
                    success: true, 
                    count: allTools.length, 
                    total: totalToolsInDB 
                };
                
            } catch (error) {
                console.error('❌ Erro ao sincronizar:', error);
                showNotification(`Erro: ${error.message}`, 'error');
                return { success: false, count: 0, total: 0 };
            } finally {
                showLoader(false);
            }
        }

        async function saveToIndexedDB(data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('IndexedDB não inicializado');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    let successCount = 0;
                    
                    const insertNext = (index) => {
                        if (index >= data.length) {
                            console.log(`✅ ${successCount} itens salvos`);
                            resolve(successCount);
                            return;
                        }
                        
                        const item = data[index];
                        const request = store.add(item);
                        
                        request.onsuccess = () => {
                            successCount++;
                            insertNext(index + 1);
                        };
                        
                        request.onerror = () => {
                            console.error(`❌ Erro ao salvar item ${index}`);
                            insertNext(index + 1);
                        };
                    };
                    
                    insertNext(0);
                };
            });
        }

        function loadFromIndexedDB(limit = 100) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('IndexedDB não inicializado');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const index = store.index('updatedAt');
                
                const request = index.openCursor(null, 'prev');
                const results = [];
                let count = 0;

                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    
                    if (cursor && count < limit) {
                        results.push(cursor.value);
                        count++;
                        cursor.continue();
                    } else {
                        resolve(results);
                    }
                };
            });
        }

        // ============================================
        // FUNÇÕES DE INTERFACE
        // ============================================
        function updateUI() {
            // Buscar total salvo
            const totalInDB = localStorage.getItem('totalItems') || tools.length;
            
            // Atualizar contagem
            document.getElementById('totalItems').textContent = `${tools.length}/${totalInDB}`;
            document.getElementById('toolsCount').textContent = `${tools.length} de ${totalInDB} itens carregados`;
            
            // Atualizar valor total
            const totalValue = tools.reduce((sum, tool) => {
                const preco = parseFloat(tool.preco) || 0;
                const quantidade = parseInt(tool.quantidade) || 1;
                return sum + (preco * quantidade);
            }, 0);
            
            document.getElementById('totalValue').textContent = 
                `R$ ${totalValue.toFixed(2).replace('.', ',')}`;
            
            // Atualizar estatísticas
            updateStatusStats();
            updateRecentItems();
            
            // Atualizar lista se estiver na tab certa
            if (currentTab === 'catalogo') {
                updateToolsList();
            }
        }

        function updateToolsList() {
            const listElement = document.getElementById('toolsList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // Carregar mais dados
            if (loadedToolsCount === 0 || loadedToolsCount < tools.length) {
                loadedToolsCount = Math.min(tools.length, loadedToolsCount + 50);
            }
            
            let filteredTools = tools.slice(0, loadedToolsCount);
            
            if (searchTerm) {
                filteredTools = filteredTools.filter(tool => 
                    tool.name.toLowerCase().includes(searchTerm) ||
                    tool.code.toLowerCase().includes(searchTerm) ||
                    (tool.patrimonio && tool.patrimonio.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredTools.length === 0) {
                listElement.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 40px;">Nenhum item encontrado</p>';
                return;
            }
            
            let html = '';
            filteredTools.forEach(tool => {
                const thumbnailHTML = tool.image ? 
                    `<img src="${tool.image}" alt="${tool.name}" onerror="this.parentElement.innerHTML='<i class=\'fas fa-tools\'></i>'">` :
                    `<i class="fas fa-tools"></i>`;
                
                html += `
                    <div class="card" style="margin-bottom: 10px; padding: 15px;" data-id="${tool.id}">
                        <div style="display: flex; align-items: start; margin-bottom: 10px;">
                            <div class="thumbnail" style="margin-right: 12px; flex-shrink: 0;">
                                ${thumbnailHTML}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; font-size: 16px;">${tool.name}</div>
                                <div style="font-size: 14px; color: var(--gray-color);">${tool.code}${tool.patrimonio ? ' | ' + tool.patrimonio : ''}</div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                    <span style="font-size: 12px; padding: 3px 8px; background: ${getStatusColor(tool.status)}20; color: ${getStatusColor(tool.status)}; border-radius: 12px;">
                                        ${tool.status}
                                    </span>
                                    <span style="font-size: 12px; color: var(--gray-color);">${tool.location}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tool-actions">
                            <button class="action-btn view" data-id="${tool.id}">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="action-btn qr" data-id="${tool.id}">
                                <i class="fas fa-qrcode"></i> QR Code
                            </button>
                        </div>
                    </div>
                `;
            });
            
            listElement.innerHTML = html;
            
            // Adicionar eventos aos botões
            document.querySelectorAll('.action-btn.view').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const toolId = this.getAttribute('data-id');
                    showToolDetails(toolId);
                });
            });
            
            document.querySelectorAll('.action-btn.qr').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const toolId = this.getAttribute('data-id');
                    generateQRCode(toolId);
                });
            });
            
            // Clique no card inteiro também abre detalhes
            document.querySelectorAll('.card[data-id]').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (!e.target.closest('.action-btn')) {
                        const toolId = this.getAttribute('data-id');
                        showToolDetails(toolId);
                    }
                });
            });
        }

        function showToolDetails(toolId) {
            const tool = tools.find(t => t.id == toolId);
            if (!tool) return;
            
            const imageHTML = tool.image ? 
                `<div class="image-preview">
                    <img src="${tool.image}" alt="${tool.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-tools\' style=\'font-size:60px; color:#ccc;\'></i><p>Sem imagem</p>'">
                </div>` :
                `<div class="image-preview">
                    <i class="fas fa-tools" style="font-size: 60px; color: #ccc;"></i>
                    <p style="margin-top: 10px; color: var(--gray-color);">Sem imagem</p>
                </div>`;
            
            document.getElementById('modalTitle').textContent = tool.name;
            document.getElementById('modalBody').innerHTML = `
                ${imageHTML}
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                    <div><strong>Código:</strong><br>${tool.code}</div>
                    <div><strong>Patrimônio:</strong><br>${tool.patrimonio || 'Não informado'}</div>
                    <div><strong>Categoria:</strong><br>${tool.category}</div>
                    <div><strong>Status:</strong><br><span style="color: ${getStatusColor(tool.status)}">${tool.status}</span></div>
                    <div><strong>Localização:</strong><br>${tool.location}</div>
                    <div><strong>Condição:</strong><br>${tool.condition}</div>
                    <div><strong>Quantidade:</strong><br>${tool.quantidade}</div>
                    <div><strong>Preço:</strong><br>R$ ${parseFloat(tool.preco || 0).toFixed(2).replace('.', ',')}</div>
                </div>
                
                ${tool.description ? `
                    <div style="margin-top: 15px;">
                        <strong>Descrição:</strong>
                        <p style="margin-top: 5px; background: var(--light-color); padding: 10px; border-radius: 8px;">${tool.description}</p>
                    </div>
                ` : ''}
                
                ${tool.observations ? `
                    <div style="margin-top: 15px;">
                        <strong>Observações:</strong>
                        <p style="margin-top: 5px; background: var(--light-color); padding: 10px; border-radius: 8px;">${tool.observations}</p>
                    </div>
                ` : ''}
                
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <button id="modalQRBtn" class="mobile-btn" style="background: #8e44ad; color: white;" data-id="${tool.id}">
                        <i class="fas fa-qrcode"></i> QR Code
                    </button>
                    <button id="modalCloseBtn" class="mobile-btn" style="background: var(--gray-color); color: white;">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
            `;
            
            // Mostrar modal
            document.getElementById('itemModal').style.display = 'flex';
            
            // Eventos do modal - USANDO AS NOVAS FUNÇÕES
            document.getElementById('modalQRBtn').addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                closeItemModal(); // Usar função de fechar
                generateQRCode(id);
            });
            
            // O botão modalCloseBtn já tem evento na função setupModalEvents
            // Mas para garantir, podemos adicionar aqui também:
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            if (modalCloseBtn) {
                // Remover evento anterior para evitar duplicação
                const newCloseBtn = modalCloseBtn.cloneNode(true);
                modalCloseBtn.parentNode.replaceChild(newCloseBtn, modalCloseBtn);
                newCloseBtn.addEventListener('click', closeItemModal);
            }
        }

        function generateQRCode(toolId) {
            const tool = tools.find(t => t.id == toolId);
            if (!tool) return;
            
            const qrContent = JSON.stringify({
                id: tool.id,
                nome: tool.name,
                codigo: tool.code,
                patrimonio: tool.patrimonio,
                categoria: tool.category,
                status: tool.status,
                localizacao: tool.location
            }, null, 2);
            
            document.getElementById('qrModalBody').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>${tool.name}</h4>
                    <p style="color: var(--gray-color); font-size: 14px;">${tool.code}</p>
                </div>
                <div id="qrcodeCanvas" style="margin: 0 auto 20px;"></div>
                <div style="margin-top: 20px;">
                    <button id="downloadQRBtn" class="mobile-btn" style="background: var(--secondary-color); color: white;">
                        <i class="fas fa-download"></i> Baixar QR Code
                    </button>
                    <button id="closeQRBtn" class="mobile-btn" style="background: var(--gray-color); color: white; margin-top: 10px;">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
            `;
            
            // Gerar QR Code
            QRCode.toCanvas(document.getElementById('qrcodeCanvas'), qrContent, {
                width: 200,
                margin: 2,
                color: { dark: '#000000', light: '#FFFFFF' }
            });
            
            // Mostrar modal
            document.getElementById('qrModal').style.display = 'flex';
            
            // Eventos
            document.getElementById('downloadQRBtn').addEventListener('click', function() {
                const canvas = document.querySelector('#qrcodeCanvas canvas');
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = `QRCode_${tool.code}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }
            });
            
            document.getElementById('closeQRBtn').addEventListener('click', closeQRModal);
        }

        // ============================================
        // FUNÇÕES DO MENU E LOGIN
        // ============================================
        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Dados de usuários
            const users = {
                'fabio@fwcompany.com.br': {
                    password: 'FabioFW123@',
                    role: 'dev',
                    name: 'Fábio Mendes',
                    email: 'fabio@fwcompany.com.br'
                },
                'emerson.silva@fwcompany.com.br': {
                    password: 'EmersonFW1@',
                    role: 'almoxarife',
                    name: 'Emerson Silva',
                    email: 'emerson.silva@fwcompany.com.br'
                },
                'fwuser': {
                    password: 'User123',
                    role: 'user',
                    name: 'Usuário Genérico',
                    email: 'fwuser@fwcompany.com.br'
                },
                'raquel@fwcompany.com.br': {
                    password: 'RaqueL1234',
                    role: 'user',
                    name: 'Raquel',
                    email: 'raquel@fwcompany.com.br'
                }
            };
            
            if (users[email] && users[email].password === password) {
                currentUser = users[email];
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showDashboard();
                initializeSystem();
            } else {
                showNotification('Credenciais inválidas', 'error');
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mobileDashboard').style.display = 'flex';
            
            if (currentUser) {
                const userBadge = document.getElementById('userBadge');
                if (userBadge) {
                    userBadge.textContent = 
                        currentUser.role === 'dev' ? 'DEV' : 
                        currentUser.role === 'admin' ? 'ADMIN' : 
                        currentUser.role === 'supervisor' ? 'SUPERVISOR' : 'OPERADOR';
                }
            }
        }

        function openMenu() {
            document.getElementById('mobileSidebar').classList.add('open');
            document.getElementById('menuOverlay').style.display = 'block';
            
            if (currentUser) {
                document.getElementById('menuUserName').textContent = currentUser.name;
                document.getElementById('menuUserEmail').textContent = currentUser.email;
                document.getElementById('menuUserRole').textContent = 
                    currentUser.role === 'dev' ? 'DEV' : 
                    currentUser.role === 'admin' ? 'ADMIN' : 
                    currentUser.role === 'supervisor' ? 'SUPERVISOR' : 'OPERADOR';
            }
        }

        function closeMenu() {
            document.getElementById('mobileSidebar').classList.remove('open');
            document.getElementById('menuOverlay').style.display = 'none';
        }

        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                if (scannerActive) {
                    stopScanner();
                }
                
                localStorage.removeItem('currentUser');
                currentUser = null;
                
                closeMenu();
                
                document.getElementById('mobileDashboard').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                
                showNotification('Logout realizado com sucesso', 'success');
            }
        }

        // ============================================
        // FUNÇÕES AUXILIARES
        // ============================================
        function getStatusColor(status) {
            switch(status) {
                case 'Disponível': return '#27ae60';
                case 'Em Uso': return '#3498db';
                case 'Manutenção': return '#f39c12';
                case 'Danificado': return '#e74c3c';
                default: return '#95a5a6';
            }
        }

        async function connectToSupabase() {
            try {
                supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                
                const { data, error } = await supabaseClient
                    .from('tools')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                updateConnectionStatus(true);
                return true;
                
            } catch (error) {
                console.error('❌ Erro ao conectar:', error);
                updateConnectionStatus(false);
                return false;
            }
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const syncElement = document.getElementById('syncStatus');
            
            if (connected) {
                statusElement.textContent = 'Online';
                statusElement.style.background = 'rgba(39,174,96,0.2)';
                statusElement.style.color = '#27ae60';
                syncElement.textContent = 'Cloud';
            } else {
                statusElement.textContent = 'Offline';
                statusElement.style.background = 'rgba(231,76,60,0.2)';
                statusElement.style.color = '#e74c3c';
                syncElement.textContent = 'Local';
            }
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const content = document.getElementById('notificationContent');
            
            content.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Funções auxiliares do menu
        function showUserProfile() {
            alert(`Perfil do Usuário:\n\nNome: ${currentUser.name}\nEmail: ${currentUser.email}\nFunção: ${currentUser.role}`);
            closeMenu();
        }

        function manageUsers() {
            closeMenu();
            showNotification('Gerenciamento de usuários em desenvolvimento', 'info');
        }

        function showReports() {
            closeMenu();
            showNotification('Relatórios em desenvolvimento', 'info');
        }

        function backupData() {
            closeMenu();
            showNotification('Backup em desenvolvimento', 'info');
        }

        function showAbout() {
            closeMenu();
            alert('Sistema de Ferramentas Mobile v1.0.0\n\nDesenvolvido para gestão de ferramentas e equipamentos.\n\n© 2024 FW Company');
        }

        function showHelp() {
            closeMenu();
            alert('Ajuda do Sistema:\n\n1. Dashboard: Visão geral\n2. Novo: Cadastrar itens\n3. Itens: Lista completa\n4. Scanner: Ler QR Codes\n5. Config: Configurações\n\nUse o menu para mais opções.');
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkSession();
        });

        function setupEventListeners() {
            // Login
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            
            // Menu
            document.getElementById('menuBtn').addEventListener('click', openMenu);
            document.getElementById('menuOverlay').addEventListener('click', closeMenu);
            
            // Scanner
            document.getElementById('startScannerBtn').addEventListener('click', startScanner);
            document.getElementById('stopScannerBtn').addEventListener('click', stopScanner);
            
            // Tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                });
            });
            
            // Botões principais
            document.getElementById('syncNowBtn').addEventListener('click', async () => {
                await fetchAllFromSupabase();
            });
            
            document.getElementById('syncAllBtn').addEventListener('click', async () => {
                if (confirm('Buscar TODOS os itens?')) {
                    await fetchAllFromSupabase();
                }
            });
            
            document.getElementById('syncUpdatesBtn').addEventListener('click', async () => {
                showNotification('Funcionalidade em desenvolvimento', 'info');
            });
            
            document.getElementById('clearCacheBtn').addEventListener('click', async () => {
                if (confirm('Limpar cache?')) {
                    if (db) {
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        store.clear();
                        tools = [];
                        updateUI();
                        showNotification('Cache limpo', 'success');
                    }
                }
            });
            
            document.getElementById('addItemBtn').addEventListener('click', () => {
                switchTab('cadastro');
            });
            
            document.getElementById('viewAllBtn').addEventListener('click', () => {
                switchTab('catalogo');
            });
            
            document.getElementById('loadMoreBtn').addEventListener('click', () => {
                loadedToolsCount += 50;
                updateToolsList();
            });
            
            // Configurar eventos dos modais
            setupModalEvents();
            
            // Network
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus(true);
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus(false);
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Parar scanner se estiver ativo e mudando de aba
            if (scannerActive && tab !== 'scanner') {
                stopScanner();
            }
            
            // Atualizar tabs ativas
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
            });
            
            // Ocultar todos os conteúdos
            document.querySelectorAll('.tab-content').forEach(div => {
                div.style.display = 'none';
            });
            
            switch(tab) {
                case 'dashboard':
                    document.getElementById('tabDashboard').style.display = 'block';
                    updateUI();
                    break;
                case 'cadastro':
                    document.getElementById('tabCadastro').style.display = 'block';
                    loadCadastroForm();
                    break;
                case 'catalogo':
                    document.getElementById('tabCatalogo').style.display = 'block';
                    loadedToolsCount = 50;
                    updateToolsList();
                    break;
                case 'scanner':
                    document.getElementById('tabScanner').style.display = 'block';
                    break;
                case 'config':
                    document.getElementById('tabConfig').style.display = 'block';
                    break;
            }
        }

        function checkSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showDashboard();
                    setTimeout(() => initializeSystem(), 500);
                } catch (e) {
                    console.error('Erro na sessão:', e);
                }
            }
        }

        async function initializeSystem() {
            console.log('🔧 Inicializando sistema...');
            
            try {
                await initIndexedDB();
                tools = await loadFromIndexedDB(100);
                console.log(`📁 ${tools.length} itens carregados`);
                
                await connectToSupabase();
                
                updateUI();
                updateSyncInfo();
                
                if (isOnline && supabaseClient && tools.length < 10) {
                    console.log('🔄 Sincronização automática');
                    setTimeout(async () => {
                        await fetchAllFromSupabase();
                    }, 1500);
                }
                
            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
                showNotification('Erro ao inicializar', 'error');
            }
        }
    </script>
</body>
</html>
